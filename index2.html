<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 應用規劃師能力測驗</title>
    <!-- Tailwind CSS CDN - 用於快速構建響應式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 字體 - 提供現代且易讀的字體樣式 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* 基本樣式設定，確保內容垂直居中 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        /* 測驗容器樣式，包含陰影和圓角，並設定背景動畫 */
        .quiz-container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center; /* 水平居中 */
            justify-content: center; /* 垂直居中 */
            position: relative;
            overflow: hidden; /* 隱藏超出容器的內容，用於背景動畫 */
            min-height: 400px; /* 確保容器有足夠高度來居中內容 */
        }
        /* 測驗容器的偽元素，用於創建脈衝背景動畫 */
        .quiz-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, #e0f2fe, #ffffff);
            animation: pulse 10s infinite alternate;
            z-index: 0;
            opacity: 0.3;
        }
        /* 脈衝動畫關鍵幀 */
        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.3; }
            100% { transform: scale(1.1); opacity: 0.5; }
        }
        /* 內容包裹器，確保內容在背景動畫之上 */
        .content-wrapper {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        /* 載入訊息的樣式 */
        .loading-message {
            font-size: 1.5rem;
            color: #4a5568;
            margin-top: 50px;
        }
        /* 科目選擇區塊樣式，響應式佈局 */
        .subject-selection {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        @media (min-width: 640px) {
            .subject-selection {
                flex-direction: row;
                justify-content: center;
            }
        }
        /* 下拉選單樣式 */
        .subject-selection select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #cbd5e0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            background-color: #f7fafc;
            appearance: none; /* 移除預設箭頭 */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20fill%3D%22%234A5568%22%20d%3D%22M9.293%2012.95l.707.707L15.657%208l-1.414-1.414L10%2010.828%206.757%207.586%205.343%209z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        .subject-selection select:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* 開始測驗按鈕樣式 */
        .start-quiz-button {
            background-color: #48bb78;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.3);
        }
        .start-quiz-button:hover:not(:disabled) {
            background-color: #38a169;
            transform: translateY(-2px);
        }
        .start-quiz-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* 初始選擇畫面樣式 */
        #initial-selection-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        /* 科目標題樣式 */
        .subject-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 問題編號樣式 */
        .question-number {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 10px;
            font-weight: 600;
        }
        /* 問題文本樣式 */
        .question-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        /* 選項容器樣式 */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            text-align: left;
        }
        /* 選項按鈕樣式 */
        .option-button {
            background-color: #edf2f7;
            color: #4a5568;
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .option-button:hover:not(.disabled):not(.correct):not(.incorrect) {
            background-color: #e2e8f0;
            border-color: #cbd5e0;
        }
        /* 選中選項的樣式 */
        .option-button.selected {
            border-color: #63b3ed;
            background-color: #ebf8ff;
            color: #2b6cb0;
        }
        /* 正確選項的樣式 */
        .option-button.correct {
            background-color: #d4edda; /* 淺綠色 */
            border-color: #48bb78; /* 綠色 */
            color: #2f855a;
        }
        /* 錯誤選項的樣式 */
        .option-button.incorrect {
            background-color: #fde8e8; /* 淺紅色 */
            border-color: #ef4444; /* 紅色 */
            color: #c53030;
        }
        /* 選項標籤樣式 (A, B, C, D) */
        .option-label {
            font-weight: bold;
            min-width: 25px;
            text-align: center;
        }
        /* 回饋容器樣式 */
        .feedback-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: left;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            display: none; /* 預設隱藏 */
            font-size: 1rem;
            line-height: 1.6;
        }
        .feedback-container.show {
            display: block;
        }
        /* 回饋標題樣式 */
        .feedback-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #2d3748;
        }
        /* 回饋文本樣式 */
        .feedback-text {
            color: #4a5568;
        }
        /* 導航按鈕容器樣式 */
        .navigation-buttons {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        /* 導航按鈕樣式 */
        .nav-button {
            background-color: #4299e1;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.3);
        }
        .nav-button:hover:not(:disabled) {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .nav-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* 提交測驗按鈕樣式 */
        .submit-quiz-button {
            background-color: #ef4444; /* 紅色 */
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        .submit-quiz-button:hover:not(:disabled) {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .submit-quiz-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* 測驗總結區塊 (預設隱藏) */
        .quiz-summary {
            margin-top: 30px;
            padding: 30px;
            background-color: #e6fffa;
            border-radius: 15px;
            border: 2px solid #38b2ac;
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 600;
            display: none; /* 預設隱藏 */
        }
        .quiz-summary.show {
            display: block;
        }
        /* 總結標題樣式 */
        .summary-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 總結分數樣式 */
        .summary-score {
            font-size: 2rem;
            color: #38b2ac;
            font-weight: 800;
            margin-bottom: 20px;
        }
        /* 總結訊息樣式 */
        .summary-message {
            font-size: 1.3rem;
            color: #4a5568;
            margin-bottom: 30px;
        }
        /* 重新測驗按鈕樣式 */
        .restart-button {
            background-color: #48bb78;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.3);
        }
        .restart-button:hover {
            background-color: #38a169;
            transform: translateY(-2px);
        }
        /* 錯題總結區塊樣式 */
        .incorrect-questions-summary {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #cbd5e0;
        }
        /* 錯題項目樣式 */
        .incorrect-questions-summary .incorrect-question-item {
            background-color: #fefcbf; /* 淺黃色 */
            border: 2px solid #ef4444; /* 紅色邊框 */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        /* 錯題文本樣式 */
        .incorrect-questions-summary .question-text-incorrect {
            font-weight: 700;
            color: #8b5f00; /* 深黃色 */
            margin-bottom: 10px;
        }
        /* 正確答案文本樣式 */
        .incorrect-questions-summary .correct-answer-text {
            font-weight: 600;
            color: #2f855a; /* 綠色 */
            margin-top: 5px;
        }
        /* 解釋文本樣式 */
        .incorrect-questions-summary .explanation-text {
            font-size: 0.95rem;
            color: #6b46c1; /* 紫色 */
            margin-top: 10px;
        }

        /* 新增：所有題目總結區塊樣式 */
        .all-questions-summary {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #cbd5e0;
        }
        /* 新增：所有題目項目樣式 */
        .all-questions-summary .question-item {
            background-color: #f7fafc; /* 淺灰色 */
            border: 1px solid #e2e8f0; /* 淺邊框 */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .all-questions-summary .question-item.correct {
            background-color: #e6fffa; /* 淺綠色 */
            border-color: #38b2ac; /* 青綠色 */
        }
        .all-questions-summary .question-item.incorrect {
            background-color: #fde8e8; /* 淺紅色 */
            border-color: #ef4444; /* 紅色 */
        }
        /* 新增：問題文本樣式 */
        .all-questions-summary .question-text-all {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }
        /* 新增：您的答案樣式 */
        .all-questions-summary .your-answer-text {
            font-weight: 600;
            color: #4299e1; /* 藍色 */
            margin-top: 5px;
        }
        /* 新增：正確答案樣式 */
        .all-questions-summary .correct-answer-text-all {
            font-weight: 600;
            color: #2f855a; /* 綠色 */
            margin-top: 5px;
        }
        /* 新增：解釋文本樣式 */
        .all-questions-summary .explanation-text-all {
            font-size: 0.95rem;
            color: #6b46c1; /* 紫色 */
            margin-top: 10px;
        }

        /* Gemini 模態框疊加層樣式 */
        .gemini-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* Gemini 模態框內容樣式 */
        .gemini-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            position: relative;
            text-align: left;
        }
        /* Gemini 模態框關閉按鈕樣式 */
        .gemini-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }
        .gemini-modal-close:hover {
            color: #4a5568;
        }
        /* Gemini 模態框標題樣式 */
        .gemini-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* Gemini 模態框輸入區文本域樣式 */
        .gemini-modal-input-area textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 80px;
            resize: vertical;
            margin-bottom: 15px;
        }
        .gemini-modal-input-area textarea:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* Gemini 模態框按鈕容器樣式 */
        .gemini-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* Gemini 模態框提交按鈕樣式 */
        .gemini-modal-submit-button {
            background-color: #4299e1;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .gemini-modal-submit-button:hover {
            background-color: #3182ce;
        }
        /* Gemini 模態框取消按鈕樣式 */
        .gemini-modal-cancel-button {
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .gemini-modal-cancel-button:hover {
            background-color: #718096;
        }
        /* Gemini 模態框載入中指示器樣式 */
        .gemini-modal-loading {
            text-align: center;
            margin-top: 20px;
            font-size: 1.1rem;
            color: #4a5568;
        }
        /* Gemini 模態框回應區樣式 */
        .gemini-modal-response {
            margin-top: 20px;
            padding: 15px;
            background-color: #e6fffa;
            border: 1px solid #38b2ac;
            border-radius: 10px;
            font-size: 1rem;
            color: #2d3748;
            white-space: pre-wrap; /* 保留空白和換行 */
            max-height: 300px;
            overflow-y: auto;
        }
        /* 詢問 Gemini 按鈕樣式 */
        .ask-gemini-button {
            background-color: #805ad5; /* 紫色 */
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(128, 90, 213, 0.3);
            /* margin-top: 20px; */ /* 移除或調整，以便與其他按鈕並排 */
        }
        .ask-gemini-button:hover {
            background-color: #6b46c1;
            transform: translateY(-2px);
        }

        /* API 金鑰輸入模態框疊加層樣式 */
        .api-key-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* 高於 Gemini 模態框 */
        }
        /* API 金鑰輸入模態框內容樣式 */
        .api-key-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: left;
        }
        /* API 金鑰模態框標題樣式 */
        .api-key-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* API 金鑰模態框輸入區輸入框樣式 */
        .api-key-modal-input-area input {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .api-key-modal-input-area input:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* API 金鑰模態框按鈕容器樣式 */
        .api-key-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* API 金鑰模態框提交按鈕樣式 */
        .api-key-modal-submit-button {
            background-color: #48bb78;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .api-key-modal-submit-button:hover {
            background-color: #38a169;
        }
        /* API 金鑰模態框取消按鈕樣式 */
        .api-key-modal-cancel-button {
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .api-key-modal-cancel-button:hover {
            background-color: #718096;
        }

        /* 計時器顯示樣式 */
        .timer-display {
            position: absolute;
            top: 1rem;
            right: 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            background-color: #e0f2fe;
            padding: 8px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: none; /* 預設隱藏 */
        }

        /* 確認模態框疊加層樣式 */
        .confirmation-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1006; /* 調整 z-index，確保它在回報問題模態框之上 */
        }
        /* 確認模態框內容樣式 */
        .confirmation-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        /* 確認模態框標題樣式 */
        .confirmation-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 確認模態框訊息樣式 */
        .confirmation-modal-message {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 25px;
        }
        /* 確認模態框按鈕容器樣式 */
        .confirmation-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        /* 確認模態框按鈕樣式 */
        .confirmation-modal-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        /* 確認按鈕 (是) 樣式 */
        .confirm-yes {
            background-color: #ef4444;
            color: white;
        }
        .confirm-yes:hover {
            background-color: #dc2626;
        }
        /* 確認按鈕 (否) 樣式 */
        .confirm-no {
            background-color: #a0aec0;
            color: white;
        }
        .confirm-no:hover {
            background-color: #718096;
        }

        /* 題目數量顯示樣式 */
        .question-counts {
            margin-top: 20px;
            font-size: 1.1rem;
            color: #4a5568;
            text-align: center;
        }
        .question-counts p {
            margin-bottom: 5px;
        }

        /* 環境選擇畫面樣式 */
        #environment-selection-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        /* 環境選擇按鈕樣式 */
        .env-button {
            background-color: #6366f1; /* 靛藍色 */
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        .env-button:hover {
            background-color: #4f46e5;
            transform: translateY(-2px);
        }

        /* 用戶計數顯示樣式 */
        #user-count-display {
            margin-top: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            background-color: #e2f8f5; /* 淺青色 */
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #38b2ac;
            display: none; /* 預設隱藏，在認證後顯示 */
            margin-bottom: 20px;
        }

        /* 繼續測驗提示樣式 */
        #continue-quiz-prompt {
            display: none; /* 預設隱藏 */
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            text-align: center;
        }
        #continue-quiz-prompt p {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }
        /* 繼續和開始新測驗按鈕容器樣式 */
        .continue-quiz-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        @media (min-width: 640px) {
            .continue-quiz-buttons {
                flex-direction: row;
            }
        }
        /* 繼續和開始新測驗按鈕樣式 */
        .continue-button, .start-new-button {
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .continue-button {
            background-color: #4299e1;
            color: white;
        }
        .continue-button:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .start-new-button {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .start-new-button:hover {
            background-color: #cbd5e0;
            transform: translateY(-2px);
        }

        /* 使用者 ID 輸入模態框疊加層樣式 */
        #user-id-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1003; /* 最高層級 */
        }
        /* 使用者 ID 輸入模態框內容樣式 */
        #user-id-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: left;
        }
        /* 使用者 ID 模態框標題樣式 */
        #user-id-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 使用者 ID 模態框輸入區輸入框樣式 */
        #user-id-modal-input-area input {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        #user-id-modal-input-area input:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* 使用者 ID 模態框按鈕容器樣式 */
        #user-id-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* 提交使用者 ID 按鈕樣式 */
        #submit-user-id-button {
            background-color: #48bb78;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        #submit-user-id-button:hover {
            background-color: #38a169;
        }
        /* 取消使用者 ID 按鈕樣式 */
        #cancel-user-id-button {
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        #cancel-user-id-button:hover {
            background-color: #718096;
        }

        /* 排行榜模態框疊加層樣式 */
        #leaderboard-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* 預設隱藏 */
            justify-content: center;
            align-items: center;
            z-index: 1004; /* 高於其他模態框 */
        }
        /* 排行榜模態框內容樣式 */
        #leaderboard-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            position: relative;
            text-align: center;
        }
        /* 排行榜模態框關閉按鈕樣式 */
        #leaderboard-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }
        .leaderboard-modal-close:hover {
            color: #4a5568;
        }
        /* 排行榜標題樣式 */
        #leaderboard-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 排行榜列表樣式 */
        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        /* 排行榜列表項目樣式 */
        #leaderboard-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #edf2f7;
            font-size: 1.1rem;
            color: #4a5568;
        }
        #leaderboard-list li:last-child {
            border-bottom: none;
        }
        #leaderboard-list li:nth-child(odd) {
            background-color: #f7fafc;
        }
        /* 排行榜前三名樣式 */
        #leaderboard-list li:first-child {
            background-color: #fff3e0; /* 金色 */
            font-weight: 700;
            color: #e65100;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        #leaderboard-list li:nth-child(2) {
            background-color: #eceff1; /* 銀色 */
            font-weight: 600;
            color: #546e7a;
        }
        #leaderboard-list li:nth-child(3) {
            background-color: #fbe9e7; /* 青銅色 */
            font-weight: 600;
            color: #bf360c;
        }
        /* 排行榜排名樣式 */
        .leaderboard-rank {
            font-weight: 700;
            min-width: 30px;
            text-align: left;
        }
        /* 排行榜名稱樣式 */
        .leaderboard-name {
            flex-grow: 1;
            text-align: left;
            margin-left: 15px;
        }
        /* 排行榜分數樣式 */
        .leaderboard-score {
            font-weight: 700;
            color: #2d3748;
        }
        /* 查看排行榜按鈕樣式 */
        .view-leaderboard-button {
            background-color: #667eea; /* 靛藍色 */
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            margin-top: 20px;
        }
        .view-leaderboard-button:hover {
            background-color: #5a67d8;
            transform: translateY(-2px);
        }
        /* 分享結果按鈕樣式 */
        .share-results-button {
            background-color: #38b2ac; /* 青綠色 */
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(56, 178, 172, 0.3);
            margin-top: 15px;
        }
        .share-results-button:hover {
            background-color: #319795;
            transform: translateY(-2px);
        }
        /* 新增：模式選擇按鈕樣式 */
        .mode-button {
            background-color: #4299e1; /* 藍色 */
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.3);
        }
        .mode-button:hover:not(.selected-mode) {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .mode-button.selected-mode {
            background-color: #2b6cb0; /* 更深的藍色 */
            cursor: default;
            box-shadow: 0 4px 10px rgba(43, 108, 176, 0.4);
        }
		/* 歷史紀錄圖卡 */
        .leaderboard-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* 這裡可以調整回你的 bg-opacity-50 */
            
            /* 核心置中屬性 */
            display: flex;
            justify-content: center;
            align-items: center;
            
            z-index: 1000; /* 或你 Tailwind 的 z-50，看哪個 z-index 值更高 */
        }

        /* 確保 leaderboard-modal-content 的樣式也存在 */
        .leaderboard-modal-content {
            background-color: white; /* 範例 */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative; /* 為了讓內部關閉按鈕可以絕對定位 */
        }

        /* 關閉按鈕的位置，確保它是相對於 leaderboard-modal-content 定位 */
        .gemini-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #333;
        }

        /* 模態框內部內容的對齊 (如果需要，例如標題、按鈕置中) */
        .leaderboard-title,
        .view-leaderboard-button {
            text-align: center; /* 讓文字和按鈕置中 */
            margin-bottom: 15px; /* 範例間距 */
        }

        /* 列表項的樣式 (如果需要，可能不需要置中，但可以調整間距) */
        .leaderboard-list {
            list-style: none; /* 移除列表點 */
            padding: 0;
            margin: 0;
        }

        .leaderboard-list li {
            display: flex; /* 讓列表項內容在一行內對齊 */
            align-items: center; /* 垂直居中列表項的內容 */
            justify-content: space-between; /* 讓內容兩端對齊 */
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
		.gemini-modal-close {
		  position: absolute;
		  top: 16px;
		  right: 20px;
		  font-size: 24px;
		  font-weight: bold;
		  color: #666;
		  cursor: pointer;
		  transition: color 0.2s ease;
		}

		.gemini-modal-close:hover {
		  color: #000;
		}

		/* 歷史紀錄按鈕 */
		.view-history-button {
			background-color: #805ad5;
			color: white;
			padding: 12px 25px;
			border-radius: 10px;
			font-size: 1.1rem;
			font-weight: 600;
			cursor: pointer;
			transition: background-color 0.3s ease, transform 0.2s ease;
			border: none;
			box-shadow: 0 4px 10px rgba(128, 90, 213, 0.3);
			margin-top: 20px;
			letter-spacing: 0.5px;
		}
		.view-history-button:hover {
			background-color: #6b46c1;
			transform: translateY(-2px);
		}
		.view-history-button:focus {
			outline: 2px solid #c4b5fd;
			outline-offset: 2px;
		}

		/* 遮罩層 */
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.6);
			backdrop-filter: blur(2px);
			display: flex;
			justify-content: center;
			align-items: center;
			flex-direction: column;
			z-index: 9999;
			color: white;
			font-size: 1.5rem;
			text-align: center;
		}

		/* Loading Spinner */
		.spinner {
			border: 8px solid rgba(255, 255, 255, 0.2);
			border-top: 8px solid #ffffff;
			border-radius: 50%;
			width: 60px;
			height: 60px;
			animation: spin 1.2s linear infinite;
			margin-bottom: 20px;
		}

		@keyframes spin {
			0%   { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

        /* 新增：回報問題模態框疊加層樣式 */
        .report-problem-modal-overlay {
            position: fixed; /* 固定定位，使其浮動在頁面最上層 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* 半透明黑色背景 */
            display: flex; /* 使用 Flexbox 居中內容 */
            justify-content: center;
            align-items: center;
            z-index: 1005; /* 確保它在其他模態框之上 (例如比 gemini-modal-overlay 的 z-index: 1000 更高) */
        }

        /* 新增：回報問題模態框內容樣式 (可以沿用現有 gemini-modal-content 的部分樣式) */
        .report-problem-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 500px; /* 設定最大寬度 */
            width: 90%; /* 響應式寬度 */
            position: relative;
            text-align: left;
        }
        /* 新增：回報問題成功訊息區塊 */
        #reportProblemSuccessMessage {
            margin-top: 15px;
            padding: 10px;
            background-color: #d4edda; /* 淺綠色背景 */
            border: 1px solid #48bb78; /* 綠色邊框 */
            border-radius: 8px;
            color: #2f855a; /* 深綠色文字 */
            text-align: center;
            display: none; /* 預設隱藏 */
            font-weight: 600;
        }

        /* 新增：回報問題選項的樣式 */
        .report-options-container {
            display: flex;
            flex-direction: column;
            gap: 10px; /* 選項之間的間距 */
            margin-bottom: 15px;
        }
        .report-option-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: #f7fafc;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .report-option-item:hover {
            background-color: #edf2f7;
            border-color: #cbd5e0;
        }
        .report-option-item input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }
        .report-option-item label {
            flex-grow: 1;
            cursor: pointer;
            font-size: 1rem;
            color: #2d3748;
        }
        /* 當 radio 被選中時，給父級 div 加上樣式 */
        .report-option-item input[type="radio"]:checked + label {
            font-weight: 600;
            color: #4299e1; /* 藍色 */
        }

    </style>
</head>
<body>
    <div class="quiz-container">
        <div class="content-wrapper">
            <!-- 環境選擇畫面 -->
            <!-- DOM 關係：environment-selection-screen 是 quiz-container > content-wrapper 的子元素 -->
            <div id="environment-selection-screen" class="flex flex-col items-center justify-center h-full">
                <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">iPAS AI應用規劃師模模擬測驗</h1>
                <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">選擇執行環境</h2>
                <div class="flex flex-col sm:flex-row gap-6">
                    <button id="select-canvas-env" class="env-button">在 Canvas 環境啟動</button>
                    <button id="select-github-env" class="env-button">使用 GitHub Pages 環境</button>
                </div>
                <p class="text-gray-600 mt-8 text-center">
                    非Canvas環境下，請點擊這裡啟動環境：<br>
                    <a href="https://g.co/gemini/share/384e247e4b93" target="_blank" class="text-blue-500 hover:underline font-semibold">前往 Gemini 啟動環境</a>
                </p>
                <div id="last-updated-display" class="mt-4 text-gray-600 text-sm">
                    <!-- 最後更新時間將在此顯示 -->
                </div>
            </div>

            <!-- 初始科目選擇畫面 (預設隱藏) -->
            <!-- DOM 關係：initial-selection-screen 是 quiz-container > content-wrapper 的子元素 -->
            <div id="initial-selection-screen" style="display: none;">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">iPAS初級AI應用規劃師模擬測驗</h1>

                <div id="user-count-display">
                    <!-- 用戶計數將在此顯示 -->
                </div>

                <!-- 繼續測驗提示 -->
                <!-- DOM 關係：continue-quiz-prompt 是 initial-selection-screen 的子元素 -->
                <div id="continue-quiz-prompt">
                    <p id="continue-quiz-message"></p>
                    <div class="continue-quiz-buttons">
                        <button id="continue-quiz-button" class="continue-button">繼續測驗</button>
                        <button id="start-new-quiz-button" class="start-new-button">開始新測驗 (將覆蓋舊進度)</button>
                    </div>
                </div>

                <!-- 模式選擇區域 -->
                <!-- DOM 關係：mode-selection-area 是 initial-selection-screen 的子元素 -->
                <div id="mode-selection-area" class="flex flex-col sm:flex-row gap-4 mb-6">
                    <button id="practice-mode-button" class="mode-button selected-mode">練習模式</button>
                    <button id="exam-mode-button" class="mode-button">正式考試</button>
                </div>

                <!-- 科目選擇區域 (預設隱藏) -->
                <!-- DOM 關係：subject-selection-area 是 initial-selection-screen 的子元素 -->
                <div id="subject-selection-area">
                    <div class="subject-selection">
                        <label for="subject-select" class="sr-only">選擇科目</label>
                        <select id="subject-select">
                            <option value="topic1_ai_intro.json">科目一：人工智慧基礎概論</option>
                            <option value="topic2_generative_ai_app_planning.json">科目二：生成式 AI 應用與規劃</option>
                        </select>
                        <button id="start-quiz-button" class="start-quiz-button">開始測驗</button>
                    </div>
                    <div id="question-counts" class="question-counts">
                        <!-- 題目數量將在此顯示 -->
                    </div>
                </div>
                <button id="view-leaderboard-button" class="view-leaderboard-button">查看排行榜</button> <!-- 排行榜按鈕 -->
                <button id="view-history-button" class="view-history-button">查看歷史紀錄</button> <!-- 新增：查看歷史紀錄按鈕 -->
            </div>

            <!-- 測驗內容區塊 (預設隱藏) -->
            <!-- DOM 關係：quiz-content 是 quiz-container > content-wrapper 的子元素 -->
            <div id="quiz-content" style="display: none;">
                <div class="timer-display" id="timer-display">00:00</div> <!-- 計時器顯示區塊 -->
                <div class="subject-title" id="current-subject-title"></div> <!-- 動態顯示科目標題 -->
                <div class="question-number" id="question-number"></div>
                <div class="question-text" id="question-text"></div>
                <!-- DOM 關係：options-container 包含多個 option-button 子元素 -->
                <div class="options-container" id="options-container">
                    <!-- 選項將由 JavaScript 載入 -->
                </div>
                <!-- DOM 關係：feedback-container 包含 feedback-title, feedback-text-content, ask-gemini-button, showReportProblemBtn 子元素 -->
                <div class="feedback-container" id="feedback-container">
                    <div class="feedback-title" id="feedback-title"></div>
                    <div class="feedback-text" id="feedback-text-content"></div>
                    <!-- 將兩個按鈕放在一個 flex 容器中，以便並排顯示和控制間距 -->
                    <div class="flex justify-center items-center mt-4">
                        <button id="ask-gemini-button" class="ask-gemini-button" style="display: none;">✨ 向 Gemini 提問</button>
                        <!-- 新增的「回報問題」按鈕，使用 ml-4 增加左側間距 -->
                        <button id="showReportProblemBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded ml-4">
                            回報問題
                        </button>
                    </div>
                </div>
                <!-- DOM 關係：navigation-buttons 包含 prev-button, next-button, submit-early-button 子元素 -->
                <div class="navigation-buttons">
                    <button id="prev-button" class="nav-button" disabled>上一題</button>
                    <button id="next-button" class="nav-button">下一題</button>
                    <button id="submit-early-button" class="submit-quiz-button">交卷</button> <!-- 新增交卷按鈕 -->
                </div>
            </div>
            <div id="loading-indicator" class="loading-message" style="display: none;">載入題目中，請稍候...</div>
            <!-- 測驗總結區塊 (預設隱藏) -->
            <!-- DOM 關係：quiz-summary 是 quiz-container > content-wrapper 的子元素 -->
            <div class="quiz-summary" id="quiz-summary">
                <div class="summary-title">測驗結果</div>
                <div class="summary-score" id="summary-score"></div>
                <div class="summary-message" id="summary-message"></div>
                <!-- DOM 關係：all-questions-summary 包含多個 question-item 子元素 -->
                <div id="all-questions-summary" class="all-questions-summary text-left"></div> <!-- 新增：所有題目總結區塊 -->
                <button id="restart-button" class="restart-button">重新測驗</button>
                <button id="view-leaderboard-button-summary" class="view-leaderboard-button mt-4">查看排行榜</button> <!-- 測驗結果頁面的排行榜按鈕 -->
                <button id="share-results-button" class="share-results-button mt-4">分享結果</button> <!-- 新增分享結果按鈕 -->
            </div>
        </div>
    </div>

    <!-- Gemini 模態框 -->
    <!-- DOM 關係：gemini-modal-overlay 包含 gemini-modal-content 子元素 -->
    <div id="gemini-modal-overlay" class="gemini-modal-overlay" style="display: none;">
        <!-- DOM 關係：gemini-modal-content 包含 gemini-modal-close, gemini-modal-title, gemini-modal-input-area, gemini-loading-indicator, gemini-response-area 子元素 -->
        <div class="gemini-modal-content">
            <span class="gemini-modal-close" id="gemini-modal-close">&times;</span>
            <div class="gemini-modal-title">向 Gemini 提問</div>
            <div class="gemini-modal-input-area">
                <p class="text-sm text-gray-600 mb-2">請輸入您想針對此題目詢問 Gemini 的問題：</p>
                <textarea id="gemini-question-input" placeholder="例如：這個概念還有哪些應用？或是提供更多相關資訊..."></textarea>
                <div class="gemini-modal-buttons">
                    <button id="gemini-modal-cancel-button" class="gemini-modal-cancel-button">取消</button>
                    <button id="submit-gemini-question-button" class="gemini-modal-submit-button">送出問題</button>
                </div>
            </div>
            <div id="gemini-loading-indicator" class="gemini-modal-loading" style="display: none;">
                載入中... 請稍候 ✨
            </div>
            <div id="gemini-response-area" class="gemini-modal-response" style="display: none;">
                <!-- Gemini 的回應將在此顯示 -->
            </div>
        </div>
    </div>

    <!-- API 金鑰輸入模態框 -->
    <!-- DOM 關係：api-key-modal-overlay 包含 api-key-modal-content 子元素 -->
    <div id="api-key-modal-overlay" class="api-key-modal-overlay" style="display: none;">
        <!-- DOM 關係：api-key-modal-content 包含 api-key-modal-title, api-key-modal-input-area 子元素 -->
        <div class="api-key-modal-content">
            <div class="api-key-modal-title">請輸入您的 Gemini API 金鑰</div>
            <p class="text-sm text-gray-600 mb-4">
                為了在非 Canvas 環境下使用 Gemini 提問功能，請在此輸入您的 Gemini API 金鑰。
                您可以從 <a href="https://g.co/gemini/share/0d8dc04f3cdf" target="_blank" class="text-blue-500 hover:underline">Google AI Studio</a> 獲取。
            </p>
            <div class="api-key-modal-input-area">
                <input type="text" id="gemini-api-key-input" placeholder="您的 Gemini API 金鑰">
                <div class="api-key-modal-buttons">
                    <button id="api-key-modal-cancel-button" class="api-key-modal-cancel-button">取消</button>
                    <button id="submit-api-key-button" class="api-key-modal-submit-button">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 確認模態框 -->
    <!-- DOM 關係：confirmation-modal-overlay 包含 confirmation-modal-content 子元素 -->
    <div id="confirmation-modal-overlay" class="confirmation-modal-overlay" style="display: none;">
        <!-- DOM 關係：confirmation-modal-content 包含 confirmation-modal-title, confirmation-modal-message, confirmation-modal-buttons 子元素 -->
        <div class="confirmation-modal-content">
            <div class="confirmation-modal-title">確認交卷</div>
            <div class="confirmation-modal-message">您確定要提前交卷嗎？交卷後將無法再修改答案。</div>
            <div class="confirmation-modal-buttons">
                <button id="confirm-yes-button" class="confirmation-modal-button confirm-yes">確定交卷</button>
                <button id="confirm-no-button" class="confirmation-modal-button confirm-no">取消</button>
            </div>
        </div>
    </div>

    <!-- 使用者 ID 輸入模態框 -->
    <!-- DOM 關係：user-id-modal-overlay 包含 user-id-modal-content 子元素 -->
    <div id="user-id-modal-overlay" class="api-key-modal-overlay" style="display: none;">
        <!-- DOM 關係：user-id-modal-content 包含 user-id-modal-title, user-id-modal-input-area 子元素 -->
        <div id="user-id-modal-content" class="api-key-modal-content">
            <div id="user-id-modal-title" class="api-key-modal-title">請輸入您的使用者暱稱</div>
            <p class="text-sm text-gray-600 mb-4">
                這個暱稱將用於識別您的測驗進度。您可以輸入任何您喜歡的名稱。
            </p>
            <div id="user-id-modal-input-area" class="api-key-modal-input-area">
                <input type="text" id="user-id-input" placeholder="您的使用者暱稱">
                <div id="user-id-modal-buttons" class="api-key-modal-buttons">
                    <button id="cancel-user-id-button" class="api-key-modal-cancel-button">取消</button>
                    <button id="submit-user-id-button" class="api-key-modal-submit-button">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 排行榜模態框 -->
    <!-- DOM 關係：leaderboard-modal-overlay 包含 leaderboard-modal-content 子元素 -->
    <div id="leaderboard-modal-overlay" class="leaderboard-modal-overlay" style="display: none;">
        <!-- DOM 關係：leaderboard-modal-content 包含 leaderboard-modal-close, leaderboard-title, leaderboard-list 子元素 -->
        <div id="leaderboard-modal-content" class="leaderboard-modal-content">
            <span class="gemini-modal-close" id="leaderboard-modal-close">&times;</span>
            <div id="leaderboard-title" class="leaderboard-title">排行榜</div>
            <!-- DOM 關係：leaderboard-list 包含多個 li 子元素 (由 JS 動態生成) -->
            <ul id="leaderboard-list">
                <!-- 排行榜條目將在此載入 -->
            </ul>
        </div>
    </div>

    <!-- 測驗歷史紀錄模態框 (新增) -->
    <!-- DOM 關係：quiz-history-modal-overlay 包含 quiz-history-modal-content 子元素 -->
    <div id="quiz-history-modal-overlay" class="leaderboard-modal-overlay fixed inset-0 bg-black bg-opacity-50 z-50" style="display: none;">
        <!-- DOM 關係：quiz-history-modal-content 包含 quiz-history-modal-close, quiz-history-title, quiz-history-list, view-incorrect-stats-button 子元素 -->
        <div id="quiz-history-modal-content" class="leaderboard-modal-content">
            <span class="gemini-modal-close" id="quiz-history-modal-close">&times;</span>
            <div id="quiz-history-title" class="leaderboard-title">測驗歷史紀錄</div>
            <!-- DOM 關係：quiz-history-list 包含多個 li 子元素 (由 JS 動態生成) -->
            <ul id="quiz-history-list" class="leaderboard-list">
                <!-- 歷史紀錄條目將在此載入 -->
            </ul>
            <button id="view-incorrect-stats-button" class="view-leaderboard-button mt-4">查看錯題統計</button>
        </div>
    </div>

    <!-- 歷史紀錄詳情/錯題統計模態框 (新增，共用 Gemini modal 的樣式) -->
    <!-- DOM 關係：quiz-history-detail-modal-overlay 包含 gemini-modal-content 子元素 -->
    <div id="quiz-history-detail-modal-overlay" class="gemini-modal-overlay" style="display: none;">
        <!-- DOM 關係：gemini-modal-content 包含 quiz-history-detail-modal-close, quiz-history-detail-title, quiz-history-detail-content 子元素 -->
        <div class="gemini-modal-content">
            <span class="gemini-modal-close" id="quiz-history-detail-modal-close">&times;</span>
            <div class="gemini-modal-title" id="quiz-history-detail-title">測驗詳情</div>
            <div id="quiz-history-detail-content" class="gemini-modal-response" style="display: block; max-height: 500px; overflow-y: auto;">
                <!-- 測驗詳情或錯題統計將在此載入 -->
            </div>
        </div>
    </div>

    <!-- 新增：回報問題模態框疊加層 (獨立於其他模態框) -->
    <!-- DOM 關係：reportProblemModalOverlay 包含 reportProblemBox 子元素 -->
    <div id="reportProblemModalOverlay" class="report-problem-modal-overlay" style="display: none;">
        <!-- DOM 關係：reportProblemBox 包含 reportProblemModalClose, h3, p, report-options-container, input[type="hidden"], reportProblemSuccessMessage, submitProblemBtn, closeReportBoxBtn 子元素 -->
        <div id="reportProblemBox" class="report-problem-modal-content">
            <span class="gemini-modal-close" id="reportProblemModalClose">&times;</span> <!-- 關閉按鈕 -->
            <h3 class="text-lg font-semibold mb-3">回報問題</h3>
            <!-- 新增：顯示當前問題編號和文本 -->
            <p class="text-gray-700 text-sm mb-4">
                您正在回報的問題：<span id="reportedQuestionNumber"></span>. <span id="reportedQuestionText" class="font-medium"></span>
            </p>
            <!-- 替換 textarea 為 radio 選項 -->
            <!-- DOM 關係：report-options-container 包含多個 report-option-item 子元素 -->
            <div class="report-options-container">
                <div class="report-option-item">
                    <input type="radio" id="reportType1" name="reportType" value="題目有誤" class="form-radio text-blue-600">
                    <label for="reportType1">題目有誤</label>
                </div>
                <div class="report-option-item">
                    <input type="radio" id="reportType2" name="reportType" value="選項有誤" class="form-radio text-blue-600">
                    <label for="reportType2">選項有誤</label>
                </div>
                <div class="report-option-item">
                    <input type="radio" id="reportType3" name="reportType" value="正確答案應為A" class="form-radio text-blue-600">
                    <label for="reportType3">正確答案應為A</label>
                </div>
                <div class="report-option-item">
                    <input type="radio" id="reportType4" name="reportType" value="正確答案應為B" class="form-radio text-blue-600">
                    <label for="reportType4">正確答案應為B</label>
                </div>
                <div class="report-option-item">
                    <input type="radio" id="reportType5" name="reportType" value="正確答案應為C" class="form-radio text-blue-600">
                    <label for="reportType5">正確答案應為C</label>
                </div>
                <div class="report-option-item">
                    <input type="radio" id="reportType6" name="reportType" value="正確答案應為D" class="form-radio text-blue-600">
                    <label for="reportType6">正確答案應為D</label>
                </div>
                <div class="report-option-item">
                    <input type="radio" id="reportType7" name="reportType" value="沒有正確答案" class="form-radio text-blue-600">
                    <label for="reportType7">沒有正確答案</label>
                </div>
                <div class="report-option-item">
                    <input type="radio" id="reportType8" name="reportType" value="解釋有誤" class="form-radio text-blue-600">
                    <label for="reportType8">解釋有誤</label>
                </div>
                <div class="report-option-item">
                    <input type="radio" id="reportType9" name="reportType" value="其他問題" class="form-radio text-blue-600">
                    <label for="reportType9">其他問題</label>
                </div>
            </div>
            <!-- 隱藏的輸入框，用於儲存當前問題的索引 -->
            <input type="hidden" id="reportedQuestionIndex">
            <input type="hidden" id="reportedQuestionOriginalText">

            <div id="reportProblemSuccessMessage" style="display: none;">您的問題已成功回報！感謝您的協助。</div> <!-- 新增的成功訊息區塊 -->
            <button id="submitProblemBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-3">
                提交問題回報
            </button>
            <button id="closeReportBoxBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded mt-3 ml-2">
                取消
            </button>
        </div>
    </div>

    <!-- 全域載入覆蓋層 -->
    <div id="global-loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <div>載入中...</div>
    </div>

    <script type="module">
        // 導入 Firebase SDK 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, getDoc, getDocs, serverTimestamp, query, orderBy, limit, addDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js"; 

        // Firebase 相關變數和初始化
        let app; // Firebase 應用實例
        let db; // Firestore 資料庫實例
        let auth; // Firebase 認證實例
        let currentEnvironment = ''; // 當前執行環境 ('canvas' 或 'github-pages')
        let effectiveAppId = ''; // 實際使用的應用程式 ID (來自 Canvas 或預設配置)
        let currentUserId = ''; // 當前登入使用者的 Firebase UID
        let currentUserDisplayName = ''; // 使用者自定義的顯示名稱
        let isAuthReady = false; // 標誌，指示 Firebase 認證是否已準備就緒

        // Firebase 專案配置 (請確保這是您的實際配置)
        // 在 Canvas 環境中，將優先使用 __firebase_config
        const defaultFirebaseConfig = {
          apiKey: "***REMOVED***",
          authDomain: "ipas-ai-planner-exam.firebaseapp.com",
          projectId: "ipas-ai-planner-exam",
          storageBucket: "ipas-ai-planner-exam.firebasestorage.app",
          appId: "1:1018339017757:web:934bf9c05ea898fdd972f4", // <-- 在此設定預設 appId
          measurementId: "G-5WWRYNKFJ6"
        };

        // 測驗應用程式相關變數
        let fullQuizData = []; // 儲存從 JSON 載入的所有題目
        let selectedQuizData = []; // 儲存隨機選取的 50 道題目
        let currentQuestionIndex = 0; // 當前題目索引
        let userAnswers = []; // 儲存使用者的答案 (每個題目一個物件)
        let score = 0; // 儲存答對的題目數量
        let incorrectQuestions = []; // 儲存答錯的題目 (用於內部追蹤，目前未直接在總結中使用)
        const optionLabels = ['A', 'B', 'C', 'D']; // 選項標籤 (A, B, C, D)
        let loadedProgressData = null; // 儲存從 Firestore 載入的進度資料
        const POINTS_PER_QUESTION = 2; // 每題分數
        let quizMode = 'practice'; // 新增：測驗模式，預設為 'practice' (練習模式)

        // 獲取 DOM 元素
        // DOM 關係：這些元素是 HTML 結構中的直接子元素或其深層子元素
        const environmentSelectionScreen = document.getElementById('environment-selection-screen'); // 環境選擇畫面
        const selectCanvasEnvButton = document.getElementById('select-canvas-env'); // Canvas 環境按鈕
        const selectGithubEnvButton = document.getElementById('select-github-env'); // GitHub Pages 環境按鈕

        const initialSelectionScreen = document.getElementById('initial-selection-screen'); // 初始科目選擇畫面
        const subjectSelectionArea = document.getElementById('subject-selection-area'); // 科目選擇區域
        const continueQuizPrompt = document.getElementById('continue-quiz-prompt'); // 繼續測驗提示區塊
        const continueQuizMessage = document.getElementById('continue-quiz-message'); // 繼續測驗提示訊息
        const continueQuizButton = document.getElementById('continue-quiz-button'); // 繼續測驗按鈕
        const startNewQuizButton = document.getElementById('start-new-quiz-button'); // 開始新測驗按鈕

        const modeSelectionArea = document.getElementById('mode-selection-area'); // 新增：模式選擇區域
        const practiceModeButton = document.getElementById('practice-mode-button'); // 新增：練習模式按鈕
        const examModeButton = document.getElementById('exam-mode-button'); // 新增：正式考試按鈕

        const subjectSelect = document.getElementById('subject-select'); // 科目選擇下拉選單
        const startQuizButton = document.getElementById('start-quiz-button'); // 開始測驗按鈕
        const currentSubjectTitle = document.getElementById('current-subject-title'); // 當前科目標題顯示區
        const questionNumberElement = document.getElementById('question-number'); // 問題編號顯示區
        const questionTextElement = document.getElementById('question-text'); // 問題文本顯示區
        const optionsContainer = document.getElementById('options-container'); // 選項容器
        const feedbackContainer = document.getElementById('feedback-container'); // 回饋訊息容器
        const feedbackTitleElement = document.getElementById('feedback-title'); // 回饋標題
        const feedbackTextContentElement = document.getElementById('feedback-text-content'); // 回饋文本內容
        const prevButton = document.getElementById('prev-button'); // 上一題按鈕
        const nextButton = document.getElementById('next-button'); // 下一題按鈕
        const submitEarlyButton = document.getElementById('submit-early-button'); // 提前交卷按鈕
        const quizContent = document.getElementById('quiz-content'); // 測驗內容區塊
        const quizSummary = document.getElementById('quiz-summary'); // 測驗總結區塊
        const summaryScoreElement = document.getElementById('summary-score'); // 總結分數顯示區
        const summaryMessageElement = document.getElementById('summary-message'); // 總結訊息顯示區
        const allQuestionsSummaryElement = document.getElementById('all-questions-summary'); // 所有題目總結區塊
        const restartButton = document.getElementById('restart-button'); // 重新測驗按鈕
        const loadingIndicator = document.getElementById('loading-indicator'); // 載入指示器
        const questionCountsElement = document.getElementById('question-counts'); // 題目數量顯示區
        const userCountDisplay = document.getElementById('user-count-display'); // 用戶計數顯示區
        const lastUpdatedDisplay = document.getElementById('last-updated-display'); // 環境選擇畫面的最後更新時間顯示區

        // Gemini API 相關 DOM 元素
        const askGeminiButton = document.getElementById('ask-gemini-button'); // 詢問 Gemini 按鈕
        const geminiModalOverlay = document.getElementById('gemini-modal-overlay'); // Gemini 模態框疊加層
        const geminiModalClose = document.getElementById('gemini-modal-close'); // Gemini 模態框關閉按鈕
        const geminiQuestionInput = document.getElementById('gemini-question-input'); // Gemini 問題輸入框
        const submitGeminiQuestionButton = document.getElementById('submit-gemini-question-button'); // 提交 Gemini 問題按鈕
        const geminiModalCancelButton = document.getElementById('gemini-modal-cancel-button'); // Gemini 模態框取消按鈕
        const geminiLoadingIndicator = document.getElementById('gemini-loading-indicator'); // Gemini 載入指示器
        const geminiResponseArea = document.getElementById('gemini-response-area'); // Gemini 回應顯示區

        // API 金鑰輸入模態框相關 DOM 元素
        const apiKeyModalOverlay = document.getElementById('api-key-modal-overlay'); // API 金鑰模態框疊加層
        const geminiApiKeyInput = document.getElementById('gemini-api-key-input'); // Gemini API 金鑰輸入框
        const submitApiKeyButton = document.getElementById('submit-api-key-button'); // 提交 API 金鑰按鈕
        const apiKeyModalCancelButton = document.getElementById('api-key-modal-cancel-button'); // API 金鑰模態框取消按鈕

        // 確認模態框相關 DOM 元素
        const confirmationModalOverlay = document.getElementById('confirmation-modal-overlay'); // 確認模態框疊加層
        const confirmYesButton = document.getElementById('confirm-yes-button'); // 確認按鈕 (是)
        const confirmNoButton = document.getElementById('confirm-no-button'); // 確認按鈕 (否)

        // 使用者 ID 輸入模態框相關 DOM 元素
        const userIdModalOverlay = document.getElementById('user-id-modal-overlay'); // 使用者 ID 輸入模態框疊加層
        const userIdInput = document.getElementById('user-id-input'); // 使用者 ID 輸入框
        const submitUserIdButton = document.getElementById('submit-user-id-button'); // 提交使用者 ID 按鈕
        const cancelUserIdButton = document.getElementById('cancel-user-id-button'); // 取消使用者 ID 按鈕

        // 排行榜相關 DOM 元素
        const viewLeaderboardButton = document.getElementById('view-leaderboard-button'); // 查看排行榜按鈕 (初始畫面)
        const viewLeaderboardButtonSummary = document.getElementById('view-leaderboard-button-summary'); // 查看排行榜按鈕 (總結畫面)
        const leaderboardModalOverlay = document.getElementById('leaderboard-modal-overlay'); // 排行榜模態框疊加層
        const leaderboardModalClose = document.getElementById('leaderboard-modal-close'); // 排行榜模態框關閉按鈕
        const leaderboardList = document.getElementById('leaderboard-list'); // 排行榜列表

        // 新增：歷史紀錄相關 DOM 元素
        const viewHistoryButton = document.getElementById('view-history-button'); // 查看歷史紀錄按鈕
        const quizHistoryModalOverlay = document.getElementById('quiz-history-modal-overlay'); // 測驗歷史紀錄模態框疊加層
        const quizHistoryModalClose = document.getElementById('quiz-history-modal-close'); // 測驗歷史紀錄模態框關閉按鈕
        const quizHistoryList = document.getElementById('quiz-history-list'); // 測驗歷史紀錄列表
        const quizHistoryDetailModalOverlay = document.getElementById('quiz-history-detail-modal-overlay'); // 測驗歷史紀錄詳情模態框疊加層
        const quizHistoryDetailModalClose = document.getElementById('quiz-history-detail-modal-close'); // 測驗歷史紀錄詳情模態框關閉按鈕
        const quizHistoryDetailTitle = document.getElementById('quiz-history-detail-title'); // 測驗歷史紀錄詳情標題
        const quizHistoryDetailContent = document.getElementById('quiz-history-detail-content'); // 測驗歷史紀錄詳情內容
        const viewIncorrectStatsButton = document.getElementById('view-incorrect-stats-button'); // 查看錯題統計按鈕

        // 分享結果按鈕 DOM 元素
        const shareResultsButton = document.getElementById('share-results-button'); // 分享結果按鈕

        // 全域載入覆蓋層 DOM 元素
        const globalLoadingOverlay = document.getElementById('global-loading-overlay'); // 全域載入覆蓋層

        // 全域變數，用於儲存 Gemini API 金鑰
        let geminiApiKey = ""; 

        // 計時器變數
        const quizDurationInSeconds = 75 * 60; // 測驗時長：75 分鐘
        let timeRemaining = quizDurationInSeconds; // 剩餘時間
        let timerInterval; // 計時器間隔 ID
        const timerDisplay = document.getElementById('timer-display'); // 計時器顯示元素
        let quizStartTime = 0; // 測驗正式開始 (或恢復) 的時間戳
        let lastActiveTime = 0; // 計時器最後活躍 (頁面可見) 的時間戳

        // 科目名稱映射表
        const subjectNames = {
            'topic1_ai_intro.json': '科目一：人工智慧基礎概論',
            'topic2_generative_ai_app_planning.json': '科目二：生成式 AI 應用與規劃'
        };

        // 新增：回報問題相關 DOM 元素
        const showReportProblemBtn = document.getElementById('showReportProblemBtn'); // 顯示回報問題按鈕
        const reportProblemModalOverlay = document.getElementById('reportProblemModalOverlay'); // 回報問題模態框疊加層
        const reportProblemModalClose = document.getElementById('reportProblemModalClose'); // 回報問題模態框關閉按鈕 (右上角 X)
        const submitProblemBtn = document.getElementById('submitProblemBtn'); // 提交問題回報按鈕
        const closeReportBoxBtn = document.getElementById('closeReportBoxBtn'); // 取消回報按鈕
        const reportProblemSuccessMessage = document.getElementById('reportProblemSuccessMessage'); // 回報成功訊息元素
        
        // 新增：回報問題選項相關 DOM 元素 (用於顯示當前問題資訊和儲存隱藏值)
        const reportedQuestionNumber = document.getElementById('reportedQuestionNumber'); // 顯示被回報的問題編號
        const reportedQuestionText = document.getElementById('reportedQuestionText'); // 顯示被回報的問題文本
        const reportedQuestionIndex = document.getElementById('reportedQuestionIndex'); // 隱藏的輸入框，儲存問題索引
        const reportedQuestionOriginalText = document.getElementById('reportedQuestionOriginalText'); // 隱藏的輸入框，儲存問題原始文本


        /**
         * 顯示全域載入覆蓋層。
         * 呼叫者：DOMContentLoaded 事件監聽器, initializeFirebaseServices, handleUserAuthenticationAndDataLoad, proceedAfterUserIdSet, fetchLeaderboardScores, fetchAndDisplayQuizHistory, displayDetailedQuizAttempt, generateAndDisplayIncorrectQuestionStats
         */
        function showGlobalLoading() {
            globalLoadingOverlay.style.display = 'flex';
        }

        /**
         * 隱藏全域載入覆蓋層。
         * 呼叫者：DOMContentLoaded 事件監聽器, initializeFirebaseServices, handleUserAuthenticationAndDataLoad, proceedAfterUserIdSet, fetchLeaderboardScores, fetchAndDisplayQuizHistory, displayDetailedQuizAttempt, generateAndDisplayIncorrectQuestionStats
         */
        function hideGlobalLoading() {
            globalLoadingOverlay.style.display = 'none';
        }

        /**
         * Fisher-Yates 洗牌演算法，用於隨機打亂陣列。
         * 呼叫者：initializeQuizData
         * @param {Array} array - 要打亂的陣列。
         * @returns {Array} - 打亂後的陣列。
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                // 使用陣列解構賦值來交換元素
                [array[i], array[j]] = [array[j], array[i]]; 
            }
            return array;
        }

        /**
         * 遞迴地從物件或陣列中移除所有 undefined 值。
         * Firestore 不支援 undefined 值，此函式用於清理資料以符合 Firestore 要求。
         * 呼叫者：saveQuizProgress, saveQuizHistory
         * @param {any} obj - 要清理的物件或值。
         * @returns {any} - 清理後的物件或值，已移除 undefined 值。
         */
        function removeUndefined(obj) {
            if (obj === null || typeof obj !== 'object') {
                return obj;
            }

            if (Array.isArray(obj)) {
                // 遞迴處理陣列中的每個元素並過濾掉 undefined 的結果
                return obj.map(item => removeUndefined(item)).filter(item => item !== undefined);
            }

            const newObj = {};
            for (const key in obj) {
                // 確保只處理物件自身的屬性，而非原型鏈上的屬性
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    const value = obj[key];
                    if (value !== undefined) {
                        // 遞迴處理巢狀物件
                        newObj[key] = removeUndefined(value);
                    }
                }
            }
            return newObj;
        }

        /**
         * 追蹤用戶訪問，在 Firestore 中記錄每個獨立訪客的資訊。
         * 儲存路徑：/artifacts/{appId}/public/data/user_visits/{userId}
         * 呼叫者：handleUserAuthenticationAndDataLoad (透過 proceedAfterUserIdSet)
         * @param {string} appIdToUse - 當前的應用程式 ID。
         */
        async function trackUserVisit(appIdToUse) {
            if (!isAuthReady || !db || !currentUserId || !appIdToUse) {
                console.warn("trackUserVisit: Firebase 認證未準備就緒或參數缺失。跳過用戶訪問追蹤。");
                return;
            }
            const userId = currentUserId; // 使用全域設定的 Firebase UID
            if (!userId) {
                console.error("Failed to track user visit: User ID not available.");
                return;
            }

            // 添加短暫延遲以確保 Firestore 資料同步 (用於診斷)
            await new Promise(resolve => setTimeout(resolve, 500)); 

            // 建構 Firestore 文件參考路徑：/artifacts/{appId}/public/data/user_visits/{userId}
            const userDocRef = doc(collection(db, 'artifacts', appIdToUse, 'public', 'data', 'user_visits'), userId); 
            console.log("Firestore document path for write:", userDocRef.path);
            console.log("Attempting Firestore operation with UID:", userId);

            try {
                const docSnap = await getDoc(userDocRef); 
                if (!docSnap.exists()) { // 如果文件不存在，表示是新訪客
                    // 記錄新訪客資訊
                    await setDoc(userDocRef, { 
                        firstVisit: serverTimestamp(), // 首次訪問時間戳
                        lastVisit: serverTimestamp(),  // 最後訪問時間戳
                        userId: userId,                // Firebase UID
                        displayName: currentUserDisplayName || '匿名用戶' // 用戶顯示名稱或預設值
                    });
                    console.log(`New user visit recorded successfully: ${userId}`); 
                } else {
                    // 如果文件已存在，更新最後訪問時間戳和顯示名稱
                    await setDoc(userDocRef, { 
                        lastVisit: serverTimestamp(),
                        displayName: currentUserDisplayName || '匿名用戶'
                    }, { merge: true }); // 使用 merge: true 以避免覆蓋其他欄位
                    console.log(`User already recorded, updated last visit time: ${userId}`);
                }
            } catch (error) {
                console.error("Failed to track user visit:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤：Firebase 權限被拒絕。請檢查您的 Firestore 安全規則，確保匿名用戶可以在路徑 `/artifacts/{appId}/public/data/user_visits/{userId}` 上讀寫。");
                }
            }
        }

        /**
         * 從 Firestore 獲取並顯示獨立訪客計數。
         * 呼叫者：handleUserAuthenticationAndDataLoad (透過 proceedAfterUserIdSet)
         */
        async function getAndDisplayUserCount() {
            userCountDisplay.textContent = '正在載入訪問人數...';
            console.log("getAndDisplayUserCount: Starting to load visitor count...");
            console.log("getAndDisplayUserCount: db instance:", db);
            console.log("getAndDisplayUserCount: effectiveAppId:", effectiveAppId);

            // 添加短暫延遲以確保 Firebase 完全初始化並連接
            await new Promise(resolve => setTimeout(resolve, 500)); 

            if (!isAuthReady || !db || !effectiveAppId) {
                console.warn("getAndDisplayUserCount: Firebase 認證未準備就緒，Firestore 未初始化或應用程式 ID 無效，無法獲取訪客計數。db:", db, "effectiveAppId:", effectiveAppId);
                userCountDisplay.textContent = '無法載入訪問人數 (初始化中/錯誤)。請檢查控制台錯誤訊息。';
                return;
            }

            try {
                // 引用 user_visits 集合
                const userVisitsCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'user_visits');
                console.log("getAndDisplayUserCount: Attempting to read user_visits collection from Firestore...");
                const querySnapshot = await getDocs(userVisitsCollectionRef);
                const userCount = querySnapshot.size; // 文件數量即為獨立訪客計數

                userCountDisplay.textContent = `總訪問人數 (獨立訪客)：${userCount} 人`;
                console.log(`getAndDisplayUserCount: Successfully fetched visitor count: ${userCount} people`);
            } catch (error) {
                console.error("getAndDisplayUserCount: Failed to fetch visitor count:", error);
                userCountDisplay.textContent = '無法載入訪問人數 (錯誤)。請檢查控制台錯誤訊息。';
                if (error.code === 'permission-denied') {
                    console.error("錯誤：Firebase 權限被拒絕。請檢查您的 Firestore 安全規則，確保對 `/artifacts/{appId}/public/data/user_visits` 的讀取權限。");
                }
            }
        }

        /**
         * 從 Firestore 載入指定科目的測驗進度。
         * 儲存路徑：/artifacts/{appId}/users/{userId}/quiz_progress/{subjectId}
         * 呼叫者：checkAndDisplaySavedProgress, document.addEventListener('visibilitychange')
         * @param {string} subjectId - 科目 ID。
         * @returns {Promise<Object|null>} - 測驗進度資料或 null。
         */
        async function loadQuizProgress(subjectId) {
            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("loadQuizProgress: Firebase 認證未準備就緒或參數缺失。無法載入進度。");
                return null;
            }

            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);
            console.log(`loadQuizProgress: Attempting to load progress for subject: ${subjectId}, user: ${currentUserId}`);

            try {
                const docSnap = await getDoc(progressDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log(`loadQuizProgress: Quiz progress loaded for ${subjectId}:`, data);
                    return data;
                } else {
                    console.log(`loadQuizProgress: No quiz progress found for subject: ${subjectId}`);
                    return null;
                }
            } catch (error) {
                console.error("loadQuizProgress: Failed to load quiz progress:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤：Firebase 權限被拒絕。請檢查您的 Firestore 安全規則，確保匿名用戶可以在路徑 `/artifacts/{appId}/users/{userId}/quiz_progress/{subjectId}` 上讀取。");
                }
                return null;
            }
        }

        /**
         * 檢查並顯示是否有儲存的測驗進度。
         * 呼叫者：handleUserAuthenticationAndDataLoad (透過 proceedAfterUserIdSet)
         */
        async function checkAndDisplaySavedProgress() {
            if (!isAuthReady || !currentUserId) {
                console.log("checkAndDisplaySavedProgress: 用戶 ID 或 Firebase 認證未準備就緒，無法檢查進度。");
                return;
            }

            const defaultSubject = subjectSelect.value;
            // 呼叫 loadQuizProgress 載入進度
            loadedProgressData = await loadQuizProgress(defaultSubject);

            if (loadedProgressData && loadedProgressData.selectedQuizData && loadedProgressData.selectedQuizData.length > 0) {
                continueQuizMessage.textContent = `您有未完成的「${subjectNames[defaultSubject]}」測驗進度 (暱稱: ${currentUserDisplayName || '匿名用戶'})。`;
                continueQuizPrompt.style.display = 'flex'; // 顯示繼續測驗提示
                subjectSelectionArea.style.display = 'none'; // 隱藏科目選擇區域
                modeSelectionArea.style.display = 'none'; // 隱藏模式選擇區域
                console.log("checkAndDisplaySavedProgress: 找到已儲存的進度。");
            } else {
                continueQuizPrompt.style.display = 'none'; // 隱藏繼續測驗提示
                subjectSelectionArea.style.display = 'block'; // 顯示科目選擇區域
                modeSelectionArea.style.display = 'flex'; // 顯示模式選擇區域
                // 呼叫 getQuestionCounts 顯示題目數量
                getQuestionCounts(); // 顯示題目數量
                console.log("checkAndDisplaySavedProgress: 未找到已儲存的進度或進度為空。");
            }
        }

        /**
         * 獲取題目的唯一識別符。
         * 建議：如果您的 JSON 題目資料有 'id' 欄位，優先使用它。
         * 否則，使用 'question' 文本作為識別符。
         * 呼叫者：initializeQuizData
         * @param {Object} question - 題目物件。
         * @returns {string} - 題目的唯一識別符。
         */
        function getQuestionIdentifier(question) {
            // 優先使用題目中的 'id' 欄位 (如果存在)
            if (question.id) {
                return question.id;
            }
            // 否則，使用題目文本作為識別符
            return question.question;
        }

        /**
         * 初始化測驗資料：從完整題目集中隨機選取 50 道題目，
         * 優先選取未曾作答過的題目。
         * 呼叫者：loadFullQuizData
         */
        function initializeQuizData() {
            const currentSubjectId = subjectSelect.value;
            const playedQuestionIdsKey = `played_questions_${currentSubjectId}`;
            const playedQuestionIds = new Set(JSON.parse(localStorage.getItem(playedQuestionIdsKey) || '[]'));

            let newQuestions = []; // 新題目 (未作答過)
            let recycledQuestions = []; // 已作答過的題目

            // 將題目分為「新題目」和「已作答過的題目」
            fullQuizData.forEach(question => {
                // 呼叫 getQuestionIdentifier 獲取題目 ID
                const questionId = getQuestionIdentifier(question);
                if (playedQuestionIds.has(questionId)) {
                    recycledQuestions.push(question);
                } else {
                    newQuestions.push(question);
                }
            });

            // 呼叫 shuffleArray 打亂題目
            shuffleArray(newQuestions);
            shuffleArray(recycledQuestions);

            selectedQuizData = []; // 清空已選題目
            const desiredQuizLength = 50; // 期望的測驗題目數量

            // 優先從新題目中選取
            for (let i = 0; i < newQuestions.length && selectedQuizData.length < desiredQuizLength; i++) {
                selectedQuizData.push(newQuestions[i]);
            }

            // 如果新題目不足，從已作答過的題目中補充
            for (let i = 0; i < recycledQuestions.length && selectedQuizData.length < desiredQuizLength; i++) {
                selectedQuizData.push(recycledQuestions[i]);
            }

            // 如果最終選取的題目數量少於 desiredQuizLength，則從 fullQuizData 中隨機補充
            // 這主要用於總題目數量少於 desiredQuizLength 的情況
            if (selectedQuizData.length < desiredQuizLength && fullQuizData.length > 0) {
                const missingCount = desiredQuizLength - selectedQuizData.length;
                // 呼叫 shuffleArray 重新打亂所有題目
                const remainingQuestions = shuffleArray([...fullQuizData]); // 重新打亂所有題目
                const currentSelectedIds = new Set(selectedQuizData.map(q => getQuestionIdentifier(q)));

                for (let i = 0; i < remainingQuestions.length && selectedQuizData.length < desiredQuizLength; i++) {
                    const question = remainingQuestions[i];
                    // 呼叫 getQuestionIdentifier 獲取題目 ID
                    const questionId = getQuestionIdentifier(question);
                    if (!currentSelectedIds.has(questionId)) {
                        selectedQuizData.push(question);
                        currentSelectedIds.add(questionId); // 更新已選 ID 集合
                    }
                }
            }

            // 最後，更新 localStorage 中的 playedQuestionIds
            const currentQuizQuestionIds = selectedQuizData.map(q => getQuestionIdentifier(q));
            localStorage.setItem(playedQuestionIdsKey, JSON.stringify(currentQuizQuestionIds));

            console.log(`initializeQuizData: 為科目 ${currentSubjectId} 選取了 ${selectedQuizData.length} 道題目。包括 ${newQuestions.length} 道新題目和 ${recycledQuestions.length} 道已作答過的題目。`);
        }


        /**
         * 載入並顯示當前題目及其選項。
         * 呼叫者：loadFullQuizData, nextButton.addEventListener, prevButton.addEventListener, document.addEventListener('visibilitychange')
         */
        function loadQuestion() {
            if (selectedQuizData.length === 0) {
                questionTextElement.textContent = '無法載入題目。請檢查 JSON 檔案。';
                optionsContainer.innerHTML = '';
                prevButton.disabled = true;
                nextButton.disabled = true;
                submitEarlyButton.disabled = true;
                console.error("loadQuestion: selectedQuizData 為空。");
                return;
            }

            const questionData = selectedQuizData[currentQuestionIndex]; // 獲取當前題目資料
            currentSubjectTitle.textContent = subjectNames[subjectSelect.value]; // 確保顯示當前科目名稱
            questionNumberElement.textContent = `問題 ${currentQuestionIndex + 1} / ${selectedQuizData.length}`; // 顯示問題編號
            questionTextElement.textContent = questionData.question; // 顯示問題文本
            optionsContainer.innerHTML = ''; // 清空選項

            // 將選項內容與其原始標籤配對，以便在打亂後仍能追蹤正確答案
            const optionsWithOriginalLabels = questionData.options.map((optionContent, index) => ({
                content: optionContent,
                originalLabel: optionLabels[index]
            }));

            // 呼叫 shuffleArray 打亂選項
            const shuffledOptions = shuffleArray(optionsWithOriginalLabels);

            shuffledOptions.forEach((optionItem, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                // 顯示新的選項標籤 (A, B, C, D) 和選項內容
                button.innerHTML = `<span class="option-label">${optionLabels[index]}</span> ${optionItem.content}`;
                // 儲存此選項內容的原始標籤，用於檢查答案正確性
                button.dataset.originalLabelForContent = optionItem.originalLabel;
                // 儲存實際內容，用於在回饋中顯示
                button.dataset.optionContent = optionItem.content; 

                // 為按鈕添加點擊事件監聽器
                // 點擊選項按鈕時，呼叫 selectOption 函式
                button.addEventListener('click', () => selectOption(button, optionItem.originalLabel));
                // DOM 關係：每個 button 元素是 optionsContainer 的子元素
                optionsContainer.appendChild(button);
            });

            // 如果用戶之前已作答此題目，則顯示其選擇和回饋
            if (userAnswers[currentQuestionIndex]) {
                const selectedOriginalLabel = userAnswers[currentQuestionIndex].selectedOriginalLabel;
                const correctOptionLabel = selectedQuizData[currentQuestionIndex].answer;

                const buttons = optionsContainer.querySelectorAll('.option-button');
                buttons.forEach(button => {
                    button.classList.add('disabled'); // 禁用所有選項
                    if (button.dataset.originalLabelForContent === selectedOriginalLabel) {
                        button.classList.add('selected');
                        // 在練習模式下，立即顯示正確/錯誤
                        if (quizMode === 'practice') {
                            if (selectedOriginalLabel === correctOptionLabel) {
                                button.classList.add('correct');
                            } else {
                                button.classList.add('incorrect');
                            }
                        }
                    }
                    // 在練習模式下，標記正確答案
                    if (quizMode === 'practice' && button.dataset.originalLabelForContent === correctOptionLabel) {
                        button.classList.add('correct');
                    }
                });
                // 僅在練習模式下顯示回饋和 Gemini 按鈕
                if (quizMode === 'practice') {
                    // 呼叫 showFeedback 顯示回饋
                    showFeedback(selectedQuizData[currentQuestionIndex].explanation, userAnswers[currentQuestionIndex].isCorrect);
                    askGeminiButton.style.display = 'inline-block'; // 顯示 Gemini 按鈕
                } else {
                    // 呼叫 hideFeedback 隱藏回饋
                    hideFeedback();
                    askGeminiButton.style.display = 'none'; // 在考試模式下隱藏 Gemini 按鈕
                }
            } else {
                // 呼叫 hideFeedback 隱藏回饋
                hideFeedback();
                askGeminiButton.style.display = 'none'; // 隱藏 Gemini 按鈕
            }

            // 清空 Gemini 模態框內容
            geminiQuestionInput.value = '';
            geminiResponseArea.innerHTML = '';
            geminiResponseArea.style.display = 'none';
            geminiLoadingIndicator.style.display = 'none';

            // 呼叫 updateNavigationButtons 更新導航按鈕狀態
            updateNavigationButtons(); // 更新導航按鈕狀態
            console.log(`loadQuestion: 載入問題 ${currentQuestionIndex + 1}。當前分數: ${score}, 用戶答案數量: ${userAnswers.length}, 錯題數量: ${incorrectQuestions.length}, 模式: ${quizMode}`);
        }

        /**
         * 處理用戶選擇選項的邏輯。
         * 呼叫者：loadQuestion (透過選項按鈕的點擊事件監聽器)
         * @param {HTMLElement} selectedButton - 用戶點擊的選項按鈕元素。
         * @param {string} selectedOriginalLabel - 選定選項的原始標籤 (A, B, C, D)。
         */
        async function selectOption(selectedButton, selectedOriginalLabel) {
            // 如果該題目已作答，則不允許重新選擇
            if (userAnswers[currentQuestionIndex]) {
                console.log(`selectOption: 問題 ${currentQuestionIndex + 1} 已作答。跳過。`);
                return;
            }

            const buttons = optionsContainer.querySelectorAll('.option-button');
            buttons.forEach(button => {
                button.classList.remove('selected');
                button.classList.add('disabled'); // 禁用所有選項
            });

            selectedButton.classList.add('selected');

            const questionData = selectedQuizData[currentQuestionIndex];
            const correctOptionLabel = questionData.answer; // 正確答案的原始標籤 (例如 'C')
            
            // 根據原始標籤獲取正確答案的實際內容
            const correctOptionContent = questionData.options[optionLabels.indexOf(correctOptionLabel)];

            // 檢查選定選項的原始標籤是否與正確答案的原始標籤匹配
            const isCorrect = (selectedOriginalLabel === correctOptionLabel);

            if (isCorrect) {
                score++; // 如果正確，分數增加
                console.log(`selectOption: 問題 ${currentQuestionIndex + 1} 正確。當前分數: ${score}`);
            } else {
                // 記錄答錯的題目 (僅用於內部追蹤)
                incorrectQuestions.push({
                    question: questionData.question,
                    selectedOption: selectedOriginalLabel, // 儲存原始標籤
                    selectedOptionContent: selectedButton.dataset.optionContent, // 實際內容
                    correctOption: correctOptionLabel, // 原始正確標籤 (A, B, C, D)
                    correctOptionContent: correctOptionContent, // 正確選項的實際內容
                    explanation: questionData.explanation
                });
                console.log(`selectOption: 問題 ${currentQuestionIndex + 1} 錯誤。當前分數: ${score}, 錯題數量: ${incorrectQuestions.length}`);
            }

            // 儲存用戶答案
            userAnswers[currentQuestionIndex] = {
                selectedOriginalLabel: selectedOriginalLabel,
                isCorrect: isCorrect,
                selectedOptionContent: selectedButton.dataset.optionContent, // 儲存選定選項的內容
                correctOptionContent: correctOptionContent // 儲存正確選項的內容
            };

            // 僅在練習模式下應用視覺回饋並顯示解釋
            if (quizMode === 'practice') {
                if (isCorrect) {
                    selectedButton.classList.add('correct');
                } else {
                    selectedButton.classList.add('incorrect');
                }
                // 標記正確答案
                buttons.forEach(button => {
                    if (button.dataset.originalLabelForContent === correctOptionLabel) {
                        button.classList.add('correct');
                    }
                });
                // 呼叫 showFeedback 顯示回饋
                showFeedback(questionData.explanation, isCorrect);
                askGeminiButton.style.display = 'inline-block'; // 顯示 Gemini 按鈕
            } else {
                // 在考試模式下，隱藏回饋和 Gemini 按鈕
                // 呼叫 hideFeedback 隱藏回饋
                hideFeedback();
                askGeminiButton.style.display = 'none';
            }

            // 呼叫 updateNavigationButtons 更新導航按鈕狀態
            updateNavigationButtons(); // 更新導航按鈕狀態 (啟用下一題按鈕)
            // 呼叫 saveQuizProgress 儲存進度
            await saveQuizProgress(subjectSelect.value); // 每次選擇後儲存進度
        }

        /**
         * 顯示題目回饋 (正確或錯誤以及解釋)。
         * 呼叫者：loadQuestion, selectOption
         * @param {string} explanation - 題目的解釋。
         * @param {boolean} isCorrect - 用戶的答案是否正確。
         */
        function showFeedback(explanation, isCorrect) {
            feedbackTitleElement.textContent = isCorrect ? '✅ 恭喜您，回答正確！' : '❌ 很抱歉，回答錯誤。';
            feedbackTextContentElement.textContent = explanation;
            feedbackContainer.classList.add('show');
        }

        /**
         * 隱藏題目回饋。
         * 呼叫者：loadQuestion, selectOption
         */
        function hideFeedback() {
            feedbackContainer.classList.remove('show');
        }

        /**
         * 更新導航按鈕 (上一題、下一題、提前交卷) 的狀態。
         * 呼叫者：loadQuestion, selectOption
         */
        function updateNavigationButtons() {
            prevButton.disabled = currentQuestionIndex === 0;
            // 下一題按鈕僅在當前題目已作答後才啟用
            nextButton.disabled = !userAnswers[currentQuestionIndex];
            submitEarlyButton.disabled = false; // 提前交卷按鈕在測驗期間始終啟用

            if (currentQuestionIndex === selectedQuizData.length - 1) {
                nextButton.textContent = '完成測驗';
            } else {
                nextButton.textContent = '下一題';
            }
        }

        // 下一題按鈕點擊事件監聽器
        nextButton.addEventListener('click', async () => { // 添加 async
            // 僅允許在當前題目已作答後點擊下一題
            if (!userAnswers[currentQuestionIndex]) {
                console.log("Next button clicked but current question not answered.");
                return;
            }

            if (currentQuestionIndex < selectedQuizData.length - 1) {
                currentQuestionIndex++;
                // 呼叫 loadQuestion 載入下一題
                loadQuestion();
                // 呼叫 saveQuizProgress 儲存進度
                await saveQuizProgress(subjectSelect.value); // 導航後儲存進度
            } else {
                // 測驗完成
                console.log("Next button clicked, quiz completed.");
                // 呼叫 showQuizSummary 顯示測驗總結
                showQuizSummary(); // 顯示測驗總結
            }
        });

        // 上一題按鈕點擊事件監聽器
        prevButton.addEventListener('click', async () => { // 添加 async
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                // 呼叫 loadQuestion 載入上一題
                loadQuestion();
                // 呼叫 saveQuizProgress 儲存進度
                await saveQuizProgress(subjectSelect.value); // 導航後儲存進度
            }
        });

        // 提前交卷按鈕點擊事件監聽器
        submitEarlyButton.addEventListener('click', () => {
            // 呼叫 showConfirmationModal 顯示確認模態框
            showConfirmationModal('確認交卷', '您確定要提前交卷嗎？交卷後將無法再修改答案。', (confirmed) => {
                if (confirmed) {
                    // 呼叫 showQuizSummary 顯示測驗總結
                    showQuizSummary(); // 確認後顯示測驗總結
                }
            });
        });

        /**
         * 顯示測驗總結頁面，計算分數，並顯示所有題目回顧。
         * 呼叫者：nextButton.addEventListener, submitEarlyButton.addEventListener, startTimer (當時間歸零時)
         */
        async function showQuizSummary() {
            // 呼叫 stopTimer 停止計時器
            stopTimer(); // 停止計時器
            quizContent.style.display = 'none'; // 隱藏測驗內容
            quizSummary.classList.add('show'); // 顯示測驗總結
            timerDisplay.style.display = 'none'; // 隱藏計時器

            const finalScorePoints = score * POINTS_PER_QUESTION; // 計算最終分數
            summaryScoreElement.textContent = `${finalScorePoints} 分`; // 顯示分數
            let message = '';
            const percentage = (score / selectedQuizData.length) * 100;
            if (percentage === 100) {
                message = '太棒了！您對AI應用規劃師能力有非常深入的了解！';
            } else if (percentage >= 80) {
                message = '表現非常出色！您已經掌握了大部分的知識。';
            } else if (percentage >= 60) {
                message = '不錯的開始！再加把勁，您會更棒的。';
            } else {
                message = '繼續努力！多加練習，您一定會進步的。';
            }
            summaryMessageElement.textContent = message; // 顯示總結訊息

            console.log(`showQuizSummary: 最終分數 (答對題目數): ${score}, 總題目數: ${selectedQuizData.length}, 最終得分: ${finalScorePoints}`);
            
            // 顯示所有題目回顧
            allQuestionsSummaryElement.innerHTML = ''; // 清空之前內容
            const title = document.createElement('h3');
            title.className = 'feedback-title text-xl mb-4';
            title.textContent = '題目回顧';
            // DOM 關係：title 元素是 allQuestionsSummaryElement 的子元素
            allQuestionsSummaryElement.appendChild(title);

            selectedQuizData.forEach((questionData, index) => {
                const userAnswer = userAnswers[index];
                const isAnswered = userAnswer !== undefined;
                const isCorrect = isAnswered ? userAnswer.isCorrect : false;

                const itemDiv = document.createElement('div');
                // DOM 關係：itemDiv 是 allQuestionsSummaryElement 的子元素
                itemDiv.className = `question-item ${isAnswered ? (isCorrect ? 'correct' : 'incorrect') : ''} bg-white border rounded-lg p-4 mb-4 shadow-sm`;

                let yourAnswerHtml = '';
                if (isAnswered) {
                    yourAnswerHtml = `<p class="your-answer-text ${isCorrect ? 'text-green-700' : 'text-blue-700'}">您的答案：${userAnswer.selectedOptionContent}</p>`;
                } else {
                    yourAnswerHtml = `<p class="your-answer-text text-gray-500">您未作答。</p>`;
                }

                itemDiv.innerHTML = `
                    <p class="question-text-all"><strong>${index + 1}. ${questionData.question}</strong></p>
                    ${yourAnswerHtml}
                    <p class="correct-answer-text-all text-green-700 mt-2">正確答案：${questionData.options[optionLabels.indexOf(questionData.answer)]}</p>
                    <p class="explanation-text-all text-purple-700 mt-2">${questionData.explanation}</p>
                `;
                allQuestionsSummaryElement.appendChild(itemDiv);
            });

            // 將分數儲存到排行榜
            // 呼叫 saveQuizScoreToLeaderboard 儲存分數
            await saveQuizScoreToLeaderboard(finalScorePoints); // 傳遞計算後的總分
            // 儲存測驗歷史紀錄
            // 呼叫 saveQuizHistory 儲存歷史紀錄
            await saveQuizHistory(subjectSelect.value, finalScorePoints, selectedQuizData, userAnswers, quizMode); // 新增：儲存測驗歷史紀錄
            // 測驗完成後，清除當前科目的進度
            // 呼叫 clearQuizProgress 清除進度
            await clearQuizProgress(subjectSelect.value);

            // 在考試模式下，在總結頁面顯示「詢問 Gemini」按鈕
            if (quizMode === 'exam') {
                askGeminiButton.style.display = 'inline-block';
            }
        }

        /**
         * 載入 JSON 題目資料。
         * 呼叫者：startQuizButton.addEventListener, continueQuizButton.addEventListener, startNewQuizButton.addEventListener
         * @param {string} jsonFileName - JSON 檔案名稱。
         * @param {boolean} isContinuing - 是否繼續之前的測驗。
         */
        async function loadFullQuizData(jsonFileName, isContinuing = false) {
            // 呼叫 showGlobalLoading 顯示載入指示器
            showGlobalLoading(); // 顯示載入指示器
            initialSelectionScreen.style.display = 'none'; // 隱藏初始選擇畫面
            loadingIndicator.style.display = 'block'; // 顯示載入訊息
            quizContent.style.display = 'none'; // 隱藏測驗內容
            quizSummary.classList.remove('show'); // 隱藏測驗總結
            questionCountsElement.style.display = 'none'; // 隱藏題目數量
            userCountDisplay.style.display = 'none'; // 測驗開始時隱藏用戶計數
            continueQuizPrompt.style.display = 'none'; // 隱藏繼續測驗提示
            subjectSelectionArea.style.display = 'none'; // 隱藏科目選擇區域
            modeSelectionArea.style.display = 'none'; // 隱藏模式選擇區域
            viewLeaderboardButton.style.display = 'none'; // 隱藏排行榜按鈕
            viewHistoryButton.style.display = 'none'; // 隱藏歷史紀錄按鈕

            console.log(`loadFullQuizData: 開始載入 ${jsonFileName}。是否繼續: ${isContinuing}, 模式: ${quizMode}`);

            try {
                if (!isContinuing) { // 如果不是繼續測驗，則從頭載入 JSON
                    console.log("loadFullQuizData: 正在開始新的測驗。");
                    const githubRawUrl = `https://raw.githubusercontent.com/ss1111119/ipas_AI-Planner-Exam/main/${jsonFileName}`;
                    const response = await fetch(githubRawUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    fullQuizData = await response.json(); // 載入所有題目
                    // 呼叫 initializeQuizData 載入資料後初始化隨機題目
                    initializeQuizData(); // 載入資料後初始化隨機題目
                    currentQuestionIndex = 0; // 重設題目索引
                    userAnswers = []; // 清空答案
                    score = 0; // 重設答對題目計數
                    incorrectQuestions = []; // 清空錯題
                    timeRemaining = quizDurationInSeconds; // 重設計時器
                    quizStartTime = Date.now(); // 設定測驗開始時間
                    lastActiveTime = Date.now(); // 設定最後活躍時間
                    console.log(`loadFullQuizData: 新測驗已初始化。分數: ${score}, 用戶答案: ${userAnswers.length}, 錯題: ${incorrectQuestions.length}`);
                } else {
                    // 如果是繼續測驗，則使用已載入的進度資料
                    console.log("loadFullQuizData: 正在繼續現有測驗。");
                    currentQuestionIndex = loadedProgressData.currentQuestionIndex ?? 0;
                    userAnswers = loadedProgressData.userAnswers || [];
                    score = loadedProgressData.score ?? 0; // 此處分數仍為答對題目數
                    incorrectQuestions = loadedProgressData.incorrectQuestions || [];
                    selectedQuizData = loadedProgressData.selectedQuizData || []; // 使用儲存的已選題目
                    quizStartTime = loadedProgressData.quizStartTime ?? Date.now(); // 載入測驗開始時間
                    lastActiveTime = loadedProgressData.lastActiveTime ?? Date.now(); // 載入最後活躍時間
                    // 同時從儲存的進度中載入測驗模式 (如果可用)
                    quizMode = loadedProgressData.quizMode ?? 'practice'; 
                    console.log(`loadFullQuizData: 測驗已恢復。載入分數: ${score}, 用戶答案: ${userAnswers.length}, 錯題: ${incorrectQuestions.length}, 模式: ${quizMode}`);
                }
                
                // 呼叫 loadQuestion 載入第一道題目
                loadQuestion(); // 載入第一道題目
                quizContent.style.display = 'block'; // 顯示測驗內容
                currentSubjectTitle.textContent = subjectNames[jsonFileName]; // 更新科目名稱
                // 呼叫 startTimer 啟動計時器
                startTimer(); // 啟動計時器
            } catch (error) {
                console.error('loadFullQuizData: 載入測驗資料失敗：', error);
                loadingIndicator.textContent = `載入題目失敗：${subjectNames[jsonFileName]}。請檢查 GitHub 上的 JSON 檔案路徑或內容格式是否正確。錯誤: ${error.message}`;
                loadingIndicator.style.display = 'block';
                // 發生錯誤時，返回初始狀態讓用戶重試
                initialSelectionScreen.style.display = 'flex';
                subjectSelectionArea.style.display = 'block';
                modeSelectionArea.style.display = 'flex'; // 錯誤時顯示模式選擇區域
                questionCountsElement.style.display = 'block';
                userCountDisplay.style.display = 'block'; // 錯誤時顯示用戶計數
                continueQuizPrompt.style.display = 'none';
                viewLeaderboardButton.style.display = 'block';
                viewHistoryButton.style.display = 'block'; // 錯誤時顯示歷史紀錄按鈕
                return;
            } finally {
                // 僅在資料成功載入或繼續測驗時隱藏載入指示器
                if (fullQuizData.length > 0 || isContinuing) { 
                    loadingIndicator.style.display = 'none';
                }
                // 呼叫 hideGlobalLoading 隱藏全域載入
                hideGlobalLoading(); // 無論成功或失敗，都隱藏全域載入
            }
        }

        // 重新測驗按鈕點擊事件監聽器
        restartButton.addEventListener('click', () => {
            // 呼叫 showGlobalLoading 顯示載入指示器
            showGlobalLoading(); // 顯示載入指示器
            // 重新顯示環境選擇畫面，並隱藏測驗內容和總結
            environmentSelectionScreen.style.display = 'flex';
            initialSelectionScreen.style.display = 'none';
            quizContent.style.display = 'none';
            quizSummary.classList.remove('show');
            askGeminiButton.style.display = 'none';
            // 呼叫 stopTimer 確保計時器停止
            stopTimer(); // 確保計時器停止
            timerDisplay.style.display = 'none';
            userCountDisplay.style.display = 'none'; // 返回環境選擇時隱藏用戶計數
            // 重新開始時將 quizMode 重設為預設值
            quizMode = 'practice';
            practiceModeButton.classList.add('selected-mode');
            examModeButton.classList.remove('selected-mode');
            // 此處無需呼叫 getAndDisplayUserCount()，它將在環境選擇後呼叫
            // 呼叫 hideGlobalLoading 確保載入已隱藏
            hideGlobalLoading(); // 確保載入已隱藏
        });

        // 「開始測驗」按鈕點擊事件監聽器 (從科目選擇畫面觸發)
        startQuizButton.addEventListener('click', () => {
            // 呼叫 loadFullQuizData 開始新的測驗
            loadFullQuizData(subjectSelect.value, false); // 開始新的測驗
        });

        // 「繼續測驗」按鈕點擊事件監聽器
        continueQuizButton.addEventListener('click', () => {
            // 呼叫 loadFullQuizData 繼續之前的測驗
            loadFullQuizData(loadedProgressData.subjectId, true); // 繼續之前的測驗
        });

        // 「開始新測驗」按鈕點擊事件監聽器
        startNewQuizButton.addEventListener('click', async () => {
            // 呼叫 clearQuizProgress 清除選定科目的現有進度
            await clearQuizProgress(subjectSelect.value); 
            // 呼叫 loadFullQuizData 開始全新的測驗
            loadFullQuizData(subjectSelect.value, false); // 開始全新的測驗
        });

        // Gemini 相關事件監聽器
        askGeminiButton.addEventListener('click', () => {
            // 如果在 GitHub Pages 環境且未設定 API 金鑰，則提示輸入
            // 呼叫 showConfirmationModal 顯示提示
            if (currentEnvironment === 'github-pages' && !geminiApiKey) {
                apiKeyModalOverlay.style.display = 'flex';
                geminiApiKeyInput.focus();
                return;
            }
            geminiModalOverlay.style.display = 'flex'; // 顯示模態框
            geminiQuestionInput.focus(); // 輸入欄位自動獲取焦點
        });

        geminiModalClose.addEventListener('click', () => {
            geminiModalOverlay.style.display = 'none'; // 隱藏模態框
            geminiResponseArea.innerHTML = ''; // 清空回應內容
            geminiResponseArea.style.display = 'none';
            geminiQuestionInput.value = ''; // 清空輸入欄位
            geminiLoadingIndicator.style.display = 'none';
        });

        // Gemini 問題模態框取消按鈕事件監聽器
        geminiModalCancelButton.addEventListener('click', () => {
            geminiModalOverlay.style.display = 'none'; // 隱藏模態框
            geminiResponseArea.innerHTML = '';
            geminiResponseArea.style.display = 'none';
            geminiQuestionInput.value = '';
            geminiLoadingIndicator.style.display = 'none';
        });

        // API 金鑰模態框取消按鈕事件監聽器
        apiKeyModalCancelButton.addEventListener('click', () => {
            apiKeyModalOverlay.style.display = 'none'; // 隱藏 API 金鑰模態框
            geminiApiKeyInput.value = '';
        });

        // 處理 API 金鑰提交
        submitApiKeyButton.addEventListener('click', () => {
            const inputKey = geminiApiKeyInput.value.trim();
            if (inputKey) {
                geminiApiKey = inputKey; // 儲存輸入的金鑰
                apiKeyModalOverlay.style.display = 'none'; // 隱藏 API 金鑰模態框
                askGeminiButton.click(); // 重新觸發「詢問 Gemini」按鈕的點擊事件
            } else {
                // 呼叫 showConfirmationModal 顯示提示
                showConfirmationModal('提示', '請輸入有效的 Gemini API 金鑰。', null, true);
            }
        });

        // 提交 Gemini 問題按鈕點擊事件監聽器
        submitGeminiQuestionButton.addEventListener('click', async () => {
            const userQuestion = geminiQuestionInput.value.trim();
            if (!userQuestion) {
                geminiResponseArea.style.display = 'block';
                geminiResponseArea.textContent = '請輸入您的問題。';
                return;
            }

            geminiResponseArea.innerHTML = '';
            geminiResponseArea.style.display = 'none';
            geminiLoadingIndicator.style.display = 'block'; // 顯示載入指示器

            const currentQuestionData = selectedQuizData[currentQuestionIndex];
            // 建構傳給 Gemini 的提示詞，包含題目、選項、正確答案和解釋
            const prompt = `關於以下測驗題目：
題目：${currentQuestionData.question}
選項：
A) ${currentQuestionData.options[0]}
B) ${currentQuestionData.options[1]}
C) ${currentQuestionData.options[2]}
D) ${currentQuestionData.options[3]}
正確答案：${currentQuestionData.answer}
解釋：${currentQuestionData.explanation}

我的問題是：${userQuestion}

請根據上述資訊，詳細回答我的問題。`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // 根據環境動態設定 Gemini API 金鑰
                const apiKeyToUse = (currentEnvironment === 'github-pages') ? geminiApiKey : ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKeyToUse}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    geminiResponseArea.textContent = text; // 顯示 Gemini 的回應
                } else {
                    geminiResponseArea.textContent = '抱歉，無法獲取回答。請稍後再試或換個問題。';
                    console.error('Gemini API response structure unexpected:', result);
                }
            } catch (error) {
                geminiResponseArea.textContent = '發生錯誤，無法連接到 Gemini 服務。請檢查您的網路連線。';
                console.error('Error calling Gemini API:', error);
            } finally {
                geminiLoadingIndicator.style.display = 'none'; // 隱藏載入指示器
                geminiResponseArea.style.display = 'block'; // 顯示回應區
            }
        });

        /**
         * 將秒數格式化為 MM:SS 時間字串。
         * 呼叫者：startTimer
         * @param {number} seconds - 要格式化的秒數。
         * @returns {string} - 格式化後的時間字串。
         */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        /**
         * 啟動測驗計時器。
         * 呼叫者：loadFullQuizData, document.addEventListener('visibilitychange')
         */
        function startTimer() {
            // 如果不是從儲存的進度繼續，則重設時間
            if (!loadedProgressData) {
                timeRemaining = quizDurationInSeconds;
                quizStartTime = Date.now(); // 為新測驗設定開始時間
            }
            lastActiveTime = Date.now(); // 計時器啟動/恢復時更新最後活躍時間
            // 呼叫 formatTime 格式化時間
            timerDisplay.textContent = formatTime(timeRemaining);
            timerDisplay.style.display = 'block'; // 測驗開始時顯示計時器

            // 清除任何現有的間隔，以防止多個計時器同時運行
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                timeRemaining--;
                // 呼叫 formatTime 格式化時間
                timerDisplay.textContent = formatTime(timeRemaining);

                if (timeRemaining <= 0) {
                    // 呼叫 stopTimer 停止計時器
                    stopTimer();
                    console.log("計時器歸零。自動提交測驗。");
                    // 呼叫 showQuizSummary 顯示測驗總結
                    showQuizSummary(); // 時間用完時自動提交
                    // 禁用所有選項和導航按鈕以防止進一步互動
                    const buttons = optionsContainer.querySelectorAll('.option-button');
                    buttons.forEach(button => {
                        button.classList.add('disabled');
                    });
                    prevButton.disabled = true;
                    nextButton.disabled = true;
                    submitEarlyButton.disabled = true;
                }
            }, 1000); // 每秒更新一次
            console.log(`startTimer: 計時器已啟動/恢復。剩餘時間: ${formatTime(timeRemaining)}, 最後活躍時間: ${new Date(lastActiveTime).toLocaleString()}`);
        }

        /**
         * 停止測驗計時器。
         * 呼叫者：showQuizSummary, restartButton.addEventListener, document.addEventListener('visibilitychange')
         */
        function stopTimer() {
            clearInterval(timerInterval);
            console.log("stopTimer: 計時器已停止。");
        }

        /**
         * 顯示自定義的確認/訊息模態框。
         * 呼叫者：submitEarlyButton.addEventListener, submitApiKeyButton.addEventListener, handleUserAuthenticationAndDataLoad, submitProblemBtn.addEventListener
         * @param {string} title - 模態框標題。
         * @param {string} message - 模態框訊息。
         * @param {Function} onConfirmCallback - 確認時執行的回呼函式。
         * @param {boolean} isAlert - 是否為提示訊息 (只顯示「確定」按鈕)。
         */
        function showConfirmationModal(title, message, onConfirmCallback, isAlert = false) {
            const modalTitle = confirmationModalOverlay.querySelector('.confirmation-modal-title');
            const modalMessage = confirmationModalOverlay.querySelector('.confirmation-modal-message');
            const modalButtons = confirmationModalOverlay.querySelector('.confirmation-modal-buttons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            modalButtons.innerHTML = ''; // 清空舊按鈕

            if (isAlert) {
                // 如果是提示訊息，只顯示「確定」按鈕
                const okButton = document.createElement('button');
                okButton.id = 'confirm-ok-button';
                okButton.className = 'confirmation-modal-button confirm-no';
                okButton.textContent = '確定';
                okButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback();
                    }
                });
                // DOM 關係：okButton 是 modalButtons 的子元素
                modalButtons.appendChild(okButton);
            } else {
                // 如果是確認訊息，顯示「確定交卷」和「取消」按鈕
                const yesButton = document.createElement('button');
                yesButton.id = 'confirm-yes-button';
                yesButton.className = 'confirmation-modal-button confirm-yes';
                yesButton.textContent = '確定交卷';
                yesButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback(true);
                    }
                });
                // DOM 關係：yesButton 是 modalButtons 的子元素
                modalButtons.appendChild(yesButton);

                const noButton = document.createElement('button');
                noButton.id = 'confirm-no-button';
                noButton.className = 'confirmation-modal-button confirm-no';
                noButton.textContent = '取消';
                noButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback(false);
                    }
                });
                // DOM 關係：noButton 是 modalButtons 的子元素
                modalButtons.appendChild(noButton);
            }

            confirmationModalOverlay.style.display = 'flex'; // 顯示模態框
        }

        /**
         * 獲取並顯示每個科目的題目數量。
         * 呼叫者：checkAndDisplaySavedProgress, handleUserAuthenticationAndDataLoad (透過 proceedAfterUserIdSet)
         */
        async function getQuestionCounts() {
            questionCountsElement.innerHTML = '<p>正在載入題目數量...</p>';
            let allCounts = {};
            let hasError = false;

            for (const fileName in subjectNames) {
                const githubRawUrl = `https://raw.githubusercontent.com/ss1111119/ipas_AI-Planner-Exam/main/${fileName}`;
                try {
                    const response = await fetch(githubRawUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    allCounts[fileName] = data.length;
                } catch (error) {
                    console.error(`Failed to load question count for ${fileName}:`, error);
                    allCounts[fileName] = '載入失敗';
                    hasError = true;
                }
            }

            questionCountsElement.innerHTML = ''; // 清空載入訊息
            if (hasError) {
                questionCountsElement.innerHTML = '<p class="text-red-500">無法載入所有題目數量，請檢查網路連線或 GitHub 檔案路徑。</p>';
            }
            for (const fileName in subjectNames) {
                const p = document.createElement('p');
                p.textContent = `${subjectNames[fileName]}：${allCounts[fileName]} 題`;
                // DOM 關係：p 元素是 questionCountsElement 的子元素
                questionCountsElement.appendChild(p);
            }
        }

        /**
         * 將測驗進度儲存到 Firestore。
         * 儲存路徑：/artifacts/{appId}/users/{userId}/quiz_progress/{subjectId}
         * 呼叫者：selectOption, nextButton.addEventListener, prevButton.addEventListener, document.addEventListener('visibilitychange'), window.addEventListener('beforeunload')
         * @param {string} subjectId - 科目 ID。
         */
        async function saveQuizProgress(subjectId) {
            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("saveQuizProgress: Firebase 認證未準備就緒或參數缺失。無法儲存進度。");
                return;
            }

            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);
            
            try {
                const dataToSave = {
                    subjectId: subjectId,
                    currentQuestionIndex: currentQuestionIndex !== undefined ? currentQuestionIndex : 0,
                    userAnswers: userAnswers || [],
                    score: score !== undefined ? score : 0, // 這是答對的題目數量
                    incorrectQuestions: incorrectQuestions || [], // 仍儲存以備將來使用
                    timeRemaining: timeRemaining !== undefined ? timeRemaining : quizDurationInSeconds,
                    selectedQuizData: selectedQuizData || [],
                    quizStartTime: quizStartTime, // 儲存測驗開始時間
                    lastActiveTime: Date.now(), // 更新並儲存最後活躍時間
                    quizMode: quizMode, // 新增：儲存當前測驗模式
                    lastSaved: serverTimestamp() // 最後儲存時間戳
                };
                
                // 呼叫 removeUndefined 深度清理資料，移除所有 undefined 值
                const cleanedDataToSave = removeUndefined(dataToSave);

                await setDoc(progressDocRef, cleanedDataToSave, { merge: false }); // 覆蓋該科目的舊進度
                console.log(`saveQuizProgress: 測驗進度已儲存至 ${subjectId}。分數: ${score}, 用戶答案: ${userAnswers.length}, 錯題: ${incorrectQuestions.length}, 模式: ${quizMode}`);
            } catch (error) {
                console.error("saveQuizProgress: 儲存測驗進度失敗：", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤：Firebase 權限被拒絕。請檢查您的 Firestore 安全規則，確保匿名用戶可以在路徑 `/artifacts/{appId}/users/{userId}/quiz_progress/{subjectId}` 上讀寫。");
                }
            }
        }

        /**
         * 清除 Firestore 中的測驗進度。
         * 呼叫者：startNewQuizButton.addEventListener, showQuizSummary
         * @param {string} subjectId - 科目 ID。
         */
        async function clearQuizProgress(subjectId) {
            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("clearQuizProgress: Firebase 認證未準備就緒或參數缺失。無法清除進度。");
                return;
            }
            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);
            try {
                await setDoc(progressDocRef, {}); // 設定為空物件以清除內容
                console.log(`clearQuizProgress: 科目 ${subjectId} 的測驗進度已清除。`);
                loadedProgressData = null; // 清除本地載入的資料
            } catch (error) {
                console.error("clearQuizProgress: 清除測驗進度失敗：", error);
            }
        }

        /**
         * 初始化 Firebase 服務 (app, auth, Firestore)。
         * 呼叫者：DOMContentLoaded 事件監聽器
         */
        async function initializeFirebaseServices() {
            try {
                console.log("initializeFirebaseServices: 正在啟動 Firebase 服務初始化...");
                
                let currentFirebaseConfig;

                // 優先使用 Canvas 環境提供的 __firebase_config
                if (typeof __firebase_config !== 'undefined') {
                    currentFirebaseConfig = JSON.parse(__firebase_config);
                    currentEnvironment = 'canvas';
                    // 在 Canvas 中，appId 使用 __app_id，如果沒有則使用 __firebase_config 的 appId
                    effectiveAppId = typeof __app_id !== 'undefined' ? __app_id : currentFirebaseConfig.appId; 
                    console.log("initializeFirebaseServices: 檢測到 Canvas 環境。使用 __firebase_config。");
                } else {
                    currentFirebaseConfig = defaultFirebaseConfig; // GitHub Pages 環境使用硬編碼配置
                    currentEnvironment = 'github-pages';
                    // GitHub Pages 環境使用 defaultFirebaseConfig 的 appId
                    effectiveAppId = currentFirebaseConfig.appId; 
                    console.log("initializeFirebaseServices: 檢測到 GitHub Pages 環境。使用 defaultFirebaseConfig。");
                }

                console.log("initializeFirebaseServices: 實際使用的 Firebase 配置:", currentFirebaseConfig);
                console.log("initializeFirebaseServices: 實際使用的應用程式 ID (effectiveAppId):", effectiveAppId);

                if (!currentFirebaseConfig.apiKey || !currentFirebaseConfig.authDomain || !currentFirebaseConfig.projectId || !currentFirebaseConfig.appId) {
                    console.error("initializeFirebaseServices: Firebase 配置不完整。請確保提供了 apiKey、authDomain、projectId 和 appId。", currentFirebaseConfig);
                    throw new Error("Firebase 配置不完整。請確保提供了 apiKey、authDomain、projectId 和 appId。");
                }

                if (!app) {
                    app = initializeApp(currentFirebaseConfig); // 初始化 Firebase 應用
                    auth = getAuth(app); // 獲取認證實例
                    db = getFirestore(app); // 獲取 Firestore 實例
                    console.log("initializeFirebaseServices: Firebase app, auth, db 已初始化。");
                } else {
                    console.log("initializeFirebaseServices: Firebase 服務已初始化，跳過重複初始化。");
                }

            } catch (error) {
                console.error("initializeFirebaseServices: Firebase 初始化失敗：", error);
                // 如果 Firebase 初始化失敗，直接顯示科目選擇畫面
                environmentSelectionScreen.style.display = 'none';
                initialSelectionScreen.style.display = 'flex';
                continueQuizPrompt.style.display = 'none';
                subjectSelectionArea.style.display = 'block';
                modeSelectionArea.style.display = 'flex'; // Firebase 初始化錯誤時顯示模式選擇區域
                questionCountsElement.style.display = 'block';
                userCountDisplay.style.display = 'block'; // 確保此畫面顯示用戶計數
                userCountDisplay.textContent = '無法載入訪問人數 (初始化錯誤)。'; // 顯示錯誤訊息
            }
        }

        /**
         * 將用戶顯示名稱儲存到 Firestore。
         * 儲存路徑：/artifacts/{appId}/users/{uid}/profile/data
         * 呼叫者：handleUserAuthenticationAndDataLoad, submitUserIdButton.addEventListener
         * @param {string} uid - Firebase 用戶 UID。
         * @param {string} displayName - 要儲存的顯示名稱。
         */
        async function saveUserDisplayNameToFirestore(uid, displayName) {
            if (!isAuthReady || !db || !uid || !effectiveAppId) {
                console.warn("saveUserDisplayNameToFirestore: Firebase 認證未準備就緒或參數缺失。無法儲存顯示名稱。");
                return;
            }
            const userProfileDocRef = doc(db, 'artifacts', effectiveAppId, 'users', uid, 'profile', 'data');
            try {
                await setDoc(userProfileDocRef, { displayName: displayName, lastUpdated: serverTimestamp() }, { merge: true });
                console.log(`saveUserDisplayNameToFirestore: 用戶顯示名稱已儲存: ${displayName}，UID: ${uid}`);
            } catch (error) {
                console.error("saveUserDisplayNameToFirestore: 儲存用戶顯示名稱失敗：", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤：Firebase 權限被拒絕。請檢查您的 Firestore 安全規則，確保用戶可以在路徑 `/artifacts/{appId}/users/{userId}/profile/data` 上讀寫。");
                }
            }
        }

        /**
         * 從 Firestore 載入用戶顯示名稱。
         * 呼叫者：handleUserAuthenticationAndDataLoad
         * @param {string} uid - Firebase 用戶 UID。
         * @returns {Promise<string|null>} - 載入的顯示名稱或 null。
         */
        async function loadUserDisplayNameFromFirestore(uid) {
            if (!isAuthReady || !db || !uid || !effectiveAppId) {
                console.warn("loadUserDisplayNameFromFirestore: Firebase 認證未準備就緒或參數缺失。無法載入顯示名稱。");
                return null;
            }
            const userProfileDocRef = doc(db, 'artifacts', effectiveAppId, 'users', uid, 'profile', 'data');
            try {
                const docSnap = await getDoc(userProfileDocRef);
                if (docSnap.exists() && docSnap.data().displayName) {
                    console.log(`loadUserDisplayNameFromFirestore: 從 Firestore 載入顯示名稱: ${docSnap.data().displayName}，UID: ${uid}`);
                    return docSnap.data().displayName;
                }
                console.log(`loadUserDisplayNameFromFirestore: 未從 Firestore 載入 UID: ${uid} 的顯示名稱。`);
                return null;
            } catch (error) {
                console.error("loadUserDisplayNameFromFirestore: 載入用戶顯示名稱失敗：", error);
                return null;
            }
        }

        /**
         * 處理用戶認證和資料載入過程。
         * 呼叫者：selectCanvasEnvButton.addEventListener, selectGithubEnvButton.addEventListener
         */
        async function handleUserAuthenticationAndDataLoad() {
            // 呼叫 showGlobalLoading 顯示載入指示器
            showGlobalLoading(); // 顯示載入指示器
            console.log("handleUserAuthenticationAndDataLoad: 正在啟動用戶認證和資料載入...");
            if (!app || !auth || !db) {
                console.error("handleUserAuthenticationAndDataLoad: Firebase 服務未初始化，無法處理用戶認證和資料載入。");
                // 呼叫 showConfirmationModal 顯示錯誤訊息
                showConfirmationModal('錯誤', 'Firebase 服務未初始化，請重新整理頁面或稍後再試。', null, true);
                // 呼叫 hideGlobalLoading 隱藏載入指示器
                hideGlobalLoading(); // 隱藏載入指示器
                return;
            }

            let firebaseAuthUid = null;

            // 步驟 1: 執行 Firebase 認證 (自定義 Token 或匿名登入)
            if (currentEnvironment === 'canvas') {
                console.log("handleUserAuthenticationAndDataLoad: Canvas 環境正在認證...");
                // 檢查 Canvas 環境是否提供了自定義認證 Token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                        firebaseAuthUid = userCredential.user.uid;
                        console.log("Canvas: 已使用自定義 Token 登入。UID:", firebaseAuthUid);
                    } catch (tokenError) {
                        console.error("Canvas: 自定義 Token 登入失敗，嘗試匿名登入：", tokenError);
                        try {
                            const userCredential = await signInAnonymously(auth);
                            firebaseAuthUid = userCredential.user.uid;
                            console.log("Canvas: 自定義 Token 失敗後，已匿名登入。UID:", firebaseAuthUid);
                        } catch (anonError) {
                            console.error("Canvas: 匿名登入失敗：", anonError);
                            // 呼叫 showConfirmationModal 顯示錯誤訊息
                            showConfirmationModal('錯誤', 'Canvas 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                            // 呼叫 hideGlobalLoading 隱藏載入指示器
                            hideGlobalLoading();
                            return;
                        }
                    }
                } else {
                    console.log("handleUserAuthenticationAndDataLoad: Canvas: 無自定義 Token，嘗試匿名登入...");
                    try {
                        const userCredential = await signInAnonymously(auth);
                        firebaseAuthUid = userCredential.user.uid;
                        console.log("Canvas: 已匿名登入。UID:", firebaseAuthUid);
                    } catch (anonError) {
                        console.error("Canvas: 匿名登入失敗：", anonError);
                        // 呼叫 showConfirmationModal 顯示錯誤訊息
                        showConfirmationModal('錯誤', 'Canvas 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                        // 呼叫 hideGlobalLoading 隱藏載入指示器
                        hideGlobalLoading();
                        return;
                    }
                }
            } else { // GitHub Pages 環境
                console.log("handleUserAuthenticationAndDataLoad: GitHub Pages 環境正在匿名認證...");
                // GitHub Pages 環境始終匿名登入以獲取 Firebase UID
                try {
                    const userCredential = await signInAnonymously(auth);
                    firebaseAuthUid = userCredential.user.uid;
                    console.log("GitHub Pages: 已匿名登入。UID:", firebaseAuthUid);
                } catch (anonError) {
                    console.error("GitHub Pages: 匿名登入失敗：", anonError);
                    // 呼叫 showConfirmationModal 顯示錯誤訊息
                    showConfirmationModal('錯誤', 'GitHub Pages 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                    // 呼叫 hideGlobalLoading 隱藏載入指示器
                    hideGlobalLoading();
                    return;
                }
            }

            // 此時，firebaseAuthUid 應已設定，將其作為實際的 currentUserId
            currentUserId = firebaseAuthUid;
            isAuthReady = true; // 設定認證準備就緒標誌
            console.log("handleUserAuthenticationAndDataLoad: currentUserId 已設定為:", currentUserId, "isAuthReady:", isAuthReady);

            // 步驟 2: 處理用戶顯示名稱
            let storedDisplayName = localStorage.getItem('user_defined_display_name');
            if (storedDisplayName) {
                currentUserDisplayName = storedDisplayName;
                console.log("handleUserAuthenticationAndDataLoad: 使用來自 localStorage 的儲存顯示名稱:", currentUserDisplayName);
                // 同步/更新至 Firestore 個人資料
                // 呼叫 saveUserDisplayNameToFirestore 儲存顯示名稱
                await saveUserDisplayNameToFirestore(currentUserId, currentUserDisplayName);
                // 呼叫 proceedAfterUserIdSet 繼續應用程式流程
                await proceedAfterUserIdSet(); // 如果找到顯示名稱，立即繼續
                // 呼叫 hideGlobalLoading 隱藏載入指示器
                hideGlobalLoading();
            } else {
                // 如果 localStorage 中沒有，嘗試從 Firestore 載入
                // 呼叫 loadUserDisplayNameFromFirestore 載入顯示名稱
                const loadedDisplayName = await loadUserDisplayNameFromFirestore(currentUserId);
                if (loadedDisplayName) {
                    currentUserDisplayName = loadedDisplayName;
                    localStorage.setItem('user_defined_display_name', currentUserDisplayName); // 儲存至 localStorage 以便下次快速存取
                    console.log("handleUserAuthenticationAndDataLoad: 使用來自 Firestore 的儲存顯示名稱:", currentUserDisplayName);
                    // 呼叫 proceedAfterUserIdSet 繼續應用程式流程
                    await proceedAfterUserIdSet(); // 如果找到顯示名稱，立即繼續
                    // 呼叫 hideGlobalLoading 隱藏載入指示器
                    hideGlobalLoading();
                } else {
                    // 如果任何地方都找不到顯示名稱，則提示用戶輸入
                    console.log("handleUserAuthenticationAndDataLoad: 未找到顯示名稱，顯示用戶暱稱輸入模態框。");
                    userIdModalOverlay.style.display = 'flex';
                    userIdInput.focus();
                    // 呼叫 hideGlobalLoading 隱藏載入指示器
                    hideGlobalLoading(); // 隱藏載入指示器 (因為將顯示另一個模態框)
                    // 此處不呼叫 proceedAfterUserIdSet()，它將在用戶提交 ID 後呼叫
                }
            }
        }

        /**
         * 在設定用戶 ID 後，繼續應用程式流程。
         * 呼叫者：handleUserAuthenticationAndDataLoad, submitUserIdButton.addEventListener
         */
        async function proceedAfterUserIdSet() {
            console.log("proceedAfterUserIdSet: 繼續執行，currentUserId:", currentUserId, "isAuthReady:", isAuthReady);
            if (currentUserId && isAuthReady) {
                console.log("proceedAfterUserIdSet: db:", db, "effectiveAppId:", effectiveAppId);
                // 呼叫 trackUserVisit 追蹤用戶訪問
                await trackUserVisit(effectiveAppId); // 追蹤用戶訪問
                
                environmentSelectionScreen.style.display = 'none'; // 隱藏環境選擇畫面
                initialSelectionScreen.style.display = 'flex'; // 顯示初始選擇畫面
                subjectSelectionArea.style.display = 'block'; // 始終顯示科目選擇
                modeSelectionArea.style.display = 'flex'; // 始終顯示模式選擇
                // 呼叫 getQuestionCounts 顯示題目數量
                getQuestionCounts(); // 顯示題目數量
                viewLeaderboardButton.style.display = 'block'; // 在初始畫面顯示排行榜按鈕
                viewHistoryButton.style.display = 'block'; // 在初始畫面顯示歷史紀錄按鈕
                // 呼叫 checkAndDisplaySavedProgress 檢查是否有儲存的進度
                await checkAndDisplaySavedProgress(); // 檢查是否有儲存的進度
                
                // 現在我們在初始選擇畫面，顯示用戶計數
                userCountDisplay.style.display = 'block'; // 確保其可見
                // 呼叫 getAndDisplayUserCount 獲取並顯示用戶計數
                await getAndDisplayUserCount(); // 獲取並顯示用戶計數
            } else {
                console.error("proceedAfterUserIdSet: 無法設定 currentUserId 或認證未準備就緒。");
                // 呼叫 showConfirmationModal 顯示錯誤訊息
                showConfirmationModal('錯誤', '無法設定使用者 ID 或認證未準備就緒，請重新整理頁面或稍後再試。', null, true);
            }
        }

        // 環境選擇按鈕點擊事件監聽器
        selectCanvasEnvButton.addEventListener('click', async () => {
            currentEnvironment = 'canvas';
            // 呼叫 handleUserAuthenticationAndDataLoad 處理用戶認證和資料載入
            await handleUserAuthenticationAndDataLoad(); // 處理用戶認證和資料載入
        });

        selectGithubEnvButton.addEventListener('click', async () => {
            currentEnvironment = 'github-pages';
            // 呼叫 handleUserAuthenticationAndDataLoad 處理用戶認證和資料載入
            await handleUserAuthenticationAndDataLoad(); // 處理用戶認證和資料載入
        });

        // 用戶 ID 輸入模態框確認按鈕點擊事件監聽器
        submitUserIdButton.addEventListener('click', async () => {
            let enteredDisplayName = userIdInput.value.trim();
            // 如果沒有輸入暱稱，則分配一個預設名稱
            if (!enteredDisplayName) {
                enteredDisplayName = '陌生人'; // 您可以根據需要更改為其他預設名稱
            }
            
            // 呼叫 showGlobalLoading 顯示載入指示器
            showGlobalLoading(); // 顯示載入指示器
            currentUserDisplayName = enteredDisplayName;
            localStorage.setItem('user_defined_display_name', enteredDisplayName); // 儲存至 localStorage
            userIdModalOverlay.style.display = 'none'; // 隱藏模態框
            console.log("User display name set and stored:", currentUserDisplayName);
            // 立即儲存至 Firestore 個人資料
            // 呼叫 saveUserDisplayNameToFirestore 儲存顯示名稱
            await saveUserDisplayNameToFirestore(currentUserId, currentUserDisplayName);
            // 呼叫 proceedAfterUserIdSet 繼續認證和資料載入
            await proceedAfterUserIdSet(); // 繼續認證和資料載入
            // 呼叫 hideGlobalLoading 隱藏載入指示器
            hideGlobalLoading(); // 隱藏載入指示器
        });

        // 用戶 ID 輸入模態框取消按鈕點擊事件監聽器
        cancelUserIdButton.addEventListener('click', () => {
            userIdModalOverlay.style.display = 'none'; // 隱藏模態框
            // 如果用戶取消，返回環境選擇畫面
            environmentSelectionScreen.style.display = 'flex';
            initialSelectionScreen.style.display = 'none';
        });

        // 新增：模式選擇事件監聽器
        practiceModeButton.addEventListener('click', () => {
            quizMode = 'practice';
            practiceModeButton.classList.add('selected-mode');
            examModeButton.classList.remove('selected-mode');
            console.log("測驗模式設定為: practice");
        });

        examModeButton.addEventListener('click', () => {
            quizMode = 'exam';
            examModeButton.classList.add('selected-mode');
            practiceModeButton.classList.remove('selected-mode');
            console.log("測驗模式設定為: exam");
        });

        /**
         * 將測驗分數儲存到排行榜。
         * 儲存路徑：/artifacts/{appId}/public/data/leaderboard_scores
         * 呼叫者：showQuizSummary
         * @param {number} finalScorePoints - 計算後的總分。
         */
        async function saveQuizScoreToLeaderboard(finalScorePoints) {
            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("saveQuizScoreToLeaderboard: Firebase 認證未準備就緒或參數缺失。無法儲存排行榜分數。");
                return;
            }

            // 排行榜資料儲存在公共路徑：/artifacts/{appId}/public/data/leaderboard_scores
            const leaderboardCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'leaderboard_scores');
            console.log("Firestore collection path for leaderboard write:", leaderboardCollectionRef.path);
            
            try {
                const scoreData = {
                    userId: currentUserId,
                    displayName: currentUserDisplayName || '匿名用戶',
                    score: finalScorePoints, // 儲存計算後的總分
                    totalQuestions: selectedQuizData.length, // 仍儲存總題目數 (如果需要)
                    correctAnswers: score, // 增加答對題目數 (如果需要)
                    subject: subjectNames[subjectSelect.value], // 科目名稱
                    quizMode: quizMode, // 儲存模式
                    timestamp: serverTimestamp() // 時間戳
                };

                // 添加新文件，ID 由 Firestore 自動生成
                await addDoc(leaderboardCollectionRef, scoreData);
                console.log("saveQuizScoreToLeaderboard: 測驗分數已儲存至排行榜。", scoreData);
            } catch (error) {
                console.error("saveQuizScoreToLeaderboard: 儲存測驗分數至排行榜失敗：", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤：Firebase 權限被拒絕。請檢查您的 Firestore 安全規則，確保用戶可以在路徑 `/artifacts/{appId}/public/data/leaderboard_scores` 上寫入。");
                }
            }
        }

        /**
         * 將測驗歷史紀錄儲存到 Firestore。
         * 儲存路徑：/artifacts/{appId}/users/{userId}/quiz_history
         * 呼叫者：showQuizSummary
         * @param {string} subjectId - 科目 ID。
         * @param {number} finalScore - 測驗的最終分數。
         * @param {Array<Object>} quizQuestions - 測驗中的題目陣列。
         * @param {Array<Object>} answers - 用戶答案的陣列。
         * @param {string} mode - 測驗模式 ('practice' 或 'exam')。
         */
        async function saveQuizHistory(subjectId, finalScore, quizQuestions, answers, mode) {
            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("saveQuizHistory: Firebase 認證未準備就緒或參數缺失。無法儲存測驗歷史紀錄。");
                return;
            }

            const quizHistoryCollectionRef = collection(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_history');

            try {
                // 整理作答過的題目資訊，以便儲存
                const questionsAttempted = quizQuestions.map((q, index) => {
                    const userAnswer = answers[index];
                    return {
                        questionText: q.question, // 題目文本
                        options: q.options, // 儲存所有選項
                        answer: q.answer, // 儲存正確答案標籤 (例如 'A', 'B')
                        explanation: q.explanation, // 題目解釋
                        userSelectedOptionContent: userAnswer ? userAnswer.selectedOptionContent : '未作答', // 用戶選擇的選項內容
                        isCorrect: userAnswer ? userAnswer.isCorrect : false // 用戶答案是否正確
                    };
                });

                const historyData = {
                    subjectId: subjectId,
                    subjectName: subjectNames[subjectId], // 科目名稱
                    timestamp: serverTimestamp(), // 儲存時間戳
                    score: finalScore, // 最終分數
                    totalQuestions: quizQuestions.length, // 總題目數
                    correctAnswers: answers.filter(a => a && a.isCorrect).length, // 計算實際答對的題目數
                    quizMode: mode, // 測驗模式
                    // 呼叫 removeUndefined 確保沒有 undefined 值
                    questionsAttempted: removeUndefined(questionsAttempted) // 確保沒有 undefined 值
                };

                await addDoc(quizHistoryCollectionRef, historyData); // 添加新文件到歷史紀錄集合
                console.log("測驗歷史紀錄已成功儲存：", historyData);
            } catch (error) {
                console.error("儲存測驗歷史紀錄失敗：", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤：Firebase 權限被拒絕。請檢查您的 Firestore 安全規則，確保 quiz_history 集合的權限。");
                }
            }
        }

        /**
         * 從 Firestore 獲取並顯示排行榜分數。
         * 呼叫者：viewLeaderboardButton.addEventListener, viewLeaderboardButtonSummary.addEventListener
         */
        async function fetchLeaderboardScores() {
            // 呼叫 showGlobalLoading 顯示載入指示器
            showGlobalLoading(); // 顯示載入指示器
            console.log("fetchLeaderboardScores: 正在開始獲取排行榜分數...");
            console.log("fetchLeaderboardScores: db 實例:", db);
            console.log("fetchLeaderboardScores: effectiveAppId:", effectiveAppId);

            if (!isAuthReady || !db || !effectiveAppId) {
                console.error("fetchLeaderboardScores: Firebase 認證未準備就緒，Firestore 未初始化或應用程式 ID 無效，無法獲取排行榜分數。");
                leaderboardList.innerHTML = '<li>無法載入排行榜 (初始化中)。</li>';
                // 呼叫 hideGlobalLoading 隱藏載入指示器
                hideGlobalLoading(); // 隱藏載入指示器
                return;
            }

            const leaderboardCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'leaderboard_scores');
            console.log("Firestore collection path for leaderboard write:", leaderboardCollectionRef.path);
            
            try {
                // 查詢排行榜分數，按分數降序排序，然後按時間戳升序排序，限制前 100 名
                const q = query(leaderboardCollectionRef, orderBy('score', 'desc'), orderBy('timestamp', 'asc'), limit(100));
                console.log("fetchLeaderboardScores: 準備執行 getDocs 查詢...");
                const querySnapshot = await getDocs(q);
                console.log("fetchLeaderboardScores: getDocs 查詢完成。");

                leaderboardList.innerHTML = ''; // 清空之前的列表
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = '<li>目前沒有排行榜資料。</li>';
                    console.log("fetchLeaderboardScores: 排行榜為空。");
                    return;
                }

                let rank = 1;
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const listItem = document.createElement('li');
                    const timestampDate = data.timestamp ? data.timestamp.toDate() : new Date(); // 將時間戳轉換為 Date 物件
                    const formattedDate = timestampDate.toLocaleString('zh-TW', {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    // 顯示從 Firestore 讀取到的 'score' 欄位，該欄位應為計算後的總分
                    listItem.innerHTML = `
                        <span class="leaderboard-rank">${rank}.</span>
                        <span class="leaderboard-name">${data.displayName} (${data.subject} - ${data.quizMode === 'practice' ? '練習' : '正式'})</span>
                        <span class="leaderboard-score">${data.score} 分</span> 
                        <span class="text-sm text-gray-500 ml-4">${formattedDate}</span>
                    `;
                    // DOM 關係：listItem 是 leaderboardList 的子元素
                    leaderboardList.appendChild(listItem);
                    rank++;
                });
                console.log("fetchLeaderboardScores: 排行榜資料已顯示。");
            }
            catch (error) {
                console.error("fetchLeaderboardScores: 獲取排行榜分數失敗：", error);
                leaderboardList.innerHTML = '<li>載入排行榜失敗 (錯誤)。</li>';
                if (error.code === 'permission-denied') {
                    console.error("錯誤：Firebase 權限被拒絕。請檢查您的 Firestore 安全規則，確保對 `/artifacts/{appId}/public/data/leaderboard_scores` 的讀取權限。");
                }
            } finally {
                // 呼叫 hideGlobalLoading 隱藏載入指示器
                hideGlobalLoading(); // 無論成功或失敗，都隱藏載入
            }
        }

        /**
         * 從 Firestore 獲取並顯示測驗歷史紀錄。
         * 呼叫者：viewHistoryButton.addEventListener
         */
        async function fetchAndDisplayQuizHistory() {
            // 呼叫 showGlobalLoading 顯示載入指示器
            showGlobalLoading(); // 顯示載入指示器
            quizHistoryList.innerHTML = '<li>載入歷史紀錄中...</li>'; // 顯示載入訊息

            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("fetchAndDisplayQuizHistory: Firebase 認證未準備就緒或參數缺失。無法獲取歷史紀錄。");
                quizHistoryList.innerHTML = '<li>無法載入歷史紀錄 (初始化中)。</li>';
                // 呼叫 hideGlobalLoading 隱藏載入指示器
                hideGlobalLoading(); // 隱藏載入指示器
                return;
            }

            const quizHistoryCollectionRef = collection(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_history');
            try {
                // 獲取最新的 50 次嘗試，按時間戳降序排序
                const q = query(quizHistoryCollectionRef, orderBy('timestamp', 'desc'), limit(50)); 
                const querySnapshot = await getDocs(q);

                quizHistoryList.innerHTML = ''; // 清空之前的列表
                if (querySnapshot.empty) {
                    quizHistoryList.innerHTML = '<li>目前沒有測驗歷史紀錄。</li>';
                    return;
                }

                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const listItem = document.createElement('li');
                    const timestampDate = data.timestamp ? data.timestamp.toDate() : new Date();
                    const formattedDate = timestampDate.toLocaleString('zh-TW', {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    listItem.innerHTML = `
                        <span class="leaderboard-name">${data.subjectName} (${data.quizMode === 'practice' ? '練習' : '正式'})</span>
                        <span class="leaderboard-score">${data.score} 分 (${data.correctAnswers}/${data.totalQuestions} 題)</span>
                        <span class="text-sm text-gray-500 ml-4">${formattedDate}</span>
                        <button data-doc-id="${docSnap.id}" class="nav-button ml-4 text-sm px-3 py-1 rounded-md">查看詳情</button>
                    `;
                    // DOM 關係：listItem 是 quizHistoryList 的子元素
                    quizHistoryList.appendChild(listItem);

                    // 為「查看詳情」按鈕添加事件監聽器
                    listItem.querySelector('button').addEventListener('click', (event) => {
                        const docId = event.target.dataset.docId;
                        // 呼叫 displayDetailedQuizAttempt 顯示詳細的測驗嘗試
                        displayDetailedQuizAttempt(docId); // 顯示詳細的測驗嘗試
                    });
                });

            } catch (error) {
                console.error("獲取測驗歷史紀錄失敗：", error);
                quizHistoryList.innerHTML = '<li>載入歷史紀錄失敗 (錯誤)。</li>';
                if (error.code === 'permission-denied') {
                    console.error("錯誤：Firebase 權限被拒絕。請檢查 quiz_history 集合的 Firestore 安全規則。");
                }
            } finally {
                // 呼叫 hideGlobalLoading 隱藏載入指示器
                hideGlobalLoading(); // 隱藏載入指示器
            }
        }

        /**
         * 顯示歷史紀錄中特定測驗嘗試的詳細視圖。
         * 呼叫者：fetchAndDisplayQuizHistory (透過查看詳情按鈕的點擊事件)
         * @param {string} docId - Firestore 中測驗嘗試的文件 ID。
         */
        async function displayDetailedQuizAttempt(docId) {
            // 呼叫 showGlobalLoading 顯示載入指示器
            showGlobalLoading(); // 顯示載入指示器
            quizHistoryDetailModalOverlay.style.display = 'flex'; // 顯示歷史紀錄詳情模態框
            quizHistoryDetailContent.innerHTML = '載入詳情中...'; // 顯示載入訊息

            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("displayDetailedQuizAttempt: Firebase 認證未準備就緒或參數缺失。無法顯示詳情。");
                quizHistoryDetailContent.innerHTML = '無法載入詳情 (初始化中)。';
                // 呼叫 hideGlobalLoading 隱藏載入指示器
                hideGlobalLoading(); // 隱藏載入指示器
                return;
            }

            const docRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_history', docId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    quizHistoryDetailTitle.textContent = `${data.subjectName} (${data.quizMode === 'practice' ? '練習' : '正式'}) - ${data.score} 分`;
                    quizHistoryDetailContent.innerHTML = ''; // 清空之前內容

                    if (data.questionsAttempted && data.questionsAttempted.length > 0) {
                        data.questionsAttempted.forEach((q, index) => {
                            const itemDiv = document.createElement('div');
                            // DOM 關係：itemDiv 是 quizHistoryDetailContent 的子元素
                            itemDiv.className = `question-item ${q.isCorrect ? 'correct' : 'incorrect'} bg-white border rounded-lg p-4 mb-4 shadow-sm`;

                            itemDiv.innerHTML = `
                                <p class="question-text-all"><strong>${index + 1}. ${q.questionText}</strong></p>
                                <p class="your-answer-text ${q.isCorrect ? 'text-green-700' : 'text-blue-700'}">您的答案：${q.userSelectedOptionContent}</p>
                                <p class="correct-answer-text-all text-green-700 mt-2">正確答案：${q.options[optionLabels.indexOf(q.answer)]}</p>
                                <p class="explanation-text-all text-purple-700 mt-2">${q.explanation}</p>
                            `;
                            quizHistoryDetailContent.appendChild(itemDiv);
                        });
                    } else {
                        quizHistoryDetailContent.innerHTML = '<p>此測驗沒有詳細的題目紀錄。</p>';
                    }
                } else {
                    quizHistoryDetailContent.innerHTML = '<p>找不到此測驗紀錄。</p>';
                }
            } catch (error) {
                console.error("獲取測驗歷史紀錄詳情失敗：", error);
                quizHistoryDetailContent.innerHTML = '載入詳情失敗 (錯誤)。';
            } finally {
                // 呼叫 hideGlobalLoading 隱藏載入指示器
                hideGlobalLoading(); // 隱藏載入指示器
            }
        }

        /**
         * 生成並顯示所有歷史紀錄中答錯題目的統計資料。
         * 呼叫者：viewIncorrectStatsButton.addEventListener
         */
        async function generateAndDisplayIncorrectQuestionStats() {
            // 呼叫 showGlobalLoading 顯示載入指示器
            showGlobalLoading(); // 顯示載入指示器
            quizHistoryDetailContent.innerHTML = '載入錯題統計中...'; // 顯示載入訊息

            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("generateAndDisplayIncorrectQuestionStats: Firebase 認證未準備就緒或參數缺失。無法生成統計。");
                quizHistoryDetailContent.innerHTML = '無法載入錯題統計 (初始化中)。';
                // 呼叫 hideGlobalLoading 隱藏載入指示器
                hideGlobalLoading(); // 隱藏載入指示器
                return;
            }

            const quizHistoryCollectionRef = collection(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_history');
            let incorrectQuestionMap = new Map(); // Map 用於儲存 {questionText: {count: N, questionData: {}}}

            try {
                const querySnapshot = await getDocs(quizHistoryCollectionRef); // 獲取所有歷史紀錄

                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.questionsAttempted && data.questionsAttempted.length > 0) {
                        data.questionsAttempted.forEach(q => {
                            if (!q.isCorrect) { // 如果題目答錯
                                // 使用題目文本作為簡單的唯一識別符進行統計
                                const questionIdentifier = q.questionText; 
                                if (incorrectQuestionMap.has(questionIdentifier)) {
                                    const currentStats = incorrectQuestionMap.get(questionIdentifier);
                                    currentStats.count++; // 錯誤次數增加
                                    // 更新為最近一次錯誤嘗試的答案，以便顯示
                                    currentStats.userSelectedOptionContent = q.userSelectedOptionContent; 
                                    incorrectQuestionMap.set(questionIdentifier, currentStats);
                                } else {
                                    incorrectQuestionMap.set(questionIdentifier, {
                                        count: 1, // 初始錯誤次數為 1
                                        questionText: q.questionText,
                                        options: q.options,
                                        answer: q.answer,
                                        explanation: q.explanation,
                                        userSelectedOptionContent: q.userSelectedOptionContent 
                                    });
                                }
                            }
                        });
                    }
                });

                quizHistoryDetailContent.innerHTML = ''; // 清空載入訊息
                quizHistoryDetailTitle.textContent = '錯題統計'; // 設定標題

                if (incorrectQuestionMap.size === 0) {
                    quizHistoryDetailContent.innerHTML = '<p>太棒了！您目前沒有錯題紀錄。</p>';
                    return;
                }

                // 按錯誤次數排序錯題 (錯誤次數最多的排在前面)
                const sortedIncorrectQuestions = Array.from(incorrectQuestionMap.values()).sort((a, b) => b.count - a.count);

                sortedIncorrectQuestions.forEach((stats, index) => {
                    const itemDiv = document.createElement('div');
                    // DOM 關係：itemDiv 是 quizHistoryDetailContent 的子元素
                    itemDiv.className = `question-item incorrect bg-white border rounded-lg p-4 mb-4 shadow-sm`;

                    itemDiv.innerHTML = `
                        <p class="question-text-all"><strong>${index + 1}. ${stats.questionText}</strong> (錯誤次數: ${stats.count})</p>
                        <p class="your-answer-text text-blue-700">您最近一次的錯誤答案：${stats.userSelectedOptionContent}</p>
                        <p class="correct-answer-text-all text-green-700 mt-2">正確答案：${stats.options[optionLabels.indexOf(stats.answer)]}</p>
                        <p class="explanation-text-all text-purple-700 mt-2">${stats.explanation}</p>
                    `;
                    quizHistoryDetailContent.appendChild(itemDiv);
                });

            } catch (error) {
                console.error("生成錯題統計失敗：", error);
                quizHistoryDetailContent.innerHTML = '載入錯題統計失敗 (錯誤)。';
            } finally {
                // 呼叫 hideGlobalLoading 隱藏載入指示器
                hideGlobalLoading(); // 隱藏載入指示器
            }
        }

        /**
         * 分享測驗結果。
         * 呼叫者：shareResultsButton.addEventListener
         */
        async function shareQuizResults() {
            const quizTitle = "iPAS初級AI應用規劃師模擬測驗";
            const subjectName = subjectNames[subjectSelect.value];
            const finalScorePoints = score * POINTS_PER_QUESTION; // 計算最終分數
            const finalScoreDisplay = `${finalScorePoints} 分`; // 顯示分數
            const message = summaryMessageElement.textContent; // 總結訊息
            const userName = currentUserDisplayName || '匿名用戶'; // 用戶名稱

            let shareText = `我在「${quizTitle}」的「${subjectName}」測驗中，獲得了 ${finalScoreDisplay}！\n${message}\n\n`;
            shareText += `我的暱稱是：${userName}\n`;

            // 這裡不再僅顯示錯題數量，而是總結答題情況
            const answeredQuestionsCount = userAnswers.filter(answer => answer !== undefined).length;
            const totalQuestionsCount = selectedQuizData.length;
            
            if (answeredQuestionsCount < totalQuestionsCount) {
                shareText += `我完成了 ${answeredQuestionsCount} / ${totalQuestionsCount} 題，其中答對了 ${score} 題。`;
            } else {
                shareText += `我完成了所有 ${totalQuestionsCount} 題，其中答對了 ${score} 題。`;
            }
            shareText += `\n\n立即來挑戰：${window.location.href}`; 

            try {
                if (navigator.share) {
                    // 如果瀏覽器支援 Web Share API，則使用它
                    await navigator.share({
                        title: quizTitle,
                        text: shareText,
                        url: window.location.href,
                    });
                    // 呼叫 showConfirmationModal 顯示分享成功訊息
                    showConfirmationModal('分享成功', '測驗結果已成功分享！', null, true);
                } else {
                    // 否則，回退到複製到剪貼簿
                    const tempInput = document.createElement('textarea');
                    tempInput.value = shareText;
                    // DOM 關係：tempInput 元素被暫時添加到 body 中
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy'); // 執行複製命令
                    document.body.removeChild(tempInput);
                    // 呼叫 showConfirmationModal 顯示複製成功訊息
                    showConfirmationModal('複製成功', '測驗結果已複製到剪貼簿！您可以貼到任何地方。', null, true);
                }
            } catch (error) {
                console.error('分享失敗：', error);
                // 檢查錯誤是否為用戶取消分享
                if (error.name !== 'AbortError') {
                    // 呼叫 showConfirmationModal 顯示分享失敗訊息
                    showConfirmationModal('分享失敗', '無法分享測驗結果。您的瀏覽器可能不支援分享功能，或發生其他錯誤。結果已嘗試複製到剪貼簿。', null, true);
                } else {
                    console.log('分享已取消。');
                }
            }
        }

        // 頁面載入初始化邏輯
        document.addEventListener('DOMContentLoaded', async () => {
            // 呼叫 showGlobalLoading 顯示載入指示器
            showGlobalLoading(); // 在 DOMContentLoaded 時顯示載入指示器
            environmentSelectionScreen.style.display = 'flex'; // 顯示環境選擇畫面
            initialSelectionScreen.style.display = 'none'; // 隱藏初始選擇畫面
            quizContent.style.display = 'none'; // 隱藏測驗內容
            quizSummary.classList.remove('show'); // 隱藏測驗總結
            timerDisplay.style.display = 'none'; // 隱藏計時器
            userIdModalOverlay.style.display = 'none'; // 隱藏用戶 ID 模態框
            leaderboardModalOverlay.style.display = 'none'; // 隱藏排行榜模態框
            quizHistoryModalOverlay.style.display = 'none'; // 隱藏歷史紀錄模態框
            quizHistoryDetailModalOverlay.style.display = 'none'; // 隱藏歷史紀錄詳情模態框
            reportProblemModalOverlay.style.display = 'none'; // 新增：確保回報問題模態框初始隱藏
            reportProblemSuccessMessage.style.display = 'none'; // 確保成功訊息初始隱藏
            
            // 由於用戶計數顯示在不同畫面，因此初始時隱藏
            userCountDisplay.style.display = 'none'; 

            // 在環境選擇畫面顯示最後更新時間
            lastUpdatedDisplay.textContent = '應用程式載入時間：' + new Date().toLocaleString('zh-TW');
            
            // 初始化 Firebase 服務
            // 呼叫 initializeFirebaseServices 初始化 Firebase
            await initializeFirebaseServices();
            // 呼叫 hideGlobalLoading 隱藏載入指示器
            hideGlobalLoading(); // DOMContentLoaded 完成後隱藏載入指示器

            // 為分享結果按鈕添加事件監聽器 (確保在 DOMContentLoaded 後執行)
            shareResultsButton.addEventListener('click', shareQuizResults);

            // 為排行榜按鈕添加事件監聽器
            viewLeaderboardButton.addEventListener('click', async () => {
                leaderboardModalOverlay.style.display = 'flex'; // 顯示排行榜模態框
                // 呼叫 fetchLeaderboardScores 載入並顯示排行榜分數
                await fetchLeaderboardScores(); // 載入並顯示排行榜分數
            });
            viewLeaderboardButtonSummary.addEventListener('click', async () => {
                leaderboardModalOverlay.style.display = 'flex'; // 顯示排行榜模態框
                // 呼叫 fetchLeaderboardScores 載入並顯示排行榜分數
                await fetchLeaderboardScores(); // 載入並顯示排行榜分數
            });

            // 為排行榜模態框關閉按鈕添加事件監聽器
            leaderboardModalClose.addEventListener('click', () => {
                leaderboardModalOverlay.style.display = 'none'; // 隱藏排行榜模態框
            });

            // 新增：為歷史紀錄按鈕添加事件監聽器
            viewHistoryButton.addEventListener('click', async () => {
                quizHistoryModalOverlay.style.display = 'flex'; // 顯示歷史紀錄模態框
                // 呼叫 fetchAndDisplayQuizHistory 載入並顯示歷史紀錄
                await fetchAndDisplayQuizHistory(); // 載入並顯示歷史紀錄
            });

            // 新增：為歷史紀錄模態框關閉按鈕添加事件監聽器
            quizHistoryModalClose.addEventListener('click', () => {
                quizHistoryModalOverlay.style.display = 'none'; // 隱藏歷史紀錄模態框
            });

            // 新增：為歷史紀錄詳情模態框關閉按鈕添加事件監聽器
            quizHistoryDetailModalClose.addEventListener('click', () => {
                quizHistoryDetailModalOverlay.style.display = 'none'; // 隱藏歷史紀錄詳情模態框
            });

            // 新增：為查看錯題統計按鈕添加事件監聽器
            viewIncorrectStatsButton.addEventListener('click', async () => {
                quizHistoryModalOverlay.style.display = 'none'; // 隱藏歷史紀錄列表
                quizHistoryDetailModalOverlay.style.display = 'flex'; // 顯示詳情模態框
                quizHistoryDetailTitle.textContent = '錯題統計'; // 設定詳情模態框標題為「錯題統計」
                // 呼叫 generateAndDisplayIncorrectQuestionStats 生成並顯示錯題統計
                await generateAndDisplayIncorrectQuestionStats(); // 生成並顯示錯題統計
            });


            // ========== START: 新增的回報問題功能 JavaScript 程式碼 ==========
            // 顯示回報問題模態框
            if (showReportProblemBtn) {
                showReportProblemBtn.addEventListener('click', () => {
                    if (reportProblemModalOverlay) {
                        // 清空所有選中的 radio
                        document.querySelectorAll('input[name="reportType"]').forEach(radio => radio.checked = false);
                        reportProblemSuccessMessage.style.display = 'none'; // 隱藏成功訊息
                        
                        // 顯示當前問題的編號和文本
                        reportedQuestionNumber.textContent = currentQuestionIndex + 1;
                        reportedQuestionText.textContent = selectedQuizData[currentQuestionIndex].question;
                        reportedQuestionIndex.value = currentQuestionIndex; // 儲存問題索引
                        reportedQuestionOriginalText.value = selectedQuizData[currentQuestionIndex].question; // 儲存問題原始文本

                        // 確保提交和取消按鈕顯示
                        submitProblemBtn.style.display = 'inline-block';
                        closeReportBoxBtn.style.display = 'inline-block';

                        reportProblemModalOverlay.style.display = 'flex'; // 顯示模態框疊加層
                    }
                });
            }

            // 關閉回報問題模態框 (透過右上角的 X 按鈕)
            if (reportProblemModalClose) {
                reportProblemModalClose.addEventListener('click', () => {
                    if (reportProblemModalOverlay) {
                        reportProblemModalOverlay.style.display = 'none'; // 隱藏模態框疊加層
                        document.querySelectorAll('input[name="reportType"]').forEach(radio => radio.checked = false); // 清空選中
                        reportProblemSuccessMessage.style.display = 'none'; // 隱藏成功訊息
                    }
                });
            }

            // 關閉回報問題模態框 (透過「取消」按鈕)
            if (closeReportBoxBtn) { // 這是原來的 closeReportBoxBtn，現在作為取消按鈕
                closeReportBoxBtn.addEventListener('click', () => {
                    if (reportProblemModalOverlay) {
                        reportProblemModalOverlay.style.display = 'none'; // 隱藏模態框疊加層
                        document.querySelectorAll('input[name="reportType"]').forEach(radio => radio.checked = false); // 清空選中
                        reportProblemSuccessMessage.style.display = 'none'; // 隱藏成功訊息
                    }
                });
            }

            // 處理提交問題回報到 Firebase
            if (submitProblemBtn) {
                submitProblemBtn.addEventListener('click', async () => { // 注意這裡需要 async
                    const selectedReportType = document.querySelector('input[name="reportType"]:checked'); // 獲取選中的回報類型

                    if (!selectedReportType) {
                        // 呼叫 showConfirmationModal 顯示提示
                        showConfirmationModal("提示", "請選擇一個回報類型！", null, true); // 使用自定義模態框顯示提示
                        return;
                    }

                    const reportType = selectedReportType.value; // 獲取回報類型的值
                    const questionIndex = reportedQuestionIndex.value; // 獲取問題索引
                    const questionText = reportedQuestionOriginalText.value; // 獲取問題原始文本
                    const currentQuestionData = selectedQuizData[questionIndex]; // 獲取當前問題的完整數據

                    try {
                        // 將問題回報資料添加到 Firestore 的 'reports' 集合中
                        await addDoc(collection(db, 'reports'), {
                            reportType: reportType, // 使用選定的回報類型
                            questionIndex: parseInt(questionIndex) + 1, // 儲存問題編號 (從1開始)
                            questionText: questionText, // 儲存問題文本
                            subjectId: subjectSelect.value, // 測驗科目ID
                            subjectName: subjectNames[subjectSelect.value], // 測驗科目名稱
                            // 包含問題的選項和正確答案，以便更容易理解回報
                            questionOptions: currentQuestionData.options,
                            questionAnswer: currentQuestionData.answer,
                            timestamp: serverTimestamp(), // 伺服器時間戳
                            userId: currentUserId || 'anonymous', // 用戶 ID
                            userName: currentUserDisplayName || '匿名用戶', // 用戶名稱
                        });

                        // 顯示成功訊息並在短暫延遲後關閉回報視窗
                        reportProblemSuccessMessage.style.display = 'block'; // 顯示成功訊息
                        document.querySelectorAll('input[name="reportType"]').forEach(radio => radio.checked = false); // 清空選中
                        // 隱藏提交和取消按鈕
                        submitProblemBtn.style.display = 'none';
                        closeReportBoxBtn.style.display = 'none';

                        setTimeout(() => {
                            reportProblemModalOverlay.style.display = 'none'; // 隱藏模態框疊加層
                            reportProblemSuccessMessage.style.display = 'none'; // 隱藏成功訊息
                            // 恢復按鈕顯示 (如果需要，例如下次打開時)
                            submitProblemBtn.style.display = 'inline-block';
                            closeReportBoxBtn.style.display = 'inline-block';
                        }, 2000); // 2 秒後自動關閉

                    } catch (error) {
                        console.error("回報問題時發生錯誤:", error);
                        // 呼叫 showConfirmationModal 顯示錯誤訊息
                        showConfirmationModal("錯誤", "回報問題時發生錯誤，請稍後再試。", null, true); // 使用自定義模態框顯示錯誤
                        reportProblemSuccessMessage.style.display = 'none'; // 確保錯誤時隱藏成功訊息
                    }
                });
            }
            // ========== END: 新增的回報問題功能 JavaScript 程式碼 ==========


            // 添加 visibilitychange 監聽器，用於精確計時器控制和進度儲存
            document.addEventListener('visibilitychange', async () => {
                // 僅在測驗內容顯示、用戶已登入且有題目資料時才處理
                if (quizContent.style.display === 'block' && currentUserId && selectedQuizData.length > 0) {
                    if (document.hidden) {
                        // 頁面被隱藏，停止計時器並儲存進度
                        // 呼叫 stopTimer 停止計時器
                        stopTimer();
                        lastActiveTime = Date.now(); // 更新最後活躍時間
                        // 呼叫 saveQuizProgress 儲存進度
                        await saveQuizProgress(subjectSelect.value);
                        console.log("Page hidden. Timer paused, progress saved.");
                    } else {
                        // 頁面可見，載入進度並恢復計時器
                        console.log("Page visible. Loading progress and resuming timer.");
                        const currentSubjectId = subjectSelect.value;
                        // 呼叫 loadQuizProgress 載入進度
                        loadedProgressData = await loadQuizProgress(currentSubjectId);
                        if (loadedProgressData) {
                            // 計算隱藏期間經過的時間
                            const hiddenTimeElapsedMs = Date.now() - (loadedProgressData.lastActiveTime || loadedProgressData.quizStartTime);
                            const hiddenTimeElapsedSeconds = Math.floor(hiddenTimeElapsedMs / 1000);
                            
                            // 從剩餘時間中減去經過的時間
                            timeRemaining = (loadedProgressData.timeRemaining ?? quizDurationInSeconds) - hiddenTimeElapsedSeconds;
                            if (timeRemaining < 0) timeRemaining = 0; // 確保時間不為負數

                            currentQuestionIndex = loadedProgressData.currentQuestionIndex ?? 0;
                            userAnswers = loadedProgressData.userAnswers || [];
                            score = loadedProgressData.score ?? 0;
                            incorrectQuestions = loadedProgressData.incorrectQuestions || [];
                            selectedQuizData = loadedProgressData.selectedQuizData || [];
                            quizStartTime = loadedProgressData.quizStartTime ?? Date.now();
                            quizMode = loadedProgressData.quizMode ?? 'practice'; // 從進度中載入測驗模式

                            // 呼叫 loadQuestion 重新載入當前題目以反映狀態
                            loadQuestion(); // 重新載入當前題目以反映狀態
                            // 呼叫 startTimer 恢復計時器
                            startTimer(); // 恢復計時器
                            console.log(`Timer resumed. Hidden for ${hiddenTimeElapsedSeconds} seconds. Time remaining: ${formatTime(timeRemaining)}`);
                        } else {
                            // 如果沒有找到進度 (例如首次載入或已清除)，則在測驗活躍時直接重新啟動計時器
                            // 呼叫 startTimer 重新啟動計時器
                            startTimer();
                            console.log("No saved progress to load, just resuming timer.");
                        }
                    }
                }
            });

            // 添加 beforeunload 監聽器，在頁面關閉前儲存進度
            window.addEventListener('beforeunload', async () => {
                // 僅在測驗內容顯示、用戶已登入且有題目資料時才儲存
                if (quizContent.style.display === 'block' && currentUserId && selectedQuizData.length > 0) {
                    // 僅在用戶至少作答過一道題目時才儲存
                    if (userAnswers.length > 0) {
                        // 在卸載前，確保 lastActiveTime 更新為當前時間
                        lastActiveTime = Date.now(); 
                        // 呼叫 saveQuizProgress 儲存測驗進度
                        await saveQuizProgress(subjectSelect.value); // 儲存測驗進度
                        console.log("Page unloading. Progress saved.");
                    }
                }
            });
        });
    </script>
</body>
</html>
