<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 應用規劃師能力測驗</title>
    <!-- Tailwind CSS CDN - 用於快速構建響應式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 字體 - 提供現代且易讀的字體樣式 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* 基本樣式設定，確保內容垂直居中 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        /* 測驗容器樣式，包含陰影和圓角，並設定背景動畫 */
        .quiz-container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center; /* 水平居中 */
            justify-content: center; /* 垂直居中 */
            position: relative;
            overflow: hidden; /* 隱藏超出容器的內容，用於背景動畫 */
            min-height: 400px; /* 確保容器有足夠高度來居中內容 */
        }
        /* 測驗容器的偽元素，用於創建脈衝背景動畫 */
        .quiz-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, #e0f2fe, #ffffff);
            animation: pulse 10s infinite alternate;
            z-index: 0;
            opacity: 0.3;
        }
        /* 脈衝動畫關鍵幀 */
        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.3; }
            100% { transform: scale(1.1); opacity: 0.5; }
        }
        /* 內容包裹器，確保內容在背景動畫之上 */
        .content-wrapper {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        /* 載入訊息的樣式 */
        .loading-message {
            font-size: 1.5rem;
            color: #4a5568;
            margin-top: 50px;
        }
        /* 科目選擇區塊樣式，響應式佈局 */
        .subject-selection {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        @media (min-width: 640px) {
            .subject-selection {
                flex-direction: row;
                justify-content: center;
            }
        }
        /* 下拉選單樣式 */
        .subject-selection select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #cbd5e0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            background-color: #f7fafc;
            appearance: none; /* 移除預設箭頭 */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20fill%3D%22%234A5568%22%20d%3D%22M9.293%2012.95l.707.707L15.657%208l-1.414-1.414L10%2010.828%206.757%207.586%205.343%209z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        .subject-selection select:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* 開始測驗按鈕樣式 */
        .start-quiz-button {
            background-color: #48bb78;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.3);
        }
        .start-quiz-button:hover:not(:disabled) {
            background-color: #38a169;
            transform: translateY(-2px);
        }
        .start-quiz-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* 初始選擇畫面樣式 */
        #initial-selection-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        /* 科目標題樣式 */
        .subject-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 問題編號樣式 */
        .question-number {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 10px;
            font-weight: 600;
        }
        /* 問題文本樣式 */
        .question-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        /* 選項容器樣式 */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            text-align: left;
        }
        /* 選項按鈕樣式 */
        .option-button {
            background-color: #edf2f7;
            color: #4a5568;
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .option-button:hover:not(.disabled):not(.correct):not(.incorrect) {
            background-color: #e2e8f0;
            border-color: #cbd5e0;
        }
        /* 選中選項的樣式 */
        .option-button.selected {
            border-color: #63b3ed;
            background-color: #ebf8ff;
            color: #2b6cb0;
        }
        /* 正確選項的樣式 */
        .option-button.correct {
            background-color: #d4edda; /* 淺綠色 */
            border-color: #48bb78; /* 綠色 */
            color: #2f855a;
        }
        /* 錯誤選項的樣式 */
        .option-button.incorrect {
            background-color: #fde8e8; /* 淺紅色 */
            border-color: #ef4444; /* 紅色 */
            color: #c53030;
        }
        /* 選項標籤樣式 (A, B, C, D) */
        .option-label {
            font-weight: bold;
            min-width: 25px;
            text-align: center;
        }
        /* 回饋容器樣式 */
        .feedback-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: left;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            display: none; /* 預設隱藏 */
            font-size: 1rem;
            line-height: 1.6;
        }
        .feedback-container.show {
            display: block;
        }
        /* 回饋標題樣式 */
        .feedback-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #2d3748;
        }
        /* 回饋文本樣式 */
        .feedback-text {
            color: #4a5568;
        }
        /* 導航按鈕容器樣式 */
        .navigation-buttons {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        /* 導航按鈕樣式 */
        .nav-button {
            background-color: #4299e1;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.3);
        }
        .nav-button:hover:not(:disabled) {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .nav-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* 提交測驗按鈕樣式 */
        .submit-quiz-button {
            background-color: #ef4444; /* 紅色 */
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        .submit-quiz-button:hover:not(:disabled) {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .submit-quiz-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* 測驗總結區塊 (預設隱藏) */
        .quiz-summary {
            margin-top: 30px;
            padding: 30px;
            background-color: #e6fffa;
            border-radius: 15px;
            border: 2px solid #38b2ac;
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 600;
            display: none; /* 預設隱藏 */
        }
        .quiz-summary.show {
            display: block;
        }
        /* 總結標題樣式 */
        .summary-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 總結分數樣式 */
        .summary-score {
            font-size: 2rem;
            color: #38b2ac;
            font-weight: 800;
            margin-bottom: 20px;
        }
        /* 總結訊息樣式 */
        .summary-message {
            font-size: 1.3rem;
            color: #4a5568;
            margin-bottom: 30px;
        }
        /* 重新測驗按鈕樣式 */
        .restart-button {
            background-color: #48bb78;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.3);
        }
        .restart-button:hover {
            background-color: #38a169;
            transform: translateY(-2px);
        }
        /* 錯題總結區塊樣式 */
        .incorrect-questions-summary {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #cbd5e0;
        }
        /* 錯題項目樣式 */
        .incorrect-questions-summary .incorrect-question-item {
            background-color: #fefcbf; /* 淺黃色 */
            border: 2px solid #ef4444; /* 紅色邊框 */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        /* 錯題文本樣式 */
        .incorrect-questions-summary .question-text-incorrect {
            font-weight: 700;
            color: #8b5f00; /* 深黃色 */
            margin-bottom: 10px;
        }
        /* 正確答案文本樣式 */
        .incorrect-questions-summary .correct-answer-text {
            font-weight: 600;
            color: #2f855a; /* 綠色 */
            margin-top: 5px;
        }
        /* 解釋文本樣式 */
        .incorrect-questions-summary .explanation-text {
            font-size: 0.95rem;
            color: #6b46c1; /* 紫色 */
            margin-top: 10px;
        }

        /* 新增：所有題目總結區塊樣式 */
        .all-questions-summary {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #cbd5e0;
        }
        /* 新增：所有題目項目樣式 */
        .all-questions-summary .question-item {
            background-color: #f7fafc; /* 淺灰色 */
            border: 1px solid #e2e8f0; /* 淺邊框 */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .all-questions-summary .question-item.correct {
            background-color: #e6fffa; /* 淺綠色 */
            border-color: #38b2ac; /* 青綠色 */
        }
        .all-questions-summary .question-item.incorrect {
            background-color: #fde8e8; /* 淺紅色 */
            border-color: #ef4444; /* 紅色 */
        }
        /* 新增：問題文本樣式 */
        .all-questions-summary .question-text-all {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }
        /* 新增：您的答案樣式 */
        .all-questions-summary .your-answer-text {
            font-weight: 600;
            color: #4299e1; /* 藍色 */
            margin-top: 5px;
        }
        /* 新增：正確答案樣式 */
        .all-questions-summary .correct-answer-text-all {
            font-weight: 600;
            color: #2f855a; /* 綠色 */
            margin-top: 5px;
        }
        /* 新增：解釋文本樣式 */
        .all-questions-summary .explanation-text-all {
            font-size: 0.95rem;
            color: #6b46c1; /* 紫色 */
            margin-top: 10px;
        }

        /* Gemini 模態框疊加層樣式 */
        .gemini-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* Gemini 模態框內容樣式 */
        .gemini-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            position: relative;
            text-align: left;
        }
        /* Gemini 模態框關閉按鈕樣式 */
        .gemini-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }
        .gemini-modal-close:hover {
            color: #4a5568;
        }
        /* Gemini 模態框標題樣式 */
        .gemini-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* Gemini 模態框輸入區文本域樣式 */
        .gemini-modal-input-area textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 80px;
            resize: vertical;
            margin-bottom: 15px;
        }
        .gemini-modal-input-area textarea:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* Gemini 模態框按鈕容器樣式 */
        .gemini-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* Gemini 模態框提交按鈕樣式 */
        .gemini-modal-submit-button {
            background-color: #4299e1;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .gemini-modal-submit-button:hover {
            background-color: #3182ce;
        }
        /* Gemini 模態框取消按鈕樣式 */
        .gemini-modal-cancel-button {
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .gemini-modal-cancel-button:hover {
            background-color: #718096;
        }
        /* Gemini 模態框載入中指示器樣式 */
        .gemini-modal-loading {
            text-align: center;
            margin-top: 20px;
            font-size: 1.1rem;
            color: #4a5568;
        }
        /* Gemini 模態框回應區樣式 */
        .gemini-modal-response {
            margin-top: 20px;
            padding: 15px;
            background-color: #e6fffa;
            border: 1px solid #38b2ac;
            border-radius: 10px;
            font-size: 1rem;
            color: #2d3748;
            white-space: pre-wrap; /* 保留空白和換行 */
            max-height: 300px;
            overflow-y: auto;
        }
        /* 詢問 Gemini 按鈕樣式 */
        .ask-gemini-button {
            background-color: #805ad5; /* 紫色 */
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(128, 90, 213, 0.3);
            margin-top: 20px;
        }
        .ask-gemini-button:hover {
            background-color: #6b46c1;
            transform: translateY(-2px);
        }

        /* API 金鑰輸入模態框疊加層樣式 */
        .api-key-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* 高於 Gemini 模態框 */
        }
        /* API 金鑰輸入模態框內容樣式 */
        .api-key-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: left;
        }
        /* API 金鑰模態框標題樣式 */
        .api-key-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* API 金鑰模態框輸入區輸入框樣式 */
        .api-key-modal-input-area input {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .api-key-modal-input-area input:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* API 金鑰模態框按鈕容器樣式 */
        .api-key-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* API 金鑰模態框提交按鈕樣式 */
        .api-key-modal-submit-button {
            background-color: #48bb78;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .api-key-modal-submit-button:hover {
            background-color: #38a169;
        }
        /* API 金鑰模態框取消按鈕樣式 */
        .api-key-modal-cancel-button {
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .api-key-modal-cancel-button:hover {
            background-color: #718096;
        }

        /* 計時器顯示樣式 */
        .timer-display {
            position: absolute;
            top: 1rem;
            right: 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            background-color: #e0f2fe;
            padding: 8px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: none; /* 預設隱藏 */
        }

        /* 確認模態框疊加層樣式 */
        .confirmation-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002; /* 高於其他模態框 */
        }
        /* 確認模態框內容樣式 */
        .confirmation-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        /* 確認模態框標題樣式 */
        .confirmation-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 確認模態框訊息樣式 */
        .confirmation-modal-message {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 25px;
        }
        /* 確認模態框按鈕容器樣式 */
        .confirmation-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        /* 確認模態框按鈕樣式 */
        .confirmation-modal-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        /* 確認按鈕 (是) 樣式 */
        .confirm-yes {
            background-color: #ef4444;
            color: white;
        }
        .confirm-yes:hover {
            background-color: #dc2626;
        }
        /* 確認按鈕 (否) 樣式 */
        .confirm-no {
            background-color: #a0aec0;
            color: white;
        }
        .confirm-no:hover {
            background-color: #718096;
        }

        /* 題目數量顯示樣式 */
        .question-counts {
            margin-top: 20px;
            font-size: 1.1rem;
            color: #4a5568;
            text-align: center;
        }
        .question-counts p {
            margin-bottom: 5px;
        }

        /* 環境選擇畫面樣式 */
        #environment-selection-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        /* 環境選擇按鈕樣式 */
        .env-button {
            background-color: #6366f1; /* 靛藍色 */
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        .env-button:hover {
            background-color: #4f46e5;
            transform: translateY(-2px);
        }

        /* 用戶計數顯示樣式 */
        #user-count-display {
            margin-top: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            background-color: #e2f8f5; /* 淺青色 */
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #38b2ac;
            display: none; /* 預設隱藏，在認證後顯示 */
            margin-bottom: 20px;
        }

        /* 繼續測驗提示樣式 */
        #continue-quiz-prompt {
            display: none; /* 預設隱藏 */
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            text-align: center;
        }
        #continue-quiz-prompt p {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }
        /* 繼續和開始新測驗按鈕容器樣式 */
        .continue-quiz-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        @media (min-width: 640px) {
            .continue-quiz-buttons {
                flex-direction: row;
            }
        }
        /* 繼續和開始新測驗按鈕樣式 */
        .continue-button, .start-new-button {
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .continue-button {
            background-color: #4299e1;
            color: white;
        }
        .continue-button:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .start-new-button {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .start-new-button:hover {
            background-color: #cbd5e0;
            transform: translateY(-2px);
        }

        /* 使用者 ID 輸入模態框疊加層樣式 */
        #user-id-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1003; /* 最高層級 */
        }
        /* 使用者 ID 輸入模態框內容樣式 */
        #user-id-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: left;
        }
        /* 使用者 ID 模態框標題樣式 */
        #user-id-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 使用者 ID 模態框輸入區輸入框樣式 */
        #user-id-modal-input-area input {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        #user-id-modal-input-area input:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* 使用者 ID 模態框按鈕容器樣式 */
        #user-id-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* 提交使用者 ID 按鈕樣式 */
        #submit-user-id-button {
            background-color: #48bb78;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        #submit-user-id-button:hover {
            background-color: #38a169;
        }
        /* 取消使用者 ID 按鈕樣式 */
        #cancel-user-id-button {
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        #cancel-user-id-button:hover {
            background-color: #718096;
        }

        /* 排行榜模態框疊加層樣式 */
        #leaderboard-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* 預設隱藏 */
            justify-content: center;
            align-items: center;
            z-index: 1004; /* 高於其他模態框 */
        }
        /* 排行榜模態框內容樣式 */
        #leaderboard-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            position: relative;
            text-align: center;
        }
        /* 排行榜模態框關閉按鈕樣式 */
        #leaderboard-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }
        .leaderboard-modal-close:hover {
            color: #4a5568;
        }
        /* 排行榜標題樣式 */
        #leaderboard-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 排行榜列表樣式 */
        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        /* 排行榜列表項目樣式 */
        #leaderboard-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #edf2f7;
            font-size: 1.1rem;
            color: #4a5568;
        }
        #leaderboard-list li:last-child {
            border-bottom: none;
        }
        #leaderboard-list li:nth-child(odd) {
            background-color: #f7fafc;
        }
        /* 排行榜前三名樣式 */
        #leaderboard-list li:first-child {
            background-color: #fff3e0; /* 金色 */
            font-weight: 700;
            color: #e65100;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        #leaderboard-list li:nth-child(2) {
            background-color: #eceff1; /* 銀色 */
            font-weight: 600;
            color: #546e7a;
        }
        #leaderboard-list li:nth-child(3) {
            background-color: #fbe9e7; /* 青銅色 */
            font-weight: 600;
            color: #bf360c;
        }
        /* 排行榜排名樣式 */
        .leaderboard-rank {
            font-weight: 700;
            min-width: 30px;
            text-align: left;
        }
        /* 排行榜名稱樣式 */
        .leaderboard-name {
            flex-grow: 1;
            text-align: left;
            margin-left: 15px;
        }
        /* 排行榜分數樣式 */
        .leaderboard-score {
            font-weight: 700;
            color: #2d3748;
        }
        /* 查看排行榜按鈕樣式 */
        .view-leaderboard-button {
            background-color: #667eea; /* 靛藍色 */
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            margin-top: 20px;
        }
        .view-leaderboard-button:hover {
            background-color: #5a67d8;
            transform: translateY(-2px);
        }
        /* 分享結果按鈕樣式 */
        .share-results-button {
            background-color: #38b2ac; /* 青綠色 */
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(56, 178, 172, 0.3);
            margin-top: 15px;
        }
        .share-results-button:hover {
            background-color: #319795;
            transform: translateY(-2px);
        }
        /* 新增：模式選擇按鈕樣式 */
        .mode-button {
            background-color: #4299e1; /* 藍色 */
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.3);
        }
        .mode-button:hover:not(.selected-mode) {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .mode-button.selected-mode {
            background-color: #2b6cb0; /* 更深的藍色 */
            cursor: default;
            box-shadow: 0 4px 10px rgba(43, 108, 176, 0.4);
        }
		/* 歷史紀錄圖卡 */
        .leaderboard-modal-content {
		  background-color: white;
		  padding: 24px;
		  border-radius: 12px;
		  width: 600px;
		  max-height: 80vh;
		  overflow-y: auto;
		  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
		  position: relative;
		  z-index: 100; /* 確保在遮罩上層 */
		}
		.gemini-modal-close {
		  position: absolute;
		  top: 16px;
		  right: 20px;
		  font-size: 24px;
		  font-weight: bold;
		  color: #666;
		  cursor: pointer;
		  transition: color 0.2s ease;
		}

		.gemini-modal-close:hover {
		  color: #000;
		}

		/* 歷史紀錄按鈕 */
		.view-history-button {
			background-color: #805ad5;
			color: white;
			padding: 12px 25px;
			border-radius: 10px;
			font-size: 1.1rem;
			font-weight: 600;
			cursor: pointer;
			transition: background-color 0.3s ease, transform 0.2s ease;
			border: none;
			box-shadow: 0 4px 10px rgba(128, 90, 213, 0.3);
			margin-top: 20px;
			letter-spacing: 0.5px;
		}
		.view-history-button:hover {
			background-color: #6b46c1;
			transform: translateY(-2px);
		}
		.view-history-button:focus {
			outline: 2px solid #c4b5fd;
			outline-offset: 2px;
		}

		/* 遮罩層 */
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.6);
			backdrop-filter: blur(2px);
			display: flex;
			justify-content: center;
			align-items: center;
			flex-direction: column;
			z-index: 9999;
			color: white;
			font-size: 1.5rem;
			text-align: center;
		}

		/* Loading Spinner */
		.spinner {
			border: 8px solid rgba(255, 255, 255, 0.2);
			border-top: 8px solid #ffffff;
			border-radius: 50%;
			width: 60px;
			height: 60px;
			animation: spin 1.2s linear infinite;
			margin-bottom: 20px;
		}

		@keyframes spin {
			0%   { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

    </style>
</head>
<body>
    <div class="quiz-container">
        <div class="content-wrapper">
            <!-- 環境選擇畫面 -->
            <div id="environment-selection-screen" class="flex flex-col items-center justify-center h-full">
                <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">iPAS AI應用規劃師模模擬測驗</h1>
                <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">選擇執行環境</h2>
                <div class="flex flex-col sm:flex-row gap-6">
                    <button id="select-canvas-env" class="env-button">在 Canvas 環境啟動</button>
                    <button id="select-github-env" class="env-button">使用 GitHub Pages 環境</button>
                </div>
                <p class="text-gray-600 mt-8 text-center">
                    非Canvas環境下，請點擊這裡啟動環境：<br>
                    <a href="https://g.co/gemini/share/384e247e4b93" target="_blank" class="text-blue-500 hover:underline font-semibold">前往 Gemini 啟動環境</a>
                </p>
                <div id="last-updated-display" class="mt-4 text-gray-600 text-sm">
                    <!-- 最後更新時間將在此顯示 -->
                </div>
            </div>

            <!-- 初始科目選擇畫面 (預設隱藏) -->
            <div id="initial-selection-screen" style="display: none;">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">iPAS初級AI應用規劃師模擬測驗</h1>

                <div id="user-count-display">
                    <!-- 用戶計數將在此顯示 -->
                </div>

                <!-- 繼續測驗提示 -->
                <div id="continue-quiz-prompt">
                    <p id="continue-quiz-message"></p>
                    <div class="continue-quiz-buttons">
                        <button id="continue-quiz-button" class="continue-button">繼續測驗</button>
                        <button id="start-new-quiz-button" class="start-new-button">開始新測驗 (將覆蓋舊進度)</button>
                    </div>
                </div>

                <!-- 模式選擇區域 -->
                <div id="mode-selection-area" class="flex flex-col sm:flex-row gap-4 mb-6">
                    <button id="practice-mode-button" class="mode-button selected-mode">練習模式</button>
                    <button id="exam-mode-button" class="mode-button">正式考試</button>
                </div>

                <!-- 科目選擇區域 (預設隱藏) -->
                <div id="subject-selection-area">
                    <div class="subject-selection">
                        <label for="subject-select" class="sr-only">選擇科目</label>
                        <select id="subject-select">
                            <option value="topic1_ai_intro.json">科目一：人工智慧基礎概論</option>
                            <option value="topic2_generative_ai_app_planning.json">科目二：生成式 AI 應用與規劃</option>
                        </select>
                        <button id="start-quiz-button" class="start-quiz-button">開始測驗</button>
                    </div>
                    <div id="question-counts" class="question-counts">
                        <!-- 題目數量將在此顯示 -->
                    </div>
                </div>
                <button id="view-leaderboard-button" class="view-leaderboard-button">查看排行榜</button> <!-- 排行榜按鈕 -->
                <button id="view-history-button" class="view-history-button">查看歷史紀錄</button> <!-- 新增：查看歷史紀錄按鈕 -->
            </div>

            <!-- 測驗內容區塊 (預設隱藏) -->
            <div id="quiz-content" style="display: none;">
                <div class="timer-display" id="timer-display">00:00</div> <!-- 計時器顯示區塊 -->
                <div class="subject-title" id="current-subject-title"></div> <!-- 動態顯示科目標題 -->
                <div class="question-number" id="question-number"></div>
                <div class="question-text" id="question-text"></div>
                <div class="options-container" id="options-container">
                    <!-- 選項將由 JavaScript 載入 -->
                </div>
                <div class="feedback-container" id="feedback-container">
                    <div class="feedback-title" id="feedback-title"></div>
                    <div class="feedback-text" id="feedback-text-content"></div>
                    <button id="ask-gemini-button" class="ask-gemini-button" style="display: none;">✨ 向 Gemini 提問</button>
                </div>
                <div class="navigation-buttons">
                    <button id="prev-button" class="nav-button" disabled>上一題</button>
                    <button id="next-button" class="nav-button">下一題</button>
                    <button id="submit-early-button" class="submit-quiz-button">交卷</button> <!-- 新增交卷按鈕 -->
                </div>
            </div>
            <div id="loading-indicator" class="loading-message" style="display: none;">載入題目中，請稍候...</div>
            <!-- 測驗總結區塊 (預設隱藏) -->
            <div class="quiz-summary" id="quiz-summary">
                <div class="summary-title">測驗結果</div>
                <div class="summary-score" id="summary-score"></div>
                <div class="summary-message" id="summary-message"></div>
                <div id="all-questions-summary" class="all-questions-summary text-left"></div> <!-- 新增：所有題目總結區塊 -->
                <button id="restart-button" class="restart-button">重新測驗</button>
                <button id="view-leaderboard-button-summary" class="view-leaderboard-button mt-4">查看排行榜</button> <!-- 測驗結果頁面的排行榜按鈕 -->
                <button id="share-results-button" class="share-results-button mt-4">分享結果</button> <!-- 新增分享結果按鈕 -->
            </div>
        </div>
    </div>

    <!-- Gemini 模態框 -->
    <div id="gemini-modal-overlay" class="gemini-modal-overlay" style="display: none;">
        <div class="gemini-modal-content">
            <span class="gemini-modal-close" id="gemini-modal-close">&times;</span>
            <div class="gemini-modal-title">向 Gemini 提問</div>
            <div class="gemini-modal-input-area">
                <p class="text-sm text-gray-600 mb-2">請輸入您想針對此題目詢問 Gemini 的問題：</p>
                <textarea id="gemini-question-input" placeholder="例如：這個概念還有哪些應用？或是提供更多相關資訊..."></textarea>
                <div class="gemini-modal-buttons">
                    <button id="gemini-modal-cancel-button" class="gemini-modal-cancel-button">取消</button>
                    <button id="submit-gemini-question-button" class="gemini-modal-submit-button">送出問題</button>
                </div>
            </div>
            <div id="gemini-loading-indicator" class="gemini-modal-loading" style="display: none;">
                載入中... 請稍候 ✨
            </div>
            <div id="gemini-response-area" class="gemini-modal-response" style="display: none;">
                <!-- Gemini 的回應將在此顯示 -->
            </div>
        </div>
    </div>

    <!-- API 金鑰輸入模態框 -->
    <div id="api-key-modal-overlay" class="api-key-modal-overlay" style="display: none;">
        <div class="api-key-modal-content">
            <div class="api-key-modal-title">請輸入您的 Gemini API 金鑰</div>
            <p class="text-sm text-gray-600 mb-4">
                為了在非 Canvas 環境下使用 Gemini 提問功能，請在此輸入您的 Gemini API 金鑰。
                您可以從 <a href="https://g.co/gemini/share/0d8dc04f3cdf" target="_blank" class="text-blue-500 hover:underline">Google AI Studio</a> 獲取。
            </p>
            <div class="api-key-modal-input-area">
                <input type="text" id="gemini-api-key-input" placeholder="您的 Gemini API 金鑰">
                <div class="api-key-modal-buttons">
                    <button id="api-key-modal-cancel-button" class="api-key-modal-cancel-button">取消</button>
                    <button id="submit-api-key-button" class="api-key-modal-submit-button">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 確認模態框 -->
    <div id="confirmation-modal-overlay" class="confirmation-modal-overlay" style="display: none;">
        <div class="confirmation-modal-content">
            <div class="confirmation-modal-title">確認交卷</div>
            <div class="confirmation-modal-message">您確定要提前交卷嗎？交卷後將無法再修改答案。</div>
            <div class="confirmation-modal-buttons">
                <button id="confirm-yes-button" class="confirmation-modal-button confirm-yes">確定交卷</button>
                <button id="confirm-no-button" class="confirmation-modal-button confirm-no">取消</button>
            </div>
        </div>
    </div>

    <!-- 使用者 ID 輸入模態框 -->
    <div id="user-id-modal-overlay" class="api-key-modal-overlay" style="display: none;">
        <div id="user-id-modal-content" class="api-key-modal-content">
            <div id="user-id-modal-title" class="api-key-modal-title">請輸入您的使用者暱稱</div>
            <p class="text-sm text-gray-600 mb-4">
                這個暱稱將用於識別您的測驗進度。您可以輸入任何您喜歡的名稱。
            </p>
            <div id="user-id-modal-input-area" class="api-key-modal-input-area">
                <input type="text" id="user-id-input" placeholder="您的使用者暱稱">
                <div id="user-id-modal-buttons" class="api-key-modal-buttons">
                    <button id="cancel-user-id-button" class="api-key-modal-cancel-button">取消</button>
                    <button id="submit-user-id-button" class="api-key-modal-submit-button">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 排行榜模態框 -->
    <div id="leaderboard-modal-overlay" class="leaderboard-modal-overlay" style="display: none;">
        <div id="leaderboard-modal-content" class="leaderboard-modal-content">
            <span class="gemini-modal-close" id="leaderboard-modal-close">&times;</span>
            <div id="leaderboard-title" class="leaderboard-title">排行榜</div>
            <ul id="leaderboard-list">
                <!-- 排行榜條目將在此載入 -->
            </ul>
        </div>
    </div>

    <!-- 測驗歷史紀錄模態框 (新增) -->
    <div id="quiz-history-modal-overlay" class="leaderboard-modal-overlay fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
        <div id="quiz-history-modal-content" class="leaderboard-modal-content">
            <span class="gemini-modal-close" id="quiz-history-modal-close">&times;</span>
            <div id="quiz-history-title" class="leaderboard-title">測驗歷史紀錄</div>
            <ul id="quiz-history-list" class="leaderboard-list">
                <!-- 歷史紀錄條目將在此載入 -->
            </ul>
            <button id="view-incorrect-stats-button" class="view-leaderboard-button mt-4">查看錯題統計</button>
        </div>
    </div>

    <!-- 歷史紀錄詳情/錯題統計模態框 (新增，共用 Gemini modal 的樣式) -->
    <div id="quiz-history-detail-modal-overlay" class="gemini-modal-overlay" style="display: none;">
        <div class="gemini-modal-content">
            <span class="gemini-modal-close" id="quiz-history-detail-modal-close">&times;</span>
            <div class="gemini-modal-title" id="quiz-history-detail-title">測驗詳情</div>
            <div id="quiz-history-detail-content" class="gemini-modal-response" style="display: block; max-height: 500px; overflow-y: auto;">
                <!-- 測驗詳情或錯題統計將在此載入 -->
            </div>
        </div>
    </div>

    <!-- 全域載入覆蓋層 -->
    <div id="global-loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <div>載入中...</div>
    </div>

    <script type="module">
        // Import Firebase SDK modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, getDoc, getDocs, serverTimestamp, query, orderBy, limit, addDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js"; 

        // Firebase related variables and initialization
        let app;
        let db;
        let auth;
        let currentEnvironment = ''; // 'canvas' or 'github-pages'
        let effectiveAppId = ''; // Stores the actual appId used
        let currentUserId = ''; // Stores the current logged-in user's Firebase UID
        let currentUserDisplayName = ''; // Stores the user's custom display name
        let isAuthReady = false; // New flag to indicate Firebase authentication is ready

        // Firebase project configuration (ensure this is your actual configuration)
        // In the Canvas environment, __firebase_config will be preferred
        const defaultFirebaseConfig = {
          apiKey: "***REMOVED***",
          authDomain: "ipas-ai-planner-exam.firebaseapp.com",
          projectId: "ipas-ai-planner-exam",
          storageBucket: "ipas-ai-planner-exam.firebasestorage.app",
          appId: "1:1018339017757:web:934bf9c05ea898fdd972f4", // <-- Set default appId here
          measurementId: "G-5WWRYNKFJ6"
        };

        // Quiz application related variables
        let fullQuizData = []; // Stores all questions loaded from JSON
        let selectedQuizData = []; // Stores 50 randomly selected questions
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0; // Stores the number of correct answers
        let incorrectQuestions = []; // Stores incorrectly answered questions
        const optionLabels = ['A', 'B', 'C', 'D']; // Option labels (A, B, C, D)
        let loadedProgressData = null; // Stores progress data loaded from Firestore
        const POINTS_PER_QUESTION = 2; // Points per question
        let quizMode = 'practice'; // New: Default to 'practice' mode

        // DOM element retrieval
        const environmentSelectionScreen = document.getElementById('environment-selection-screen');
        const selectCanvasEnvButton = document.getElementById('select-canvas-env');
        const selectGithubEnvButton = document.getElementById('select-github-env');

        const initialSelectionScreen = document.getElementById('initial-selection-screen');
        const subjectSelectionArea = document.getElementById('subject-selection-area');
        const continueQuizPrompt = document.getElementById('continue-quiz-prompt');
        const continueQuizMessage = document.getElementById('continue-quiz-message');
        const continueQuizButton = document.getElementById('continue-quiz-button');
        const startNewQuizButton = document.getElementById('start-new-quiz-button');

        const modeSelectionArea = document.getElementById('mode-selection-area'); // New: Mode selection area
        const practiceModeButton = document.getElementById('practice-mode-button'); // New: Practice mode button
        const examModeButton = document.getElementById('exam-mode-button'); // New: Exam mode button

        const subjectSelect = document.getElementById('subject-select');
        const startQuizButton = document.getElementById('start-quiz-button');
        const currentSubjectTitle = document.getElementById('current-subject-title');
        const questionNumberElement = document.getElementById('question-number');
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackTitleElement = document.getElementById('feedback-title');
        const feedbackTextContentElement = document.getElementById('feedback-text-content');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const submitEarlyButton = document.getElementById('submit-early-button');
        const quizContent = document.getElementById('quiz-content');
        const quizSummary = document.getElementById('quiz-summary');
        const summaryScoreElement = document.getElementById('summary-score');
        const summaryMessageElement = document.getElementById('summary-message');
        const allQuestionsSummaryElement = document.getElementById('all-questions-summary'); // All questions summary
        const restartButton = document.getElementById('restart-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const questionCountsElement = document.getElementById('question-counts');
        const userCountDisplay = document.getElementById('user-count-display'); // Now on initial-selection-screen
        const lastUpdatedDisplay = document.getElementById('last-updated-display'); // New element on environment-selection-screen

        // Gemini API related DOM elements
        const askGeminiButton = document.getElementById('ask-gemini-button');
        const geminiModalOverlay = document.getElementById('gemini-modal-overlay');
        const geminiModalClose = document.getElementById('gemini-modal-close');
        const geminiQuestionInput = document.getElementById('gemini-question-input');
        const submitGeminiQuestionButton = document.getElementById('submit-gemini-question-button');
        const geminiModalCancelButton = document.getElementById('gemini-modal-cancel-button');
        const geminiLoadingIndicator = document.getElementById('gemini-loading-indicator');
        const geminiResponseArea = document.getElementById('gemini-response-area');

        // API Key input modal related DOM elements
        const apiKeyModalOverlay = document.getElementById('api-key-modal-overlay');
        const geminiApiKeyInput = document.getElementById('gemini-api-key-input');
        const submitApiKeyButton = document.getElementById('submit-api-key-button');
        const apiKeyModalCancelButton = document.getElementById('api-key-modal-cancel-button');

        // Confirmation modal related DOM elements
        const confirmationModalOverlay = document.getElementById('confirmation-modal-overlay');
        const confirmYesButton = document.getElementById('confirm-yes-button');
        const confirmNoButton = document.getElementById('confirm-no-button');

        // User ID input modal related DOM elements
        const userIdModalOverlay = document.getElementById('user-id-modal-overlay');
        const userIdInput = document.getElementById('user-id-input');
        const submitUserIdButton = document.getElementById('submit-user-id-button');
        const cancelUserIdButton = document.getElementById('cancel-user-id-button');

        // Leaderboard related DOM elements
        const viewLeaderboardButton = document.getElementById('view-leaderboard-button');
        const viewLeaderboardButtonSummary = document.getElementById('view-leaderboard-button-summary');
        const leaderboardModalOverlay = document.getElementById('leaderboard-modal-overlay');
        const leaderboardModalClose = document.getElementById('leaderboard-modal-close');
        const leaderboardList = document.getElementById('leaderboard-list');

        // New: History related DOM elements
        const viewHistoryButton = document.getElementById('view-history-button');
        const quizHistoryModalOverlay = document.getElementById('quiz-history-modal-overlay');
        const quizHistoryModalClose = document.getElementById('quiz-history-modal-close');
        const quizHistoryList = document.getElementById('quiz-history-list');
        const quizHistoryDetailModalOverlay = document.getElementById('quiz-history-detail-modal-overlay');
        const quizHistoryDetailModalClose = document.getElementById('quiz-history-detail-modal-close');
        const quizHistoryDetailTitle = document.getElementById('quiz-history-detail-title');
        const quizHistoryDetailContent = document.getElementById('quiz-history-detail-content');
        const viewIncorrectStatsButton = document.getElementById('view-incorrect-stats-button');

        // Share results button DOM element
        const shareResultsButton = document.getElementById('share-results-button');

        // Global loading overlay DOM element
        const globalLoadingOverlay = document.getElementById('global-loading-overlay');

        // Global variable for Gemini API key
        let geminiApiKey = ""; 

        // Timer variables
        const quizDurationInSeconds = 75 * 60; // 75 minutes
        let timeRemaining = quizDurationInSeconds;
        let timerInterval;
        const timerDisplay = document.getElementById('timer-display');
        let quizStartTime = 0; // Timestamp when the quiz officially started (or resumed)
        let lastActiveTime = 0; // Timestamp of the last time the timer was active (page visible)

        // Subject name mapping table
        const subjectNames = {
            'topic1_ai_intro.json': '科目一：人工智慧基礎概論',
            'topic2_generative_ai_app_planning.json': '科目二：生成式 AI 應用與規劃'
        };

        /**
         * Displays the global loading overlay.
         */
        function showGlobalLoading() {
            globalLoadingOverlay.style.display = 'flex';
        }

        /**
         * Hides the global loading overlay.
         */
        function hideGlobalLoading() {
            globalLoadingOverlay.style.display = 'none';
        }

        /**
         * Fisher-Yates shuffle algorithm, used to randomize an array.
         * @param {Array} array - The array to shuffle.
         * @returns {Array} - The shuffled array.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                // Correct array destructuring assignment for swapping elements
                [array[i], array[j]] = [array[j], array[i]]; 
            }
            return array;
        }

        /**
         * Recursively removes all undefined values from an object or array.
         * Firestore does not support undefined values, this function cleans data to meet Firestore requirements.
         * @param {any} obj - The object or value to clean.
         * @returns {any} - The cleaned object or value, with undefined values removed.
         */
        function removeUndefined(obj) {
            if (obj === null || typeof obj !== 'object') {
                return obj;
            }

            if (Array.isArray(obj)) {
                // Recursively process each element in the array and filter out undefined results
                return obj.map(item => removeUndefined(item)).filter(item => item !== undefined);
            }

            const newObj = {};
            for (const key in obj) {
                // Ensure only own properties of the object are processed, not those on the prototype chain
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    const value = obj[key];
                    if (value !== undefined) {
                        // Recursively process nested objects
                        newObj[key] = removeUndefined(value);
                    }
                }
            }
            return newObj;
        }

        /**
         * Tracks user visits, recording information about each unique visitor in Firestore.
         * @param {string} appIdToUse - The current application ID.
         */
        async function trackUserVisit(appIdToUse) {
            if (!isAuthReady || !db || !currentUserId || !appIdToUse) {
                console.warn("trackUserVisit: Firebase auth not ready or parameters missing. Skipping user visit tracking.");
                return;
            }
            const userId = currentUserId; // Use the globally set Firebase UID
            if (!userId) {
                console.error("Failed to track user visit: User ID not available.");
                return;
            }

            // Add a short delay to ensure Firestore data sync (for diagnosis)
            await new Promise(resolve => setTimeout(resolve, 500)); 

            // Construct Firestore document reference path: /artifacts/{appId}/public/data/user_visits/{userId}
            const userDocRef = doc(collection(db, 'artifacts', appIdToUse, 'public', 'data', 'user_visits'), userId); 
            console.log("Firestore document path for write:", userDocRef.path);
            console.log("Attempting Firestore operation with UID:", userId);

            try {
                const docSnap = await getDoc(userDocRef); 
                if (!docSnap.exists()) { // If the document does not exist, it's a new visitor
                    // Record new visitor information
                    await setDoc(userDocRef, { 
                        firstVisit: serverTimestamp(), // First visit timestamp
                        lastVisit: serverTimestamp(),  // Last visit timestamp
                        userId: userId,                // Firebase UID
                        displayName: currentUserDisplayName || '匿名用戶' // User display name or default value
                    });
                    console.log(`New user visit recorded successfully: ${userId}`); 
                } else {
                    // If the document already exists, update last visit timestamp and display name
                    await setDoc(userDocRef, { 
                        lastVisit: serverTimestamp(),
                        displayName: currentUserDisplayName || '匿名用戶'
                    }, { merge: true }); // Use merge: true to avoid overwriting other fields
                    console.log(`User already recorded, updated last visit time: ${userId}`);
                }
            } catch (error) {
                console.error("Failed to track user visit:", error);
                if (error.code === 'permission-denied') {
                    console.error("Error: Firebase permission denied. Please check your Firestore security rules to ensure anonymous users can read/write on path `/artifacts/{appId}/public/data/user_visits/{userId}`.");
                }
            }
        }

        /**
         * Fetches and displays the count of unique visitors from Firestore.
         */
        async function getAndDisplayUserCount() {
            userCountDisplay.textContent = '正在載入訪問人數...';
            console.log("getAndDisplayUserCount: Starting to load visitor count...");
            console.log("getAndDisplayUserCount: db instance:", db);
            console.log("getAndDisplayUserCount: effectiveAppId:", effectiveAppId);

            // Add a short delay to ensure Firebase is fully initialized and connected
            await new Promise(resolve => setTimeout(resolve, 500)); 

            if (!isAuthReady || !db || !effectiveAppId) {
                console.warn("getAndDisplayUserCount: Firebase auth not ready, Firestore not initialized or App ID invalid, cannot fetch visitor count. db:", db, "effectiveAppId:", effectiveAppId);
                userCountDisplay.textContent = '無法載入訪問人數 (初始化中/錯誤)。請檢查控制台錯誤訊息。';
                return;
            }

            try {
                // Reference the user_visits collection
                const userVisitsCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'user_visits');
                console.log("getAndDisplayUserCount: Attempting to read user_visits collection from Firestore...");
                const querySnapshot = await getDocs(userVisitsCollectionRef);
                const userCount = querySnapshot.size; // The number of documents is the count of unique visitors

                userCountDisplay.textContent = `總訪問人數 (獨立訪客)：${userCount} 人`;
                console.log(`getAndDisplayUserCount: Successfully fetched visitor count: ${userCount} people`);
            } catch (error) {
                console.error("getAndDisplayUserCount: Failed to fetch visitor count:", error);
                userCountDisplay.textContent = '無法載入訪問人數 (錯誤)。請檢查控制台錯誤訊息。';
                if (error.code === 'permission-denied') {
                    console.error("Error: Firebase permission denied. Please check your Firestore security rules to ensure read access to `/artifacts/{appId}/public/data/user_visits`.");
                }
            }
        }

        /**
         * Loads quiz progress for a given subject from Firestore.
         * @param {string} subjectId - The subject ID.
         * @returns {Promise<Object|null>} - Quiz progress data or null.
         */
        async function loadQuizProgress(subjectId) {
            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("loadQuizProgress: Firebase auth not ready or parameters missing. Cannot load progress.");
                return null;
            }

            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);
            console.log(`loadQuizProgress: Attempting to load progress for subject: ${subjectId}, user: ${currentUserId}`);

            try {
                const docSnap = await getDoc(progressDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log(`loadQuizProgress: Quiz progress loaded for ${subjectId}:`, data);
                    return data;
                } else {
                    console.log(`loadQuizProgress: No quiz progress found for subject: ${subjectId}`);
                    return null;
                }
            } catch (error) {
                console.error("loadQuizProgress: Failed to load quiz progress:", error);
                if (error.code === 'permission-denied') {
                    console.error("Error: Firebase permission denied. Please check your Firestore security rules to ensure anonymous users can read on path `/artifacts/{appId}/users/{userId}/quiz_progress/{subjectId}`.");
                }
                return null;
            }
        }

        /**
         * Checks and displays if there is saved quiz progress.
         */
        async function checkAndDisplaySavedProgress() {
            if (!isAuthReady || !currentUserId) {
                console.log("checkAndDisplaySavedProgress: User ID or Firebase auth not ready, cannot check progress.");
                return;
            }

            const defaultSubject = subjectSelect.value;
            loadedProgressData = await loadQuizProgress(defaultSubject);

            if (loadedProgressData && loadedProgressData.selectedQuizData && loadedProgressData.selectedQuizData.length > 0) {
                continueQuizMessage.textContent = `您有未完成的「${subjectNames[defaultSubject]}」測驗進度 (暱稱: ${currentUserDisplayName || '匿名用戶'})。`;
                continueQuizPrompt.style.display = 'flex'; // Show continue quiz prompt
                subjectSelectionArea.style.display = 'none'; // Hide subject selection area
                modeSelectionArea.style.display = 'none'; // Hide mode selection area
                console.log("checkAndDisplaySavedProgress: Found saved progress.");
            } else {
                continueQuizPrompt.style.display = 'none'; // Hide continue quiz prompt
                subjectSelectionArea.style.display = 'block'; // Show subject selection area
                modeSelectionArea.style.display = 'flex'; // Show mode selection area
                getQuestionCounts(); // Display question counts
                console.log("checkAndDisplaySavedProgress: No saved progress found or progress is empty.");
            }
        }

        /**
         * Gets the unique identifier for a question.
         * Recommendation: If your JSON question data has an 'id' field, prioritize using it.
         * Otherwise, use the 'question' text as the identifier.
         * @param {Object} question - The question object.
         * @returns {string} - The unique identifier for the question.
         */
        function getQuestionIdentifier(question) {
            // Prioritize using the 'id' field in the question (if it exists)
            if (question.id) {
                return question.id;
            }
            // Otherwise, use the question text as the identifier
            return question.question;
        }

        /**
         * Initializes quiz data: randomly selects 50 questions from the full set,
         * prioritizing unplayed questions.
         */
        function initializeQuizData() {
            const currentSubjectId = subjectSelect.value;
            const playedQuestionIdsKey = `played_questions_${currentSubjectId}`;
            const playedQuestionIds = new Set(JSON.parse(localStorage.getItem(playedQuestionIdsKey) || '[]'));

            let newQuestions = [];
            let recycledQuestions = [];

            // Divide questions into "new questions" and "already played questions"
            fullQuizData.forEach(question => {
                const questionId = getQuestionIdentifier(question);
                if (playedQuestionIds.has(questionId)) {
                    recycledQuestions.push(question);
                } else {
                    newQuestions.push(question);
                }
            });

            // Shuffle new questions and recycled questions
            shuffleArray(newQuestions);
            shuffleArray(recycledQuestions);

            selectedQuizData = [];
            const desiredQuizLength = 50;

            // Prioritize selecting from new questions
            for (let i = 0; i < newQuestions.length && selectedQuizData.length < desiredQuizLength; i++) {
                selectedQuizData.push(newQuestions[i]);
            }

            // If new questions are not enough, supplement from recycled questions
            for (let i = 0; i < recycledQuestions.length && selectedQuizData.length < desiredQuizLength; i++) {
                selectedQuizData.push(recycledQuestions[i]);
            }

            // If the final selected questions are less than desiredQuizLength, supplement randomly from fullQuizData
            // This is mainly for cases where the total number of questions is less than desiredQuizLength
            if (selectedQuizData.length < desiredQuizLength && fullQuizData.length > 0) {
                const missingCount = desiredQuizLength - selectedQuizData.length;
                const remainingQuestions = shuffleArray([...fullQuizData]); // Reshuffle all questions
                const currentSelectedIds = new Set(selectedQuizData.map(q => getQuestionIdentifier(q)));

                for (let i = 0; i < remainingQuestions.length && selectedQuizData.length < desiredQuizLength; i++) {
                    const question = remainingQuestions[i];
                    const questionId = getQuestionIdentifier(question);
                    if (!currentSelectedIds.has(questionId)) {
                        selectedQuizData.push(question);
                        currentSelectedIds.add(questionId); // Update selected ID set
                    }
                }
            }

            // Finally, update playedQuestionIds in localStorage
            const currentQuizQuestionIds = selectedQuizData.map(q => getQuestionIdentifier(q));
            localStorage.setItem(playedQuestionIdsKey, JSON.stringify(currentQuizQuestionIds));

            console.log(`initializeQuizData: Selected ${selectedQuizData.length} questions for subject ${currentSubjectId}. Including ${newQuestions.length} new questions and ${recycledQuestions.length} recycled questions.`);
        }


        /**
         * Loads and displays the current question and its options.
         */
        function loadQuestion() {
            if (selectedQuizData.length === 0) {
                questionTextElement.textContent = '無法載入題目。請檢查 JSON 檔案。';
                optionsContainer.innerHTML = '';
                prevButton.disabled = true;
                nextButton.disabled = true;
                submitEarlyButton.disabled = true;
                console.error("loadQuestion: selectedQuizData is empty.");
                return;
            }

            const questionData = selectedQuizData[currentQuestionIndex];
            currentSubjectTitle.textContent = subjectNames[subjectSelect.value]; // Ensure current subject name is displayed here
            questionNumberElement.textContent = `問題 ${currentQuestionIndex + 1} / ${selectedQuizData.length}`;
            questionTextElement.textContent = questionData.question;
            optionsContainer.innerHTML = ''; // Clear options

            // Pair option content with their original labels, so correct answer can be tracked after shuffling
            const optionsWithOriginalLabels = questionData.options.map((optionContent, index) => ({
                content: optionContent,
                originalLabel: optionLabels[index]
            }));

            // Shuffle options
            const shuffledOptions = shuffleArray(optionsWithOriginalLabels);

            shuffledOptions.forEach((optionItem, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                // Display new option labels (A, B, C, D) and option content
                button.innerHTML = `<span class="option-label">${optionLabels[index]}</span> ${optionItem.content}`;
                // Store the original label for this option content, used for checking answer correctness
                button.dataset.originalLabelForContent = optionItem.originalLabel;
                // Store actual content, for display in feedback
                button.dataset.optionContent = optionItem.content; 

                // Add click event listener to the button
                button.addEventListener('click', () => selectOption(button, optionItem.originalLabel));
                optionsContainer.appendChild(button);
            });

            // If the user has previously answered this question, display their choice and feedback
            if (userAnswers[currentQuestionIndex]) {
                const selectedOriginalLabel = userAnswers[currentQuestionIndex].selectedOriginalLabel;
                const correctOptionLabel = selectedQuizData[currentQuestionIndex].answer;

                const buttons = optionsContainer.querySelectorAll('.option-button');
                buttons.forEach(button => {
                    button.classList.add('disabled'); // Disable all options
                    if (button.dataset.originalLabelForContent === selectedOriginalLabel) {
                        button.classList.add('selected');
                        // In practice mode, show correct/incorrect immediately
                        if (quizMode === 'practice') {
                            if (selectedOriginalLabel === correctOptionLabel) {
                                button.classList.add('correct');
                            } else {
                                button.classList.add('incorrect');
                            }
                        }
                    }
                    // In practice mode, mark correct answer
                    if (quizMode === 'practice' && button.dataset.originalLabelForContent === correctOptionLabel) {
                        button.classList.add('correct');
                    }
                });
                // Only show feedback and Gemini button in practice mode
                if (quizMode === 'practice') {
                    showFeedback(selectedQuizData[currentQuestionIndex].explanation, userAnswers[currentQuestionIndex].isCorrect);
                    askGeminiButton.style.display = 'inline-block'; // Show Gemini button
                } else {
                    hideFeedback();
                    askGeminiButton.style.display = 'none'; // Hide Gemini button in exam mode
                }
            } else {
                hideFeedback();
                askGeminiButton.style.display = 'none'; // Hide Gemini button
            }

            // Clear Gemini modal content
            geminiQuestionInput.value = '';
            geminiResponseArea.innerHTML = '';
            geminiResponseArea.style.display = 'none';
            geminiLoadingIndicator.style.display = 'none';

            updateNavigationButtons();
            console.log(`loadQuestion: Loaded question ${currentQuestionIndex + 1}. Current score: ${score}, User answers count: ${userAnswers.length}, Incorrect questions count: ${incorrectQuestions.length}, Mode: ${quizMode}`);
        }

        /**
         * Handles the logic when a user selects an option.
         * @param {HTMLElement} selectedButton - The option button element clicked by the user.
         * @param {string} selectedOriginalLabel - The original label (A, B, C, D) of the selected option.
         */
        async function selectOption(selectedButton, selectedOriginalLabel) {
            // If there is already an answer, do not allow re-selection
            if (userAnswers[currentQuestionIndex]) {
                console.log(`selectOption: Question ${currentQuestionIndex + 1} already answered. Skipping.`);
                return;
            }

            const buttons = optionsContainer.querySelectorAll('.option-button');
            buttons.forEach(button => {
                button.classList.remove('selected');
                button.classList.add('disabled'); // Disable all options
            });

            selectedButton.classList.add('selected');

            const questionData = selectedQuizData[currentQuestionIndex];
            const correctOptionLabel = questionData.answer; // Original label of the correct answer (e.g., 'C')
            
            // Get the actual content of the correct answer based on the original label
            const correctOptionContent = questionData.options[optionLabels.indexOf(correctOptionLabel)];

            // Check if the original label of the selected option matches the original label of the correct answer
            const isCorrect = (selectedOriginalLabel === correctOptionLabel);

            if (isCorrect) {
                score++; // Increment score if correct
                console.log(`selectOption: Question ${currentQuestionIndex + 1} correct. Current score: ${score}`);
            } else {
                // Record incorrectly answered question (only for internal tracking)
                incorrectQuestions.push({
                    question: questionData.question,
                    selectedOption: selectedOriginalLabel, // Store original label
                    selectedOptionContent: selectedButton.dataset.optionContent, // Actual content
                    correctOption: correctOptionLabel, // Original correct label (A, B, C, D)
                    correctOptionContent: correctOptionContent, // Actual content of the correct option
                    explanation: questionData.explanation
                });
                console.log(`selectOption: Question ${currentQuestionIndex + 1} incorrect. Current score: ${score}, Incorrect questions count: ${incorrectQuestions.length}`);
            }

            // Store user's answer
            userAnswers[currentQuestionIndex] = {
                selectedOriginalLabel: selectedOriginalLabel,
                isCorrect: isCorrect,
                selectedOptionContent: selectedButton.dataset.optionContent, // Store content of selected option
                correctOptionContent: correctOptionContent // Store content of correct option
            };

            // Apply visual feedback and show explanation only in practice mode
            if (quizMode === 'practice') {
                if (isCorrect) {
                    selectedButton.classList.add('correct');
                } else {
                    selectedButton.classList.add('incorrect');
                }
                // Mark correct answer
                buttons.forEach(button => {
                    if (button.dataset.originalLabelForContent === correctOptionLabel) {
                        button.classList.add('correct');
                    }
                });
                showFeedback(questionData.explanation, isCorrect);
                askGeminiButton.style.display = 'inline-block'; // Show Gemini button
            } else {
                // In exam mode, hide feedback and Gemini button
                hideFeedback();
                askGeminiButton.style.display = 'none';
            }

            updateNavigationButtons(); // Enable next question button
            await saveQuizProgress(subjectSelect.value); // Save progress after each selection
        }

        /**
         * Displays question feedback (correct or incorrect and explanation).
         * @param {string} explanation - The explanation for the question.
         * @param {boolean} isCorrect - Whether the user's answer was correct.
         */
        function showFeedback(explanation, isCorrect) {
            feedbackTitleElement.textContent = isCorrect ? '✅ 恭喜您，回答正確！' : '❌ 很抱歉，回答錯誤。';
            feedbackTextContentElement.textContent = explanation;
            feedbackContainer.classList.add('show');
        }

        /**
         * Hides question feedback.
         */
        function hideFeedback() {
            feedbackContainer.classList.remove('show');
        }

        /**
         * Updates the state of navigation buttons (Previous, Next, Submit Early).
         */
        function updateNavigationButtons() {
            prevButton.disabled = currentQuestionIndex === 0;
            // Next button is enabled only after the current question is answered
            nextButton.disabled = !userAnswers[currentQuestionIndex];
            submitEarlyButton.disabled = false; // Submit Early button is always enabled during the quiz

            if (currentQuestionIndex === selectedQuizData.length - 1) {
                nextButton.textContent = '完成測驗';
            } else {
                nextButton.textContent = '下一題';
            }
        }

        // Next button click event listener
        nextButton.addEventListener('click', async () => { // Add async
            // Only allow clicking next if the current question has been answered
            if (!userAnswers[currentQuestionIndex]) {
                console.log("Next button clicked but current question not answered.");
                return;
            }

            if (currentQuestionIndex < selectedQuizData.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
                await saveQuizProgress(subjectSelect.value); // Save progress after navigation
            } else {
                // Quiz completed
                console.log("Next button clicked, quiz completed.");
                showQuizSummary();
            }
        });

        // Previous button click event listener
        prevButton.addEventListener('click', async () => { // Add async
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
                await saveQuizProgress(subjectSelect.value); // Save progress after navigation
            }
        });

        // Submit Early button click event listener
        submitEarlyButton.addEventListener('click', () => {
            confirmationModalOverlay.style.display = 'flex'; // Show confirmation modal
        });

        // Confirm Submit button click event listener
        confirmYesButton.addEventListener('click', () => {
            confirmationModalOverlay.style.display = 'none'; // Hide confirmation modal
            showQuizSummary(); // Proceed to show quiz summary
        });

        // Cancel Submit button click event listener
        confirmNoButton.addEventListener('click', () => {
            confirmationModalOverlay.style.display = 'none'; // Hide confirmation modal
        });

        /**
         * Displays the quiz summary page, calculates score, and shows all questions review.
         */
        async function showQuizSummary() {
            stopTimer(); // Stop the timer
            quizContent.style.display = 'none';
            quizSummary.classList.add('show');
            timerDisplay.style.display = 'none'; // Hide timer

            const finalScorePoints = score * POINTS_PER_QUESTION; // Calculate final score
            summaryScoreElement.textContent = `${finalScorePoints} 分`; // Display score
            let message = '';
            const percentage = (score / selectedQuizData.length) * 100;
            if (percentage === 100) {
                message = '太棒了！您對AI應用規劃師能力有非常深入的了解！';
            } else if (percentage >= 80) {
                message = '表現非常出色！您已經掌握了大部分的知識。';
            } else if (percentage >= 60) {
                message = '不錯的開始！再加把勁，您會更棒的。';
            } else {
                message = '繼續努力！多加練習，您一定會進步的。';
            }
            summaryMessageElement.textContent = message;

            console.log(`showQuizSummary: Final score (correct answers): ${score}, Total questions: ${selectedQuizData.length}, Final points: ${finalScorePoints}`);
            
            // Display all questions review
            allQuestionsSummaryElement.innerHTML = ''; // Clear previous content
            const title = document.createElement('h3');
            title.className = 'feedback-title text-xl mb-4';
            title.textContent = '題目回顧';
            allQuestionsSummaryElement.appendChild(title);

            selectedQuizData.forEach((questionData, index) => {
                const userAnswer = userAnswers[index];
                const isAnswered = userAnswer !== undefined;
                const isCorrect = isAnswered ? userAnswer.isCorrect : false;

                const itemDiv = document.createElement('div');
                itemDiv.className = `question-item ${isAnswered ? (isCorrect ? 'correct' : 'incorrect') : ''} bg-white border rounded-lg p-4 mb-4 shadow-sm`;

                let yourAnswerHtml = '';
                if (isAnswered) {
                    yourAnswerHtml = `<p class="your-answer-text ${isCorrect ? 'text-green-700' : 'text-blue-700'}">您的答案：${userAnswer.selectedOptionContent}</p>`;
                } else {
                    yourAnswerHtml = `<p class="your-answer-text text-gray-500">您未作答。</p>`;
                }

                itemDiv.innerHTML = `
                    <p class="question-text-all"><strong>${index + 1}. ${questionData.question}</strong></p>
                    ${yourAnswerHtml}
                    <p class="correct-answer-text-all text-green-700 mt-2">正確答案：${questionData.options[optionLabels.indexOf(questionData.answer)]}</p>
                    <p class="explanation-text-all text-purple-700 mt-2">${questionData.explanation}</p>
                `;
                allQuestionsSummaryElement.appendChild(itemDiv);
            });

            // Save score to leaderboard
            await saveQuizScoreToLeaderboard(finalScorePoints); // Pass the calculated total score
            // Save quiz history
            await saveQuizHistory(subjectSelect.value, finalScorePoints, selectedQuizData, userAnswers, quizMode); // New: Save quiz history
            // Clear progress for the current subject as the quiz is completed
            await clearQuizProgress(subjectSelect.value);

            // In exam mode, show the Ask Gemini button in the summary
            if (quizMode === 'exam') {
                askGeminiButton.style.display = 'inline-block';
            }
        }

        /**
         * Loads JSON question data.
         * @param {string} jsonFileName - The JSON file name.
         * @param {boolean} isContinuing - Whether to continue a previous quiz.
         */
        async function loadFullQuizData(jsonFileName, isContinuing = false) {
            showGlobalLoading(); // Show loading indicator
            initialSelectionScreen.style.display = 'none';
            loadingIndicator.style.display = 'block';
            quizContent.style.display = 'none';
            quizSummary.classList.remove('show');
            questionCountsElement.style.display = 'none';
            userCountDisplay.style.display = 'none'; // Hide user count when quiz starts
            continueQuizPrompt.style.display = 'none';
            subjectSelectionArea.style.display = 'none';
            modeSelectionArea.style.display = 'none'; // Hide mode selection area
            viewLeaderboardButton.style.display = 'none';
            viewHistoryButton.style.display = 'none'; // Hide history button

            console.log(`loadFullQuizData: Starting load for ${jsonFileName}. Is continuing: ${isContinuing}, Mode: ${quizMode}`);

            try {
                if (!isContinuing) { // If not continuing quiz, load JSON from scratch
                    console.log("loadFullQuizData: Starting a NEW quiz.");
                    const githubRawUrl = `https://raw.githubusercontent.com/ss1111119/ipas_AI-Planner-Exam/main/${jsonFileName}`;
                    const response = await fetch(githubRawUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    fullQuizData = await response.json();
                    initializeQuizData(); // Initialize random questions after loading data
                    currentQuestionIndex = 0; // Reset question index
                    userAnswers = []; // Clear answers
                    score = 0; // Reset correct answer count
                    incorrectQuestions = []; // Clear incorrect questions
                    timeRemaining = quizDurationInSeconds; // Reset timer
                    quizStartTime = Date.now(); // Set quiz start time
                    lastActiveTime = Date.now(); // Set last active time
                    console.log(`loadFullQuizData: New quiz initialized. Score: ${score}, User answers: ${userAnswers.length}, Incorrect questions: ${incorrectQuestions.length}`);
                } else {
                    // If continuing quiz, use loaded progress data
                    console.log("loadFullQuizData: Continuing an existing quiz.");
                    currentQuestionIndex = loadedProgressData.currentQuestionIndex ?? 0;
                    userAnswers = loadedProgressData.userAnswers || [];
                    score = loadedProgressData.score ?? 0; // Score here is still the number of correct answers
                    incorrectQuestions = loadedProgressData.incorrectQuestions || [];
                    timeRemaining = loadedProgressData.timeRemaining ?? quizDurationInSeconds;
                    selectedQuizData = loadedProgressData.selectedQuizData || []; // Use stored selected questions
                    quizStartTime = loadedProgressData.quizStartTime ?? Date.now(); // Load quiz start time
                    lastActiveTime = loadedProgressData.lastActiveTime ?? Date.now(); // Load last active time
                    // Also load the quiz mode from saved progress if available
                    quizMode = loadedProgressData.quizMode ?? 'practice'; 
                    console.log(`loadFullQuizData: Quiz resumed. Loaded score: ${score}, User answers: ${userAnswers.length}, Incorrect questions: ${incorrectQuestions.length}, Mode: ${quizMode}`);
                }
                
                loadQuestion(); // Load the first question
                quizContent.style.display = 'block'; // Show quiz content
                currentSubjectTitle.textContent = subjectNames[jsonFileName]; // Update subject title
                startTimer(); // Start the timer
            } catch (error) {
                console.error('loadFullQuizData: Failed to load quiz data:', error);
                loadingIndicator.textContent = `載入題目失敗：${subjectNames[jsonFileName]}。請檢查 GitHub 上的 JSON 檔案路徑或內容格式是否正確。錯誤: ${error.message}`;
                loadingIndicator.style.display = 'block';
                // On error, return to initial state for user to retry
                initialSelectionScreen.style.display = 'flex';
                subjectSelectionArea.style.display = 'block';
                modeSelectionArea.style.display = 'flex'; // Show mode selection area on error
                questionCountsElement.style.display = 'block';
                userCountDisplay.style.display = 'block'; // Show user count on error
                continueQuizPrompt.style.display = 'none';
                viewLeaderboardButton.style.display = 'block';
                viewHistoryButton.style.display = 'block'; // Show history button on error
                return;
            } finally {
                // Only hide loading indicator if data loaded successfully or continuing quiz
                if (fullQuizData.length > 0 || isContinuing) { 
                    loadingIndicator.style.display = 'none';
                }
                hideGlobalLoading(); // Hide global loading regardless of success or failure
            }
        }

        // Restart Quiz button click event listener
        restartButton.addEventListener('click', () => {
            showGlobalLoading(); // Show loading indicator
            // Re-display environment selection screen, and hide quiz content and summary
            environmentSelectionScreen.style.display = 'flex';
            initialSelectionScreen.style.display = 'none';
            quizContent.style.display = 'none';
            quizSummary.classList.remove('show');
            askGeminiButton.style.display = 'none';
            stopTimer(); // Ensure timer stops
            timerDisplay.style.display = 'none';
            userCountDisplay.style.display = 'none'; // Hide user count when returning to env selection
            // Reset quizMode to default when restarting
            quizMode = 'practice';
            practiceModeButton.classList.add('selected-mode');
            examModeButton.classList.remove('selected-mode');
            // No need to call getAndDisplayUserCount() here, it will be called after env selection
            hideGlobalLoading(); // Ensure loading is hidden
        });

        // "Start Quiz" button click event listener (triggered from subject selection screen)
        startQuizButton.addEventListener('click', () => {
            loadFullQuizData(subjectSelect.value, false); // Start a new quiz
        });

        // "Continue Quiz" button click event listener
        continueQuizButton.addEventListener('click', () => {
            loadFullQuizData(loadedProgressData.subjectId, true); // Continue previous quiz
        });

        // "Start New Quiz" button click event listener
        startNewQuizButton.addEventListener('click', async () => {
            // Clear existing progress for the selected subject
            await clearQuizProgress(subjectSelect.value); 
            loadFullQuizData(subjectSelect.value, false); // Start a brand new quiz
        });

        // Gemini related event listeners
        askGeminiButton.addEventListener('click', () => {
            // If in GitHub Pages environment and no API key is set, prompt for input
            if (currentEnvironment === 'github-pages' && !geminiApiKey) {
                apiKeyModalOverlay.style.display = 'flex';
                geminiApiKeyInput.focus();
                return;
            }
            geminiModalOverlay.style.display = 'flex'; // Show modal
            geminiQuestionInput.focus(); // Input field automatically gets focus
        });

        geminiModalClose.addEventListener('click', () => {
            geminiModalOverlay.style.display = 'none'; // Hide modal
            geminiResponseArea.innerHTML = ''; // Clear response content
            geminiResponseArea.style.display = 'none';
            geminiQuestionInput.value = ''; // Clear input field
            geminiLoadingIndicator.style.display = 'none';
        });

        // Gemini Question Modal Cancel button event listener
        geminiModalCancelButton.addEventListener('click', () => {
            geminiModalOverlay.style.display = 'none'; // Hide modal
            geminiResponseArea.innerHTML = '';
            geminiResponseArea.style.display = 'none';
            geminiQuestionInput.value = '';
            geminiLoadingIndicator.style.display = 'none';
        });

        // API Key Modal Cancel button event listener
        apiKeyModalCancelButton.addEventListener('click', () => {
            apiKeyModalOverlay.style.display = 'none'; // Hide API Key modal
            geminiApiKeyInput.value = '';
        });

        // Handle API Key submission
        submitApiKeyButton.addEventListener('click', () => {
            const inputKey = geminiApiKeyInput.value.trim();
            if (inputKey) {
                geminiApiKey = inputKey; // Store the entered key
                apiKeyModalOverlay.style.display = 'none'; // Hide API Key modal
                askGeminiButton.click(); // Re-trigger click event for Ask Gemini button
            } else {
                showConfirmationModal('提示', '請輸入有效的 Gemini API 金鑰。', null, true);
            }
        });

        // Submit Gemini Question button click event listener
        submitGeminiQuestionButton.addEventListener('click', async () => {
            const userQuestion = geminiQuestionInput.value.trim();
            if (!userQuestion) {
                geminiResponseArea.style.display = 'block';
                geminiResponseArea.textContent = '請輸入您的問題。';
                return;
            }

            geminiResponseArea.innerHTML = '';
            geminiResponseArea.style.display = 'none';
            geminiLoadingIndicator.style.display = 'block'; // Show loading indicator

            const currentQuestionData = selectedQuizData[currentQuestionIndex];
            const prompt = `關於以下測驗題目：
題目：${currentQuestionData.question}
選項：
A) ${currentQuestionData.options[0]}
B) ${currentQuestionData.options[1]}
C) ${currentQuestionData.options[2]}
D) ${currentQuestionData.options[3]}
正確答案：${currentQuestionData.answer}
解釋：${currentQuestionData.explanation}

我的問題是：${userQuestion}

請根據上述資訊，詳細回答我的問題。`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // Use dynamically set Gemini API key based on environment
                const apiKeyToUse = (currentEnvironment === 'github-pages') ? geminiApiKey : ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKeyToUse}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    geminiResponseArea.textContent = text;
                } else {
                    geminiResponseArea.textContent = '抱歉，無法獲取回答。請稍後再試或換個問題。';
                    console.error('Gemini API response structure unexpected:', result);
                }
            } catch (error) {
                geminiResponseArea.textContent = '發生錯誤，無法連接到 Gemini 服務。請檢查您的網路連線。';
                console.error('Error calling Gemini API:', error);
            } finally {
                geminiLoadingIndicator.style.display = 'none'; // Hide loading indicator
                geminiResponseArea.style.display = 'block'; // Show response area
            }
        });

        /**
         * Formats seconds into an MM:SS time string.
         * @param {number} seconds - The number of seconds to format.
         * @returns {string} - The formatted time string.
         */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        /**
         * Starts the quiz timer.
         */
        function startTimer() {
            // If not continuing from saved progress, reset time
            if (!loadedProgressData) {
                timeRemaining = quizDurationInSeconds;
                quizStartTime = Date.now(); // Set quiz start time for new quiz
            }
            lastActiveTime = Date.now(); // Set last active time when timer starts/resumes
            timerDisplay.textContent = formatTime(timeRemaining);
            timerDisplay.style.display = 'block'; // Show timer when quiz starts

            // Clear any existing interval to prevent multiple timers running
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                timeRemaining--;
                timerDisplay.textContent = formatTime(timeRemaining);

                if (timeRemaining <= 0) {
                    stopTimer();
                    console.log("Timer reached 0. Auto-submitting quiz.");
                    showQuizSummary(); // Auto-submit when time runs out
                    // Disable all options and navigation buttons to prevent further interaction
                    const buttons = optionsContainer.querySelectorAll('.option-button');
                    buttons.forEach(button => {
                        button.classList.add('disabled');
                    });
                    prevButton.disabled = true;
                    nextButton.disabled = true;
                    submitEarlyButton.disabled = true;
                }
            }, 1000);
            console.log(`startTimer: Timer started/resumed. Time remaining: ${formatTime(timeRemaining)}, Last active time: ${new Date(lastActiveTime).toLocaleString()}`);
        }

        /**
         * Stops the quiz timer.
         */
        function stopTimer() {
            clearInterval(timerInterval);
            console.log("stopTimer: Timer stopped.");
        }

        /**
         * Displays a custom confirmation/message modal.
         * @param {string} title - The modal title.
         * @param {string} message - The modal message.
         * @param {Function} onConfirmCallback - Callback function to execute on confirmation.
         * @param {boolean} isAlert - Whether it's an alert message (only shows an "OK" button).
         */
        function showConfirmationModal(title, message, onConfirmCallback, isAlert = false) {
            const modalTitle = confirmationModalOverlay.querySelector('.confirmation-modal-title');
            const modalMessage = confirmationModalOverlay.querySelector('.confirmation-modal-message');
            const modalButtons = confirmationModalOverlay.querySelector('.confirmation-modal-buttons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            modalButtons.innerHTML = ''; // Clear old buttons

            if (isAlert) {
                // If it's an alert message, only show an "OK" button
                const okButton = document.createElement('button');
                okButton.id = 'confirm-ok-button';
                okButton.className = 'confirmation-modal-button confirm-no';
                okButton.textContent = '確定';
                okButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback();
                    }
                });
                modalButtons.appendChild(okButton);
            } else {
                // If it's a confirmation message, show "Confirm Submit" and "Cancel" buttons
                const yesButton = document.createElement('button');
                yesButton.id = 'confirm-yes-button';
                yesButton.className = 'confirmation-modal-button confirm-yes';
                yesButton.textContent = '確定交卷';
                yesButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback(true);
                    }
                });
                modalButtons.appendChild(yesButton);

                const noButton = document.createElement('button');
                noButton.id = 'confirm-no-button';
                noButton.className = 'confirmation-modal-button confirm-no';
                noButton.textContent = '取消';
                noButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback(false);
                    }
                });
                modalButtons.appendChild(noButton);
            }

            confirmationModalOverlay.style.display = 'flex';
        }

        /**
         * Fetches and displays the number of questions for each subject.
         */
        async function getQuestionCounts() {
            questionCountsElement.innerHTML = '<p>正在載入題目數量...</p>';
            let allCounts = {};
            let hasError = false;

            for (const fileName in subjectNames) {
                const githubRawUrl = `https://raw.githubusercontent.com/ss1111119/ipas_AI-Planner-Exam/main/${fileName}`;
                try {
                    const response = await fetch(githubRawUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    allCounts[fileName] = data.length;
                } catch (error) {
                    console.error(`Failed to load question count for ${fileName}:`, error);
                    allCounts[fileName] = '載入失敗';
                    hasError = true;
                }
            }

            questionCountsElement.innerHTML = ''; // Clear loading message
            if (hasError) {
                questionCountsElement.innerHTML = '<p class="text-red-500">無法載入所有題目數量，請檢查網路連線或 GitHub 檔案路徑。</p>';
            }
            for (const fileName in subjectNames) {
                const p = document.createElement('p');
                p.textContent = `${subjectNames[fileName]}：${allCounts[fileName]} 題`;
                questionCountsElement.appendChild(p);
            }
        }

        /**
         * Saves quiz progress to Firestore.
         * @param {string} subjectId - The subject ID.
         */
        async function saveQuizProgress(subjectId) {
            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("saveQuizProgress: Firebase auth not ready or parameters missing. Cannot save progress.");
                return;
            }

            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);
            
            try {
                const dataToSave = {
                    subjectId: subjectId,
                    currentQuestionIndex: currentQuestionIndex !== undefined ? currentQuestionIndex : 0,
                    userAnswers: userAnswers || [],
                    score: score !== undefined ? score : 0, // This is the count of correct answers
                    incorrectQuestions: incorrectQuestions || [], // Still save for potential future use
                    timeRemaining: timeRemaining !== undefined ? timeRemaining : quizDurationInSeconds,
                    selectedQuizData: selectedQuizData || [],
                    quizStartTime: quizStartTime, // Save quiz start time
                    lastActiveTime: Date.now(), // Update and save last active time
                    quizMode: quizMode, // New: Save the current quiz mode
                    lastSaved: serverTimestamp()
                };
                
                // Deep clean data, remove all undefined values
                const cleanedDataToSave = removeUndefined(dataToSave);

                await setDoc(progressDocRef, cleanedDataToSave, { merge: false }); // Overwrite old progress for this subject
                console.log(`saveQuizProgress: Quiz progress saved for ${subjectId}. Score: ${score}, User answers: ${userAnswers.length}, Incorrect questions: ${incorrectQuestions.length}, Mode: ${quizMode}`);
            } catch (error) {
                console.error("saveQuizProgress: Failed to save quiz progress:", error);
                if (error.code === 'permission-denied') {
                    console.error("Error: Firebase permission denied. Please check your Firestore security rules to ensure anonymous users can read/write on path `/artifacts/{appId}/users/{userId}/quiz_progress/{subjectId}`.");
                }
            }
        }

        /**
         * Clears quiz progress in Firestore.
         * @param {string} subjectId - The subject ID.
         */
        async function clearQuizProgress(subjectId) {
            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("clearQuizProgress: Firebase auth not ready or parameters missing. Cannot clear progress.");
                return;
            }
            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);
            try {
                await setDoc(progressDocRef, {}); // Set to empty object to clear content
                console.log(`clearQuizProgress: Quiz progress cleared for ${subjectId}.`);
                loadedProgressData = null; // Clear locally loaded data
            } catch (error) {
                console.error("clearQuizProgress: Failed to clear quiz progress:", error);
            }
        }

        /**
         * Initializes Firebase services (app, auth, Firestore).
         */
        async function initializeFirebaseServices() {
            try {
                console.log("initializeFirebaseServices: Starting Firebase service initialization...");
                
                let currentFirebaseConfig;

                // Prioritize __firebase_config provided by Canvas environment
                if (typeof __firebase_config !== 'undefined') {
                    currentFirebaseConfig = JSON.parse(__firebase_config);
                    currentEnvironment = 'canvas';
                    effectiveAppId = typeof __app_id !== 'undefined' ? __app_id : currentFirebaseConfig.appId; // In Canvas, appId uses __app_id, if not available then __firebase_config's appId
                    console.log("initializeFirebaseServices: Canvas environment detected. Using __firebase_config.");
                } else {
                    currentFirebaseConfig = defaultFirebaseConfig; // GitHub Pages environment uses hardcoded config
                    currentEnvironment = 'github-pages';
                    effectiveAppId = currentFirebaseConfig.appId; // GitHub Pages environment uses defaultFirebaseConfig's appId
                    console.log("initializeFirebaseServices: GitHub Pages environment detected. Using defaultFirebaseConfig.");
                }

                console.log("initializeFirebaseServices: Actual Firebase Config used:", currentFirebaseConfig);
                console.log("initializeFirebaseServices: Actual App ID used (effectiveAppId):", effectiveAppId);

                if (!currentFirebaseConfig.apiKey || !currentFirebaseConfig.authDomain || !currentFirebaseConfig.projectId || !currentFirebaseConfig.appId) {
                    console.error("initializeFirebaseServices: Incomplete Firebase configuration. Ensure apiKey, authDomain, projectId, and appId are provided.", currentFirebaseConfig);
                    throw new Error("Incomplete Firebase configuration. Ensure apiKey, authDomain, projectId, and appId are provided.");
                }

                if (!app) {
                    app = initializeApp(currentFirebaseConfig); 
                    auth = getAuth(app); 
                    db = getFirestore(app); 
                    console.log("initializeFirebaseServices: Firebase app, auth, db initialized.");
                } else {
                    console.log("initializeFirebaseServices: Firebase services already initialized, skipping duplicate initialization.");
                }

            } catch (error) {
                console.error("initializeFirebaseServices: Firebase initialization failed:", error);
                // If Firebase initialization fails, directly show subject selection screen
                environmentSelectionScreen.style.display = 'none';
                initialSelectionScreen.style.display = 'flex';
                continueQuizPrompt.style.display = 'none';
                subjectSelectionArea.style.display = 'block';
                modeSelectionArea.style.display = 'flex'; // Show mode selection area on Firebase init error
                getQuestionCounts(); // Still try to display question counts
                viewLeaderboardButton.style.display = 'block';
                viewHistoryButton.style.display = 'block'; // Show history button on Firebase init error
                userCountDisplay.style.display = 'block'; // Ensure user count is visible on this screen
                userCountDisplay.textContent = '無法載入訪問人數 (初始化錯誤)。'; // Display error message
            }
        }

        /**
         * Saves user display name to Firestore.
         * @param {string} uid - Firebase user UID.
         * @param {string} displayName - The display name to save.
         */
        async function saveUserDisplayNameToFirestore(uid, displayName) {
            if (!isAuthReady || !db || !uid || !effectiveAppId) {
                console.warn("saveUserDisplayNameToFirestore: Firebase auth not ready or parameters missing. Cannot save display name.");
                return;
            }
            const userProfileDocRef = doc(db, 'artifacts', effectiveAppId, 'users', uid, 'profile', 'data');
            try {
                await setDoc(userProfileDocRef, { displayName: displayName, lastUpdated: serverTimestamp() }, { merge: true });
                console.log(`saveUserDisplayNameToFirestore: User display name saved: ${displayName} for UID: ${uid}`);
            } catch (error) {
                console.error("saveUserDisplayNameToFirestore: Failed to save user display name:", error);
                if (error.code === 'permission-denied') {
                    console.error("Error: Firebase permission denied. Please check your Firestore security rules to ensure users can read/write on path `/artifacts/{appId}/users/{userId}/profile/data`.");
                }
            }
        }

        /**
         * Loads user display name from Firestore.
         * @param {string} uid - Firebase user UID.
         * @returns {Promise<string|null>} - The loaded display name or null.
         */
        async function loadUserDisplayNameFromFirestore(uid) {
            if (!isAuthReady || !db || !uid || !effectiveAppId) {
                console.warn("loadUserDisplayNameFromFirestore: Firebase auth not ready or parameters missing. Cannot load display name.");
                return null;
            }
            const userProfileDocRef = doc(db, 'artifacts', effectiveAppId, 'users', uid, 'profile', 'data');
            try {
                const docSnap = await getDoc(userProfileDocRef);
                if (docSnap.exists() && docSnap.data().displayName) {
                    console.log(`loadUserDisplayNameFromFirestore: Loaded display name from Firestore: ${docSnap.data().displayName} for UID: ${uid}`);
                    return docSnap.data().displayName;
                }
                console.log(`loadUserDisplayNameFromFirestore: No display name loaded from Firestore for UID: ${uid}`);
                return null;
            } catch (error) {
                console.error("loadUserDisplayNameFromFirestore: Failed to load user display name:", error);
                return null;
            }
        }

        /**
         * Handles user authentication and data loading process.
         */
        async function handleUserAuthenticationAndDataLoad() {
            showGlobalLoading(); // Show loading indicator
            console.log("handleUserAuthenticationAndDataLoad: Starting user authentication and data loading...");
            if (!app || !auth || !db) {
                console.error("handleUserAuthenticationAndDataLoad: Firebase services not initialized, cannot handle user authentication and data loading.");
                showConfirmationModal('錯誤', 'Firebase 服務未初始化，請重新整理頁面或稍後再試。', null, true);
                hideGlobalLoading(); // Hide loading indicator
                return;
            }

            let firebaseAuthUid = null;

            // Step 1: Perform Firebase authentication (Custom Token or Anonymous login)
            if (currentEnvironment === 'canvas') {
                console.log("handleUserAuthenticationAndDataLoad: Canvas environment authenticating...");
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                        firebaseAuthUid = userCredential.user.uid;
                        console.log("Canvas: Signed in with custom token. UID:", firebaseAuthUid);
                    } catch (tokenError) {
                        console.error("Canvas: Custom token sign-in failed, attempting anonymous sign-in:", tokenError);
                        try {
                            const userCredential = await signInAnonymously(auth);
                            firebaseAuthUid = userCredential.user.uid;
                            console.log("Canvas: After custom token failure, signed in anonymously. UID:", firebaseAuthUid);
                        } catch (anonError) {
                            console.error("Canvas: Anonymous sign-in failed:", anonError);
                            showConfirmationModal('錯誤', 'Canvas 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                            hideGlobalLoading();
                            return;
                        }
                    }
                } else {
                    console.log("handleUserAuthenticationAndDataLoad: Canvas: No custom token, attempting anonymous sign-in...");
                    try {
                        const userCredential = await signInAnonymously(auth);
                        firebaseAuthUid = userCredential.user.uid;
                        console.log("Canvas: Signed in anonymously. UID:", firebaseAuthUid);
                    } catch (anonError) {
                        console.error("Canvas: Anonymous sign-in failed:", anonError);
                        showConfirmationModal('錯誤', 'Canvas 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                        hideGlobalLoading();
                        return;
                    }
                }
            } else { // GitHub Pages environment
                console.log("handleUserAuthenticationAndDataLoad: GitHub Pages environment authenticating anonymously...");
                // GitHub Pages environment always signs in anonymously to get Firebase UID
                try {
                    const userCredential = await signInAnonymously(auth);
                    firebaseAuthUid = userCredential.user.uid;
                    console.log("GitHub Pages: Signed in anonymously. UID:", firebaseAuthUid);
                } catch (anonError) {
                    console.error("GitHub Pages: Anonymous sign-in failed:", anonError);
                    showConfirmationModal('錯誤', 'GitHub Pages 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                    hideGlobalLoading();
                    return;
                }
            }

            // At this point, firebaseAuthUid should be set, use it as the actual currentUserId
            currentUserId = firebaseAuthUid;
            isAuthReady = true; // Set auth ready flag
            console.log("handleUserAuthenticationAndDataLoad: currentUserId set to:", currentUserId, "isAuthReady:", isAuthReady);

            // Step 2: Handle user display name
            let storedDisplayName = localStorage.getItem('user_defined_display_name');
            if (storedDisplayName) {
                currentUserDisplayName = storedDisplayName;
                console.log("handleUserAuthenticationAndDataLoad: Using stored display name from localStorage:", currentUserDisplayName);
                // Sync/update to Firestore profile
                await saveUserDisplayNameToFirestore(currentUserId, currentUserDisplayName);
                await proceedAfterUserIdSet(); // If display name found, proceed immediately
                hideGlobalLoading();
            } else {
                // If not in localStorage, try loading from Firestore
                const loadedDisplayName = await loadUserDisplayNameFromFirestore(currentUserId);
                if (loadedDisplayName) {
                    currentUserDisplayName = loadedDisplayName;
                    localStorage.setItem('user_defined_display_name', currentUserDisplayName); // Save to localStorage for quick access next time
                    console.log("handleUserAuthenticationAndDataLoad: Using stored display name from Firestore:", currentUserDisplayName);
                    await proceedAfterUserIdSet(); // If display name found, proceed immediately
                    hideGlobalLoading();
                } else {
                    // If display name not found anywhere, prompt user for input
                    console.log("handleUserAuthenticationAndDataLoad: Display name not found, showing user nickname input modal.");
                    userIdModalOverlay.style.display = 'flex';
                    userIdInput.focus();
                    hideGlobalLoading(); // Hide loading indicator (because another modal will be shown)
                    // Do not call proceedAfterUserIdSet() here, it will be called after user submits ID
                }
            }
        }

        /**
         * Continues the application flow after the user ID is set.
         */
        async function proceedAfterUserIdSet() {
            console.log("proceedAfterUserIdSet: Continuing execution, currentUserId:", currentUserId, "isAuthReady:", isAuthReady);
            if (currentUserId && isAuthReady) {
                console.log("proceedAfterUserIdSet: db:", db, "effectiveAppId:", effectiveAppId);
                await trackUserVisit(effectiveAppId); // Track user visit
                
                environmentSelectionScreen.style.display = 'none';
                initialSelectionScreen.style.display = 'flex';
                subjectSelectionArea.style.display = 'block'; // Always show subject selection
                modeSelectionArea.style.display = 'flex'; // Always show mode selection
                getQuestionCounts(); // Display question counts
                viewLeaderboardButton.style.display = 'block'; // Show leaderboard button on initial screen
                viewHistoryButton.style.display = 'block'; // Show history button on initial screen
                await checkAndDisplaySavedProgress(); // Check for saved progress
                
                // Now that we are on the initial selection screen, display user count
                userCountDisplay.style.display = 'block'; // Ensure it's visible
                await getAndDisplayUserCount(); // Fetch and display user count
            } else {
                console.error("proceedAfterUserIdSet: Unable to set currentUserId or auth not ready.");
                showConfirmationModal('錯誤', '無法設定使用者 ID 或認證未準備就緒，請重新整理頁面或稍後再試。', null, true);
            }
        }

        // Environment selection button click event listeners
        selectCanvasEnvButton.addEventListener('click', async () => {
            currentEnvironment = 'canvas';
            await handleUserAuthenticationAndDataLoad();
        });

        selectGithubEnvButton.addEventListener('click', async () => {
            currentEnvironment = 'github-pages';
            await handleUserAuthenticationAndDataLoad();
        });

        // User ID input modal confirm button click event listener
        submitUserIdButton.addEventListener('click', async () => {
            let enteredDisplayName = userIdInput.value.trim();
            // If no nickname is entered, assign a default name
            if (!enteredDisplayName) {
                enteredDisplayName = '陌生人'; // You can change this to another default name as needed
            }
            
            showGlobalLoading(); // Show loading indicator
            currentUserDisplayName = enteredDisplayName;
            localStorage.setItem('user_defined_display_name', enteredDisplayName); // Save to localStorage
            userIdModalOverlay.style.display = 'none'; // Hide modal
            console.log("User display name set and stored:", currentUserDisplayName);
            // Immediately save to Firestore profile
            await saveUserDisplayNameToFirestore(currentUserId, currentUserDisplayName);
            await proceedAfterUserIdSet(); // Continue with authentication and data loading
            hideGlobalLoading(); // Hide loading indicator
        });

        // User ID input modal cancel button click event listener
        cancelUserIdButton.addEventListener('click', () => {
            userIdModalOverlay.style.display = 'none'; // Hide modal
            // If user cancels, return to environment selection screen
            environmentSelectionScreen.style.display = 'flex';
            initialSelectionScreen.style.display = 'none';
        });

        // New: Mode selection event listeners
        practiceModeButton.addEventListener('click', () => {
            quizMode = 'practice';
            practiceModeButton.classList.add('selected-mode');
            examModeButton.classList.remove('selected-mode');
            console.log("Quiz mode set to: practice");
        });

        examModeButton.addEventListener('click', () => {
            quizMode = 'exam';
            examModeButton.classList.add('selected-mode');
            practiceModeButton.classList.remove('selected-mode');
            console.log("Quiz mode set to: exam");
        });

        /**
         * Saves quiz score to the leaderboard.
         * @param {number} finalScorePoints - The calculated total score.
         */
        async function saveQuizScoreToLeaderboard(finalScorePoints) {
            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("saveQuizScoreToLeaderboard: Firebase auth not ready or parameters missing. Cannot save leaderboard score.");
                return;
            }

            // Leaderboard data is stored in public path: /artifacts/{appId}/public/data/leaderboard_scores
            const leaderboardCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'leaderboard_scores');
            console.log("Firestore collection path for leaderboard write:", leaderboardCollectionRef.path);
            
            try {
                const scoreData = {
                    userId: currentUserId,
                    displayName: currentUserDisplayName || '匿名用戶',
                    score: finalScorePoints, // Save the calculated total score
                    totalQuestions: selectedQuizData.length, // Still save total questions, if needed
                    correctAnswers: score, // Add correct answer count, if needed
                    subject: subjectNames[subjectSelect.value],
                    quizMode: quizMode, // Save the mode
                    timestamp: serverTimestamp()
                };

                // Add a new document, ID automatically generated by Firestore
                await addDoc(leaderboardCollectionRef, scoreData);
                console.log("saveQuizScoreToLeaderboard: Quiz score saved to leaderboard.", scoreData);
            } catch (error) {
                console.error("saveQuizScoreToLeaderboard: Failed to save quiz score to leaderboard:", error);
                if (error.code === 'permission-denied') {
                    console.error("Error: Firebase permission denied. Please check your Firestore security rules to ensure users can write on path `/artifacts/{appId}/public/data/leaderboard_scores`.");
                }
            }
        }

        /**
         * Saves quiz history to Firestore.
         * @param {string} subjectId - The subject ID.
         * @param {number} finalScore - The final score of the quiz.
         * @param {Array<Object>} quizQuestions - The array of questions in the quiz.
         * @param {Array<Object>} answers - The array of user answers.
         * @param {string} mode - The quiz mode ('practice' or 'exam').
         */
        async function saveQuizHistory(subjectId, finalScore, quizQuestions, answers, mode) {
            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("saveQuizHistory: Firebase auth not ready or parameters missing. Cannot save quiz history.");
                return;
            }

            const quizHistoryCollectionRef = collection(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_history');

            try {
                const questionsAttempted = quizQuestions.map((q, index) => {
                    const userAnswer = answers[index];
                    return {
                        questionText: q.question,
                        options: q.options, // Store all options
                        answer: q.answer, // Store correct answer label (e.g., 'A', 'B')
                        explanation: q.explanation,
                        userSelectedOptionContent: userAnswer ? userAnswer.selectedOptionContent : '未作答',
                        isCorrect: userAnswer ? userAnswer.isCorrect : false
                    };
                });

                const historyData = {
                    subjectId: subjectId,
                    subjectName: subjectNames[subjectId],
                    timestamp: serverTimestamp(),
                    score: finalScore,
                    totalQuestions: quizQuestions.length,
                    correctAnswers: answers.filter(a => a && a.isCorrect).length, // Count actual correct answers
                    quizMode: mode,
                    questionsAttempted: removeUndefined(questionsAttempted) // Ensure no undefined values
                };

                await addDoc(quizHistoryCollectionRef, historyData);
                console.log("Quiz history saved successfully:", historyData);
            } catch (error) {
                console.error("Failed to save quiz history:", error);
                if (error.code === 'permission-denied') {
                    console.error("Error: Firebase permission denied. Please check your Firestore security rules for quiz_history collection.");
                }
            }
        }

        /**
         * Fetches and displays leaderboard scores from Firestore.
         */
        async function fetchLeaderboardScores() {
            showGlobalLoading(); // Show loading indicator
            console.log("fetchLeaderboardScores: Starting to fetch leaderboard scores...");
            console.log("fetchLeaderboardScores: db instance:", db);
            console.log("fetchLeaderboardScores: effectiveAppId:", effectiveAppId);

            if (!isAuthReady || !db || !effectiveAppId) {
                console.error("fetchLeaderboardScores: Firebase auth not ready, Firestore not initialized or App ID invalid, cannot fetch leaderboard scores.");
                leaderboardList.innerHTML = '<li>無法載入排行榜 (初始化中)。</li>';
                hideGlobalLoading(); // Hide loading indicator
                return;
            }

            const leaderboardCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'leaderboard_scores');
            console.log("fetchLeaderboardScores: leaderboardCollectionRef path:", leaderboardCollectionRef.path);
            
            try {
                // Query leaderboard scores, ordered by score descending, then by timestamp ascending, limit to top 100
                const q = query(leaderboardCollectionRef, orderBy('score', 'desc'), orderBy('timestamp', 'asc'), limit(100));
                console.log("fetchLeaderboardScores: Preparing to execute getDocs query...");
                const querySnapshot = await getDocs(q);
                console.log("fetchLeaderboardScores: getDocs query completed.");

                leaderboardList.innerHTML = ''; // Clear previous list
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = '<li>目前沒有排行榜資料。</li>';
                    console.log("fetchLeaderboardScores: Leaderboard is empty.");
                    return;
                }

                let rank = 1;
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const listItem = document.createElement('li');
                    const timestampDate = data.timestamp ? data.timestamp.toDate() : new Date(); // Convert timestamp to Date object
                    const formattedDate = timestampDate.toLocaleString('zh-TW', {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    // Display the 'score' field read from Firestore, which should now be the calculated total score
                    listItem.innerHTML = `
                        <span class="leaderboard-rank">${rank}.</span>
                        <span class="leaderboard-name">${data.displayName} (${data.subject} - ${data.quizMode === 'practice' ? '練習' : '正式'})</span>
                        <span class="leaderboard-score">${data.score} 分</span> 
                        <span class="text-sm text-gray-500 ml-4">${formattedDate}</span>
                    `;
                    leaderboardList.appendChild(listItem);
                    rank++;
                });
                console.log("fetchLeaderboardScores: Leaderboard data displayed.");
            } catch (error) {
                console.error("fetchLeaderboardScores: Failed to fetch leaderboard scores:", error);
                leaderboardList.innerHTML = '<li>載入排行榜失敗 (錯誤)。</li>';
                if (error.code === 'permission-denied') {
                    console.error("Error: Firebase permission denied. Please check your Firestore security rules to ensure read access to `/artifacts/{appId}/public/data/leaderboard_scores`.");
                }
            } finally {
                hideGlobalLoading(); // Hide loading regardless of success or failure
            }
        }

        /**
         * Fetches and displays quiz history from Firestore.
         */
        async function fetchAndDisplayQuizHistory() {
            showGlobalLoading();
            quizHistoryList.innerHTML = '<li>載入歷史紀錄中...</li>';

            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("fetchAndDisplayQuizHistory: Firebase auth not ready or parameters missing. Cannot fetch history.");
                quizHistoryList.innerHTML = '<li>無法載入歷史紀錄 (初始化中)。</li>';
                hideGlobalLoading();
                return;
            }

            const quizHistoryCollectionRef = collection(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_history');
            try {
                // Fetch latest 50 attempts, ordered by timestamp descending
                const q = query(quizHistoryCollectionRef, orderBy('timestamp', 'desc'), limit(50)); 
                const querySnapshot = await getDocs(q);

                quizHistoryList.innerHTML = ''; // Clear previous list
                if (querySnapshot.empty) {
                    quizHistoryList.innerHTML = '<li>目前沒有測驗歷史紀錄。</li>';
                    return;
                }

                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const listItem = document.createElement('li');
                    const timestampDate = data.timestamp ? data.timestamp.toDate() : new Date();
                    const formattedDate = timestampDate.toLocaleString('zh-TW', {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    listItem.innerHTML = `
                        <span class="leaderboard-name">${data.subjectName} (${data.quizMode === 'practice' ? '練習' : '正式'})</span>
                        <span class="leaderboard-score">${data.score} 分 (${data.correctAnswers}/${data.totalQuestions} 題)</span>
                        <span class="text-sm text-gray-500 ml-4">${formattedDate}</span>
                        <button data-doc-id="${docSnap.id}" class="nav-button ml-4 text-sm px-3 py-1 rounded-md">查看詳情</button>
                    `;
                    quizHistoryList.appendChild(listItem);

                    // Add event listener to the "查看詳情" button
                    listItem.querySelector('button').addEventListener('click', (event) => {
                        const docId = event.target.dataset.docId;
                        displayDetailedQuizAttempt(docId);
                    });
                });

            } catch (error) {
                console.error("Failed to fetch quiz history:", error);
                quizHistoryList.innerHTML = '<li>載入歷史紀錄失敗 (錯誤)。</li>';
                if (error.code === 'permission-denied') {
                    console.error("Error: Firebase permission denied. Please check your Firestore security rules for quiz_history collection.");
                }
            } finally {
                hideGlobalLoading();
            }
        }

        /**
         * Displays the detailed view of a specific quiz attempt from history.
         * @param {string} docId - The document ID of the quiz attempt in Firestore.
         */
        async function displayDetailedQuizAttempt(docId) {
            showGlobalLoading();
            quizHistoryDetailModalOverlay.style.display = 'flex';
            quizHistoryDetailContent.innerHTML = '載入詳情中...';

            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("displayDetailedQuizAttempt: Firebase auth not ready or parameters missing. Cannot display detail.");
                quizHistoryDetailContent.innerHTML = '無法載入詳情 (初始化中)。';
                hideGlobalLoading();
                return;
            }

            const docRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_history', docId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    quizHistoryDetailTitle.textContent = `${data.subjectName} (${data.quizMode === 'practice' ? '練習' : '正式'}) - ${data.score} 分`;
                    quizHistoryDetailContent.innerHTML = ''; // Clear previous content

                    if (data.questionsAttempted && data.questionsAttempted.length > 0) {
                        data.questionsAttempted.forEach((q, index) => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = `question-item ${q.isCorrect ? 'correct' : 'incorrect'} bg-white border rounded-lg p-4 mb-4 shadow-sm`;

                            itemDiv.innerHTML = `
                                <p class="question-text-all"><strong>${index + 1}. ${q.questionText}</strong></p>
                                <p class="your-answer-text ${q.isCorrect ? 'text-green-700' : 'text-blue-700'}">您的答案：${q.userSelectedOptionContent}</p>
                                <p class="correct-answer-text-all text-green-700 mt-2">正確答案：${q.options[optionLabels.indexOf(q.answer)]}</p>
                                <p class="explanation-text-all text-purple-700 mt-2">${q.explanation}</p>
                            `;
                            quizHistoryDetailContent.appendChild(itemDiv);
                        });
                    } else {
                        quizHistoryDetailContent.innerHTML = '<p>此測驗沒有詳細的題目紀錄。</p>';
                    }
                } else {
                    quizHistoryDetailContent.innerHTML = '<p>找不到此測驗紀錄。</p>';
                }
            } catch (error) {
                console.error("Failed to fetch quiz history detail:", error);
                quizHistoryDetailContent.innerHTML = '載入詳情失敗 (錯誤)。';
            } finally {
                hideGlobalLoading();
            }
        }

        /**
         * Generates and displays statistics for incorrectly answered questions across all history.
         */
        async function generateAndDisplayIncorrectQuestionStats() {
            showGlobalLoading();
            quizHistoryDetailContent.innerHTML = '載入錯題統計中...';

            if (!isAuthReady || !db || !currentUserId || !effectiveAppId) {
                console.warn("generateAndDisplayIncorrectQuestionStats: Firebase auth not ready or parameters missing. Cannot generate stats.");
                quizHistoryDetailContent.innerHTML = '無法載入錯題統計 (初始化中)。';
                hideGlobalLoading();
                return;
            }

            const quizHistoryCollectionRef = collection(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_history');
            let incorrectQuestionMap = new Map(); // Map to store {questionText: {count: N, questionData: {}}}

            try {
                const querySnapshot = await getDocs(quizHistoryCollectionRef);

                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.questionsAttempted && data.questionsAttempted.length > 0) {
                        data.questionsAttempted.forEach(q => {
                            if (!q.isCorrect) {
                                // Use question text as a unique identifier for simplicity in stats
                                const questionIdentifier = q.questionText; 
                                if (incorrectQuestionMap.has(questionIdentifier)) {
                                    const currentStats = incorrectQuestionMap.get(questionIdentifier);
                                    currentStats.count++;
                                    // Update with the latest incorrect attempt's answer for display
                                    currentStats.userSelectedOptionContent = q.userSelectedOptionContent; 
                                    incorrectQuestionMap.set(questionIdentifier, currentStats);
                                } else {
                                    incorrectQuestionMap.set(questionIdentifier, {
                                        count: 1,
                                        questionText: q.questionText,
                                        options: q.options,
                                        answer: q.answer,
                                        explanation: q.explanation,
                                        userSelectedOptionContent: q.userSelectedOptionContent 
                                    });
                                }
                            }
                        });
                    }
                });

                quizHistoryDetailContent.innerHTML = ''; // Clear loading message
                quizHistoryDetailTitle.textContent = '錯題統計';

                if (incorrectQuestionMap.size === 0) {
                    quizHistoryDetailContent.innerHTML = '<p>太棒了！您目前沒有錯題紀錄。</p>';
                    return;
                }

                // Sort incorrect questions by count (most incorrect first)
                const sortedIncorrectQuestions = Array.from(incorrectQuestionMap.values()).sort((a, b) => b.count - a.count);

                sortedIncorrectQuestions.forEach((stats, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `question-item incorrect bg-white border rounded-lg p-4 mb-4 shadow-sm`;

                    itemDiv.innerHTML = `
                        <p class="question-text-all"><strong>${index + 1}. ${stats.questionText}</strong> (錯誤次數: ${stats.count})</p>
                        <p class="your-answer-text text-blue-700">您最近一次的錯誤答案：${stats.userSelectedOptionContent}</p>
                        <p class="correct-answer-text-all text-green-700 mt-2">正確答案：${stats.options[optionLabels.indexOf(stats.answer)]}</p>
                        <p class="explanation-text-all text-purple-700 mt-2">${stats.explanation}</p>
                    `;
                    quizHistoryDetailContent.appendChild(itemDiv);
                });

            } catch (error) {
                console.error("Failed to generate incorrect question stats:", error);
                quizHistoryDetailContent.innerHTML = '載入錯題統計失敗 (錯誤)。';
            } finally {
                hideGlobalLoading();
            }
        }

        /**
         * Shares quiz results.
         */
        async function shareQuizResults() {
            const quizTitle = "iPAS初級AI應用規劃師模擬測驗";
            const subjectName = subjectNames[subjectSelect.value];
            const finalScorePoints = score * POINTS_PER_QUESTION; // Calculate final score
            const finalScoreDisplay = `${finalScorePoints} 分`; // Display score
            const message = summaryMessageElement.textContent;
            const userName = currentUserDisplayName || '匿名用戶';

            let shareText = `我在「${quizTitle}」的「${subjectName}」測驗中，獲得了 ${finalScoreDisplay}！\n${message}\n\n`;
            shareText += `我的暱稱是：${userName}\n`;

            // 這裡不再僅顯示錯題數量，而是總結答題情況
            const answeredQuestionsCount = userAnswers.filter(answer => answer !== undefined).length;
            const totalQuestionsCount = selectedQuizData.length;
            
            if (answeredQuestionsCount < totalQuestionsCount) {
                shareText += `我完成了 ${answeredQuestionsCount} / ${totalQuestionsCount} 題，其中答對了 ${score} 題。`;
            } else {
                shareText += `我完成了所有 ${totalQuestionsCount} 題，其中答對了 ${score} 題。`;
            }
            shareText += `\n\n立即來挑戰：${window.location.href}`; 

            try {
                if (navigator.share) {
                    // If browser supports Web Share API, use it
                    await navigator.share({
                        title: quizTitle,
                        text: shareText,
                        url: window.location.href,
                    });
                    showConfirmationModal('分享成功', '測驗結果已成功分享！', null, true);
                } else {
                    // Otherwise, fall back to copying to clipboard
                    const tempInput = document.createElement('textarea');
                    tempInput.value = shareText;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showConfirmationModal('複製成功', '測驗結果已複製到剪貼簿！您可以貼到任何地方。', null, true);
                }
            } catch (error) {
                console.error('Share failed:', error);
                // Check if error is user cancelling share
                if (error.name !== 'AbortError') {
                    showConfirmationModal('分享失敗', '無法分享測驗結果。您的瀏覽器可能不支援分享功能，或發生其他錯誤。結果已嘗試複製到剪貼簿。', null, true);
                } else {
                    console.log('分享已取消。');
                }
            }
        }

        // Page load initialization logic
        document.addEventListener('DOMContentLoaded', async () => {
            showGlobalLoading(); // Show loading indicator on DOMContentLoaded
            environmentSelectionScreen.style.display = 'flex';
            initialSelectionScreen.style.display = 'none';
            quizContent.style.display = 'none';
            quizSummary.classList.remove('show');
            timerDisplay.style.display = 'none';
            userIdModalOverlay.style.display = 'none';
            leaderboardModalOverlay.style.display = 'none';
            quizHistoryModalOverlay.style.display = 'none'; // Hide history modal
            quizHistoryDetailModalOverlay.style.display = 'none'; // Hide history detail modal
            
            // Initially hide user count display as it's now on a different screen
            userCountDisplay.style.display = 'none'; 

            // Display last updated time on the environment selection screen
            lastUpdatedDisplay.textContent = '應用程式載入時間：' + new Date().toLocaleString('zh-TW');
            
            // Initialize Firebase services
            await initializeFirebaseServices();
            hideGlobalLoading(); // Hide loading indicator after DOMContentLoaded completes

            // Add event listener for share results button (ensure executed after DOMContentLoaded)
            shareResultsButton.addEventListener('click', shareQuizResults);

            // Add event listener for leaderboard button
            viewLeaderboardButton.addEventListener('click', async () => {
                leaderboardModalOverlay.style.display = 'flex'; // Show leaderboard modal
                await fetchLeaderboardScores(); // Load and display leaderboard scores
            });
            viewLeaderboardButtonSummary.addEventListener('click', async () => {
                leaderboardModalOverlay.style.display = 'flex'; // Show leaderboard modal
                await fetchLeaderboardScores(); // Load and display leaderboard scores
            });

            // Add event listener for leaderboard modal close button
            leaderboardModalClose.addEventListener('click', () => {
                leaderboardModalOverlay.style.display = 'none'; // Hide leaderboard modal
            });

            // New: Add event listener for history button
            viewHistoryButton.addEventListener('click', async () => {
                quizHistoryModalOverlay.style.display = 'flex'; // Show history modal
                await fetchAndDisplayQuizHistory(); // Load and display history records
            });

            // New: Add event listener for history modal close button
            quizHistoryModalClose.addEventListener('click', () => {
                quizHistoryModalOverlay.style.display = 'none'; // Hide history modal
            });

            // New: Add event listener for history detail modal close button
            quizHistoryDetailModalClose.addEventListener('click', () => {
                quizHistoryDetailModalOverlay.style.display = 'none'; // Hide history detail modal
            });

            // New: Add event listener for view incorrect stats button
            viewIncorrectStatsButton.addEventListener('click', async () => {
                quizHistoryModalOverlay.style.display = 'none'; // Hide history list
                quizHistoryDetailModalOverlay.style.display = 'flex'; // Show detail modal
                quizHistoryDetailTitle.textContent = '錯題統計';
                await generateAndDisplayIncorrectQuestionStats();
            });


            // Add visibilitychange listener for precise timer
            document.addEventListener('visibilitychange', async () => {
                if (quizContent.style.display === 'block' && currentUserId && selectedQuizData.length > 0) {
                    if (document.hidden) {
                        // Page is hidden, stop timer and save progress
                        stopTimer();
                        lastActiveTime = Date.now(); // Update last active time
                        await saveQuizProgress(subjectSelect.value);
                        console.log("Page hidden. Timer paused, progress saved.");
                    } else {
                        // Page is visible, load progress and resume timer
                        console.log("Page visible. Loading progress and resuming timer.");
                        const currentSubjectId = subjectSelect.value;
                        loadedProgressData = await loadQuizProgress(currentSubjectId);
                        if (loadedProgressData) {
                            // Calculate time elapsed while hidden
                            const hiddenTimeElapsedMs = Date.now() - (loadedProgressData.lastActiveTime || loadedProgressData.quizStartTime);
                            const hiddenTimeElapsedSeconds = Math.floor(hiddenTimeElapsedMs / 1000);
                            
                            // Subtract elapsed time from remaining time
                            timeRemaining = (loadedProgressData.timeRemaining ?? quizDurationInSeconds) - hiddenTimeElapsedSeconds;
                            if (timeRemaining < 0) timeRemaining = 0; // Ensure time doesn't go negative

                            currentQuestionIndex = loadedProgressData.currentQuestionIndex ?? 0;
                            userAnswers = loadedProgressData.userAnswers || [];
                            score = loadedProgressData.score ?? 0;
                            incorrectQuestions = loadedProgressData.incorrectQuestions || [];
                            selectedQuizData = loadedProgressData.selectedQuizData || [];
                            quizStartTime = loadedProgressData.quizStartTime ?? Date.now();
                            quizMode = loadedProgressData.quizMode ?? 'practice'; // Load quiz mode from progress

                            loadQuestion(); // Reload current question to reflect state
                            startTimer(); // Resume timer
                            console.log(`Timer resumed. Hidden for ${hiddenTimeElapsedSeconds} seconds. Time remaining: ${formatTime(timeRemaining)}`);
                        } else {
                            // If no progress found (e.g., first load or cleared), just restart timer if quiz is active
                            startTimer();
                            console.log("No saved progress to load, just resuming timer.");
                        }
                    }
                }
            });

            // Add beforeunload listener to save progress before page closes
            window.addEventListener('beforeunload', async () => {
                if (quizContent.style.display === 'block' && currentUserId && selectedQuizData.length > 0) {
                    // Only save if quiz is active and user has answered at least one question
                    if (userAnswers.length > 0) {
                        // Before unloading, ensure lastActiveTime is updated to the current moment
                        lastActiveTime = Date.now(); 
                        await saveQuizProgress(subjectSelect.value); 
                        console.log("Page unloading. Progress saved.");
                    }
                }
            });
        });
    </script>
</body>
</html>
