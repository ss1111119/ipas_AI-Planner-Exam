<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 應用規劃師能力測驗</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .quiz-container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 800px;
            width: 100%;
            /* 調整為 Flexbox 佈局以確保內容居中 */
            display: flex;
            flex-direction: column;
            align-items: center; /* 水平居中 */
            justify-content: center; /* 垂直居中 */
            position: relative;
            overflow: hidden; /* For background animation */
            min-height: 400px; /* 確保容器有足夠高度來居中內容 */
        }
        .quiz-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, #e0f2fe, #ffffff);
            animation: pulse 10s infinite alternate;
            z-index: 0;
            opacity: 0.3;
        }
        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.3; }
            100% { transform: scale(1.1); opacity: 0.5; }
        }
        .content-wrapper {
            position: relative;
            z-index: 1;
            width: 100%; /* 確保佔滿父容器寬度 */
            height: 100%; /* 確保佔滿父容器高度 */
            /* 調整為 Flexbox 佈局以確保其子元素居中 */
            display: flex;
            flex-direction: column;
            align-items: center; /* 水平居中 */
            justify-content: center; /* 垂直居中 */
        }
        .loading-message {
            font-size: 1.5rem;
            color: #4a5568;
            margin-top: 50px;
        }
        .subject-selection {
            margin-bottom: 25px;
            display: flex; /* 使用 flexbox 讓下拉選單和按鈕並排 */
            flex-direction: column; /* 預設為垂直排列 */
            align-items: center; /* 水平居中 */
            gap: 20px; /* 間距 */
        }
        @media (min-width: 640px) { /* 在較大螢幕上改為水平排列 */
            .subject-selection {
                flex-direction: row;
                justify-content: center;
            }
        }
        .subject-selection select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #cbd5e0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            background-color: #f7fafc;
            appearance: none; /* Remove default arrow */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20fill%3D%22%234A5568%22%20d%3D%22M9.293%2012.95l.707.707L15.657%208l-1.414-1.414L10%2010.828%206.757%207.586%205.343%209z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        .subject-selection select:focus {
            outline: none;
            border-color: #63b3ed;
        }
        .start-quiz-button {
            background-color: #48bb78;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.3);
        }
        .start-quiz-button:hover:not(:disabled) {
            background-color: #38a169;
            transform: translateY(-2px);
        }
        .start-quiz-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* 確保初始選擇畫面居中 */
        #initial-selection-screen {
            display: flex; /* 預設為 Flexbox 佈局 */
            flex-direction: column; /* 垂直排列子元素 */
            align-items: center; /* 水平居中子元素 */
            justify-content: center; /* 垂直居中子元素 */
            width: 100%; /* 佔滿父容器寬度 */
            height: 100%; /* 佔滿父容器高度 */
        }
        .subject-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        .question-number {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .question-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            text-align: left;
        }
        .option-button {
            background-color: #edf2f7;
            color: #4a5568;
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .option-button:hover:not(.disabled):not(.correct):not(.incorrect) {
            background-color: #e2e8f0;
            border-color: #cbd5e0;
        }
        .option-button.selected {
            border-color: #63b3ed;
            background-color: #ebf8ff;
            color: #2b6cb0;
        }
        .option-button.correct {
            background-color: #d4edda; /* Light green */
            border-color: #48bb78; /* Green */
            color: #2f855a;
        }
        .option-button.incorrect {
            background-color: #fde8e8; /* Light red */
            border-color: #ef4444; /* Red */
            color: #c53030;
        }
        .option-label {
            font-weight: bold;
            min-width: 25px; /* Ensure consistent alignment */
            text-align: center;
        }
        .feedback-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: left;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            display: none; /* Hidden by default */
            font-size: 1rem;
            line-height: 1.6;
        }
        .feedback-container.show {
            display: block;
        }
        .feedback-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #2d3748;
        }
        .feedback-text {
            color: #4a5568;
        }
        .navigation-buttons {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .nav-button {
            background-color: #4299e1;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.3);
        }
        .nav-button:hover:not(:disabled) {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .nav-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        .submit-quiz-button { /* New style for submit quiz button */
            background-color: #ef4444; /* Red color for submit */
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        .submit-quiz-button:hover:not(:disabled) {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .submit-quiz-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        .quiz-summary {
            margin-top: 30px;
            padding: 30px;
            background-color: #e6fffa;
            border-radius: 15px;
            border: 2px solid #38b2ac;
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 600;
            display: none; /* Hidden by default */
        }
        .quiz-summary.show {
            display: block;
        }
        .summary-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        .summary-score {
            font-size: 2.5rem;
            color: #38b2ac;
            font-weight: 800;
            margin-bottom: 20px;
        }
        .summary-message {
            font-size: 1.3rem;
            color: #4a5568;
            margin-bottom: 30px;
        }
        .restart-button {
            background-color: #48bb78;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.3);
        }
        .restart-button:hover {
            background-color: #38a169;
            transform: translateY(-2px);
        }
        .incorrect-questions-summary {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #cbd5e0;
        }
        .incorrect-questions-summary .incorrect-question-item {
            background-color: #fefcbf; /* Light yellow for incorrect questions */
            border: 2px solid #ef4444; /* Red border for incorrect questions */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px; /* Add margin between items */
        }
        .incorrect-questions-summary .question-text-incorrect {
            font-weight: 700;
            color: #8b5f00; /* Darker yellow text */
            margin-bottom: 10px;
        }
        .incorrect-questions-summary .correct-answer-text {
            font-weight: 600;
            color: #2f855a; /* Green for correct answer */
            margin-top: 5px;
        }
        .incorrect-questions-summary .explanation-text {
            font-size: 0.95rem;
            color: #6b46c1; /* Purple for explanation */
            margin-top: 10px;
        }

        /* Gemini Modal Styles */
        .gemini-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .gemini-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            position: relative;
            text-align: left;
        }
        .gemini-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }
        .gemini-modal-close:hover {
            color: #4a5568;
        }
        .gemini-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        .gemini-modal-input-area textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 80px;
            resize: vertical;
            margin-bottom: 15px;
        }
        .gemini-modal-input-area textarea:focus {
            outline: none;
            border-color: #63b3ed;
        }
        .gemini-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .gemini-modal-submit-button {
            background-color: #4299e1;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .gemini-modal-submit-button:hover {
            background-color: #3182ce;
        }
        .gemini-modal-cancel-button { /* New style for cancel button */
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .gemini-modal-cancel-button:hover {
            background-color: #718096;
        }
        .gemini-modal-loading {
            text-align: center;
            margin-top: 20px;
            font-size: 1.1rem;
            color: #4a5568;
        }
        .gemini-modal-response {
            margin-top: 20px;
            padding: 15px;
            background-color: #e6fffa;
            border: 1px solid #38b2ac;
            border-radius: 10px;
            font-size: 1rem;
            color: #2d3748;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            max-height: 300px; /* Limit height */
            overflow-y: auto; /* Add scroll if content overflows */
        }
        .ask-gemini-button {
            background-color: #805ad5; /* Purple for Gemini feature */
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(128, 90, 213, 0.3);
            margin-top: 20px; /* Space from feedback container */
        }
        .ask-gemini-button:hover {
            background-color: #6b46c1;
            transform: translateY(-2px);
        }

        /* New API Key Modal Styles */
        .api-key-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than Gemini modal */
        }
        .api-key-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: left;
        }
        .api-key-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        .api-key-modal-input-area input {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .api-key-modal-input-area input:focus {
            outline: none;
            border-color: #63b3ed;
        }
        .api-key-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px; /* Add gap for buttons */
        }
        .api-key-modal-submit-button {
            background-color: #48bb78;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .api-key-modal-submit-button:hover {
            background-color: #38a169;
        }
        .api-key-modal-cancel-button { /* New style for API key cancel button */
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .api-key-modal-cancel-button:hover {
            background-color: #718096;
        }

        /* Timer Display Styles */
        .timer-display {
            position: absolute;
            top: 1rem;
            right: 1rem;
            text-align: center;
            font-size: 1.2rem; /* Adjusted for better visibility */
            font-weight: 700;
            color: #2d3748; /* Darker text for contrast */
            background-color: #e0f2fe; /* Light blue background */
            padding: 8px 15px; /* Adjusted padding */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: none; /* Hidden by default */
        }

        /* Confirmation Modal Styles */
        .confirmation-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002; /* Higher than other modals */
        }
        .confirmation-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .confirmation-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        .confirmation-modal-message {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 25px;
        }
        .confirmation-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .confirmation-modal-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .confirm-yes {
            background-color: #ef4444;
            color: white;
        }
        .confirm-yes:hover {
            background-color: #dc2626;
        }
        .confirm-no {
            background-color: #a0aec0;
            color: white;
        }
        .confirm-no:hover {
            background-color: #718096;
        }

        .question-counts {
            margin-top: 20px;
            font-size: 1.1rem;
            color: #4a5568;
            text-align: center;
        }
        .question-counts p {
            margin-bottom: 5px;
        }

        /* Environment Selection Screen Styles */
        #environment-selection-screen {
            display: flex; /* Initially flex to be visible */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        .env-button {
            background-color: #6366f1; /* Indigo color */
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        .env-button:hover {
            background-color: #4f46e5;
            transform: translateY(-2px);
        }

        /* User Count Display */
        #user-count-display {
            margin-top: 20px; /* Adjusted margin for placement */
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            background-color: #e2f8f5; /* Light teal background */
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #38b2ac;
            display: block; /* Always visible on environment screen */
        }

        /* Continue Quiz Prompt */
        #continue-quiz-prompt {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            text-align: center;
        }
        #continue-quiz-prompt p {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }
        .continue-quiz-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        @media (min-width: 640px) {
            .continue-quiz-buttons {
                flex-direction: row;
            }
        }
        .continue-button, .start-new-button {
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .continue-button {
            background-color: #4299e1;
            color: white;
        }
        .continue-button:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .start-new-button {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .start-new-button:hover {
            background-color: #cbd5e0;
            transform: translateY(-2px);
        }

        /* User ID Input Modal Styles */
        #user-id-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1003; /* Highest z-index */
        }
        #user-id-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: left;
        }
        #user-id-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        #user-id-modal-input-area input {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        #user-id-modal-input-area input:focus {
            outline: none;
            border-color: #63b3ed;
        }
        #user-id-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        #submit-user-id-button {
            background-color: #48bb78;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        #submit-user-id-button:hover {
            background-color: #38a169;
        }
        #cancel-user-id-button {
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        #cancel-user-id-button:hover {
            background-color: #718096;
        }

        /* Leaderboard Styles */
        #leaderboard-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1004; /* Higher than other modals */
        }
        #leaderboard-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            position: relative;
            text-align: center;
        }
        #leaderboard-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }
        #leaderboard-modal-close:hover {
            color: #4a5568;
        }
        #leaderboard-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        #leaderboard-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #edf2f7;
            font-size: 1.1rem;
            color: #4a5568;
        }
        #leaderboard-list li:last-child {
            border-bottom: none;
        }
        #leaderboard-list li:nth-child(odd) {
            background-color: #f7fafc;
        }
        #leaderboard-list li:first-child {
            background-color: #fff3e0; /* Gold for 1st place */
            font-weight: 700;
            color: #e65100;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        #leaderboard-list li:nth-child(2) {
            background-color: #eceff1; /* Silver for 2nd place */
            font-weight: 600;
            color: #546e7a;
        }
        #leaderboard-list li:nth-child(3) {
            background-color: #fbe9e7; /* Bronze for 3rd place */
            font-weight: 600;
            color: #bf360c;
        }
        .leaderboard-rank {
            font-weight: 700;
            min-width: 30px;
            text-align: left;
        }
        .leaderboard-name {
            flex-grow: 1;
            text-align: left;
            margin-left: 15px;
        }
        .leaderboard-score {
            font-weight: 700;
            color: #2d3748;
        }
        .view-leaderboard-button {
            background-color: #667eea; /* Indigo for leaderboard button */
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            margin-top: 20px; /* Space from other elements */
        }
        .view-leaderboard-button:hover {
            background-color: #5a67d8;
            transform: translateY(-2px);
        }
        /* Share Button Style */
        .share-results-button {
            background-color: #38b2ac; /* Teal color for share */
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(56, 178, 172, 0.3);
            margin-top: 15px; /* Space from restart button */
        }
        .share-results-button:hover {
            background-color: #319795;
            transform: translateY(-2px);
        }

        @media (max-width: 640px) {
            .quiz-container {
                padding: 20px;
            }
            .question-text {
                font-size: 1.2rem;
            }
            .option-button {
                font-size: 1rem;
                padding: 12px 15px;
            }
            .nav-button {
                padding: 10px 20px;
                font-size: 1rem;
            }
            .summary-title {
                font-size: 1.5rem;
            }
            .summary-score {
                font-size: 2rem;
            }
            .summary-message {
                font-size: 1.1rem;
            }
            .restart-button {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            .gemini-modal-content {
                padding: 20px;
            }
            .gemini-modal-title {
                font-size: 1.2rem;
            }
            .gemini-modal-input-area textarea {
                min-height: 60px;
            }
            .api-key-modal-content {
                padding: 20px;
            }
            .api-key-modal-title {
                font-size: 1.2rem;
            }
            .timer-display {
                font-size: 1rem; /* Smaller font for mobile */
                padding: 6px 12px;
            }
            .confirmation-modal-content {
                padding: 20px;
            }
            .confirmation-modal-title {
                font-size: 1.2rem;
            }
            .confirmation-modal-message {
                font-size: 1rem;
            }
            .confirmation-modal-button {
                padding: 8px 15px;
                font-size: 1rem;
            }
            .env-button {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            #user-id-modal-content {
                padding: 20px;
            }
            #user-id-modal-title {
                font-size: 1.2rem;
            }
            #leaderboard-modal-content {
                padding: 20px;
            }
            #leaderboard-title {
                font-size: 1.5rem;
            }
            #leaderboard-list li {
                font-size: 1rem;
                padding: 10px 15px;
            }
            .view-leaderboard-button {
                padding: 10px 20px;
                font-size: 1rem;
            }
            .share-results-button {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <div class="content-wrapper">
            <!-- New: Environment Selection Screen -->
            <div id="environment-selection-screen" class="flex flex-col items-center justify-center h-full">
                <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">選擇執行環境</h1>
                <div class="flex flex-col sm:flex-row gap-6">
                    <button id="select-canvas-env" class="env-button">在 Canvas 環境啟動</button>
                    <button id="select-github-env" class="env-button">使用 GitHub Pages 環境</button>
                </div>
                <p class="text-gray-600 mt-8 text-center">
                    非Canvas環境下，請點擊這裡啟動環境：<br>
                    <a href="https://g.co/gemini/share/0d8dc04f3cdf" target="_blank" class="text-blue-500 hover:underline font-semibold">前往 Gemini 對話分享連結</a>
                </p>
                <div id="user-count-display">
                    <!-- User count will be displayed here -->
                </div>
            </div>

            <!-- Existing: Initial Subject Selection Screen (now hidden initially) -->
            <div id="initial-selection-screen" style="display: none;">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">iPAS初級AI應用規劃師模擬測驗</h1>

                <!-- New: Continue Quiz Prompt -->
                <div id="continue-quiz-prompt">
                    <p id="continue-quiz-message"></p>
                    <div class="continue-quiz-buttons">
                        <button id="continue-quiz-button" class="continue-button">繼續測驗</button>
                        <button id="start-new-quiz-button" class="start-new-button">開始新測驗 (將覆蓋舊進度)</button>
                    </div>
                </div>

                <!-- Original Subject Selection (initially hidden) -->
                <div id="subject-selection-area" style="display: none;">
                    <div class="subject-selection">
                        <label for="subject-select" class="sr-only">選擇科目</label>
                        <select id="subject-select">
                            <option value="topic1_ai_intro.json">科目一：人工智慧基礎概論</option>
                            <option value="topic2_generative_ai_app_planning.json">科目二：生成式 AI 應用與規劃</option>
                        </select>
                        <button id="start-quiz-button" class="start-quiz-button">開始測驗</button>
                    </div>
                    <div id="question-counts" class="question-counts">
                        <!-- Question counts will be displayed here -->
                    </div>
                </div>
                <button id="view-leaderboard-button" class="view-leaderboard-button">查看排行榜</button> <!-- 排行榜按鈕 -->
            </div>

            <div id="quiz-content" style="display: none;">
                <div class="timer-display" id="timer-display">00:00</div> <!-- 計時器顯示區塊 -->
                <div class="subject-title" id="current-subject-title"></div> <!-- 動態顯示科目標題 -->
                <div class="question-number" id="question-number"></div>
                <div class="question-text" id="question-text"></div>
                <div class="options-container" id="options-container">
                    <!-- Options will be loaded here by JavaScript -->
                </div>
                <div class="feedback-container" id="feedback-container">
                    <div class="feedback-title" id="feedback-title"></div>
                    <div class="feedback-text" id="feedback-text-content"></div>
                    <button id="ask-gemini-button" class="ask-gemini-button" style="display: none;">✨ 向 Gemini 提問</button>
                </div>
                <div class="navigation-buttons">
                    <button id="prev-button" class="nav-button" disabled>上一題</button>
                    <button id="next-button" class="nav-button">下一題</button>
                    <button id="submit-early-button" class="submit-quiz-button">交卷</button> <!-- 新增交卷按鈕 -->
                </div>
            </div>
            <div id="loading-indicator" class="loading-message" style="display: none;">載入題目中，請稍候...</div>
            <div class="quiz-summary" id="quiz-summary">
                <div class="summary-title">測驗結果</div>
                <div class="summary-score" id="summary-score"></div>
                <div class="summary-message" id="summary-message"></div>
                <div id="incorrect-questions-summary" class="mt-8 text-left"></div>
                <button id="restart-button" class="restart-button">重新測驗</button>
                <button id="view-leaderboard-button-summary" class="view-leaderboard-button mt-4">查看排行榜</button> <!-- 測驗結果頁面的排行榜按鈕 -->
                <button id="share-results-button" class="share-results-button mt-4">分享結果</button> <!-- 新增分享結果按鈕 -->
            </div>
        </div>
    </div>

    <!-- Gemini Modal -->
    <div id="gemini-modal-overlay" class="gemini-modal-overlay" style="display: none;">
        <div class="gemini-modal-content">
            <span class="gemini-modal-close" id="gemini-modal-close">&times;</span>
            <div class="gemini-modal-title">向 Gemini 提問</div>
            <div class="gemini-modal-input-area">
                <p class="text-sm text-gray-600 mb-2">請輸入您想針對此題目詢問 Gemini 的問題：</p>
                <textarea id="gemini-question-input" placeholder="例如：這個概念還有哪些應用？或是提供更多相關資訊..."></textarea>
                <div class="gemini-modal-buttons">
                    <button id="gemini-modal-cancel-button" class="gemini-modal-cancel-button">取消</button> <!-- 新增取消按鈕 -->
                    <button id="submit-gemini-question-button" class="gemini-modal-submit-button">送出問題</button>
                </div>
            </div>
            <div id="gemini-loading-indicator" class="gemini-modal-loading" style="display: none;">
                載入中... 請稍候 ✨
            </div>
            <div id="gemini-response-area" class="gemini-modal-response" style="display: none;">
                <!-- Gemini's response will be displayed here -->
            </div>
        </div>
    </div>

    <!-- API Key Input Modal -->
    <div id="api-key-modal-overlay" class="api-key-modal-overlay" style="display: none;">
        <div class="api-key-modal-content">
            <div class="api-key-modal-title">請輸入您的 Gemini API 金鑰</div>
            <p class="text-sm text-gray-600 mb-4">
                為了在非 Canvas 環境下使用 Gemini 提問功能，請在此輸入您的 Gemini API 金鑰。
                您可以從 <a href="https://g.co/gemini/share/0d8dc04f3cdf" target="_blank" class="text-blue-500 hover:underline">Google AI Studio</a> 獲取。
            </p>
            <div class="api-key-modal-input-area">
                <input type="text" id="gemini-api-key-input" placeholder="您的 Gemini API 金鑰">
                <div class="api-key-modal-buttons">
                    <button id="api-key-modal-cancel-button" class="api-key-modal-cancel-button">取消</button> <!-- 獲取 API Key 模態框的取消按鈕 -->
                    <button id="submit-api-key-button" class="api-key-modal-submit-button">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal-overlay" class="confirmation-modal-overlay" style="display: none;">
        <div class="confirmation-modal-content">
            <div class="confirmation-modal-title">確認交卷</div>
            <div class="confirmation-modal-message">您確定要提前交卷嗎？交卷後將無法再修改答案。</div>
            <div class="confirmation-modal-buttons">
                <button id="confirm-yes-button" class="confirmation-modal-button confirm-yes">確定交卷</button>
                <button id="confirm-no-button" class="confirmation-modal-button confirm-no">取消</button>
            </div>
        </div>
    </div>

    <!-- User ID Input Modal -->
    <div id="user-id-modal-overlay" class="api-key-modal-overlay" style="display: none;">
        <div id="user-id-modal-content" class="api-key-modal-content">
            <div id="user-id-modal-title" class="api-key-modal-title">請輸入您的使用者暱稱</div>
            <p class="text-sm text-gray-600 mb-4">
                這個暱稱將用於識別您的測驗進度。您可以輸入任何您喜歡的名稱。
            </p>
            <div id="user-id-modal-input-area" class="api-key-modal-input-area">
                <input type="text" id="user-id-input" placeholder="您的使用者暱稱">
                <div id="user-id-modal-buttons" class="api-key-modal-buttons">
                    <button id="cancel-user-id-button" class="api-key-modal-cancel-button">取消</button>
                    <button id="submit-user-id-button" class="api-key-modal-submit-button">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal-overlay" class="leaderboard-modal-overlay" style="display: none;">
        <div id="leaderboard-modal-content" class="leaderboard-modal-content">
            <span class="gemini-modal-close" id="leaderboard-modal-close">&times;</span>
            <div id="leaderboard-title" class="leaderboard-title">排行榜</div>
            <ul id="leaderboard-list">
                <!-- Leaderboard entries will be loaded here -->
            </ul>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, getDoc, getDocs, serverTimestamp, query, orderBy, limit, addDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js"; 

        // Firebase 相關變數和初始化
        let app;
        let db;
        let auth;
        let currentEnvironment = ''; // 'canvas' or 'github-pages'
        let effectiveAppId = ''; // 儲存實際使用的 appId
        let currentUserId = ''; // 儲存當前登入用戶的 Firebase UID
        let currentUserDisplayName = ''; // 儲存使用者自定義的暱稱

        // 直接使用從 Firebase Console 複製的配置
        const firebaseConfig = {
          apiKey: "***REMOVED***",
          authDomain: "ipas-ai-planner-exam.firebaseapp.com",
          projectId: "ipas-ai-planner-exam",
          storageBucket: "ipas-ai-planner-exam.firebasestorage.app",
          appId: "1:1018339017757:web:934bf9c05ea898fdd972f4",
          measurementId: "G-5WWRYNKFJ6"
        };

        // 測驗應用程式相關變數
        let fullQuizData = []; // 儲存從 JSON 載入的所有題目
        let selectedQuizData = []; // 儲存隨機選取的 50 題
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let incorrectQuestions = []; // 儲存答錯的題目
        const optionLabels = ['A', 'B', 'C', 'D']; // 將 optionLabels 移到全域範圍
        let loadedProgressData = null; // 儲存從 Firestore 載入的進度資料

        // DOM 元素獲取
        const environmentSelectionScreen = document.getElementById('environment-selection-screen'); // 新增環境選擇畫面
        const selectCanvasEnvButton = document.getElementById('select-canvas-env');
        const selectGithubEnvButton = document.getElementById('select-github-env');

        const initialSelectionScreen = document.getElementById('initial-selection-screen');
        const subjectSelectionArea = document.getElementById('subject-selection-area'); // 新增的科目選擇區域
        const continueQuizPrompt = document.getElementById('continue-quiz-prompt'); // 繼續測驗提示
        const continueQuizMessage = document.getElementById('continue-quiz-message'); // 繼續測驗訊息
        const continueQuizButton = document.getElementById('continue-quiz-button'); // 繼續測驗按鈕
        const startNewQuizButton = document.getElementById('start-new-quiz-button'); // 開始新測驗按鈕

        const subjectSelect = document.getElementById('subject-select');
        const startQuizButton = document.getElementById('start-quiz-button');
        const currentSubjectTitle = document.getElementById('current-subject-title');
        const questionNumberElement = document.getElementById('question-number');
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackTitleElement = document.getElementById('feedback-title');
        const feedbackTextContentElement = document.getElementById('feedback-text-content');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const submitEarlyButton = document.getElementById('submit-early-button'); // 新增交卷按鈕元素
        const quizContent = document.getElementById('quiz-content');
        const quizSummary = document.getElementById('quiz-summary');
        const summaryScoreElement = document.getElementById('summary-score');
        const summaryMessageElement = document.getElementById('summary-message');
        const incorrectQuestionsSummaryElement = document.getElementById('incorrect-questions-summary'); 
        const restartButton = document.getElementById('restart-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const questionCountsElement = document.getElementById('question-counts'); // 新增題目數量顯示元素
        const userCountDisplay = document.getElementById('user-count-display'); // 新增用戶計數顯示元素

        // Gemini API 相關元素
        const askGeminiButton = document.getElementById('ask-gemini-button');
        const geminiModalOverlay = document.getElementById('gemini-modal-overlay');
        const geminiModalClose = document.getElementById('gemini-modal-close');
        const geminiQuestionInput = document.getElementById('gemini-question-input');
        const submitGeminiQuestionButton = document.getElementById('submit-gemini-question-button');
        const geminiModalCancelButton = document.getElementById('gemini-modal-cancel-button'); // 新增取消按鈕元素
        const geminiLoadingIndicator = document.getElementById('gemini-loading-indicator');
        const geminiResponseArea = document.getElementById('gemini-response-area');

        // New API Key Input Elements
        const apiKeyModalOverlay = document.getElementById('api-key-modal-overlay');
        const geminiApiKeyInput = document.getElementById('gemini-api-key-input');
        const submitApiKeyButton = document.getElementById('submit-api-key-button');
        const apiKeyModalCancelButton = document.getElementById('api-key-modal-cancel-button'); // 獲取 API Key 模態框的取消按鈕

        // Confirmation Modal Elements
        const confirmationModalOverlay = document.getElementById('confirmation-modal-overlay');
        const confirmYesButton = document.getElementById('confirm-yes-button');
        const confirmNoButton = document.getElementById('confirm-no-button');

        // User ID Input Modal Elements
        const userIdModalOverlay = document.getElementById('user-id-modal-overlay');
        const userIdInput = document.getElementById('user-id-input');
        const submitUserIdButton = document.getElementById('submit-user-id-button');
        const cancelUserIdButton = document.getElementById('cancel-user-id-button'); // 新增取消按鈕

        // Leaderboard Elements
        const viewLeaderboardButton = document.getElementById('view-leaderboard-button');
        const viewLeaderboardButtonSummary = document.getElementById('view-leaderboard-button-summary');
        const leaderboardModalOverlay = document.getElementById('leaderboard-modal-overlay');
        const leaderboardModalClose = document.getElementById('leaderboard-modal-close');
        const leaderboardList = document.getElementById('leaderboard-list');

        // Share Results Element
        const shareResultsButton = document.getElementById('share-results-button');


        // Global variable to store Gemini API Key
        let geminiApiKey = ""; 

        // Timer variables
        const quizDurationInSeconds = 75 * 60; // 75 minutes
        let timeRemaining = quizDurationInSeconds;
        let timerInterval;
        const timerDisplay = document.getElementById('timer-display');


        // 科目名稱映射
        const subjectNames = {
            'topic1_ai_intro.json': '科目一：人工智慧基礎概論',
            'topic2_generative_ai_app_planning.json': '科目二：生成式 AI 應用與規劃'
        };

        /**
         * Fisher-Yates 洗牌演算法
         * @param {Array} array - 要洗牌的陣列
         * @returns {Array} - 洗牌後的陣列
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                // 修正：正確的陣列解構交換語法
                [array[i], array[j]] = [array[j], array[i]]; 
            }
            return array;
        }

        /**
         * 遞迴地從物件或陣列中移除所有 undefined 值。
         * Firestore 不支援 undefined 值。
         * @param {any} obj - 要清理的物件或值。
         * @returns {any} - 清理後的物件或值，undefined 值會被移除。
         */
        function removeUndefined(obj) {
            if (obj === null || typeof obj !== 'object') {
                return obj;
            }

            if (Array.isArray(obj)) {
                // 遞迴處理陣列中的每個元素，並過濾掉 undefined 的結果
                return obj.map(item => removeUndefined(item)).filter(item => item !== undefined);
            }

            const newObj = {};
            for (const key in obj) {
                // 確保只處理物件自身的屬性，而非原型鏈上的屬性
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    const value = obj[key];
                    if (value !== undefined) {
                        // 遞迴處理巢狀物件
                        newObj[key] = removeUndefined(value);
                    }
                }
            }
            return newObj;
                }

        // 追蹤使用者訪問
        async function trackUserVisit(appIdToUse) {
            const userId = currentUserId; // Use the globally set currentUserId (Firebase UID)
            if (!userId) {
                console.error("追蹤使用者訪問失敗: 無法獲取使用者 ID。");
                return;
            }

            // 增加短暫延遲，以確保 Firestore 數據同步（診斷用）
            await new Promise(resolve => setTimeout(resolve, 500)); 

            // 使用公共數據路徑：/artifacts/{appId}/public/data/user_visits/{userId}
            // 這裡記錄每個唯一使用者的最後訪問時間，而不是總計數
            const userDocRef = doc(collection(db, 'artifacts', appIdToUse, 'public', 'data', 'user_visits'), userId); 
            console.log("Firestore document path for write:", userDocRef.path); // Log the full path for debugging
            console.log("Attempting Firestore operation with UID:", userId); // Log UID right before operation

            try {
                const docSnap = await getDoc(userDocRef); 
                if (!docSnap.exists()) { // Use .exists() as a method
                    // 如果使用者是第一次訪問，則記錄下來
                    await setDoc(userDocRef, { 
                        firstVisit: serverTimestamp(), 
                        lastVisit: serverTimestamp(),
                        userId: userId, // 儲存 Firebase UID
                        displayName: currentUserDisplayName || '匿名用戶' // 儲存暱稱
                    });
                    console.log(`新使用者訪問記錄成功: ${userId}`); 
                } else {
                    // 如果使用者已存在，則更新最後訪問時間和暱稱
                    await setDoc(userDocRef, { 
                        lastVisit: serverTimestamp(),
                        displayName: currentUserDisplayName || '匿名用戶' // 更新暱稱
                    }, { merge: true }); // 使用 merge: true 以免覆蓋其他字段
                    console.log(`使用者已記錄，更新最後訪問時間: ${userId}`);
                }
            } catch (error) {
                console.error("追蹤使用者訪問失敗:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許匿名使用者在路徑 `/artifacts/{appId}/public/data/user_visits/{userId}` 上進行讀寫操作。");
                }
            }
        }

        // 獲取並顯示獨立訪問人數
        async function getAndDisplayUserCount() {
            userCountDisplay.textContent = '正在載入訪問人數...'; // Loading message
            console.log("getAndDisplayUserCount: 開始載入訪問人數...");
            console.log("getAndDisplayUserCount: db 實例:", db);
            console.log("getAndDisplayUserCount: effectiveAppId:", effectiveAppId);

            // Add a small delay to ensure Firebase is fully initialized and connected
            await new Promise(resolve => setTimeout(resolve, 500)); 

            if (!db || !effectiveAppId) {
                console.error("getAndDisplayUserCount: Firestore 未初始化或 App ID 無效，無法獲取訪問人數。db:", db, "effectiveAppId:", effectiveAppId);
                userCountDisplay.textContent = '無法載入訪問人數 (初始化中/錯誤)。請檢查控制台錯誤訊息。';
                return;
            }

            try {
                // 參考 user_visits 集合
                const userVisitsCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'user_visits');
                console.log("getAndDisplayUserCount: 嘗試從 Firestore 讀取 user_visits 集合...");
                const querySnapshot = await getDocs(userVisitsCollectionRef);
                const userCount = querySnapshot.size; // 獲取文件數量

                userCountDisplay.textContent = `總訪問人數 (獨立訪客)：${userCount} 人`;
                console.log(`getAndDisplayUserCount: 成功獲取訪問人數: ${userCount} 人`);
            } catch (error) {
                console.error("getAndDisplayUserCount: 獲取訪問人數失敗:", error);
                userCountDisplay.textContent = '無法載入訪問人數 (錯誤)。請檢查控制台錯誤訊息。';
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許讀取 `/artifacts/{appId}/public/data/user_visits`。");
                }
            }
        }

        // 從 Firestore 載入測驗進度
        async function loadQuizProgress(subjectId) {
            if (!db || !currentUserId || !effectiveAppId) {
                console.warn("無法載入進度：Firebase 未初始化或用戶 ID 無效。");
                return null;
            }

            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);

            try {
                const docSnap = await getDoc(progressDocRef);
                if (docSnap.exists()) {
                    console.log(`測驗進度已載入 (科目: ${subjectId})`);
                    return docSnap.data();
                } else {
                    console.log(`未找到測驗進度 (科目: ${subjectId})`);
                    return null;
                }
            } catch (error) {
                console.error("載入測驗進度失敗:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許匿名使用者在路徑 `/artifacts/{appId}/users/{userId}/quiz_progress/{subjectId}` 上進行讀取操作。");
                }
                return null;
            }
        }

        // 檢查並顯示是否有儲存的進度
        async function checkAndDisplaySavedProgress() {
            if (!currentUserId) {
                console.log("用戶 ID 尚未準備好，無法檢查進度。");
                return;
            }

            // 預設選擇的科目
            const defaultSubject = subjectSelect.value;
            loadedProgressData = await loadQuizProgress(defaultSubject);

            if (loadedProgressData) {
                continueQuizMessage.textContent = `您有未完成的「${subjectNames[defaultSubject]}」測驗進度 (暱稱: ${currentUserDisplayName || '匿名用戶'})。`;
                continueQuizPrompt.style.display = 'flex'; // 顯示繼續測驗提示
                subjectSelectionArea.style.display = 'none'; // 隱藏科目選擇區域
            } else {
                continueQuizPrompt.style.display = 'none'; // 隱藏繼續測驗提示
                subjectSelectionArea.style.display = 'block'; // 顯示科目選擇區域
                getQuestionCounts(); // 顯示題目數量
            }
        }

        // 初始化測驗資料：隨機抽取 50 題
        function initializeQuizData() {
            const shuffledFullData = shuffleArray([...fullQuizData]);
            selectedQuizData = shuffledFullData.slice(0, Math.min(50, shuffledFullData.length));
        }

        // 載入問題
        function loadQuestion() {
            if (selectedQuizData.length === 0) {
                questionTextElement.textContent = '無法載入題目。請檢查 JSON 檔案。';
                optionsContainer.innerHTML = '';
                prevButton.disabled = true;
                nextButton.disabled = true;
                submitEarlyButton.disabled = true; // Disable submit button if no questions
                return;
            }

            const questionData = selectedQuizData[currentQuestionIndex];
            questionNumberElement.textContent = `問題 ${currentQuestionIndex + 1} / ${selectedQuizData.length}`;
            questionTextElement.textContent = questionData.question;
            optionsContainer.innerHTML = ''; // 清空選項

            // Create an array of objects, each containing option content and its original label (A, B, C, D)
            const optionsWithOriginalLabels = questionData.options.map((optionContent, index) => ({
                content: optionContent,
                originalLabel: optionLabels[index] // optionLabels is global
            }));

            // Shuffle this array of objects
            const shuffledOptions = shuffleArray(optionsWithOriginalLabels);

            shuffledOptions.forEach((optionItem, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                // Display the new label (A, B, C, D based on shuffled position) and the option content
                button.innerHTML = `<span class="option-label">${optionLabels[index]}</span> ${optionItem.content}`;
                // Store the original label of this option's content for correctness check
                button.dataset.originalLabelForContent = optionItem.originalLabel;
                // Store the actual content for display purposes (e.g., in feedback)
                button.dataset.optionContent = optionItem.content; 

                // When clicked, pass the button element and the original label of its content
                button.addEventListener('click', () => selectOption(button, optionItem.originalLabel));
                optionsContainer.appendChild(button);
            });

            // 顯示用戶之前的選擇和回饋（如果有的話）
            if (userAnswers[currentQuestionIndex]) {
                const selectedOriginalLabel = userAnswers[currentQuestionIndex].selectedOriginalLabel; // Get original label of previously selected option
                const correctOptionLabel = selectedQuizData[currentQuestionIndex].answer; // Correct answer label (A, B, C, D)

                const buttons = optionsContainer.querySelectorAll('.option-button');
                buttons.forEach(button => {
                    button.classList.add('disabled'); // Disable all options
                    if (button.dataset.originalLabelForContent === selectedOriginalLabel) {
                        button.classList.add('selected');
                        if (selectedOriginalLabel === correctOptionLabel) {
                            button.classList.add('correct');
                        } else {
                            button.classList.add('incorrect');
                        }
                    }
                    // Highlight the correct answer
                    if (button.dataset.originalLabelForContent === correctOptionLabel) {
                        button.classList.add('correct');
                    }
                });
                showFeedback(selectedQuizData[currentQuestionIndex].explanation, userAnswers[currentQuestionIndex].isCorrect);
                askGeminiButton.style.display = 'inline-block'; // Show Gemini button
            } else {
                hideFeedback();
                askGeminiButton.style.display = 'none'; // Hide Gemini button
            }

            // 清空 Gemini 模態框內容
            geminiQuestionInput.value = '';
            geminiResponseArea.innerHTML = '';
            geminiResponseArea.style.display = 'none';
            geminiLoadingIndicator.style.display = 'none';

            updateNavigationButtons();
        }

        // 選擇選項
        async function selectOption(selectedButton, selectedOriginalLabel) { // Now receives the original label of the clicked option
            // 如果已經有答案，則不允許再次選擇
            if (userAnswers[currentQuestionIndex]) {
                return;
            }

            const buttons = optionsContainer.querySelectorAll('.option-button');
            buttons.forEach(button => {
                button.classList.remove('selected');
                button.classList.add('disabled'); // 禁用所有選項
            });

            selectedButton.classList.add('selected');

            const questionData = selectedQuizData[currentQuestionIndex];
            const correctOptionLabel = questionData.answer; // Correct answer label from JSON (e.g., 'C')
            
            // Get the actual content of the correct answer based on its original label
            const correctOptionContent = questionData.options[optionLabels.indexOf(correctOptionLabel)];

            // Check if the selected option's original label matches the correct answer's original label
            const isCorrect = (selectedOriginalLabel === correctOptionLabel);

            if (isCorrect) {
                selectedButton.classList.add('correct');
                score++; // 答對加分
            } else {
                selectedButton.classList.add('incorrect');
                // Record incorrect question
                incorrectQuestions.push({
                    question: questionData.question,
                    selectedOption: selectedButton.dataset.displayLabel, // Use the displayed label (A, B, C, D)
                    selectedOptionContent: selectedButton.dataset.optionContent, // Use the actual content
                    correctOption: correctOptionLabel, // Original correct label (A, B, C, D)
                    correctOptionContent: correctOptionContent, // Actual content of the correct option
                    explanation: questionData.explanation
                });
            }

            // Highlight the correct answer
            buttons.forEach(button => {
                if (button.dataset.originalLabelForContent === correctOptionLabel) {
                    button.classList.add('correct');
                }
            });

            // Store user's answer
            userAnswers[currentQuestionIndex] = {
                selectedOriginalLabel: selectedOriginalLabel, // Store the original label of the selected option
                isCorrect: isCorrect
            };

            showFeedback(questionData.explanation, isCorrect);
            askGeminiButton.style.display = 'inline-block'; // Show Gemini button
            updateNavigationButtons(); // Enable next button after answering

            // Save progress after each answer
            // await saveQuizProgress(subjectSelect.value); // Temporarily commented out as per user request
        }

        // 顯示回饋
        function showFeedback(explanation, isCorrect) {
            feedbackTitleElement.textContent = isCorrect ? '✅ 恭喜您，回答正確！' : '❌ 很抱歉，回答錯誤。';
            feedbackTextContentElement.textContent = explanation;
            feedbackContainer.classList.add('show');
        }

        // 隱藏回饋
        function hideFeedback() {
            feedbackContainer.classList.remove('show');
        }

        // 更新導航按鈕狀態
        function updateNavigationButtons() {
            prevButton.disabled = currentQuestionIndex === 0;
            // 下一題按鈕只有在當前題目作答後才啟用
            nextButton.disabled = !userAnswers[currentQuestionIndex];
            submitEarlyButton.disabled = false; // Always enable submit button during quiz

            if (currentQuestionIndex === selectedQuizData.length - 1) {
                nextButton.textContent = '完成測驗';
            } else {
                nextButton.textContent = '下一題';
            }
        }

        // 下一題按鈕事件
        nextButton.addEventListener('click', () => {
            // 只有當前題目作答後才能點擊下一題
            if (!userAnswers[currentQuestionIndex]) {
                return;
            }

            if (currentQuestionIndex < selectedQuizData.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                // 完成測驗
                showQuizSummary();
            }
        });

        // 上一題按鈕事件
        prevButton.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        });

        // 交卷按鈕事件
        submitEarlyButton.addEventListener('click', () => {
            confirmationModalOverlay.style.display = 'flex'; // Show confirmation modal
        });

        // 確認交卷按鈕事件
        confirmYesButton.addEventListener('click', () => {
            confirmationModalOverlay.style.display = 'none'; // Hide confirmation modal
            showQuizSummary(); // Proceed to show quiz summary
        });

        // 取消交卷按鈕事件
        confirmNoButton.addEventListener('click', () => {
            confirmationModalOverlay.style.display = 'none'; // Hide confirmation modal
        });

        // 顯示測驗結果
        async function showQuizSummary() {
            stopTimer(); // Stop the timer when the quiz summary is shown
            quizContent.style.display = 'none';
            quizSummary.classList.add('show');

            summaryScoreElement.textContent = `${score} / ${selectedQuizData.length}`;
            let message = '';
            const percentage = (score / selectedQuizData.length) * 100;
            if (percentage === 100) {
                message = '太棒了！您對AI應用規劃師能力有非常深入的了解！';
            } else if (percentage >= 80) {
                message = '表現非常出色！您已經掌握了大部分的知識。';
            } else if (percentage >= 60) {
                message = '不錯的開始！再加把勁，您會更棒的。';
            } else {
                message = '繼續努力！多加練習，您一定會進步的。';
            }
            summaryMessageElement.textContent = message;

            // 顯示錯題回顧
            incorrectQuestionsSummaryElement.innerHTML = ''; // 清空之前的錯題
            if (incorrectQuestions.length > 0) {
                const title = document.createElement('h3');
                title.className = 'feedback-title text-xl mb-4';
                title.textContent = '錯題回顧';
                incorrectQuestionsSummaryElement.appendChild(title);

                incorrectQuestions.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    // Add new classes for the block effect
                    itemDiv.className = 'incorrect-question-item bg-red-50 border-red-300 border-2 rounded-lg p-4 mb-4 shadow-sm'; 
                    itemDiv.innerHTML = `
                        <p class="question-text-incorrect text-red-800"><strong>${index + 1}. ${item.question}</strong></p>
                        <p class="correct-answer-text text-green-700 mt-2">正確答案：${item.correctOptionContent}</p>
                        <p class="explanation-text text-purple-700 mt-2">${item.explanation}</p>
                    `;
                    incorrectQuestionsSummaryElement.appendChild(itemDiv);
                });
            } else {
                const noIncorrect = document.createElement('p');
                noIncorrect.className = 'feedback-text';
                noIncorrect.textContent = '恭喜您，沒有答錯的題目！';
                incorrectQuestionsSummaryElement.appendChild(noIncorrect);
            }

            // Clear saved progress after quiz completion
            // await clearQuizProgress(subjectSelect.value); // Temporarily commented out as per user request
            await saveQuizScoreToLeaderboard(); // Save score to leaderboard
        }

        // 載入 JSON 檔案的函數
        async function loadFullQuizData(jsonFileName, isContinuing = false) {
            initialSelectionScreen.style.display = 'none'; // 隱藏科目選擇畫面
            loadingIndicator.style.display = 'block'; // 顯示載入中訊息
            quizContent.style.display = 'none'; // 隱藏測驗內容
            quizSummary.classList.remove('show'); // 隱藏總結
            questionCountsElement.style.display = 'none'; // 隱藏題目數量
            userCountDisplay.style.display = 'none'; // 隱藏訪問人數
            continueQuizPrompt.style.display = 'none'; // 隱藏繼續測驗提示
            subjectSelectionArea.style.display = 'none'; // 隱藏科目選擇區域
            viewLeaderboardButton.style.display = 'none'; // 隱藏排行榜按鈕

            try {
                if (!isContinuing) { // Only fetch JSON if not continuing from saved data
                    // 從 GitHub 原始內容 URL 載入題目
                    const githubRawUrl = `https://raw.githubusercontent.com/ss1111119/ipas_AI-Planner-Exam/main/${jsonFileName}`;
                    const response = await fetch(githubRawUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    fullQuizData = await response.json();
                    initializeQuizData(); // 載入資料後再初始化隨機題目
                    currentQuestionIndex = 0; // 重置題目索引
                    userAnswers = []; // 清空答案
                    score = 0; // 重置分數
                    incorrectQuestions = []; // 清空錯題
                    timeRemaining = quizDurationInSeconds; // Reset timer
                } else {
                    // If continuing, use loadedProgressData
                    // Fix: Use nullish coalescing operator (??) to provide default values for numbers
                    currentQuestionIndex = loadedProgressData.currentQuestionIndex ?? 0;
                    userAnswers = loadedProgressData.userAnswers || [];
                    score = loadedProgressData.score ?? 0;
                    incorrectQuestions = loadedProgressData.incorrectQuestions || [];
                    timeRemaining = loadedProgressData.timeRemaining ?? quizDurationInSeconds;
                    selectedQuizData = loadedProgressData.selectedQuizData || []; // Use saved selectedQuizData
                }
                
                loadQuestion(); // 載入第一題
                quizContent.style.display = 'block'; // 顯示測驗內容
                currentSubjectTitle.textContent = subjectNames[jsonFileName]; // 更新科目標題
                startTimer(); // Start the timer when the quiz begins
            } catch (error) {
                console.error('載入測驗資料失敗:', error);
                loadingIndicator.textContent = `載入題目失敗：${subjectNames[jsonFileName]}。請檢查 GitHub 上的 JSON 檔案路徑或內容格式是否正確。錯誤: ${error.message}`;
                loadingIndicator.style.display = 'block'; // Keep it visible to show the error
                // On error, revert to initial state to allow user to retry
                initialSelectionScreen.style.display = 'flex';
                subjectSelectionArea.style.display = 'block';
                questionCountsElement.style.display = 'block';
                userCountDisplay.style.display = 'block';
                continueQuizPrompt.style.display = 'none'; // Ensure this is hidden
                viewLeaderboardButton.style.display = 'block'; // Show leaderboard button
                return; // Exit function if loading failed
            } finally {
                // Only hide loading indicator if data was successfully loaded
                if (fullQuizData.length > 0 || isContinuing) { 
                    loadingIndicator.style.display = 'none';
                }
            }
        }

        // 重新測驗按鈕事件
        restartButton.addEventListener('click', () => {
            // 重新顯示環境選擇畫面，並隱藏測驗內容和總結
            environmentSelectionScreen.style.display = 'flex'; // Go back to environment selection
            initialSelectionScreen.style.display = 'none';
            quizContent.style.display = 'none';
            quizSummary.classList.remove('show');
            askGeminiButton.style.display = 'none'; // 隱藏 Gemini 按鈕
            stopTimer(); // 確保計時器停止
            timerDisplay.style.display = 'none'; // 確保計時器隱藏
            // Re-trigger Firebase init and user ID handling for the environment screen
            // No need to call handleUserAuthenticationAndDataLoad() here,
            // just re-display the environment screen and let DOMContentLoaded handle counts.
            // But we need to ensure the user ID is still handled for the next quiz attempt.
            // The user will re-click an environment button, which will trigger auth again.
            // For now, just ensure the count is visible on return.
            getAndDisplayUserCount(); // Update count on return to environment screen
        });

        // 「開始測驗」按鈕事件 (從科目選擇畫面觸發)
        startQuizButton.addEventListener('click', () => {
            loadFullQuizData(subjectSelect.value, false); // Start a new quiz
        });

        // 「繼續測驗」按鈕事件
        continueQuizButton.addEventListener('click', () => {
            if (loadedProgressData) {
                loadFullQuizData(loadedProgressData.subjectId, true); // Continue from saved progress
            }
        });

        // 「開始新測驗」按鈕事件
        startNewQuizButton.addEventListener('click', async () => {
            // Clear existing progress for the selected subject before starting a new one
            // await clearQuizProgress(subjectSelect.value); // Temporarily commented out as per user request
            loadFullQuizData(subjectSelect.value, false); // Start a brand new quiz
        });


        // Gemini 相關事件監聽器
        askGeminiButton.addEventListener('click', () => {
            // 如果是 GitHub Pages 環境且沒有設定 API 金鑰，則提示輸入
            if (currentEnvironment === 'github-pages' && !geminiApiKey) {
                apiKeyModalOverlay.style.display = 'flex';
                geminiApiKeyInput.focus();
                return; // 停止，等待 API 金鑰輸入
            }
            geminiModalOverlay.style.display = 'flex'; // 顯示模態框
            geminiQuestionInput.focus(); // 輸入框自動獲取焦點
        });

        geminiModalClose.addEventListener('click', () => {
            geminiModalOverlay.style.display = 'none'; // 隱藏模態框
            geminiResponseArea.innerHTML = ''; // 清空回應內容
            geminiResponseArea.style.display = 'none';
            geminiQuestionInput.value = ''; // 清空輸入框
            geminiLoadingIndicator.style.display = 'none'; // 隱藏載入指示器
        });

        // 新增 Gemini 提問模態框取消按鈕的事件監聽器
        geminiModalCancelButton.addEventListener('click', () => {
            geminiModalOverlay.style.display = 'none'; // 隱藏模態框
            geminiResponseArea.innerHTML = ''; // 清空回應內容
            geminiResponseArea.style.display = 'none'; // 隱藏回應區域
            geminiQuestionInput.value = ''; // 清空輸入框
            geminiLoadingIndicator.style.display = 'none'; // 隱藏載入指示器
        });

        // 新增 API Key 模態框取消按鈕的事件監聽器
        apiKeyModalCancelButton.addEventListener('click', () => {
            apiKeyModalOverlay.style.display = 'none'; // 隱藏 API Key 模態框
            geminiApiKeyInput.value = ''; // 清空輸入框
        });

        // Handle API Key submission
        submitApiKeyButton.addEventListener('click', () => {
            const inputKey = geminiApiKeyInput.value.trim();
            if (inputKey) {
                geminiApiKey = inputKey; // Store the input key
                apiKeyModalOverlay.style.display = 'none'; // Hide the API key modal
                // Now re-trigger the askGeminiButton click to proceed with the question
                askGeminiButton.click(); 
            } else {
                // 使用自定義的訊息框替代 alert
                showConfirmationModal('提示', '請輸入有效的 Gemini API 金鑰。', null, true);
            }
        });


        submitGeminiQuestionButton.addEventListener('click', async () => {
            const userQuestion = geminiQuestionInput.value.trim();
            if (!userQuestion) {
                geminiResponseArea.style.display = 'block';
                geminiResponseArea.textContent = '請輸入您的問題。';
                return;
            }

            geminiResponseArea.innerHTML = ''; // 清空之前的回應
            geminiResponseArea.style.display = 'none';
            geminiLoadingIndicator.style.display = 'block'; // 顯示載入指示器

            const currentQuestionData = selectedQuizData[currentQuestionIndex];
            const prompt = `關於以下測驗題目：
題目：${currentQuestionData.question}
選項：
A) ${currentQuestionData.options[0]}
B) ${currentQuestionData.options[1]}
C) ${currentQuestionData.options[2]}
D) ${currentQuestionData.options[3]}
正確答案：${currentQuestionData.answer}
解釋：${currentQuestionData.explanation}

我的問題是：${userQuestion}

請根據上述資訊，詳細回答我的問題。`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // Use the dynamically set geminiApiKey
                const apiKeyToUse = (currentEnvironment === 'github-pages') ? geminiApiKey : ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKeyToUse}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    geminiResponseArea.textContent = text;
                } else {
                    geminiResponseArea.textContent = '抱歉，無法獲取回答。請稍後再試或換個問題。';
                    console.error('Gemini API response structure unexpected:', result);
                }
            } catch (error) {
                geminiResponseArea.textContent = '發生錯誤，無法連接到 Gemini 服務。請檢查您的網路連線。';
                console.error('Error calling Gemini API:', error);
            } finally {
                geminiLoadingIndicator.style.display = 'none'; // 隱藏載入指示器
                geminiResponseArea.style.display = 'block'; // 顯示回應區域
            }
        });

        // Timer functions
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function startTimer() {
            // Only reset time if not continuing from saved progress
            if (!loadedProgressData) {
                timeRemaining = quizDurationInSeconds;
            }
            timerDisplay.textContent = formatTime(timeRemaining);
            timerDisplay.style.display = 'block'; // Show timer when quiz starts

            timerInterval = setInterval(() => {
                timeRemaining--;
                timerDisplay.textContent = formatTime(timeRemaining);

                if (timeRemaining <= 0) {
                    stopTimer();
                    // Automatically submit the quiz when time runs out
                    showQuizSummary();
                    // Optionally, disable all options to prevent further interaction
                    const buttons = optionsContainer.querySelectorAll('.option-button');
                    buttons.forEach(button => {
                        button.classList.add('disabled');
                    });
                    // Also disable navigation buttons and submit button
                    prevButton.disabled = true;
                    nextButton.disabled = true;
                    submitEarlyButton.disabled = true;
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // 自定義確認/訊息模態框函數
        function showConfirmationModal(title, message, onConfirmCallback, isAlert = false) {
            const modalTitle = confirmationModalOverlay.querySelector('.confirmation-modal-title');
            const modalMessage = confirmationModalOverlay.querySelector('.confirmation-modal-message');
            const modalButtons = confirmationModalOverlay.querySelector('.confirmation-modal-buttons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            // 清空舊按鈕
            modalButtons.innerHTML = '';

            if (isAlert) {
                // 如果是提示訊息，只顯示一個「確定」按鈕
                const okButton = document.createElement('button');
                okButton.id = 'confirm-ok-button';
                okButton.className = 'confirmation-modal-button confirm-no'; // 使用 confirm-no 的樣式
                okButton.textContent = '確定';
                okButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback();
                    }
                });
                modalButtons.appendChild(okButton);
            } else {
                // 如果是確認訊息，顯示「確定交卷」和「取消」按鈕
                const yesButton = document.createElement('button');
                yesButton.id = 'confirm-yes-button';
                yesButton.className = 'confirmation-modal-button confirm-yes';
                yesButton.textContent = '確定交卷';
                yesButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback(true);
                    }
                });
                modalButtons.appendChild(yesButton);

                const noButton = document.createElement('button');
                noButton.id = 'confirm-no-button';
                noButton.className = 'confirmation-modal-button confirm-no';
                noButton.textContent = '取消';
                noButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback(false);
                    }
                });
                modalButtons.appendChild(noButton);
            }

            confirmationModalOverlay.style.display = 'flex';
        }


        // 獲取並顯示題目數量
        async function getQuestionCounts() {
            questionCountsElement.innerHTML = '<p>正在載入題目數量...</p>';
            let allCounts = {};
            let hasError = false;

            for (const fileName in subjectNames) {
                const githubRawUrl = `https://raw.githubusercontent.com/ss1111119/ipas_AI-Planner-Exam/main/${fileName}`;
                try {
                    const response = await fetch(githubRawUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    allCounts[fileName] = data.length;
                } catch (error) {
                    console.error(`載入 ${fileName} 題目數量失敗:`, error);
                    allCounts[fileName] = '載入失敗';
                    hasError = true;
                }
            }

            questionCountsElement.innerHTML = ''; // Clear loading message
            if (hasError) {
                questionCountsElement.innerHTML = '<p class="text-red-500">無法載入所有題目數量，請檢查網路連線或 GitHub 檔案路徑。</p>';
            }
            for (const fileName in subjectNames) {
                const p = document.createElement('p');
                p.textContent = `${subjectNames[fileName]}：${allCounts[fileName]} 題`;
                questionCountsElement.appendChild(p);
            }
        }


        // 儲存測驗進度到 Firestore
        async function saveQuizProgress(subjectId) {
            if (!db || !currentUserId || !effectiveAppId) {
                console.warn("無法儲存進度：Firebase 未初始化或用戶 ID 無效。");
                return;
            }

            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);
            
            try {
                const dataToSave = {
                    subjectId: subjectId,
                    // 確保所有數值型欄位都有預設值，避免 undefined
                    currentQuestionIndex: currentQuestionIndex !== undefined ? currentQuestionIndex : 0,
                    userAnswers: userAnswers || [], // 確保是陣列
                    score: score !== undefined ? score : 0,
                    incorrectQuestions: incorrectQuestions || [], // 確保是陣列
                    timeRemaining: timeRemaining !== undefined ? timeRemaining : quizDurationInSeconds,
                    selectedQuizData: selectedQuizData || [], // 確保是陣列
                    lastSaved: serverTimestamp()
                };
                
                // 深度清理資料，移除所有 undefined 值
                const cleanedDataToSave = removeUndefined(dataToSave);

                await setDoc(progressDocRef, cleanedDataToSave, { merge: false }); // Overwrite previous progress for this subject
                console.log(`測驗進度已儲存 (科目: ${subjectId})`);
            } catch (error) {
                console.error("儲存測驗進度失敗:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許匿名使用者在路徑 `/artifacts/{appId}/users/{userId}/quiz_progress/{subjectId}` 上進行讀寫操作。");
                }
            }
        }


        // 清除 Firestore 中的測驗進度
        async function clearQuizProgress(subjectId) {
            if (!db || !currentUserId || !effectiveAppId) {
                console.warn("無法清除進度：Firebase 未初始化或用戶 ID 無效。");
                return;
            }
            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);
            try {
                await setDoc(progressDocRef, {}); // Set to empty object to clear content
                console.log(`測驗進度已清除 (科目: ${subjectId})`);
                loadedProgressData = null; // Clear local loaded data
            } catch (error) {
                console.error("清除測驗進度失敗:", error);
            }
        }

        // Firebase 初始化 (僅初始化服務，不處理登入邏輯)
        async function initializeFirebaseServices() {
            try {
                console.log("initializeFirebaseServices: 開始初始化 Firebase 服務...");
                console.log("initializeFirebaseServices: 檢查 firebaseConfig:", firebaseConfig);
                
                if (!firebaseConfig.apiKey || !firebaseConfig.authDomain || !firebaseConfig.projectId || !firebaseConfig.appId) {
                    console.error("initializeFirebaseServices: Firebase 配置不完整。請確保 apiKey, authDomain, projectId, 和 appId 都已提供。", firebaseConfig);
                    throw new Error("Firebase 配置不完整。請確保 apiKey, authDomain, projectId, 和 appId 都已提供。");
                }

                if (!app) {
                    app = initializeApp(firebaseConfig); 
                    auth = getAuth(app); 
                    db = getFirestore(app); 
                    console.log("initializeFirebaseServices: Firebase app, auth, db 已初始化。");
                } else {
                    console.log("initializeFirebaseServices: Firebase 服務已初始化，跳過重複初始化。");
                }


                let firebaseAppId = firebaseConfig.appId;
                if (typeof __app_id !== 'undefined') {
                    firebaseAppId = __app_id;
                    currentEnvironment = 'canvas';
                    console.log("initializeFirebaseServices: 檢測到 Canvas 環境。使用 __app_id。");
                } else {
                    currentEnvironment = 'github-pages'; // Default to github-pages if not canvas
                    console.log("initializeFirebaseServices: 檢測到 GitHub Pages 環境。");
                }
                effectiveAppId = firebaseAppId;
                console.log("initializeFirebaseServices: 實際使用的 appId (effectiveAppId):", effectiveAppId);

            } catch (error) {
                console.error("initializeFirebaseServices: Firebase 初始化失敗:", error);
                userCountDisplay.textContent = '無法載入訪問人數 (初始化錯誤)。'; // Display error on screen
                // If Firebase initialization fails, show subject selection directly
                environmentSelectionScreen.style.display = 'none';
                initialSelectionScreen.style.display = 'flex';
                continueQuizPrompt.style.display = 'none';
                subjectSelectionArea.style.display = 'block';
                getQuestionCounts(); // Still try to show question counts
                viewLeaderboardButton.style.display = 'block'; // Show leaderboard button
            }
        }

        // 新增函數：儲存使用者暱稱到 Firestore
        async function saveUserDisplayNameToFirestore(uid, displayName) {
            if (!db || !uid || !effectiveAppId) {
                console.warn("無法儲存顯示名稱：Firebase 未初始化或 UID 無效。");
                return;
            }
            const userProfileDocRef = doc(db, 'artifacts', effectiveAppId, 'users', uid, 'profile', 'data');
            try {
                await setDoc(userProfileDocRef, { displayName: displayName, lastUpdated: serverTimestamp() }, { merge: true });
                console.log(`使用者顯示名稱已儲存: ${displayName} for UID: ${uid}`);
            } catch (error) {
                console.error("儲存使用者顯示名稱失敗:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許使用者在路徑 `/artifacts/{appId}/users/{userId}/profile/data` 上進行讀寫操作。");
                }
            }
        }

        // 新增函數：從 Firestore 載入使用者暱稱
        async function loadUserDisplayNameFromFirestore(uid) {
            if (!db || !uid || !effectiveAppId) {
                console.warn("無法載入顯示名稱：Firebase 未初始化或 UID 無效。");
                return null;
            }
            const userProfileDocRef = doc(db, 'artifacts', effectiveAppId, 'users', uid, 'profile', 'data');
            try {
                const docSnap = await getDoc(userProfileDocRef);
                if (docSnap.exists() && docSnap.data().displayName) {
                    console.log(`從 Firestore 載入顯示名稱: ${docSnap.data().displayName} for UID: ${uid}`);
                    return docSnap.data().displayName;
                }
                console.log(`未從 Firestore 載入顯示名稱 for UID: ${uid}`);
                return null;
            } catch (error) {
                console.error("載入使用者顯示名稱失敗:", error);
                return null;
            }
        }

        // 處理使用者認證和資料載入
        async function handleUserAuthenticationAndDataLoad() {
            console.log("handleUserAuthenticationAndDataLoad: 開始處理使用者認證和資料載入...");
            if (!app || !auth || !db) {
                console.error("handleUserAuthenticationAndDataLoad: Firebase 服務未初始化，無法處理使用者認證和資料載入。");
                showConfirmationModal('錯誤', 'Firebase 服務未初始化，請重新整理頁面或稍後再試。', null, true);
                return;
            }

            let firebaseAuthUid = null;

            // Step 1: Perform Firebase Authentication (Custom Token or Anonymous)
            if (currentEnvironment === 'canvas') {
                console.log("handleUserAuthenticationAndDataLoad: Canvas 環境認證中...");
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                        firebaseAuthUid = userCredential.user.uid;
                        console.log("Canvas: 已使用自定義 token 登入。UID:", firebaseAuthUid);
                    } catch (tokenError) {
                        console.error("Canvas: 自定義 token 登入失敗，嘗試匿名登入:", tokenError);
                        try {
                            const userCredential = await signInAnonymously(auth);
                            firebaseAuthUid = userCredential.user.uid;
                            console.log("Canvas: 自定義 token 失敗後，已匿名登入。UID:", firebaseAuthUid);
                        } catch (anonError) {
                            console.error("Canvas: 匿名登入失敗:", anonError);
                            showConfirmationModal('錯誤', 'Canvas 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                            return;
                        }
                    }
                } else {
                    console.log("Canvas: 無自定義 token，嘗試匿名登入...");
                    try {
                        const userCredential = await signInAnonymously(auth);
                        firebaseAuthUid = userCredential.user.uid;
                        console.log("Canvas: 已匿名登入。UID:", firebaseAuthUid);
                    } catch (anonError) {
                        console.error("Canvas: 匿名登入失敗:", anonError);
                        showConfirmationModal('錯誤', 'Canvas 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                        return;
                    }
                }
            } else { // GitHub Pages Environment
                console.log("handleUserAuthenticationAndDataLoad: GitHub Pages 環境匿名認證中...");
                // Always sign in anonymously for GitHub Pages to get a Firebase UID for security rules
                try {
                    const userCredential = await signInAnonymously(auth);
                    firebaseAuthUid = userCredential.user.uid;
                    console.log("GitHub Pages: 已匿名登入。UID:", firebaseAuthUid);
                } catch (anonError) {
                    console.error("GitHub Pages: 匿名登入失敗:", anonError);
                    showConfirmationModal('錯誤', 'GitHub Pages 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                    return;
                }
            }

            // At this point, firebaseAuthUid should be set. Use it as the actual currentUserId.
            currentUserId = firebaseAuthUid;
            console.log("handleUserAuthenticationAndDataLoad: currentUserId 已設定為:", currentUserId);

            // Step 2: Handle user display name
            let storedDisplayName = localStorage.getItem('user_defined_display_name');
            if (storedDisplayName) {
                currentUserDisplayName = storedDisplayName;
                console.log("handleUserAuthenticationAndDataLoad: 從 localStorage 使用儲存的顯示名稱:", currentUserDisplayName);
                // Also save/update it in Firestore profile for consistency
                await saveUserDisplayNameToFirestore(currentUserId, currentUserDisplayName);
                await proceedAfterUserIdSet(); // Proceed immediately if display name found
            } else {
                // Try to load from Firestore if not in localStorage
                const loadedDisplayName = await loadUserDisplayNameFromFirestore(currentUserId);
                if (loadedDisplayName) {
                    currentUserDisplayName = loadedDisplayName;
                    localStorage.setItem('user_defined_display_name', currentUserDisplayName); // Store in localStorage for future quick access
                    console.log("handleUserAuthenticationAndDataLoad: 從 Firestore 使用儲存的顯示名稱:", currentUserDisplayName);
                    await proceedAfterUserIdSet(); // Proceed immediately if display name found
                } else {
                    // If no display name found anywhere, prompt the user
                    console.log("handleUserAuthenticationAndDataLoad: 未找到顯示名稱，顯示使用者暱稱輸入模態框。");
                    userIdModalOverlay.style.display = 'flex';
                    userIdInput.focus();
                    // Do NOT call proceedAfterUserIdSet() here, it will be called after user submits ID
                }
            }
        }

        // 新增函數：在設定使用者 ID 後繼續執行
        async function proceedAfterUserIdSet() {
            console.log("proceedAfterUserIdSet: 繼續執行，currentUserId:", currentUserId);
            if (currentUserId) {
                console.log("proceedAfterUserIdSet: db:", db, "effectiveAppId:", effectiveAppId); // Diagnostic log
                await trackUserVisit(effectiveAppId); // This uses currentUserId (Firebase UID)
                // Removed: await getAndDisplayUserCount(); // <--- This call is now done on DOMContentLoaded
                // checkAndDisplaySavedProgress(); // Temporarily commented out as per user request
                environmentSelectionScreen.style.display = 'none';
                initialSelectionScreen.style.display = 'flex';
                subjectSelectionArea.style.display = 'block'; // Always show subject selection for now
                getQuestionCounts(); // Display question counts
                viewLeaderboardButton.style.display = 'block'; // Show leaderboard button on initial screen
            } else {
                console.error("proceedAfterUserIdSet: 無法設定 currentUserId。");
                showConfirmationModal('錯誤', '無法設定使用者 ID，請重新整理頁面或稍後再試。', null, true);
            }
        }

        // 環境選擇按鈕事件監聽器
        selectCanvasEnvButton.addEventListener('click', async () => {
            currentEnvironment = 'canvas';
            // Ensure user count display is visible when this screen is active
            userCountDisplay.style.display = 'block'; 
            await handleUserAuthenticationAndDataLoad();
        });

        selectGithubEnvButton.addEventListener('click', async () => {
            currentEnvironment = 'github-pages';
            // Ensure user count display is visible when this screen is active
            userCountDisplay.style.display = 'block'; 
            await handleUserAuthenticationAndDataLoad();
        });

        // 使用者 ID 輸入模態框的確認按鈕
        submitUserIdButton.addEventListener('click', async () => {
            let enteredDisplayName = userIdInput.value.trim();
            // 如果沒有輸入暱稱，則給予預設稱呼
            if (!enteredDisplayName) {
                enteredDisplayName = '陌生人'; // 或者您可以使用 '匿名訪客', '未命名用戶' 等
            }
            
            showGlobalLoading(); // 顯示載入中
            currentUserDisplayName = enteredDisplayName;
            localStorage.setItem('user_defined_display_name', enteredDisplayName); // Store in localStorage
            userIdModalOverlay.style.display = 'none'; // 隱藏模態框
            console.log("User display name set and stored:", currentUserDisplayName);
            // Save to Firestore profile immediately
            await saveUserDisplayNameToFirestore(currentUserId, currentUserDisplayName);
            await proceedAfterUserIdSet(); // 繼續處理認證和資料載入
            hideGlobalLoading(); // 隱藏載入中
        });

        // 使用者 ID 輸入模態框的取消按鈕
        cancelUserIdButton.addEventListener('click', () => {
            userIdModalOverlay.style.display = 'none'; // 隱藏模態框
            // 如果使用者取消，則回到環境選擇畫面
            environmentSelectionScreen.style.display = 'flex';
            initialSelectionScreen.style.display = 'none'; // 確保初始選擇畫面隱藏
            userCountDisplay.style.display = 'block'; // Ensure it's visible if returning to env screen
            // Re-initialize Firebase and user auth for the environment screen
            // No need to call initializeFirebaseServices() again, as it's already done on DOMContentLoaded.
            // Just ensure the count is updated if needed.
            getAndDisplayUserCount(); // Update count on return to environment screen
        });

        // Leaderboard functions
        async function saveQuizScoreToLeaderboard() {
            if (!db || !currentUserId || !effectiveAppId) {
                console.warn("無法儲存排行榜分數：Firebase 未初始化或用戶 ID 無效。");
                return;
            }

            // 使用公共數據路徑：/artifacts/{appId}/public/data/leaderboard_scores
            const leaderboardCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'leaderboard_scores');
            
            try {
                const scoreData = {
                    userId: currentUserId,
                    displayName: currentUserDisplayName || '匿名用戶',
                    score: score,
                    totalQuestions: selectedQuizData.length,
                    subject: subjectNames[subjectSelect.value],
                    timestamp: serverTimestamp()
                };

                // Add a new document with an auto-generated ID
                await addDoc(leaderboardCollectionRef, scoreData);
                console.log("測驗分數已儲存到排行榜。");
            } catch (error) {
                console.error("儲存測驗分數到排行榜失敗:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許使用者在路徑 `/artifacts/{appId}/public/data/leaderboard_scores` 上進行寫入操作。");
                }
            }
        }

        async function fetchLeaderboardScores() {
            console.log("fetchLeaderboardScores: 開始獲取排行榜分數...");
            console.log("fetchLeaderboardScores: db 實例:", db);
            console.log("fetchLeaderboardScores: effectiveAppId:", effectiveAppId);

            if (!db || !effectiveAppId) {
                console.error("fetchLeaderboardScores: Firestore 未初始化或 App ID 無效，無法獲取排行榜分數。");
                leaderboardList.innerHTML = '<li>無法載入排行榜 (初始化中)。</li>';
                return;
            }

            const leaderboardCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'leaderboard_scores');
            console.log("fetchLeaderboardScores: leaderboardCollectionRef path:", leaderboardCollectionRef.path);
            
            try {
                const q = query(leaderboardCollectionRef, orderBy('score', 'desc'), orderBy('timestamp', 'asc'), limit(100));
                console.log("fetchLeaderboardScores: 準備執行 getDocs 查詢...");
                const querySnapshot = await getDocs(q);
                console.log("fetchLeaderboardScores: getDocs 查詢已完成。");

                leaderboardList.innerHTML = ''; // Clear previous list
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = '<li>目前沒有排行榜資料。</li>';
                    console.log("fetchLeaderboardScores: 排行榜為空。");
                    return;
                }

                let rank = 1;
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const listItem = document.createElement('li');
                    const timestampDate = data.timestamp ? data.timestamp.toDate() : new Date(); // Convert timestamp to Date object
                    const formattedDate = timestampDate.toLocaleString('zh-TW', {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    listItem.innerHTML = `
                        <span class="leaderboard-rank">${rank}.</span>
                        <span class="leaderboard-name">${data.displayName} (${data.subject})</span>
                        <span class="leaderboard-score">${data.score} / ${data.totalQuestions}</span>
                        <span class="text-sm text-gray-500 ml-4">${formattedDate}</span>
                    `;
                    leaderboardList.appendChild(listItem);
                    rank++;
                });
                console.log("fetchLeaderboardScores: 排行榜資料已顯示。");
            } catch (error) {
                console.error("fetchLeaderboardScores: 獲取排行榜分數失敗:", error);
                leaderboardList.innerHTML = '<li>載入排行榜失敗 (錯誤)。</li>';
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許讀取 `/artifacts/{appId}/public/data/leaderboard_scores`。");
                }
            }
        }

        // 排行榜按鈕事件監聽器
        viewLeaderboardButton.addEventListener('click', async () => {
            leaderboardModalOverlay.style.display = 'flex';
            await fetchLeaderboardScores();
        });

        viewLeaderboardButtonSummary.addEventListener('click', async () => {
            leaderboardModalOverlay.style.display = 'flex';
            await fetchLeaderboardScores();
        });

        leaderboardModalClose.addEventListener('click', () => {
            leaderboardModalOverlay.style.display = 'none';
        });

        // Share Quiz Results Function
        async function shareQuizResults() {
            const quizTitle = "iPAS初級AI應用規劃師模擬測驗";
            const subjectName = subjectNames[subjectSelect.value];
            const finalScore = `${score} / ${selectedQuizData.length}`;
            const message = summaryMessageElement.textContent;
            const userName = currentUserDisplayName || '匿名用戶';

            let shareText = `我在「${quizTitle}」的「${subjectName}」測驗中，獲得了 ${finalScore} 分！\n${message}\n\n`;
            shareText += `我的暱稱是：${userName}\n`;

            if (incorrectQuestions.length > 0) {
                shareText += `\n我答錯了 ${incorrectQuestions.length} 題，繼續努力！`;
            } else {
                shareText += `\n恭喜我，沒有答錯的題目！`;
            }
            shareText += `\n\n立即來挑戰：${window.location.href}`; // Include current URL

            try {
                if (navigator.share) {
                    // Use Web Share API if available
                    await navigator.share({
                        title: quizTitle,
                        text: shareText,
                        url: window.location.href,
                    });
                    showConfirmationModal('分享成功', '測驗結果已成功分享！', null, true);
                } else {
                    // Fallback to copying to clipboard
                    const tempInput = document.createElement('textarea');
                    tempInput.value = shareText;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showConfirmationModal('複製成功', '測驗結果已複製到剪貼簿！您可以貼到任何地方。', null, true);
                }
            } catch (error) {
                console.error('分享失敗:', error);
                // Check if the error is due to user aborting share (e.e., clicking cancel)
                if (error.name !== 'AbortError') {
                    showConfirmationModal('分享失敗', '無法分享測驗結果。您的瀏覽器可能不支援分享功能，或發生其他錯誤。結果已嘗試複製到剪貼簿。', null, true);
                } else {
                    // User cancelled sharing, no need for an error message
                    console.log('分享已取消。');
                }
            }
        }

        // Add event listener for the share button
        shareResultsButton.addEventListener('click', shareQuizResults);


        // 頁面載入時只顯示環境選擇畫面，並初始化 Firebase 服務
        document.addEventListener('DOMContentLoaded', async () => {
            environmentSelectionScreen.style.display = 'flex';
            initialSelectionScreen.style.display = 'none';
            quizContent.style.display = 'none';
            quizSummary.classList.remove('show');
            timerDisplay.style.display = 'none'; // Hide timer on initial load
            userIdModalOverlay.style.display = 'none'; // 確保使用者 ID 模態框初始是隱藏的
            leaderboardModalOverlay.style.display = 'none'; // 確保排行榜模態框初始是隱藏的
            
            // 在頁面載入時就初始化 Firebase 服務
            await initializeFirebaseServices();
            // 立即獲取並顯示訪問人數，因為它在首頁顯示
            await getAndDisplayUserCount();

            // Add beforeunload listener to save progress
            window.addEventListener('beforeunload', async () => {
                if (quizContent.style.display === 'block' && currentUserId && selectedQuizData.length > 0) {
                    // Only save if quiz is active and user has answered at least one question
                    if (userAnswers.length > 0) {
                        // Note: beforeunload is synchronous, so async operations might not complete.
                        // For critical data, a more robust solution might involve a dedicated "save" button
                        // or a backend service. However, for simple progress, this is a best effort.
                        // await saveQuizProgress(subjectSelect.value); // Temporarily commented out as per user request
                    }
                }
            });
        });
    </script>
</body>
</html>
