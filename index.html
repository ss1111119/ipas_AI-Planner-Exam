<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 應用規劃師能力測驗</title>
    <!-- Tailwind CSS CDN - 用於快速構建響應式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 字體 - 提供現代且易讀的字體樣式 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* 基本樣式設定，確保內容垂直居中 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        /* 測驗容器樣式，包含陰影和圓角，並設定背景動畫 */
        .quiz-container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center; /* 水平居中 */
            justify-content: center; /* 垂直居中 */
            position: relative;
            overflow: hidden; /* 隱藏超出容器的內容，用於背景動畫 */
            min-height: 400px; /* 確保容器有足夠高度來居中內容 */
        }
        /* 測驗容器的偽元素，用於創建脈衝背景動畫 */
        .quiz-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, #e0f2fe, #ffffff);
            animation: pulse 10s infinite alternate;
            z-index: 0;
            opacity: 0.3;
        }
        /* 脈衝動畫關鍵幀 */
        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.3; }
            100% { transform: scale(1.1); opacity: 0.5; }
        }
        /* 內容包裹器，確保內容在背景動畫之上 */
        .content-wrapper {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        /* 載入訊息的樣式 */
        .loading-message {
            font-size: 1.5rem;
            color: #4a5568;
            margin-top: 50px;
        }
        /* 科目選擇區塊樣式，響應式佈局 */
        .subject-selection {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        @media (min-width: 640px) {
            .subject-selection {
                flex-direction: row;
                justify-content: center;
            }
        }
        /* 下拉選單樣式 */
        .subject-selection select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #cbd5e0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            background-color: #f7fafc;
            appearance: none; /* 移除預設箭頭 */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20fill%3D%22%234A5568%22%20d%3D%22M9.293%2012.95l.707.707L15.657%208l-1.414-1.414L10%2010.828%206.757%207.586%205.343%209z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        .subject-selection select:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* 開始測驗按鈕樣式 */
        .start-quiz-button {
            background-color: #48bb78;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.3);
        }
        .start-quiz-button:hover:not(:disabled) {
            background-color: #38a169;
            transform: translateY(-2px);
        }
        .start-quiz-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* 初始選擇畫面樣式 */
        #initial-selection-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        /* 科目標題樣式 */
        .subject-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 問題編號樣式 */
        .question-number {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 10px;
            font-weight: 600;
        }
        /* 問題文本樣式 */
        .question-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        /* 選項容器樣式 */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            text-align: left;
        }
        /* 選項按鈕樣式 */
        .option-button {
            background-color: #edf2f7;
            color: #4a5568;
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .option-button:hover:not(.disabled):not(.correct):not(.incorrect) {
            background-color: #e2e8f0;
            border-color: #cbd5e0;
        }
        /* 選中選項的樣式 */
        .option-button.selected {
            border-color: #63b3ed;
            background-color: #ebf8ff;
            color: #2b6cb0;
        }
        /* 正確選項的樣式 */
        .option-button.correct {
            background-color: #d4edda; /* 淺綠色 */
            border-color: #48bb78; /* 綠色 */
            color: #2f855a;
        }
        /* 錯誤選項的樣式 */
        .option-button.incorrect {
            background-color: #fde8e8; /* 淺紅色 */
            border-color: #ef4444; /* 紅色 */
            color: #c53030;
        }
        /* 選項標籤樣式 (A, B, C, D) */
        .option-label {
            font-weight: bold;
            min-width: 25px;
            text-align: center;
        }
        /* 回饋容器樣式 */
        .feedback-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: left;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            display: none; /* 預設隱藏 */
            font-size: 1rem;
            line-height: 1.6;
        }
        .feedback-container.show {
            display: block;
        }
        /* 回饋標題樣式 */
        .feedback-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #2d3748;
        }
        /* 回饋文本樣式 */
        .feedback-text {
            color: #4a5568;
        }
        /* 導航按鈕容器樣式 */
        .navigation-buttons {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        /* 導航按鈕樣式 */
        .nav-button {
            background-color: #4299e1;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.3);
        }
        .nav-button:hover:not(:disabled) {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .nav-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* 提交測驗按鈕樣式 */
        .submit-quiz-button {
            background-color: #ef4444; /* 紅色 */
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        .submit-quiz-button:hover:not(:disabled) {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .submit-quiz-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* 測驗總結區塊 (預設隱藏) */
        .quiz-summary {
            margin-top: 30px;
            padding: 30px;
            background-color: #e6fffa;
            border-radius: 15px;
            border: 2px solid #38b2ac;
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 600;
            display: none; /* 預設隱藏 */
        }
        .quiz-summary.show {
            display: block;
        }
        /* 總結標題樣式 */
        .summary-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 總結分數樣式 */
        .summary-score {
            font-size: 2.5rem;
            color: #38b2ac;
            font-weight: 800;
            margin-bottom: 20px;
        }
        /* 總結訊息樣式 */
        .summary-message {
            font-size: 1.3rem;
            color: #4a5568;
            margin-bottom: 30px;
        }
        /* 重新測驗按鈕樣式 */
        .restart-button {
            background-color: #48bb78;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.3);
        }
        .restart-button:hover {
            background-color: #38a169;
            transform: translateY(-2px);
        }
        /* 錯題總結區塊樣式 */
        .incorrect-questions-summary {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #cbd5e0;
        }
        /* 錯題項目樣式 */
        .incorrect-questions-summary .incorrect-question-item {
            background-color: #fefcbf; /* 淺黃色 */
            border: 2px solid #ef4444; /* 紅色邊框 */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        /* 錯題文本樣式 */
        .incorrect-questions-summary .question-text-incorrect {
            font-weight: 700;
            color: #8b5f00; /* 深黃色 */
            margin-bottom: 10px;
        }
        /* 正確答案文本樣式 */
        .incorrect-questions-summary .correct-answer-text {
            font-weight: 600;
            color: #2f855a; /* 綠色 */
            margin-top: 5px;
        }
        /* 解釋文本樣式 */
        .incorrect-questions-summary .explanation-text {
            font-size: 0.95rem;
            color: #6b46c1; /* 紫色 */
            margin-top: 10px;
        }

        /* Gemini 模態框疊加層樣式 */
        .gemini-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* Gemini 模態框內容樣式 */
        .gemini-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            position: relative;
            text-align: left;
        }
        /* Gemini 模態框關閉按鈕樣式 */
        .gemini-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }
        .gemini-modal-close:hover {
            color: #4a5568;
        }
        /* Gemini 模態框標題樣式 */
        .gemini-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* Gemini 模態框輸入區文本域樣式 */
        .gemini-modal-input-area textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 80px;
            resize: vertical;
            margin-bottom: 15px;
        }
        .gemini-modal-input-area textarea:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* Gemini 模態框按鈕容器樣式 */
        .gemini-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* Gemini 模態框提交按鈕樣式 */
        .gemini-modal-submit-button {
            background-color: #4299e1;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .gemini-modal-submit-button:hover {
            background-color: #3182ce;
        }
        /* Gemini 模態框取消按鈕樣式 */
        .gemini-modal-cancel-button {
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .gemini-modal-cancel-button:hover {
            background-color: #718096;
        }
        /* Gemini 模態框載入中指示器樣式 */
        .gemini-modal-loading {
            text-align: center;
            margin-top: 20px;
            font-size: 1.1rem;
            color: #4a5568;
        }
        /* Gemini 模態框回應區樣式 */
        .gemini-modal-response {
            margin-top: 20px;
            padding: 15px;
            background-color: #e6fffa;
            border: 1px solid #38b2ac;
            border-radius: 10px;
            font-size: 1rem;
            color: #2d3748;
            white-space: pre-wrap; /* 保留空白和換行 */
            max-height: 300px;
            overflow-y: auto;
        }
        /* 詢問 Gemini 按鈕樣式 */
        .ask-gemini-button {
            background-color: #805ad5; /* 紫色 */
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(128, 90, 213, 0.3);
            margin-top: 20px;
        }
        .ask-gemini-button:hover {
            background-color: #6b46c1;
            transform: translateY(-2px);
        }

        /* API 金鑰輸入模態框疊加層樣式 */
        .api-key-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* 高於 Gemini 模態框 */
        }
        /* API 金鑰輸入模態框內容樣式 */
        .api-key-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: left;
        }
        /* API 金鑰模態框標題樣式 */
        .api-key-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* API 金鑰模態框輸入區輸入框樣式 */
        .api-key-modal-input-area input {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        .api-key-modal-input-area input:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* API 金鑰模態框按鈕容器樣式 */
        .api-key-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* API 金鑰模態框提交按鈕樣式 */
        .api-key-modal-submit-button {
            background-color: #48bb78;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .api-key-modal-submit-button:hover {
            background-color: #38a169;
        }
        /* API 金鑰模態框取消按鈕樣式 */
        .api-key-modal-cancel-button {
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .api-key-modal-cancel-button:hover {
            background-color: #718096;
        }

        /* 計時器顯示樣式 */
        .timer-display {
            position: absolute;
            top: 1rem;
            right: 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            background-color: #e0f2fe;
            padding: 8px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: none; /* 預設隱藏 */
        }

        /* 確認模態框疊加層樣式 */
        .confirmation-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002; /* 高於其他模態框 */
        }
        /* 確認模態框內容樣式 */
        .confirmation-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        /* 確認模態框標題樣式 */
        .confirmation-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 確認模態框訊息樣式 */
        .confirmation-modal-message {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 25px;
        }
        /* 確認模態框按鈕容器樣式 */
        .confirmation-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        /* 確認模態框按鈕樣式 */
        .confirmation-modal-button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        /* 確認按鈕 (是) 樣式 */
        .confirm-yes {
            background-color: #ef4444;
            color: white;
        }
        .confirm-yes:hover {
            background-color: #dc2626;
        }
        /* 確認按鈕 (否) 樣式 */
        .confirm-no {
            background-color: #a0aec0;
            color: white;
        }
        .confirm-no:hover {
            background-color: #718096;
        }

        /* 題目數量顯示樣式 */
        .question-counts {
            margin-top: 20px;
            font-size: 1.1rem;
            color: #4a5568;
            text-align: center;
        }
        .question-counts p {
            margin-bottom: 5px;
        }

        /* 環境選擇畫面樣式 */
        #environment-selection-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        /* 環境選擇按鈕樣式 */
        .env-button {
            background-color: #6366f1; /* 靛藍色 */
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        .env-button:hover {
            background-color: #4f46e5;
            transform: translateY(-2px);
        }

        /* 用戶計數顯示樣式 */
        #user-count-display {
            margin-top: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            background-color: #e2f8f5; /* 淺青色 */
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #38b2ac;
            display: block;
        }

        /* 繼續測驗提示樣式 */
        #continue-quiz-prompt {
            display: none; /* 預設隱藏 */
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            text-align: center;
        }
        #continue-quiz-prompt p {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }
        /* 繼續測驗按鈕容器樣式 */
        .continue-quiz-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        @media (min-width: 640px) {
            .continue-quiz-buttons {
                flex-direction: row;
            }
        }
        /* 繼續和開始新測驗按鈕樣式 */
        .continue-button, .start-new-button {
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .continue-button {
            background-color: #4299e1;
            color: white;
        }
        .continue-button:hover {
            background-color: #3182ce;
            transform: translateY(-2px);
        }
        .start-new-button {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .start-new-button:hover {
            background-color: #cbd5e0;
            transform: translateY(-2px);
        }

        /* 使用者 ID 輸入模態框疊加層樣式 */
        #user-id-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1003; /* 最高層級 */
        }
        /* 使用者 ID 輸入模態框內容樣式 */
        #user-id-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            text-align: left;
        }
        /* 使用者 ID 模態框標題樣式 */
        #user-id-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 使用者 ID 模態框輸入區輸入框樣式 */
        #user-id-modal-input-area input {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        #user-id-modal-input-area input:focus {
            outline: none;
            border-color: #63b3ed;
        }
        /* 使用者 ID 模態框按鈕容器樣式 */
        #user-id-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* 提交使用者 ID 按鈕樣式 */
        #submit-user-id-button {
            background-color: #48bb78;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        #submit-user-id-button:hover {
            background-color: #38a169;
        }
        /* 取消使用者 ID 按鈕樣式 */
        #cancel-user-id-button {
            background-color: #a0aec0;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        #cancel-user-id-button:hover {
            background-color: #718096;
        }

        /* 排行榜模態框疊加層樣式 */
        #leaderboard-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* 預設隱藏 */
            justify-content: center;
            align-items: center;
            z-index: 1004; /* 高於其他模態框 */
        }
        /* 排行榜模態框內容樣式 */
        #leaderboard-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            position: relative;
            text-align: center;
        }
        /* 排行榜模態框關閉按鈕樣式 */
        #leaderboard-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.2s ease;
        }
        .leaderboard-modal-close:hover {
            color: #4a5568;
        }
        /* 排行榜標題樣式 */
        #leaderboard-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
        }
        /* 排行榜列表樣式 */
        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        /* 排行榜列表項目樣式 */
        #leaderboard-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #edf2f7;
            font-size: 1.1rem;
            color: #4a5568;
        }
        #leaderboard-list li:last-child {
            border-bottom: none;
        }
        #leaderboard-list li:nth-child(odd) {
            background-color: #f7fafc;
        }
        /* 排行榜前三名樣式 */
        #leaderboard-list li:first-child {
            background-color: #fff3e0; /* 金色 */
            font-weight: 700;
            color: #e65100;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        #leaderboard-list li:nth-child(2) {
            background-color: #eceff1; /* 銀色 */
            font-weight: 600;
            color: #546e7a;
        }
        #leaderboard-list li:nth-child(3) {
            background-color: #fbe9e7; /* 青銅色 */
            font-weight: 600;
            color: #bf360c;
        }
        /* 排行榜排名樣式 */
        .leaderboard-rank {
            font-weight: 700;
            min-width: 30px;
            text-align: left;
        }
        /* 排行榜名稱樣式 */
        .leaderboard-name {
            flex-grow: 1;
            text-align: left;
            margin-left: 15px;
        }
        /* 排行榜分數樣式 */
        .leaderboard-score {
            font-weight: 700;
            color: #2d3748;
        }
        /* 查看排行榜按鈕樣式 */
        .view-leaderboard-button {
            background-color: #667eea; /* 靛藍色 */
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            margin-top: 20px;
        }
        .view-leaderboard-button:hover {
            background-color: #5a67d8;
            transform: translateY(-2px);
        }
        /* 分享結果按鈕樣式 */
        .share-results-button {
            background-color: #38b2ac; /* 青綠色 */
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            box-shadow: 0 4px 10px rgba(56, 178, 172, 0.3);
            margin-top: 15px;
        }
        .share-results-button:hover {
            background-color: #319795;
            transform: translateY(-2px);
        }

        /* 響應式設計調整 */
        @media (max-width: 640px) {
            .quiz-container {
                padding: 20px;
            }
            .question-text {
                font-size: 1.2rem;
            }
            .option-button {
                font-size: 1rem;
                padding: 12px 15px;
            }
            .nav-button {
                padding: 10px 20px;
                font-size: 1rem;
            }
            .summary-title {
                font-size: 1.5rem;
            }
            .summary-score {
                font-size: 2rem;
            }
            .summary-message {
                font-size: 1.1rem;
            }
            .restart-button {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            .gemini-modal-content {
                padding: 20px;
            }
            .gemini-modal-title {
                font-size: 1.2rem;
            }
            .gemini-modal-input-area textarea {
                min-height: 60px;
            }
            .api-key-modal-content {
                padding: 20px;
            }
            .api-key-modal-title {
                font-size: 1.2rem;
            }
            .timer-display {
                font-size: 1rem;
                padding: 6px 12px;
            }
            .confirmation-modal-content {
                padding: 20px;
            }
            .confirmation-modal-title {
                font-size: 1.2rem;
            }
            .confirmation-modal-message {
                font-size: 1rem;
            }
            .confirmation-modal-button {
                padding: 8px 15px;
                font-size: 1rem;
            }
            .env-button {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            #user-id-modal-content {
                padding: 20px;
            }
            #user-id-modal-title {
                font-size: 1.2rem;
            }
            #leaderboard-modal-content {
                padding: 20px;
            }
            #leaderboard-title {
                font-size: 1.5rem;
            }
            #leaderboard-list li {
                font-size: 1rem;
                padding: 10px 15px;
            }
            .view-leaderboard-button {
                padding: 10px 20px;
                font-size: 1rem;
            }
            .share-results-button {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
        }
        /* 全域載入覆蓋層樣式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999; /* 確保在所有元素之上 */
            color: white;
            font-size: 2rem;
            text-align: center;
        }
        /* 載入中旋轉圖示樣式 */
        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #fff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        /* 旋轉動畫關鍵幀 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <div class="content-wrapper">
            <!-- 環境選擇畫面 -->
            <div id="environment-selection-screen" class="flex flex-col items-center justify-center h-full">
                <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">iPAS AI應用規劃師模模擬測驗</h1>
                <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">選擇執行環境</h2>
                <div class="flex flex-col sm:flex-row gap-6">
                    <button id="select-canvas-env" class="env-button">在 Canvas 環境啟動</button>
                    <button id="select-github-env" class="env-button">使用 GitHub Pages 環境</button>
                </div>
                <p class="text-gray-600 mt-8 text-center">
                    非Canvas環境下，請點擊這裡啟動環境：<br>
                    <a href="https://g.co/gemini/share/0d8dc04f3cdf" target="_blank" class="text-blue-500 hover:underline font-semibold">前往 Gemini 對話分享連結</a>
                </p>
                <div id="user-count-display">
                    <!-- 用戶計數將在此顯示 -->
                </div>
            </div>

            <!-- 初始科目選擇畫面 (預設隱藏) -->
            <div id="initial-selection-screen" style="display: none;">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">iPAS初級AI應用規劃師模擬測驗</h1>

                <!-- 繼續測驗提示 -->
                <div id="continue-quiz-prompt">
                    <p id="continue-quiz-message"></p>
                    <div class="continue-quiz-buttons">
                        <button id="continue-quiz-button" class="continue-button">繼續測驗</button>
                        <button id="start-new-quiz-button" class="start-new-button">開始新測驗 (將覆蓋舊進度)</button>
                    </div>
                </div>

                <!-- 科目選擇區域 (預設隱藏) -->
                <div id="subject-selection-area" style="display: none;">
                    <div class="subject-selection">
                        <label for="subject-select" class="sr-only">選擇科目</label>
                        <select id="subject-select">
                            <option value="topic1_ai_intro.json">科目一：人工智慧基礎概論</option>
                            <option value="topic2_generative_ai_app_planning.json">科目二：生成式 AI 應用與規劃</option>
                        </select>
                        <button id="start-quiz-button" class="start-quiz-button">開始測驗</button>
                    </div>
                    <div id="question-counts" class="question-counts">
                        <!-- 題目數量將在此顯示 -->
                    </div>
                </div>
                <button id="view-leaderboard-button" class="view-leaderboard-button">查看排行榜</button> <!-- 排行榜按鈕 -->
            </div>

            <!-- 測驗內容區塊 (預設隱藏) -->
            <div id="quiz-content" style="display: none;">
                <div class="timer-display" id="timer-display">00:00</div> <!-- 計時器顯示區塊 -->
                <div class="subject-title" id="current-subject-title"></div> <!-- 動態顯示科目標題 -->
                <div class="question-number" id="question-number"></div>
                <div class="question-text" id="question-text"></div>
                <div class="options-container" id="options-container">
                    <!-- 選項將由 JavaScript 載入 -->
                </div>
                <div class="feedback-container" id="feedback-container">
                    <div class="feedback-title" id="feedback-title"></div>
                    <div class="feedback-text" id="feedback-text-content"></div>
                    <button id="ask-gemini-button" class="ask-gemini-button" style="display: none;">✨ 向 Gemini 提問</button>
                </div>
                <div class="navigation-buttons">
                    <button id="prev-button" class="nav-button" disabled>上一題</button>
                    <button id="next-button" class="nav-button">下一題</button>
                    <button id="submit-early-button" class="submit-quiz-button">交卷</button> <!-- 新增交卷按鈕 -->
                </div>
            </div>
            <div id="loading-indicator" class="loading-message" style="display: none;">載入題目中，請稍候...</div>
            <!-- 測驗總結區塊 (預設隱藏) -->
            <div class="quiz-summary" id="quiz-summary">
                <div class="summary-title">測驗結果</div>
                <div class="summary-score" id="summary-score"></div>
                <div class="summary-message" id="summary-message"></div>
                <div id="incorrect-questions-summary" class="mt-8 text-left"></div>
                <button id="restart-button" class="restart-button">重新測驗</button>
                <button id="view-leaderboard-button-summary" class="view-leaderboard-button mt-4">查看排行榜</button> <!-- 測驗結果頁面的排行榜按鈕 -->
                <button id="share-results-button" class="share-results-button mt-4">分享結果</button> <!-- 新增分享結果按鈕 -->
            </div>
        </div>
    </div>

    <!-- Gemini 模態框 -->
    <div id="gemini-modal-overlay" class="gemini-modal-overlay" style="display: none;">
        <div class="gemini-modal-content">
            <span class="gemini-modal-close" id="gemini-modal-close">&times;</span>
            <div class="gemini-modal-title">向 Gemini 提問</div>
            <div class="gemini-modal-input-area">
                <p class="text-sm text-gray-600 mb-2">請輸入您想針對此題目詢問 Gemini 的問題：</p>
                <textarea id="gemini-question-input" placeholder="例如：這個概念還有哪些應用？或是提供更多相關資訊..."></textarea>
                <div class="gemini-modal-buttons">
                    <button id="gemini-modal-cancel-button" class="gemini-modal-cancel-button">取消</button>
                    <button id="submit-gemini-question-button" class="gemini-modal-submit-button">送出問題</button>
                </div>
            </div>
            <div id="gemini-loading-indicator" class="gemini-modal-loading" style="display: none;">
                載入中... 請稍候 ✨
            </div>
            <div id="gemini-response-area" class="gemini-modal-response" style="display: none;">
                <!-- Gemini 的回應將在此顯示 -->
            </div>
        </div>
    </div>

    <!-- API 金鑰輸入模態框 -->
    <div id="api-key-modal-overlay" class="api-key-modal-overlay" style="display: none;">
        <div class="api-key-modal-content">
            <div class="api-key-modal-title">請輸入您的 Gemini API 金鑰</div>
            <p class="text-sm text-gray-600 mb-4">
                為了在非 Canvas 環境下使用 Gemini 提問功能，請在此輸入您的 Gemini API 金鑰。
                您可以從 <a href="https://g.co/gemini/share/0d8dc04f3cdf" target="_blank" class="text-blue-500 hover:underline">Google AI Studio</a> 獲取。
            </p>
            <div class="api-key-modal-input-area">
                <input type="text" id="gemini-api-key-input" placeholder="您的 Gemini API 金鑰">
                <div class="api-key-modal-buttons">
                    <button id="api-key-modal-cancel-button" class="api-key-modal-cancel-button">取消</button>
                    <button id="submit-api-key-button" class="api-key-modal-submit-button">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 確認模態框 -->
    <div id="confirmation-modal-overlay" class="confirmation-modal-overlay" style="display: none;">
        <div class="confirmation-modal-content">
            <div class="confirmation-modal-title">確認交卷</div>
            <div class="confirmation-modal-message">您確定要提前交卷嗎？交卷後將無法再修改答案。</div>
            <div class="confirmation-modal-buttons">
                <button id="confirm-yes-button" class="confirmation-modal-button confirm-yes">確定交卷</button>
                <button id="confirm-no-button" class="confirmation-modal-button confirm-no">取消</button>
            </div>
        </div>
    </div>

    <!-- 使用者 ID 輸入模態框 -->
    <div id="user-id-modal-overlay" class="api-key-modal-overlay" style="display: none;">
        <div id="user-id-modal-content" class="api-key-modal-content">
            <div id="user-id-modal-title" class="api-key-modal-title">請輸入您的使用者暱稱</div>
            <p class="text-sm text-gray-600 mb-4">
                這個暱稱將用於識別您的測驗進度。您可以輸入任何您喜歡的名稱。
            </p>
            <div id="user-id-modal-input-area" class="api-key-modal-input-area">
                <input type="text" id="user-id-input" placeholder="您的使用者暱稱">
                <div id="user-id-modal-buttons" class="api-key-modal-buttons">
                    <button id="cancel-user-id-button" class="api-key-modal-cancel-button">取消</button>
                    <button id="submit-user-id-button" class="api-key-modal-submit-button">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 排行榜模態框 -->
    <div id="leaderboard-modal-overlay" class="leaderboard-modal-overlay" style="display: none;">
        <div id="leaderboard-modal-content" class="leaderboard-modal-content">
            <span class="gemini-modal-close" id="leaderboard-modal-close">&times;</span>
            <div id="leaderboard-title" class="leaderboard-title">排行榜</div>
            <ul id="leaderboard-list">
                <!-- 排行榜條目將在此載入 -->
            </ul>
        </div>
    </div>

    <!-- 全域載入覆蓋層 -->
    <div id="global-loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <div>載入中...</div>
    </div>

    <script type="module">
        // 導入 Firebase SDK 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, getDoc, getDocs, serverTimestamp, query, orderBy, limit, addDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js"; 

        // Firebase 相關變數和初始化
        let app;
        let db;
        let auth;
        let currentEnvironment = ''; // 'canvas' 或 'github-pages'
        let effectiveAppId = ''; // 儲存實際使用的 appId
        let currentUserId = ''; // 儲存當前登入用戶的 Firebase UID
        let currentUserDisplayName = ''; // 儲存使用者自定義的暱稱

        // Firebase 專案配置 (請確保這是您的實際配置)
        // 在 Canvas 環境下，會優先使用 __firebase_config
        const defaultFirebaseConfig = {
          apiKey: "***REMOVED***",
          authDomain: "ipas-ai-planner-exam.firebaseapp.com",
          projectId: "ipas-ai-planner-exam",
          storageBucket: "ipas-ai-planner-exam.firebasestorage.app",
          appId: "1:1018339017757:web:934bf9c05ea898fdd972f4", // <-- 這裡設定預設的 appId
          measurementId: "G-5WWRYNKFJ6"
        };

        // 測驗應用程式相關變數
        let fullQuizData = []; // 儲存從 JSON 載入的所有題目
        let selectedQuizData = []; // 儲存隨機選取的 50 題
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0; // 儲存答對題數
        let incorrectQuestions = []; // 儲存答錯的題目
        const optionLabels = ['A', 'B', 'C', 'D']; // 選項標籤 (A, B, C, D)
        let loadedProgressData = null; // 儲存從 Firestore 載入的進度資料
        const POINTS_PER_QUESTION = 2.5; // 每題分數

        // DOM 元素獲取
        const environmentSelectionScreen = document.getElementById('environment-selection-screen');
        const selectCanvasEnvButton = document.getElementById('select-canvas-env');
        const selectGithubEnvButton = document.getElementById('select-github-env');

        const initialSelectionScreen = document.getElementById('initial-selection-screen');
        const subjectSelectionArea = document.getElementById('subject-selection-area');
        const continueQuizPrompt = document.getElementById('continue-quiz-prompt');
        const continueQuizMessage = document.getElementById('continue-quiz-message');
        const continueQuizButton = document.getElementById('continue-quiz-button');
        const startNewQuizButton = document.getElementById('start-new-quiz-button');

        const subjectSelect = document.getElementById('subject-select');
        const startQuizButton = document.getElementById('start-quiz-button');
        const currentSubjectTitle = document.getElementById('current-subject-title');
        const questionNumberElement = document.getElementById('question-number');
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackTitleElement = document.getElementById('feedback-title');
        const feedbackTextContentElement = document.getElementById('feedback-text-content');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const submitEarlyButton = document.getElementById('submit-early-button');
        const quizContent = document.getElementById('quiz-content');
        const quizSummary = document.getElementById('quiz-summary');
        const summaryScoreElement = document.getElementById('summary-score');
        const summaryMessageElement = document.getElementById('summary-message');
        const incorrectQuestionsSummaryElement = document.getElementById('incorrect-questions-summary'); 
        const restartButton = document.getElementById('restart-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const questionCountsElement = document.getElementById('question-counts');
        const userCountDisplay = document.getElementById('user-count-display');

        // Gemini API 相關 DOM 元素
        const askGeminiButton = document.getElementById('ask-gemini-button');
        const geminiModalOverlay = document.getElementById('gemini-modal-overlay');
        const geminiModalClose = document.getElementById('gemini-modal-close');
        const geminiQuestionInput = document.getElementById('gemini-question-input');
        const submitGeminiQuestionButton = document.getElementById('submit-gemini-question-button');
        const geminiModalCancelButton = document.getElementById('gemini-modal-cancel-button');
        const geminiLoadingIndicator = document.getElementById('gemini-loading-indicator');
        const geminiResponseArea = document.getElementById('gemini-response-area');

        // API 金鑰輸入模態框相關 DOM 元素
        const apiKeyModalOverlay = document.getElementById('api-key-modal-overlay');
        const geminiApiKeyInput = document.getElementById('gemini-api-key-input');
        const submitApiKeyButton = document.getElementById('submit-api-key-button');
        const apiKeyModalCancelButton = document.getElementById('api-key-modal-cancel-button');

        // 確認模態框相關 DOM 元素
        const confirmationModalOverlay = document.getElementById('confirmation-modal-overlay');
        const confirmYesButton = document.getElementById('confirm-yes-button');
        const confirmNoButton = document.getElementById('confirm-no-button');

        // 使用者 ID 輸入模態框相關 DOM 元素
        const userIdModalOverlay = document.getElementById('user-id-modal-overlay');
        const userIdInput = document.getElementById('user-id-input');
        const submitUserIdButton = document.getElementById('submit-user-id-button');
        const cancelUserIdButton = document.getElementById('cancel-user-id-button');

        // 排行榜相關 DOM 元素
        const viewLeaderboardButton = document.getElementById('view-leaderboard-button');
        const viewLeaderboardButtonSummary = document.getElementById('view-leaderboard-button-summary');
        const leaderboardModalOverlay = document.getElementById('leaderboard-modal-overlay');
        const leaderboardModalClose = document.getElementById('leaderboard-modal-close');
        const leaderboardList = document.getElementById('leaderboard-list');

        // 分享結果按鈕 DOM 元素
        const shareResultsButton = document.getElementById('share-results-button');

        // 全域載入覆蓋層 DOM 元素
        const globalLoadingOverlay = document.getElementById('global-loading-overlay');

        // 全域變數，用於儲存 Gemini API 金鑰
        let geminiApiKey = ""; 

        // 計時器變數
        const quizDurationInSeconds = 75 * 60; // 75 分鐘
        let timeRemaining = quizDurationInSeconds;
        let timerInterval;
        const timerDisplay = document.getElementById('timer-display');

        // 科目名稱映射表
        const subjectNames = {
            'topic1_ai_intro.json': '科目一：人工智慧基礎概論',
            'topic2_generative_ai_app_planning.json': '科目二：生成式 AI 應用與規劃'
        };

        /**
         * 顯示全域載入覆蓋層。
         */
        function showGlobalLoading() {
            globalLoadingOverlay.style.display = 'flex';
        }

        /**
         * 隱藏全域載入覆蓋層。
         */
        function hideGlobalLoading() {
            globalLoadingOverlay.style.display = 'none';
        }

        /**
         * Fisher-Yates 洗牌演算法，用於隨機打亂陣列。
         * @param {Array} array - 要洗牌的陣列。
         * @returns {Array} - 洗牌後的陣列。
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                // 正確的陣列解構賦值，用於交換元素
                [array[i], array[j]] = [array[j], array[i]]; 
            }
            return array;
        }

        /**
         * 遞迴地從物件或陣列中移除所有 undefined 值。
         * Firestore 不支援 undefined 值，此函數用於清理資料以符合 Firestore 要求。
         * @param {any} obj - 要清理的物件或值。
         * @returns {any} - 清理後的物件或值，undefined 值會被移除。
         */
        function removeUndefined(obj) {
            if (obj === null || typeof obj !== 'object') {
                return obj;
            }

            if (Array.isArray(obj)) {
                // 遞迴處理陣列中的每個元素，並過濾掉 undefined 的結果
                return obj.map(item => removeUndefined(item)).filter(item => item !== undefined);
            }

            const newObj = {};
            for (const key in obj) {
                // 確保只處理物件自身的屬性，而非原型鏈上的屬性
                if (Object.prototype.hasOwnProperty.call(obj, key)) {
                    const value = obj[key];
                    if (value !== undefined) {
                        // 遞迴處理巢狀物件
                        newObj[key] = removeUndefined(value);
                    }
                }
            }
            return newObj;
        }

        /**
         * 追蹤使用者訪問，在 Firestore 中記錄每個獨立訪客的資訊。
         * @param {string} appIdToUse - 當前使用的應用程式 ID。
         */
        async function trackUserVisit(appIdToUse) {
            const userId = currentUserId; // 使用全域設定的 Firebase UID
            if (!userId) {
                console.error("追蹤使用者訪問失敗: 無法獲取使用者 ID。");
                return;
            }

            // 增加短暫延遲，以確保 Firestore 數據同步（診斷用）
            await new Promise(resolve => setTimeout(resolve, 500)); 

            // 構建 Firestore 文件參考路徑：/artifacts/{appId}/public/data/user_visits/{userId}
            const userDocRef = doc(collection(db, 'artifacts', appIdToUse, 'public', 'data', 'user_visits'), userId); 
            console.log("Firestore document path for write:", userDocRef.path);
            console.log("Attempting Firestore operation with UID:", userId);

            try {
                const docSnap = await getDoc(userDocRef); 
                if (!docSnap.exists()) { // 如果文件不存在，表示是新訪客
                    // 記錄新訪客的資訊
                    await setDoc(userDocRef, { 
                        firstVisit: serverTimestamp(), // 首次訪問時間
                        lastVisit: serverTimestamp(),  // 最後訪問時間
                        userId: userId,                // Firebase UID
                        displayName: currentUserDisplayName || '匿名用戶' // 使用者暱稱或預設值
                    });
                    console.log(`新使用者訪問記錄成功: ${userId}`); 
                } else {
                    // 如果文件已存在，更新最後訪問時間和暱稱
                    await setDoc(userDocRef, { 
                        lastVisit: serverTimestamp(),
                        displayName: currentUserDisplayName || '匿名用戶'
                    }, { merge: true }); // 使用 merge: true 以免覆蓋其他字段
                    console.log(`使用者已記錄，更新最後訪問時間: ${userId}`);
                }
            } catch (error) {
                console.error("追蹤使用者訪問失敗:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許匿名使用者在路徑 `/artifacts/{appId}/public/data/user_visits/{userId}` 上進行讀寫操作。");
                }
            }
        }

        /**
         * 從 Firestore 獲取並顯示獨立訪問人數。
         */
        async function getAndDisplayUserCount() {
            userCountDisplay.textContent = '正在載入訪問人數...';
            console.log("getAndDisplayUserCount: 開始載入訪問人數...");
            console.log("getAndDisplayUserCount: db 實例:", db);
            console.log("getAndDisplayUserCount: effectiveAppId:", effectiveAppId);

            // 增加短暫延遲，以確保 Firebase 完全初始化並連接
            await new Promise(resolve => setTimeout(resolve, 500)); 

            if (!db || !effectiveAppId) {
                console.error("getAndDisplayUserCount: Firestore 未初始化或 App ID 無效，無法獲取訪問人數。db:", db, "effectiveAppId:", effectiveAppId);
                userCountDisplay.textContent = '無法載入訪問人數 (初始化中/錯誤)。請檢查控制台錯誤訊息。';
                return;
            }

            try {
                // 參考 user_visits 集合
                const userVisitsCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'user_visits');
                console.log("getAndDisplayUserCount: 嘗試從 Firestore 讀取 user_visits 集合...");
                const querySnapshot = await getDocs(userVisitsCollectionRef);
                const userCount = querySnapshot.size; // 獲取文件數量即為獨立訪客人數

                userCountDisplay.textContent = `總訪問人數 (獨立訪客)：${userCount} 人`;
                console.log(`getAndDisplayUserCount: 成功獲取訪問人數: ${userCount} 人`);
            } catch (error) {
                console.error("getAndDisplayUserCount: 獲取訪問人數失敗:", error);
                userCountDisplay.textContent = '無法載入訪問人數 (錯誤)。請檢查控制台錯誤訊息。';
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許讀取 `/artifacts/{appId}/public/data/user_visits`。");
                }
            }
        }

        /**
         * 從 Firestore 載入指定科目的測驗進度。
         * @param {string} subjectId - 科目 ID。
         * @returns {Promise<Object|null>} - 測驗進度資料或 null。
         */
        async function loadQuizProgress(subjectId) {
            if (!db || !currentUserId || !effectiveAppId) {
                console.warn("無法載入進度：Firebase 未初始化或用戶 ID 無效。");
                return null;
            }

            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);

            try {
                const docSnap = await getDoc(progressDocRef);
                if (docSnap.exists()) {
                    console.log(`測驗進度已載入 (科目: ${subjectId})`);
                    return docSnap.data();
                } else {
                    console.log(`未找到測驗進度 (科目: ${subjectId})`);
                    return null;
                }
            } catch (error) {
                console.error("載入測驗進度失敗:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許匿名使用者在路徑 `/artifacts/{appId}/users/{userId}/quiz_progress/{subjectId}` 上進行讀取操作。");
                }
                return null;
            }
        }

        /**
         * 檢查並顯示是否有儲存的測驗進度。
         */
        async function checkAndDisplaySavedProgress() {
            if (!currentUserId) {
                console.log("用戶 ID 尚未準備好，無法檢查進度。");
                return;
            }

            const defaultSubject = subjectSelect.value;
            loadedProgressData = await loadQuizProgress(defaultSubject);

            if (loadedProgressData) {
                continueQuizMessage.textContent = `您有未完成的「${subjectNames[defaultSubject]}」測驗進度 (暱稱: ${currentUserDisplayName || '匿名用戶'})。`;
                continueQuizPrompt.style.display = 'flex'; // 顯示繼續測驗提示
                subjectSelectionArea.style.display = 'none'; // 隱藏科目選擇區域
            } else {
                continueQuizPrompt.style.display = 'none'; // 隱藏繼續測驗提示
                subjectSelectionArea.style.display = 'block'; // 顯示科目選擇區域
                getQuestionCounts(); // 顯示題目數量
            }
        }

        /**
         * 獲取問題的唯一識別碼。
         * 建議：如果您的 JSON 題目資料中有 'id' 欄位，請優先使用它。
         * 如果沒有，則使用 'question' 文本作為識別碼。
         * @param {Object} question - 題目物件。
         * @returns {string} - 題目的唯一識別碼。
         */
        function getQuestionIdentifier(question) {
            // 優先使用題目中的 'id' 欄位（如果存在）
            if (question.id) {
                return question.id;
            }
            // 否則，使用題目文本作為識別碼
            return question.question;
        }

        /**
         * 初始化測驗資料：從完整題目中隨機抽取 50 題，優先選取未做過的題目。
         */
        function initializeQuizData() {
            const currentSubjectId = subjectSelect.value;
            const playedQuestionIdsKey = `played_questions_${currentSubjectId}`;
            const playedQuestionIds = new Set(JSON.parse(localStorage.getItem(playedQuestionIdsKey) || '[]'));

            let newQuestions = [];
            let recycledQuestions = [];

            // 將題目分為「新題目」和「已做過題目」
            fullQuizData.forEach(question => {
                const questionId = getQuestionIdentifier(question);
                if (playedQuestionIds.has(questionId)) {
                    recycledQuestions.push(question);
                } else {
                    newQuestions.push(question);
                }
            });

            // 洗牌新題目和已做過題目
            shuffleArray(newQuestions);
            shuffleArray(recycledQuestions);

            selectedQuizData = [];
            const desiredQuizLength = 50;

            // 優先從新題目中選取
            for (let i = 0; i < newQuestions.length && selectedQuizData.length < desiredQuizLength; i++) {
                selectedQuizData.push(newQuestions[i]);
            }

            // 如果新題目不足，從已做過題目中補充
            for (let i = 0; i < recycledQuestions.length && selectedQuizData.length < desiredQuizLength; i++) {
                selectedQuizData.push(recycledQuestions[i]);
            }

            // 如果最終選取的題目少於 desiredQuizLength，則從 fullQuizData 中隨機補充
            // 這主要用於題目總數小於 desiredQuizLength 的情況
            if (selectedQuizData.length < desiredQuizLength && fullQuizData.length > 0) {
                const missingCount = desiredQuizLength - selectedQuizData.length;
                const remainingQuestions = shuffleArray([...fullQuizData]); // 重新洗牌所有題目
                const currentSelectedIds = new Set(selectedQuizData.map(q => getQuestionIdentifier(q)));

                for (let i = 0; i < remainingQuestions.length && selectedQuizData.length < desiredQuizLength; i++) {
                    const question = remainingQuestions[i];
                    const questionId = getQuestionIdentifier(question);
                    if (!currentSelectedIds.has(questionId)) {
                        selectedQuizData.push(question);
                        currentSelectedIds.add(questionId); // 更新已選取ID集合
                    }
                }
            }

            // 最後，更新 localStorage 中的 playedQuestionIds
            const currentQuizQuestionIds = selectedQuizData.map(q => getQuestionIdentifier(q));
            localStorage.setItem(playedQuestionIdsKey, JSON.stringify(currentQuizQuestionIds));

            console.log(`為科目 ${currentSubjectId} 選取了 ${selectedQuizData.length} 道題目。其中有 ${newQuestions.length} 道新題目，${recycledQuestions.length} 道重複題目。`);
        }


        /**
         * 載入並顯示當前問題及其選項。
         */
        function loadQuestion() {
            if (selectedQuizData.length === 0) {
                questionTextElement.textContent = '無法載入題目。請檢查 JSON 檔案。';
                optionsContainer.innerHTML = '';
                prevButton.disabled = true;
                nextButton.disabled = true;
                submitEarlyButton.disabled = true;
                return;
            }

            const questionData = selectedQuizData[currentQuestionIndex];
            currentSubjectTitle.textContent = subjectNames[subjectSelect.value]; // 確保這裡顯示的是當前科目名稱
            questionNumberElement.textContent = `問題 ${currentQuestionIndex + 1} / ${selectedQuizData.length}`;
            questionTextElement.textContent = questionData.question;
            optionsContainer.innerHTML = ''; // 清空選項

            // 將選項內容及其原始標籤配對，以便洗牌後仍能追蹤正確答案
            const optionsWithOriginalLabels = questionData.options.map((optionContent, index) => ({
                content: optionContent,
                originalLabel: optionLabels[index]
            }));

            // 洗牌選項
            const shuffledOptions = shuffleArray(optionsWithOriginalLabels);

            shuffledOptions.forEach((optionItem, index) => {
                const button = document.createElement('button');
                button.className = 'option-button';
                // 顯示新的選項標籤 (A, B, C, D) 和選項內容
                button.innerHTML = `<span class="option-label">${optionLabels[index]}</span> ${optionItem.content}`;
                // 儲存此選項內容的原始標籤，用於檢查答案正確性
                button.dataset.originalLabelForContent = optionItem.originalLabel;
                // 儲存實際內容，用於顯示在回饋中
                button.dataset.optionContent = optionItem.content; 

                // 為按鈕添加點擊事件監聽器
                button.addEventListener('click', () => selectOption(button, optionItem.originalLabel));
                optionsContainer.appendChild(button);
            });

            // 如果用戶之前已經回答過此問題，則顯示其選擇和回饋
            if (userAnswers[currentQuestionIndex]) {
                const selectedOriginalLabel = userAnswers[currentQuestionIndex].selectedOriginalLabel;
                const correctOptionLabel = selectedQuizData[currentQuestionIndex].answer;

                const buttons = optionsContainer.querySelectorAll('.option-button');
                buttons.forEach(button => {
                    button.classList.add('disabled'); // 禁用所有選項
                    if (button.dataset.originalLabelForContent === selectedOriginalLabel) {
                        button.classList.add('selected');
                        if (selectedOriginalLabel === correctOptionLabel) {
                            button.classList.add('correct');
                        } else {
                            button.classList.add('incorrect');
                        }
                    }
                    // 標記正確答案
                    if (button.dataset.originalLabelForContent === correctOptionLabel) {
                        button.classList.add('correct');
                    }
                });
                showFeedback(selectedQuizData[currentQuestionIndex].explanation, userAnswers[currentQuestionIndex].isCorrect);
                askGeminiButton.style.display = 'inline-block'; // 顯示 Gemini 按鈕
            } else {
                hideFeedback();
                askGeminiButton.style.display = 'none'; // 隱藏 Gemini 按鈕
            }

            // 清空 Gemini 模態框內容
            geminiQuestionInput.value = '';
            geminiResponseArea.innerHTML = '';
            geminiResponseArea.style.display = 'none';
            geminiLoadingIndicator.style.display = 'none';

            updateNavigationButtons();
        }

        /**
         * 處理用戶選擇選項的邏輯。
         * @param {HTMLElement} selectedButton - 用戶點擊的選項按鈕元素。
         * @param {string} selectedOriginalLabel - 被選選項的原始標籤 (A, B, C, D)。
         */
        async function selectOption(selectedButton, selectedOriginalLabel) {
            // 如果已經有答案，則不允許再次選擇
            if (userAnswers[currentQuestionIndex]) {
                return;
            }

            const buttons = optionsContainer.querySelectorAll('.option-button');
            buttons.forEach(button => {
                button.classList.remove('selected');
                button.classList.add('disabled'); // 禁用所有選項
            });

            selectedButton.classList.add('selected');

            const questionData = selectedQuizData[currentQuestionIndex];
            const correctOptionLabel = questionData.answer; // 正確答案的原始標籤 (例如 'C')
            
            // 根據原始標籤獲取正確答案的實際內容
            const correctOptionContent = questionData.options[optionLabels.indexOf(correctOptionLabel)];

            // 檢查所選選項的原始標籤是否與正確答案的原始標籤匹配
            const isCorrect = (selectedOriginalLabel === correctOptionLabel);

            if (isCorrect) {
                selectedButton.classList.add('correct');
                score++; // 答對加分
            } else {
                selectedButton.classList.add('incorrect');
                // 記錄答錯的題目
                incorrectQuestions.push({
                    question: questionData.question,
                    selectedOption: selectedOriginalLabel, // 儲存原始標籤
                    selectedOptionContent: selectedButton.dataset.optionContent, // 實際內容
                    correctOption: correctOptionLabel, // 原始正確標籤 (A, B, C, D)
                    correctOptionContent: correctOptionContent, // 正確選項的實際內容
                    explanation: questionData.explanation
                });
            }

            // 標記正確答案
            buttons.forEach(button => {
                if (button.dataset.originalLabelForContent === correctOptionLabel) {
                    button.classList.add('correct');
                }
            });

            // 儲存用戶的答案
            userAnswers[currentQuestionIndex] = {
                selectedOriginalLabel: selectedOriginalLabel,
                isCorrect: isCorrect
            };

            showFeedback(questionData.explanation, isCorrect);
            askGeminiButton.style.display = 'inline-block'; // 顯示 Gemini 按鈕
            updateNavigationButtons(); // 啟用下一題按鈕
            await saveQuizProgress(subjectSelect.value); // 在每次選擇後保存進度
        }

        /**
         * 顯示問題回饋（正確或錯誤及解釋）。
         * @param {string} explanation - 問題的解釋。
         * @param {boolean} isCorrect - 用戶答案是否正確。
         */
        function showFeedback(explanation, isCorrect) {
            feedbackTitleElement.textContent = isCorrect ? '✅ 恭喜您，回答正確！' : '❌ 很抱歉，回答錯誤。';
            feedbackTextContentElement.textContent = explanation;
            feedbackContainer.classList.add('show');
        }

        /**
         * 隱藏問題回饋。
         */
        function hideFeedback() {
            feedbackContainer.classList.remove('show');
        }

        /**
         * 更新導航按鈕 (上一題、下一題、交卷) 的狀態。
         */
        function updateNavigationButtons() {
            prevButton.disabled = currentQuestionIndex === 0;
            // 下一題按鈕只有在當前題目作答後才啟用
            nextButton.disabled = !userAnswers[currentQuestionIndex];
            submitEarlyButton.disabled = false; // 測驗期間始終啟用交卷按鈕

            if (currentQuestionIndex === selectedQuizData.length - 1) {
                nextButton.textContent = '完成測驗';
            } else {
                nextButton.textContent = '下一題';
            }
        }

        // 下一題按鈕點擊事件監聽器
        nextButton.addEventListener('click', async () => { // 添加 async
            // 只有當前題目作答後才能點擊下一題
            if (!userAnswers[currentQuestionIndex]) {
                return;
            }

            if (currentQuestionIndex < selectedQuizData.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
                await saveQuizProgress(subjectSelect.value); // 在導航後保存進度
            } else {
                // 完成測驗
                showQuizSummary();
            }
        });

        // 上一題按鈕點擊事件監聽器
        prevButton.addEventListener('click', async () => { // 添加 async
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
                await saveQuizProgress(subjectSelect.value); // 在導航後保存進度
            }
        });

        // 交卷按鈕點擊事件監聽器
        submitEarlyButton.addEventListener('click', () => {
            confirmationModalOverlay.style.display = 'flex'; // 顯示確認模態框
        });

        // 確認交卷按鈕點擊事件監聽器
        confirmYesButton.addEventListener('click', () => {
            confirmationModalOverlay.style.display = 'none'; // 隱藏確認模態框
            showQuizSummary(); // 繼續顯示測驗總結
        });

        // 取消交卷按鈕點擊事件監聽器
        confirmNoButton.addEventListener('click', () => {
            confirmationModalOverlay.style.display = 'none'; // 隱藏確認模態框
        });

        /**
         * 顯示測驗總結頁面，計算分數並顯示錯題回顧。
         */
        async function showQuizSummary() {
            stopTimer(); // 停止計時器
            quizContent.style.display = 'none';
            quizSummary.classList.add('show');
            timerDisplay.style.display = 'none'; // 隱藏計時器

            const finalScorePoints = score * POINTS_PER_QUESTION; // 計算最終分數
            summaryScoreElement.textContent = `${finalScorePoints} 分`; // 顯示分數
            let message = '';
            const percentage = (score / selectedQuizData.length) * 100;
            if (percentage === 100) {
                message = '太棒了！您對AI應用規劃師能力有非常深入的了解！';
            } else if (percentage >= 80) {
                message = '表現非常出色！您已經掌握了大部分的知識。';
            } else if (percentage >= 60) {
                message = '不錯的開始！再加把勁，您會更棒的。';
            } else {
                message = '繼續努力！多加練習，您一定會進步的。';
            }
            summaryMessageElement.textContent = message;

            // 顯示錯題回顧
            incorrectQuestionsSummaryElement.innerHTML = ''; // 清空之前的錯題
            if (incorrectQuestions.length > 0) {
                const title = document.createElement('h3');
                title.className = 'feedback-title text-xl mb-4';
                title.textContent = '錯題回顧';
                incorrectQuestionsSummaryElement.appendChild(title);

                incorrectQuestions.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'incorrect-question-item bg-red-50 border-red-300 border-2 rounded-lg p-4 mb-4 shadow-sm'; 
                    itemDiv.innerHTML = `
                        <p class="question-text-incorrect text-red-800"><strong>${index + 1}. ${item.question}</strong></p>
                        <p class="correct-answer-text text-green-700 mt-2">正確答案：${item.correctOptionContent}</p>
                        <p class="explanation-text text-purple-700 mt-2">${item.explanation}</p>
                    `;
                    incorrectQuestionsSummaryElement.appendChild(itemDiv);
                });
            } else {
                const noIncorrect = document.createElement('p');
                noIncorrect.className = 'feedback-text';
                noIncorrect.textContent = '恭喜您，沒有答錯的題目！';
                incorrectQuestionsSummaryElement.appendChild(noIncorrect);
            }

            // 將分數儲存到排行榜
            await saveQuizScoreToLeaderboard(finalScorePoints); // 傳遞計算後的總分
            // 清除當前科目的進度，因為測驗已經完成
            await clearQuizProgress(subjectSelect.value);
        }

        /**
         * 載入 JSON 題目資料。
         * @param {string} jsonFileName - JSON 檔案名。
         * @param {boolean} isContinuing - 是否為繼續上次測驗。
         */
        async function loadFullQuizData(jsonFileName, isContinuing = false) {
            showGlobalLoading(); // 顯示載入中
            initialSelectionScreen.style.display = 'none';
            loadingIndicator.style.display = 'block';
            quizContent.style.display = 'none';
            quizSummary.classList.remove('show');
            questionCountsElement.style.display = 'none';
            userCountDisplay.style.display = 'none';
            continueQuizPrompt.style.display = 'none';
            subjectSelectionArea.style.display = 'none';
            viewLeaderboardButton.style.display = 'none';

            try {
                if (!isContinuing) { // 如果不是繼續測驗，則從頭載入 JSON
                    const githubRawUrl = `https://raw.githubusercontent.com/ss1111119/ipas_AI-Planner-Exam/main/${jsonFileName}`;
                    const response = await fetch(githubRawUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    fullQuizData = await response.json();
                    initializeQuizData(); // 載入資料後再初始化隨機題目
                    currentQuestionIndex = 0; // 重置題目索引
                    userAnswers = []; // 清空答案
                    score = 0; // 重置答對題數
                    incorrectQuestions = []; // 清空錯題
                    timeRemaining = quizDurationInSeconds; // 重置計時器
                } else {
                    // 如果是繼續測驗，則使用已載入的進度資料
                    currentQuestionIndex = loadedProgressData.currentQuestionIndex ?? 0;
                    userAnswers = loadedProgressData.userAnswers || [];
                    score = loadedProgressData.score ?? 0; // 這裡的 score 仍然是答對題數
                    incorrectQuestions = loadedProgressData.incorrectQuestions || [];
                    timeRemaining = loadedProgressData.timeRemaining ?? quizDurationInSeconds;
                    selectedQuizData = loadedProgressData.selectedQuizData || []; // 使用儲存的選定題目
                }
                
                loadQuestion(); // 載入第一題
                quizContent.style.display = 'block'; // 顯示測驗內容
                currentSubjectTitle.textContent = subjectNames[jsonFileName]; // 更新科目標題
                startTimer(); // 啟動計時器
            } catch (error) {
                console.error('載入測驗資料失敗:', error);
                loadingIndicator.textContent = `載入題目失敗：${subjectNames[jsonFileName]}。請檢查 GitHub 上的 JSON 檔案路徑或內容格式是否正確。錯誤: ${error.message}`;
                loadingIndicator.style.display = 'block';
                // 發生錯誤時，返回初始狀態讓用戶重試
                initialSelectionScreen.style.display = 'flex';
                subjectSelectionArea.style.display = 'block';
                questionCountsElement.style.display = 'block';
                userCountDisplay.style.display = 'block';
                continueQuizPrompt.style.display = 'none';
                viewLeaderboardButton.style.display = 'block';
                return;
            } finally {
                // 只有在資料成功載入或為繼續測驗時才隱藏載入指示器
                if (fullQuizData.length > 0 || isContinuing) { 
                    loadingIndicator.style.display = 'none';
                }
                hideGlobalLoading(); // 無論成功或失敗，都隱藏全域載入中
            }
        }

        // 重新測驗按鈕點擊事件監聽器
        restartButton.addEventListener('click', () => {
            showGlobalLoading(); // 顯示載入中
            // 重新顯示環境選擇畫面，並隱藏測驗內容和總結
            environmentSelectionScreen.style.display = 'flex';
            initialSelectionScreen.style.display = 'none';
            quizContent.style.display = 'none';
            quizSummary.classList.remove('show');
            askGeminiButton.style.display = 'none';
            stopTimer(); // 確保計時器停止
            timerDisplay.style.display = 'none';
            // 重新獲取並顯示訪問人數
            getAndDisplayUserCount().finally(() => {
                hideGlobalLoading(); // 確保讀取完成後隱藏載入中
            }); 
        });

        // 「開始測驗」按鈕點擊事件監聽器 (從科目選擇畫面觸發)
        startQuizButton.addEventListener('click', () => {
            loadFullQuizData(subjectSelect.value, false); // 開始新測驗
        });

        // 「繼續測驗」按鈕點擊事件監聽器
        continueQuizButton.addEventListener('click', () => {
            loadFullQuizData(loadedProgressData.subjectId, true); // 繼續上次測驗
        });

        // 「開始新測驗」按鈕點擊事件監聽器
        startNewQuizButton.addEventListener('click', async () => {
            // 清除選定科目的現有進度
            await clearQuizProgress(subjectSelect.value); 
            loadFullQuizData(subjectSelect.value, false); // 開始一個全新的測驗
        });

        // Gemini 相關事件監聽器
        askGeminiButton.addEventListener('click', () => {
            // 如果是 GitHub Pages 環境且沒有設定 API 金鑰，則提示輸入
            if (currentEnvironment === 'github-pages' && !geminiApiKey) {
                apiKeyModalOverlay.style.display = 'flex';
                geminiApiKeyInput.focus();
                return;
            }
            geminiModalOverlay.style.display = 'flex'; // 顯示模態框
            geminiQuestionInput.focus(); // 輸入框自動獲取焦點
        });

        geminiModalClose.addEventListener('click', () => {
            geminiModalOverlay.style.display = 'none'; // 隱藏模態框
            geminiResponseArea.innerHTML = ''; // 清空回應內容
            geminiResponseArea.style.display = 'none';
            geminiQuestionInput.value = ''; // 清空輸入框
            geminiLoadingIndicator.style.display = 'none';
        });

        // Gemini 提問模態框取消按鈕的事件監聽器
        geminiModalCancelButton.addEventListener('click', () => {
            geminiModalOverlay.style.display = 'none'; // 隱藏模態框
            geminiResponseArea.innerHTML = '';
            geminiResponseArea.style.display = 'none';
            geminiQuestionInput.value = '';
            geminiLoadingIndicator.style.display = 'none';
        });

        // API 金鑰模態框取消按鈕的事件監聽器
        apiKeyModalCancelButton.addEventListener('click', () => {
            apiKeyModalOverlay.style.display = 'none'; // 隱藏 API 金鑰模態框
            geminiApiKeyInput.value = '';
        });

        // 處理 API 金鑰提交
        submitApiKeyButton.addEventListener('click', () => {
            const inputKey = geminiApiKeyInput.value.trim();
            if (inputKey) {
                geminiApiKey = inputKey; // 儲存輸入的金鑰
                apiKeyModalOverlay.style.display = 'none'; // 隱藏 API 金鑰模態框
                askGeminiButton.click(); // 重新觸發詢問 Gemini 按鈕的點擊事件
            } else {
                showConfirmationModal('提示', '請輸入有效的 Gemini API 金鑰。', null, true);
            }
        });

        // 提交 Gemini 問題按鈕點擊事件監聽器
        submitGeminiQuestionButton.addEventListener('click', async () => {
            const userQuestion = geminiQuestionInput.value.trim();
            if (!userQuestion) {
                geminiResponseArea.style.display = 'block';
                geminiResponseArea.textContent = '請輸入您的問題。';
                return;
            }

            geminiResponseArea.innerHTML = '';
            geminiResponseArea.style.display = 'none';
            geminiLoadingIndicator.style.display = 'block'; // 顯示載入指示器

            const currentQuestionData = selectedQuizData[currentQuestionIndex];
            const prompt = `關於以下測驗題目：
題目：${currentQuestionData.question}
選項：
A) ${currentQuestionData.options[0]}
B) ${currentQuestionData.options[1]}
C) ${currentQuestionData.options[2]}
D) ${currentQuestionData.options[3]}
正確答案：${currentQuestionData.answer}
解釋：${currentQuestionData.explanation}

我的問題是：${userQuestion}

請根據上述資訊，詳細回答我的問題。`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                // 根據環境使用動態設定的 Gemini API 金鑰
                const apiKeyToUse = (currentEnvironment === 'github-pages') ? geminiApiKey : ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKeyToUse}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    geminiResponseArea.textContent = text;
                } else {
                    geminiResponseArea.textContent = '抱歉，無法獲取回答。請稍後再試或換個問題。';
                    console.error('Gemini API response structure unexpected:', result);
                }
            } catch (error) {
                geminiResponseArea.textContent = '發生錯誤，無法連接到 Gemini 服務。請檢查您的網路連線。';
                console.error('Error calling Gemini API:', error);
            } finally {
                geminiLoadingIndicator.style.display = 'none'; // 隱藏載入指示器
                geminiResponseArea.style.display = 'block'; // 顯示回應區域
            }
        });

        /**
         * 將秒數格式化為 MM:SS 的時間字串。
         * @param {number} seconds - 要格式化的秒數。
         * @returns {string} - 格式化後的時間字串。
         */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        /**
         * 啟動測驗計時器。
         */
        function startTimer() {
            // 如果不是從儲存的進度繼續，則重置時間
            if (!loadedProgressData) {
                timeRemaining = quizDurationInSeconds;
            }
            timerDisplay.textContent = formatTime(timeRemaining);
            timerDisplay.style.display = 'block'; // 測驗開始時顯示計時器

            timerInterval = setInterval(() => {
                timeRemaining--;
                timerDisplay.textContent = formatTime(timeRemaining);

                if (timeRemaining <= 0) {
                    stopTimer();
                    showQuizSummary(); // 時間到自動交卷
                    // 禁用所有選項和導航按鈕，防止進一步互動
                    const buttons = optionsContainer.querySelectorAll('.option-button');
                    buttons.forEach(button => {
                        button.classList.add('disabled');
                    });
                    prevButton.disabled = true;
                    nextButton.disabled = true;
                    submitEarlyButton.disabled = true;
                }
            }, 1000);
        }

        /**
         * 停止測驗計時器。
         */
        function stopTimer() {
            clearInterval(timerInterval);
        }

        /**
         * 顯示自定義的確認/訊息模態框。
         * @param {string} title - 模態框標題。
         * @param {string} message - 模態框訊息。
         * @param {Function} onConfirmCallback - 確認時執行的回調函數。
         * @param {boolean} isAlert - 是否為提示訊息 (只顯示一個「確定」按鈕)。
         */
        function showConfirmationModal(title, message, onConfirmCallback, isAlert = false) {
            const modalTitle = confirmationModalOverlay.querySelector('.confirmation-modal-title');
            const modalMessage = confirmationModalOverlay.querySelector('.confirmation-modal-message');
            const modalButtons = confirmationModalOverlay.querySelector('.confirmation-modal-buttons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            modalButtons.innerHTML = ''; // 清空舊按鈕

            if (isAlert) {
                // 如果是提示訊息，只顯示一個「確定」按鈕
                const okButton = document.createElement('button');
                okButton.id = 'confirm-ok-button';
                okButton.className = 'confirmation-modal-button confirm-no';
                okButton.textContent = '確定';
                okButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback();
                    }
                });
                modalButtons.appendChild(okButton);
            } else {
                // 如果是確認訊息，顯示「確定交卷」和「取消」按鈕
                const yesButton = document.createElement('button');
                yesButton.id = 'confirm-yes-button';
                yesButton.className = 'confirmation-modal-button confirm-yes';
                yesButton.textContent = '確定交卷';
                yesButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback(true);
                    }
                });
                modalButtons.appendChild(yesButton);

                const noButton = document.createElement('button');
                noButton.id = 'confirm-no-button';
                noButton.className = 'confirmation-modal-button confirm-no';
                noButton.textContent = '取消';
                noButton.addEventListener('click', () => {
                    confirmationModalOverlay.style.display = 'none';
                    if (onConfirmCallback) {
                        onConfirmCallback(false);
                    }
                });
                modalButtons.appendChild(noButton);
            }

            confirmationModalOverlay.style.display = 'flex';
        }

        /**
         * 獲取並顯示每個科目的題目數量。
         */
        async function getQuestionCounts() {
            questionCountsElement.innerHTML = '<p>正在載入題目數量...</p>';
            let allCounts = {};
            let hasError = false;

            for (const fileName in subjectNames) {
                const githubRawUrl = `https://raw.githubusercontent.com/ss1111119/ipas_AI-Planner-Exam/main/${fileName}`;
                try {
                    const response = await fetch(githubRawUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    allCounts[fileName] = data.length;
                } catch (error) {
                    console.error(`載入 ${fileName} 題目數量失敗:`, error);
                    allCounts[fileName] = '載入失敗';
                    hasError = true;
                }
            }

            questionCountsElement.innerHTML = ''; // 清空載入訊息
            if (hasError) {
                questionCountsElement.innerHTML = '<p class="text-red-500">無法載入所有題目數量，請檢查網路連線或 GitHub 檔案路徑。</p>';
            }
            for (const fileName in subjectNames) {
                const p = document.createElement('p');
                p.textContent = `${subjectNames[fileName]}：${allCounts[fileName]} 題`;
                questionCountsElement.appendChild(p);
            }
        }

        /**
         * 儲存測驗進度到 Firestore。
         * @param {string} subjectId - 科目 ID。
         */
        async function saveQuizProgress(subjectId) {
            if (!db || !currentUserId || !effectiveAppId) {
                console.warn("無法儲存進度：Firebase 未初始化或用戶 ID 無效。");
                return;
            }

            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);
            
            try {
                const dataToSave = {
                    subjectId: subjectId,
                    currentQuestionIndex: currentQuestionIndex !== undefined ? currentQuestionIndex : 0,
                    userAnswers: userAnswers || [],
                    score: score !== undefined ? score : 0,
                    incorrectQuestions: incorrectQuestions || [],
                    timeRemaining: timeRemaining !== undefined ? timeRemaining : quizDurationInSeconds,
                    selectedQuizData: selectedQuizData || [],
                    lastSaved: serverTimestamp()
                };
                
                // 深度清理資料，移除所有 undefined 值
                const cleanedDataToSave = removeUndefined(dataToSave);

                await setDoc(progressDocRef, cleanedDataToSave, { merge: false }); // 覆蓋該科目的舊進度
                console.log(`測驗進度已儲存 (科目: ${subjectId})`);
            } catch (error) {
                console.error("儲存測驗進度失敗:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許匿名使用者在路徑 `/artifacts/{appId}/users/{userId}/quiz_progress/{subjectId}` 上進行讀寫操作。");
                }
            }
        }

        /**
         * 清除 Firestore 中的測驗進度。
         * @param {string} subjectId - 科目 ID。
         */
        async function clearQuizProgress(subjectId) {
            if (!db || !currentUserId || !effectiveAppId) {
                console.warn("無法清除進度：Firebase 未初始化或用戶 ID 無效。");
                return;
            }
            const progressDocRef = doc(db, 'artifacts', effectiveAppId, 'users', currentUserId, 'quiz_progress', subjectId);
            try {
                await setDoc(progressDocRef, {}); // 設定為空物件以清除內容
                console.log(`測驗進度已清除 (科目: ${subjectId})`);
                loadedProgressData = null; // 清除本地已載入的資料
            } catch (error) {
                console.error("清除測驗進度失敗:", error);
            }
        }

        /**
         * 初始化 Firebase 服務 (應用程式、認證、Firestore)。
         */
        async function initializeFirebaseServices() {
            try {
                console.log("initializeFirebaseServices: 開始初始化 Firebase 服務...");
                
                let currentFirebaseConfig;

                // 優先使用 Canvas 環境提供的 __firebase_config
                if (typeof __firebase_config !== 'undefined') {
                    currentFirebaseConfig = JSON.parse(__firebase_config);
                    currentEnvironment = 'canvas';
                    effectiveAppId = typeof __app_id !== 'undefined' ? __app_id : currentFirebaseConfig.appId; // Canvas 環境下，appId 使用 __app_id，如果沒有則用 __firebase_config 的 appId
                    console.log("initializeFirebaseServices: 檢測到 Canvas 環境。使用 __firebase_config。");
                } else {
                    currentFirebaseConfig = defaultFirebaseConfig; // GitHub Pages 環境使用硬編碼的配置
                    currentEnvironment = 'github-pages';
                    effectiveAppId = currentFirebaseConfig.appId; // GitHub Pages 環境使用 defaultFirebaseConfig 的 appId
                    console.log("initializeFirebaseServices: 檢測到 GitHub Pages 環境。使用 defaultFirebaseConfig。");
                }

                console.log("initializeFirebaseServices: 實際使用的 Firebase Config:", currentFirebaseConfig);
                console.log("initializeFirebaseServices: 實際使用的 App ID (effectiveAppId):", effectiveAppId);

                if (!currentFirebaseConfig.apiKey || !currentFirebaseConfig.authDomain || !currentFirebaseConfig.projectId || !currentFirebaseConfig.appId) {
                    console.error("initializeFirebaseServices: Firebase 配置不完整。請確保 apiKey, authDomain, projectId, 和 appId 都已提供。", currentFirebaseConfig);
                    throw new Error("Firebase 配置不完整。請確保 apiKey, authDomain, projectId, 和 appId 都已提供。");
                }

                if (!app) {
                    app = initializeApp(currentFirebaseConfig); 
                    auth = getAuth(app); 
                    db = getFirestore(app); 
                    console.log("initializeFirebaseServices: Firebase app, auth, db 已初始化。");
                } else {
                    console.log("initializeFirebaseServices: Firebase 服務已初始化，跳過重複初始化。");
                }

            } catch (error) {
                console.error("initializeFirebaseServices: Firebase 初始化失敗:", error);
                userCountDisplay.textContent = '無法載入訪問人數 (初始化錯誤)。';
                // 如果 Firebase 初始化失敗，直接顯示科目選擇畫面
                environmentSelectionScreen.style.display = 'none';
                initialSelectionScreen.style.display = 'flex';
                continueQuizPrompt.style.display = 'none';
                subjectSelectionArea.style.display = 'block';
                getQuestionCounts(); // 仍然嘗試顯示題目數量
                viewLeaderboardButton.style.display = 'block';
            }
        }

        /**
         * 儲存使用者暱稱到 Firestore。
         * @param {string} uid - Firebase 用戶 UID。
         * @param {string} displayName - 要儲存的暱稱。
         */
        async function saveUserDisplayNameToFirestore(uid, displayName) {
            if (!db || !uid || !effectiveAppId) {
                console.warn("無法儲存顯示名稱：Firebase 未初始化或 UID 無效。");
                return;
            }
            const userProfileDocRef = doc(db, 'artifacts', effectiveAppId, 'users', uid, 'profile', 'data');
            try {
                await setDoc(userProfileDocRef, { displayName: displayName, lastUpdated: serverTimestamp() }, { merge: true });
                console.log(`使用者顯示名稱已儲存: ${displayName} for UID: ${uid}`);
            } catch (error) {
                console.error("儲存使用者顯示名稱失敗:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許使用者在路徑 `/artifacts/{appId}/users/{userId}/profile/data` 上進行讀寫操作。");
                }
            }
        }

        /**
         * 從 Firestore 載入使用者暱稱。
         * @param {string} uid - Firebase 用戶 UID。
         * @returns {Promise<string|null>} - 載入的暱稱或 null。
         */
        async function loadUserDisplayNameFromFirestore(uid) {
            if (!db || !uid || !effectiveAppId) {
                console.warn("無法載入顯示名稱：Firebase 未初始化或 UID 無效。");
                return null;
            }
            const userProfileDocRef = doc(db, 'artifacts', effectiveAppId, 'users', uid, 'profile', 'data');
            try {
                const docSnap = await getDoc(userProfileDocRef);
                if (docSnap.exists() && docSnap.data().displayName) {
                    console.log(`從 Firestore 載入顯示名稱: ${docSnap.data().displayName} for UID: ${uid}`);
                    return docSnap.data().displayName;
                }
                console.log(`未從 Firestore 載入顯示名稱 for UID: ${uid}`);
                return null;
            } catch (error) {
                console.error("載入使用者顯示名稱失敗:", error);
                return null;
            }
        }

        /**
         * 處理使用者認證和資料載入流程。
         */
        async function handleUserAuthenticationAndDataLoad() {
            showGlobalLoading(); // 顯示載入中
            console.log("handleUserAuthenticationAndDataLoad: 開始處理使用者認證和資料載入...");
            if (!app || !auth || !db) {
                console.error("handleUserAuthenticationAndDataLoad: Firebase 服務未初始化，無法處理使用者認證和資料載入。");
                showConfirmationModal('錯誤', 'Firebase 服務未初始化，請重新整理頁面或稍後再試。', null, true);
                hideGlobalLoading(); // 隱藏載入中
                return;
            }

            let firebaseAuthUid = null;

            // 步驟 1: 執行 Firebase 認證 (自定義 Token 或匿名登入)
            if (currentEnvironment === 'canvas') {
                console.log("handleUserAuthenticationAndDataLoad: Canvas 環境認證中...");
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                        firebaseAuthUid = userCredential.user.uid;
                        console.log("Canvas: 已使用自定義 token 登入。UID:", firebaseAuthUid);
                    } catch (tokenError) {
                        console.error("Canvas: 自定義 token 登入失敗，嘗試匿名登入:", tokenError);
                        try {
                            const userCredential = await signInAnonymously(auth);
                            firebaseAuthUid = userCredential.user.uid;
                            console.log("Canvas: 自定義 token 失敗後，已匿名登入。UID:", firebaseAuthUid);
                        } catch (anonError) {
                            console.error("Canvas: 匿名登入失敗:", anonError);
                            showConfirmationModal('錯誤', 'Canvas 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                            hideGlobalLoading();
                            return;
                        }
                    }
                } else {
                    console.log("Canvas: 無自定義 token，嘗試匿名登入...");
                    try {
                        const userCredential = await signInAnonymously(auth);
                        firebaseAuthUid = userCredential.user.uid;
                        console.log("Canvas: 已匿名登入。UID:", firebaseAuthUid);
                    } catch (anonError) {
                        console.error("Canvas: 匿名登入失敗:", anonError);
                        showConfirmationModal('錯誤', 'Canvas 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                        hideGlobalLoading();
                        return;
                    }
                }
            } else { // GitHub Pages 環境
                console.log("handleUserAuthenticationAndDataLoad: GitHub Pages 環境匿名認證中...");
                // GitHub Pages 環境總是匿名登入以獲取 Firebase UID
                try {
                    const userCredential = await signInAnonymously(auth);
                    firebaseAuthUid = userCredential.user.uid;
                    console.log("GitHub Pages: 已匿名登入。UID:", firebaseAuthUid);
                } catch (anonError) {
                    console.error("GitHub Pages: 匿名登入失敗:", anonError);
                    showConfirmationModal('錯誤', 'GitHub Pages 環境登入失敗，請檢查網路連線或稍後再試。', null, true);
                    hideGlobalLoading();
                    return;
                }
            }

            // 此時 firebaseAuthUid 應該已被設定，將其作為實際的 currentUserId
            currentUserId = firebaseAuthUid;
            console.log("handleUserAuthenticationAndDataLoad: currentUserId 已設定為:", currentUserId);

            // 步驟 2: 處理使用者顯示名稱
            let storedDisplayName = localStorage.getItem('user_defined_display_name');
            if (storedDisplayName) {
                currentUserDisplayName = storedDisplayName;
                console.log("handleUserAuthenticationAndDataLoad: 從 localStorage 使用儲存的顯示名稱:", currentUserDisplayName);
                // 同步儲存/更新到 Firestore 個人資料中
                await saveUserDisplayNameToFirestore(currentUserId, currentUserDisplayName);
                await proceedAfterUserIdSet(); // 如果找到顯示名稱，立即繼續
                hideGlobalLoading();
            } else {
                // 如果 localStorage 中沒有，嘗試從 Firestore 載入
                const loadedDisplayName = await loadUserDisplayNameFromFirestore(currentUserId);
                if (loadedDisplayName) {
                    currentUserDisplayName = loadedDisplayName;
                    localStorage.setItem('user_defined_display_name', currentUserDisplayName); // 儲存到 localStorage 以便下次快速存取
                    console.log("handleUserAuthenticationAndDataLoad: 從 Firestore 使用儲存的顯示名稱:", currentUserDisplayName);
                    await proceedAfterUserIdSet(); // 如果找到顯示名稱，立即繼續
                    hideGlobalLoading();
                } else {
                    // 如果任何地方都未找到顯示名稱，提示用戶輸入
                    console.log("handleUserAuthenticationAndDataLoad: 未找到顯示名稱，顯示使用者暱稱輸入模態框。");
                    userIdModalOverlay.style.display = 'flex';
                    userIdInput.focus();
                    hideGlobalLoading(); // 隱藏載入中 (因為要顯示另一個模態框)
                    // 不在此處呼叫 proceedAfterUserIdSet()，它將在用戶提交 ID 後呼叫
                }
            }
        }

        /**
         * 在設定使用者 ID 後繼續執行應用程式流程。
         */
        async function proceedAfterUserIdSet() {
            console.log("proceedAfterUserIdSet: 繼續執行，currentUserId:", currentUserId);
            if (currentUserId) {
                console.log("proceedAfterUserIdSet: db:", db, "effectiveAppId:", effectiveAppId);
                await trackUserVisit(effectiveAppId); // 追蹤用戶訪問
                environmentSelectionScreen.style.display = 'none';
                initialSelectionScreen.style.display = 'flex';
                subjectSelectionArea.style.display = 'block'; // 始終顯示科目選擇
                getQuestionCounts(); // 顯示題目數量
                viewLeaderboardButton.style.display = 'block'; // 在初始畫面顯示排行榜按鈕
                await checkAndDisplaySavedProgress(); // 檢查是否有儲存的進度
            } else {
                console.error("proceedAfterUserIdSet: 無法設定 currentUserId。");
                showConfirmationModal('錯誤', '無法設定使用者 ID，請重新整理頁面或稍後再試。', null, true);
            }
        }

        // 環境選擇按鈕點擊事件監聽器
        selectCanvasEnvButton.addEventListener('click', async () => {
            currentEnvironment = 'canvas';
            userCountDisplay.style.display = 'block'; // 確保在環境選擇畫面顯示用戶計數
            await handleUserAuthenticationAndDataLoad();
        });

        selectGithubEnvButton.addEventListener('click', async () => {
            currentEnvironment = 'github-pages';
            userCountDisplay.style.display = 'block'; // 確保在環境選擇畫面顯示用戶計數
            await handleUserAuthenticationAndDataLoad();
        });

        // 使用者 ID 輸入模態框的確認按鈕點擊事件監聽器
        submitUserIdButton.addEventListener('click', async () => {
            let enteredDisplayName = userIdInput.value.trim();
            // 如果沒有輸入暱稱，則給予預設稱呼
            if (!enteredDisplayName) {
                enteredDisplayName = '陌生人'; // 您可以根據需求修改為其他預設名稱
            }
            
            showGlobalLoading(); // 顯示載入中
            currentUserDisplayName = enteredDisplayName;
            localStorage.setItem('user_defined_display_name', enteredDisplayName); // 儲存到 localStorage
            userIdModalOverlay.style.display = 'none'; // 隱藏模態框
            console.log("User display name set and stored:", currentUserDisplayName);
            // 立即儲存到 Firestore 個人資料中
            await saveUserDisplayNameToFirestore(currentUserId, currentUserDisplayName);
            await proceedAfterUserIdSet(); // 繼續處理認證和資料載入
            hideGlobalLoading(); // 隱藏載入中
        });

        // 使用者 ID 輸入模態框的取消按鈕點擊事件監聽器
        cancelUserIdButton.addEventListener('click', () => {
            userIdModalOverlay.style.display = 'none'; // 隱藏模態框
            // 如果使用者取消，則回到環境選擇畫面
            environmentSelectionScreen.style.display = 'flex';
            initialSelectionScreen.style.display = 'none';
            userCountDisplay.style.display = 'block';
            getAndDisplayUserCount(); // 返回環境選擇畫面時更新用戶計數
        });

        /**
         * 將測驗分數儲存到排行榜。
         * @param {number} finalScorePoints - 計算後的總分數。
         */
        async function saveQuizScoreToLeaderboard(finalScorePoints) {
            if (!db || !currentUserId || !effectiveAppId) {
                console.warn("無法儲存排行榜分數：Firebase 未初始化或必要參數缺失。");
                return;
            }

            // 排行榜資料儲存在公共路徑：/artifacts/{appId}/public/data/leaderboard_scores
            const leaderboardCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'leaderboard_scores');
            console.log("Firestore collection path for leaderboard write:", leaderboardCollectionRef.path);
            
            try {
                const scoreData = {
                    userId: currentUserId,
                    displayName: currentUserDisplayName || '匿名用戶',
                    score: finalScorePoints, // 儲存計算後的總分數
                    totalQuestions: selectedQuizData.length, // 仍然儲存總題數，以備需要
                    correctAnswers: score, // 新增答對題數，以備需要
                    subject: subjectNames[subjectSelect.value],
                    timestamp: serverTimestamp()
                };

                // 添加一個新文件，ID 由 Firestore 自動生成
                await addDoc(leaderboardCollectionRef, scoreData);
                console.log("測驗分數已儲存到排行榜。");
            } catch (error) {
                console.error("儲存測驗分數到排行榜失敗:", error);
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許使用者在路徑 `/artifacts/{appId}/public/data/leaderboard_scores` 上進行寫入操作。");
                }
            }
        }

        /**
         * 從 Firestore 獲取並顯示排行榜分數。
         */
        async function fetchLeaderboardScores() {
            showGlobalLoading(); // 顯示載入中
            console.log("fetchLeaderboardScores: 開始獲取排行榜分數...");
            console.log("fetchLeaderboardScores: db 實例:", db);
            console.log("fetchLeaderboardScores: effectiveAppId:", effectiveAppId);

            if (!db || !effectiveAppId) {
                console.error("fetchLeaderboardScores: Firestore 未初始化或 App ID 無效，無法獲取排行榜分數。");
                leaderboardList.innerHTML = '<li>無法載入排行榜 (初始化中)。</li>';
                hideGlobalLoading(); // 隱藏載入中
                return;
            }

            const leaderboardCollectionRef = collection(db, 'artifacts', effectiveAppId, 'public', 'data', 'leaderboard_scores');
            console.log("fetchLeaderboardScores: leaderboardCollectionRef path:", leaderboardCollectionRef.path);
            
            try {
                // 查詢排行榜分數，按分數降序排列，分數相同則按時間升序排列，限制前 100 名
                const q = query(leaderboardCollectionRef, orderBy('score', 'desc'), orderBy('timestamp', 'asc'), limit(100));
                console.log("fetchLeaderboardScores: 準備執行 getDocs 查詢...");
                const querySnapshot = await getDocs(q);
                console.log("fetchLeaderboardScores: getDocs 查詢已完成。");

                leaderboardList.innerHTML = ''; // 清空之前的列表
                if (querySnapshot.empty) {
                    leaderboardList.innerHTML = '<li>目前沒有排行榜資料。</li>';
                    console.log("fetchLeaderboardScores: 排行榜為空。");
                    return;
                }

                let rank = 1;
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const listItem = document.createElement('li');
                    const timestampDate = data.timestamp ? data.timestamp.toDate() : new Date(); // 將時間戳轉換為 Date 物件
                    const formattedDate = timestampDate.toLocaleString('zh-TW', {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    // 這裡顯示的是從 Firestore 讀取到的 'score' 欄位，現在它應該是計算後的總分
                    listItem.innerHTML = `
                        <span class="leaderboard-rank">${rank}.</span>
                        <span class="leaderboard-name">${data.displayName} (${data.subject})</span>
                        <span class="leaderboard-score">${data.score} 分</span> 
                        <span class="text-sm text-gray-500 ml-4">${formattedDate}</span>
                    `;
                    leaderboardList.appendChild(listItem);
                    rank++;
                });
                console.log("fetchLeaderboardScores: 排行榜資料已顯示。");
            } catch (error) {
                console.error("fetchLeaderboardScores: 獲取排行榜分數失敗:", error);
                leaderboardList.innerHTML = '<li>載入排行榜失敗 (錯誤)。</li>';
                if (error.code === 'permission-denied') {
                    console.error("錯誤提示: Firebase 權限不足。請檢查您的 Firestore 安全規則，確保允許讀取 `/artifacts/{appId}/public/data/leaderboard_scores`。");
                }
            } finally {
                hideGlobalLoading(); // 無論成功或失敗，都隱藏載入中
            }
        }

        /**
         * 分享測驗結果。
         */
        async function shareQuizResults() {
            const quizTitle = "iPAS初級AI應用規劃師模擬測驗";
            const subjectName = subjectNames[subjectSelect.value];
            const finalScorePoints = score * POINTS_PER_QUESTION; // 計算最終分數
            const finalScoreDisplay = `${finalScorePoints} 分`; // 顯示分數
            const message = summaryMessageElement.textContent;
            const userName = currentUserDisplayName || '匿名用戶';

            let shareText = `我在「${quizTitle}」的「${subjectName}」測驗中，獲得了 ${finalScoreDisplay}！\n${message}\n\n`;
            shareText += `我的暱稱是：${userName}\n`;

            if (incorrectQuestions.length > 0) {
                shareText += `\n我答錯了 ${incorrectQuestions.length} 題，繼續努力！`;
            } else {
                shareText += `\n恭喜我，沒有答錯的題目！`;
            } 
            shareText += `\n\n立即來挑戰：${window.location.href}`; 

            try {
                if (navigator.share) {
                    // 如果瀏覽器支援 Web Share API，則使用它
                    await navigator.share({
                        title: quizTitle,
                        text: shareText,
                        url: window.location.href,
                    });
                    showConfirmationModal('分享成功', '測驗結果已成功分享！', null, true);
                } else {
                    // 否則，回退到複製到剪貼簿
                    const tempInput = document.createElement('textarea');
                    tempInput.value = shareText;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showConfirmationModal('複製成功', '測驗結果已複製到剪貼簿！您可以貼到任何地方。', null, true);
                }
            } catch (error) {
                console.error('分享失敗:', error);
                // 檢查錯誤是否為用戶取消分享
                if (error.name !== 'AbortError') {
                    showConfirmationModal('分享失敗', '無法分享測驗結果。您的瀏覽器可能不支援分享功能，或發生其他錯誤。結果已嘗試複製到剪貼簿。', null, true);
                } else {
                    console.log('分享已取消。');
                }
            }
        }

        // 頁面載入時執行初始化邏輯
        document.addEventListener('DOMContentLoaded', async () => {
            showGlobalLoading(); // 在 DOMContentLoaded 時顯示載入中
            environmentSelectionScreen.style.display = 'flex';
            initialSelectionScreen.style.display = 'none';
            quizContent.style.display = 'none';
            quizSummary.classList.remove('show');
            timerDisplay.style.display = 'none';
            userIdModalOverlay.style.display = 'none';
            leaderboardModalOverlay.style.display = 'none';
            
            // 初始化 Firebase 服務
            await initializeFirebaseServices();
            // 立即獲取並顯示訪問人數
            await getAndDisplayUserCount();
            hideGlobalLoading(); // 在 DOMContentLoaded 完成後隱藏載入中

            // 為分享結果按鈕添加事件監聽器 (確保在 DOMContentLoaded 後執行)
            shareResultsButton.addEventListener('click', shareQuizResults);

            // 為排行榜按鈕添加事件監聽器
            viewLeaderboardButton.addEventListener('click', async () => {
                leaderboardModalOverlay.style.display = 'flex'; // 顯示排行榜模態框
                await fetchLeaderboardScores(); // 載入並顯示排行榜分數
            });
            viewLeaderboardButtonSummary.addEventListener('click', async () => {
                leaderboardModalOverlay.style.display = 'flex'; // 顯示排行榜模態框
                await fetchLeaderboardScores(); // 載入並顯示排行榜分數
            });

            // 為排行榜模態框的關閉按鈕添加事件監聽器
            leaderboardModalClose.addEventListener('click', () => {
                leaderboardModalOverlay.style.display = 'none'; // 隱藏排行榜模態框
            });


            // 添加 beforeunload 監聽器以在頁面關閉前保存進度
            window.addEventListener('beforeunload', async () => {
                if (quizContent.style.display === 'block' && currentUserId && selectedQuizData.length > 0) {
                    // 只有在測驗活躍且用戶至少回答了一個問題時才保存
                    if (userAnswers.length > 0) {
                        await saveQuizProgress(subjectSelect.value); 
                    }
                }
            });
        });
    </script>
</body>
</html>
